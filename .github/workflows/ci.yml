name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: fcra_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio playwright
          playwright install chromium

      - name: Run unit tests with coverage
        run: pytest tests/ -v --tb=short --ignore=tests/mandatory --cov=. --cov-report=xml --cov-report=term-missing
        env:
          CI: "true"
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/fcra_test
          SECRET_KEY: test-secret-key

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 30

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Check coverage threshold
        run: |
          python -c "
          import xml.etree.ElementTree as ET
          import sys

          MINIMUM_COVERAGE = 20  # Fail if coverage drops below this

          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          line_rate = float(root.get('line-rate', 0)) * 100

          print(f'Line Coverage: {line_rate:.1f}%')
          print(f'Minimum Required: {MINIMUM_COVERAGE}%')

          # Write to job summary
          with open('$GITHUB_STEP_SUMMARY', 'a') as f:
              f.write('## Coverage Report\n')
              f.write(f'**Line Coverage: {line_rate:.1f}%** (minimum: {MINIMUM_COVERAGE}%)\n')
              if line_rate >= MINIMUM_COVERAGE:
                  f.write('✅ Coverage threshold passed\n')
              else:
                  f.write('❌ Coverage threshold failed\n')

          if line_rate < MINIMUM_COVERAGE:
              print(f'❌ FAILED: Coverage {line_rate:.1f}% is below minimum {MINIMUM_COVERAGE}%')
              sys.exit(1)
          else:
              print(f'✅ PASSED: Coverage meets minimum threshold')
          "
        env:
          GITHUB_STEP_SUMMARY: ${{ github.step_summary }}

  cypress-tests:
    name: Cypress E2E Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: fcra_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install Node dependencies
        run: npm ci

      - name: Start Flask app
        run: |
          python app.py &
          sleep 10
        env:
          CI: "true"
          PORT: "5001"
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/fcra_test
          SECRET_KEY: test-secret-key

      - name: Wait for app
        run: |
          for i in {1..30}; do
            curl -s http://localhost:5001/staff/login && break
            echo "Waiting for app... ($i)"
            sleep 2
          done

      - name: Run Cypress tests
        uses: cypress-io/github-action@v6
        with:
          wait-on: http://localhost:5001
          wait-on-timeout: 120
          browser: chrome
          record: false
        env:
          CI: "true"
          PORT: "5001"

      - name: Upload screenshots on failure
        uses: actions/upload-artifact@v6
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          retention-days: 7

      - name: Upload videos on failure
        uses: actions/upload-artifact@v6
        if: failure()
        with:
          name: cypress-videos
          path: cypress/videos
          retention-days: 7

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install flake8
        run: pip install flake8

      - name: Run flake8
        run: flake8 app.py services/ --max-line-length=150 --ignore=E501,W503,E402 --exit-zero

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install bandit
        run: pip install bandit

      - name: Run bandit (Python security)
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "### Python (Bandit)" >> $GITHUB_STEP_SUMMARY
          bandit -r app.py services/ -f txt -o bandit-report.txt --severity-level medium || true
          if [ -s bandit-report.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat bandit-report.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No issues found" >> $GITHUB_STEP_SUMMARY
          fi
          bandit -r app.py services/ --severity-level high --confidence-level high

      - name: Run npm audit (JS security)
        run: |
          echo "### JavaScript (npm audit)" >> $GITHUB_STEP_SUMMARY
          npm ci
          npm audit --audit-level=high || echo "⚠️ Vulnerabilities found (see above)" >> $GITHUB_STEP_SUMMARY

  formatting:
    name: Code Formatting
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install formatters
        run: pip install black isort

      - name: Check black formatting
        run: |
          echo "## Code Formatting" >> $GITHUB_STEP_SUMMARY
          echo "### Black (Python)" >> $GITHUB_STEP_SUMMARY
          if black --check app.py services/ 2>&1; then
            echo "✅ All files formatted correctly" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some files need formatting. Run: \`black app.py services/\`" >> $GITHUB_STEP_SUMMARY
          fi
          black --check app.py services/

      - name: Check isort imports
        run: |
          echo "### isort (Import ordering)" >> $GITHUB_STEP_SUMMARY
          if isort --check-only app.py services/ --profile black 2>&1; then
            echo "✅ All imports sorted correctly" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Some imports need sorting. Run: \`isort app.py services/ --profile black\`" >> $GITHUB_STEP_SUMMARY
          fi
          isort --check-only app.py services/ --profile black

  type-check:
    name: Type Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install mypy
          pip install -r requirements.txt

      - name: Run mypy
        run: |
          echo "## Type Check (mypy)" >> $GITHUB_STEP_SUMMARY
          ERROR_COUNT=$(mypy app.py services/ --ignore-missing-imports 2>&1 | grep -c "error:" || echo "0")
          echo "Found **$ERROR_COUNT** type errors" >> $GITHUB_STEP_SUMMARY
          if [ "$ERROR_COUNT" -eq "0" ]; then
            echo "✅ No type errors found" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Type errors found (non-blocking)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View errors (first 50)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            mypy app.py services/ --ignore-missing-imports 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          # Non-blocking for now
          mypy app.py services/ --ignore-missing-imports || true
