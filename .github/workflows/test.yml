name: FCRA Platform Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Unit Tests - Run first, fastest feedback
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: fcra_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run unit tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/fcra_test
          TESTING: 'true'
          CI: 'true'
          FCRA_ENCRYPTION_KEY: 'test-key-for-ci-only-not-production'
        run: |
          python -m pytest tests/ \
            --tb=short \
            --ignore=tests/integration/ \
            -v \
            --cov=services \
            --cov-report=xml \
            --cov-report=term-missing

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # ============================================
  # Regression Tests - Credit Import specific
  # ============================================
  regression-tests:
    name: Regression Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run regression tests
        env:
          TESTING: 'true'
          CI: 'true'
        run: |
          python -m pytest \
            tests/test_credit_import_regression.py \
            tests/test_credit_extraction_regression.py \
            -v \
            --tb=short

  # ============================================
  # Integration Tests - Require database
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: fcra_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/fcra_test
          TESTING: 'true'
          CI: 'true'
          FCRA_ENCRYPTION_KEY: 'test-key-for-ci-only-not-production'
        run: |
          python -m pytest tests/integration/ -v --tb=short

  # ============================================
  # Cypress E2E Tests - Full browser testing
  # ============================================
  cypress-tests:
    name: Cypress E2E Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, regression-tests]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: fcra_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Cypress
        run: npm install cypress

      - name: Start Flask server
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/fcra_test
          FCRA_ENCRYPTION_KEY: 'test-key-for-ci-only-not-production'
          PORT: 5001
          CI: 'true'
        run: |
          python app.py &
          sleep 10
          curl -f http://localhost:5001/health || exit 1

      - name: Run Cypress tests
        env:
          CI: 'true'
        run: |
          npx cypress run \
            --spec "cypress/e2e/login.cy.js,cypress/e2e/clients.cy.js,cypress/e2e/dashboard.cy.js"

      - name: Upload Cypress screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots

      - name: Upload Cypress videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-videos
          path: cypress/videos

  # ============================================
  # Final Status Check
  # ============================================
  all-tests-passed:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [unit-tests, regression-tests, integration-tests, cypress-tests]
    if: always()

    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "Unit tests failed"
            exit 1
          fi
          if [ "${{ needs.regression-tests.result }}" != "success" ]; then
            echo "Regression tests failed"
            exit 1
          fi
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "Integration tests failed"
            exit 1
          fi
          if [ "${{ needs.cypress-tests.result }}" != "success" ]; then
            echo "Cypress tests failed"
            exit 1
          fi
          echo "âœ… All tests passed!"
