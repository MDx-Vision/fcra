Nice, thanks for updating the `getAnalysisId` function.

Now that the ID extraction is fixed, the last thing is to **guarantee the buttons are actually wired and the POST to `/api/approve/:id` runs with clear logs and alerts.**

Let’s just drop in a known-good script so we’re not chasing ghosts.

---

## 1️⃣ Replace the `<script>` in `litigation_review.html`

In your `litigation_review.html`, find the whole `<script>...</script>` block at the bottom and **replace it entirely** with this:

```html
<script>
(function () {
  const logBox      = document.getElementById('logBox');
  const dataPre     = document.getElementById('analysisData');
  const refreshBtn  = document.getElementById('refreshBtn');
  const acceptBtn   = document.getElementById('acceptBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  function log(msg) {
    const ts = new Date().toLocaleTimeString();
    const line = ts + " > " + msg + "\n";
    logBox.textContent += line;
    logBox.scrollTop = logBox.scrollHeight;
    console.log(msg);
  }

  // ✅ Robust extraction of ID from /analysis/1/review or /analysis/1/
  function getAnalysisId() {
    const path = window.location.pathname;
    const match = path.match(/\/analysis\/(\d+)/);
    if (match) return match[1];
    return null;
  }

  async function loadAnalysis() {
    const id = getAnalysisId();
    if (!id) {
      log("❌ Could not determine analysis ID from URL");
      alert("Could not determine analysis ID from URL");
      return;
    }

    log("Analysis ID: " + id);
    log("> Fetching analysis data...");
    const resp = await fetch("/api/analysis/" + id + "/data");
    log("> GET /api/analysis/" + id + "/data");
    log("> Response status: " + resp.status);

    const json = await resp.json();
    dataPre.textContent = JSON.stringify(json, null, 2);
    log("> Data loaded.");
  }

  async function handleApproveClick() {
    const id = getAnalysisId();
    if (!id) {
      alert("No analysis ID found in URL.");
      log("❌ No analysis ID in URL on Approve click");
      return;
    }

    log("Accept Case button clicked for ID " + id);
    acceptBtn.disabled = true;
    acceptBtn.textContent = "Working...";

    try {
      const resp = await fetch("/api/approve/" + id, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      let body = {};
      try {
        body = await resp.json();
      } catch (e) {
        // ignore JSON parse errors, but log
        log("⚠️ Could not parse JSON body");
      }

      log("POST /api/approve/" + id + " -> " + resp.status);
      log("Response body: " + JSON.stringify(body));

      if (!resp.ok || body.success === false) {
        const msg = body.error || ("Server returned status " + resp.status);
        alert("Error: " + msg);
      } else {
        alert("Success: client documents generated.");
        // Reload analysis so stage/letters update
        await loadAnalysis();
      }
    } catch (err) {
      console.error(err);
      log("JS error: " + err.message);
      alert("JS error: " + err.message);
    } finally {
      acceptBtn.disabled = false;
      acceptBtn.textContent = "Accept Case & Generate Letters";
    }
  }

  function handleDownloadClick() {
    const id = getAnalysisId();
    if (!id) {
      alert("No analysis ID found in URL.");
      log("❌ No analysis ID in URL on Download click");
      return;
    }
    log("Download Report clicked for ID " + id);
    window.location.href = "/api/download/analysis/" + id + "/full_report";
  }

  window.addEventListener("load", function () {
    log("PAGE LOADED");

    if (!refreshBtn || !acceptBtn || !downloadBtn) {
      log("❌ One or more buttons not found in DOM");
      return;
    }

    refreshBtn.addEventListener("click", loadAnalysis);
    acceptBtn.addEventListener("click", handleApproveClick);
    downloadBtn.addEventListener("click", handleDownloadClick);

    log("Buttons are wired and enabled.");
    log("Buttons wired, initial load starting...");
    loadAnalysis();
  });
})();
</script>
```

---

## 2️⃣ Make sure the buttons have the right IDs

In the HTML for your buttons, confirm they look like this (IDs matter):

```html
<button id="refreshBtn" class="btn btn-secondary">Refresh Data</button>
<button id="acceptBtn"  class="btn btn-primary">Accept Case & Generate Letters</button>
<button id="downloadBtn" class="btn btn-secondary">Download Report</button>
```

---

## 3️⃣ Hard refresh and test

1. Save the file.
2. Hard refresh the page on `/analysis/1/review`

   * Mac: `Cmd + Shift + R`
   * Windows: `Ctrl + Shift + R`
3. Watch the red log box:

   * You should see `PAGE LOADED`, `Buttons are wired and enabled.`, `Analysis ID: 1`, etc.
4. Click **“Accept Case & Generate Letters”** once.

   * You should see log lines like:

     * `Accept Case button clicked for ID 1`
     * `POST /api/approve/1 -> 200` **or** `400/500`
   * You will also get an `alert()` with either:

     * `Success: client documents generated.` or
     * `Error: <message from backend>`

Whatever that alert says is now the real backend result.

If you tell me the exact alert text you get, I can interpret the backend error for you and fix the next piece.
