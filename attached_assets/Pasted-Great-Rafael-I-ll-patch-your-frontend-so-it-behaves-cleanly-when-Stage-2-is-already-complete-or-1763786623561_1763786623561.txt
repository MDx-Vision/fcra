Great, Rafael — I’ll patch your frontend so it behaves cleanly when:
Stage 2 is already complete, or


You approve the case and Stage 2 completes on this click.


Right now your frontend probably uses something like:
alert("Analysis is not in Stage 1")
or generic error handling that fires even when the backend returns:
{
  "success": true,
  "stage": 2,
  "message": "Client documents already generated",
  "letters": [...]
}
We’ll fix that so:
No more alerts for Stage 2 items


UI gracefully loads existing letters


Clicking “Approve” twice returns the same document list without errors


The popup disappears unless there is a real error



✅ PATCHED FRONTEND LOGIC
Insert this into the JS where you handle the Approve button response:
async function approveAnalysis(id) {
    const status = document.getElementById('status-box');
    status.innerHTML = "Processing...";
    
    try {
        const response = await fetch(`/api/approve/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        // REAL ERROR — show popup
        if (!result.success) {
            throw new Error(result.error || "Unknown server error");
        }

        // CASE: Stage already completed
        if (result.stage === 2) {
            status.innerHTML = "Client documents already generated";
            renderLetters(result.letters);
            return;
        }

        // CASE: Stage 2 executed successfully
        status.innerHTML = "Documents generated successfully";
        renderLetters(result.letters);

    } catch (err) {
        status.innerHTML = `❌ Error: ${err.message}`;
    }
}

✅ You also need this helper function
Add this under your script so the letters load cleanly in the UI:
function renderLetters(letters) {
    const list = document.getElementById('letters-list');
    list.innerHTML = ""; // clear old data

    if (!letters || letters.length === 0) {
        list.innerHTML = "<p>No letters found.</p>";
        return;
    }

    letters.forEach(letter => {
        const item = document.createElement('li');
        item.innerHTML = `
            <strong>${letter.bureau}</strong>
            – Round ${letter.round}
            <br>
            <a href="${letter.filepath}" target="_blank">Download PDF</a>
        `;
        list.appendChild(item);
    });
}

✅ And your HTML needs one placeholder
Somewhere in the analysis page (Stage 1 review page), add:
<div id="status-box" style="margin-top:20px; font-weight:600;"></div>

<ul id="letters-list" style="margin-top:20px;"></ul>



