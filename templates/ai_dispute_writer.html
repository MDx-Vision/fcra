{% extends "includes/dashboard_base.html" %}

{% block title %}AI Dispute Writer{% endblock %}

{% block head %}
<style>
    .writer-container {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 1.5rem;
        min-height: calc(100vh - 120px);
    }

    .sidebar-panel {
        background: var(--bg-primary, #fff);
        border-radius: 12px;
        border: 1px solid var(--border-color, #e5e7eb);
        padding: 1.5rem;
        height: fit-content;
        position: sticky;
        top: 1rem;
    }

    .main-panel {
        background: var(--bg-primary, #fff);
        border-radius: 12px;
        border: 1px solid var(--border-color, #e5e7eb);
        padding: 1.5rem;
    }

    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary, #1f2937);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title svg {
        width: 18px;
        height: 18px;
        stroke: #22c55e;
    }

    .client-search {
        position: relative;
        margin-bottom: 1rem;
    }

    .client-search input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: 8px;
        font-size: 0.875rem;
        background: var(--bg-secondary, #f9fafb);
    }

    .client-search svg {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        stroke: var(--text-secondary, #6b7280);
    }

    .client-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .client-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color, #e5e7eb);
        transition: background 0.2s;
    }

    .client-item:last-child {
        border-bottom: none;
    }

    .client-item:hover {
        background: var(--bg-secondary, #f9fafb);
    }

    .client-item.selected {
        background: rgba(34, 197, 94, 0.1);
        border-left: 3px solid #22c55e;
    }

    .client-name {
        font-weight: 600;
        color: var(--text-primary, #1f2937);
    }

    .client-info {
        font-size: 0.75rem;
        color: var(--text-secondary, #6b7280);
    }

    .round-selector {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .round-btn {
        padding: 0.75rem;
        border: 2px solid var(--border-color, #e5e7eb);
        border-radius: 8px;
        background: var(--bg-secondary, #f9fafb);
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
    }

    .round-btn:hover {
        border-color: #22c55e;
    }

    .round-btn.active {
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.1);
    }

    .round-number {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary, #1f2937);
    }

    .round-name {
        font-size: 0.625rem;
        color: var(--text-secondary, #6b7280);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .tone-selector {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .tone-btn {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: 6px;
        background: var(--bg-secondary, #f9fafb);
        cursor: pointer;
        font-size: 0.75rem;
        transition: all 0.2s;
    }

    .tone-btn:hover {
        border-color: #22c55e;
    }

    .tone-btn.active {
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.1);
        font-weight: 600;
    }

    .generate-btn {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .generate-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .generate-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .generate-btn svg {
        width: 20px;
        height: 20px;
    }

    .items-panel {
        margin-bottom: 1rem;
    }

    .items-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .items-count {
        font-size: 0.75rem;
        color: var(--text-secondary, #6b7280);
    }

    .select-all-btn {
        font-size: 0.75rem;
        color: #22c55e;
        cursor: pointer;
        background: none;
        border: none;
    }

    .item-checkbox {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 6px;
        margin-bottom: 0.25rem;
        cursor: pointer;
    }

    .item-checkbox:hover {
        background: var(--bg-secondary, #f9fafb);
    }

    .item-checkbox input {
        margin-top: 0.25rem;
    }

    .item-details {
        flex: 1;
    }

    .item-creditor {
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--text-primary, #1f2937);
    }

    .item-meta {
        font-size: 0.75rem;
        color: var(--text-secondary, #6b7280);
    }

    .letters-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .letter-tabs {
        display: flex;
        gap: 0.5rem;
        border-bottom: 1px solid var(--border-color, #e5e7eb);
        padding-bottom: 0.5rem;
    }

    .letter-tab {
        padding: 0.5rem 1rem;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 0.875rem;
        color: var(--text-secondary, #6b7280);
        border-radius: 6px;
        transition: all 0.2s;
    }

    .letter-tab:hover {
        background: var(--bg-secondary, #f9fafb);
    }

    .letter-tab.active {
        background: rgba(34, 197, 94, 0.1);
        color: #16a34a;
        font-weight: 600;
    }

    .letter-content {
        background: var(--bg-secondary, #f9fafb);
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: 8px;
        padding: 1.5rem;
        min-height: 400px;
        max-height: 600px;
        overflow-y: auto;
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        line-height: 1.6;
    }

    .letter-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }

    .action-btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .action-btn svg {
        width: 16px;
        height: 16px;
    }

    .btn-save {
        background: #22c55e;
        color: white;
        border: none;
    }

    .btn-save:hover {
        background: #16a34a;
    }

    .btn-copy {
        background: var(--bg-secondary, #f3f4f6);
        color: var(--text-primary, #1f2937);
        border: 1px solid var(--border-color, #e5e7eb);
    }

    .btn-copy:hover {
        background: var(--bg-tertiary, #e5e7eb);
    }

    .btn-regenerate {
        background: #3b82f6;
        color: white;
        border: none;
    }

    .btn-regenerate:hover {
        background: #2563eb;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary, #6b7280);
    }

    .empty-state svg {
        width: 64px;
        height: 64px;
        stroke: #d1d5db;
        margin-bottom: 1rem;
    }

    .suggestion-banner {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .suggestion-banner svg {
        width: 24px;
        height: 24px;
        stroke: #3b82f6;
        flex-shrink: 0;
    }

    .suggestion-text {
        font-size: 0.875rem;
        color: #1e40af;
    }

    .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .loading-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        text-align: center;
    }

    .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid #e5e7eb;
        border-top-color: #22c55e;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .custom-instructions {
        margin-bottom: 1rem;
    }

    .custom-instructions textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: 8px;
        font-size: 0.875rem;
        resize: vertical;
        min-height: 60px;
    }

    .bureau-checkboxes {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .bureau-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    @media (max-width: 1024px) {
        .writer-container {
            grid-template-columns: 1fr;
        }

        .sidebar-panel {
            position: static;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content" style="padding: 1.5rem;">
    <!-- Page Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div>
            <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary, #1f2937);">
                AI Dispute Writer
            </h1>
            <p style="color: var(--text-secondary, #6b7280); font-size: 0.875rem;">
                Generate customized FCRA dispute letters using AI
            </p>
        </div>
    </div>

    <div class="writer-container">
        <!-- Left Sidebar -->
        <div class="sidebar-panel">
            <!-- Client Selection -->
            <div class="section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                </svg>
                Select Client
            </div>

            <div class="client-search">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" id="clientSearch" placeholder="Search clients..." oninput="filterClients()">
            </div>

            <div class="client-list" id="clientList">
                <div class="empty-state" style="padding: 1rem;">Loading clients...</div>
            </div>

            <!-- Suggestion Banner -->
            <div class="suggestion-banner" id="suggestionBanner" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <span class="suggestion-text" id="suggestionText"></span>
            </div>

            <!-- Round Selection -->
            <div class="section-title" style="margin-top: 1.5rem;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                Select Round
            </div>

            <div class="round-selector" id="roundSelector">
                <div class="round-btn active" data-round="1" onclick="selectRound(1)">
                    <div class="round-number">R1</div>
                    <div class="round-name">Initial</div>
                </div>
                <div class="round-btn" data-round="2" onclick="selectRound(2)">
                    <div class="round-number">R2</div>
                    <div class="round-name">MOV</div>
                </div>
                <div class="round-btn" data-round="3" onclick="selectRound(3)">
                    <div class="round-number">R3</div>
                    <div class="round-name">Regulatory</div>
                </div>
                <div class="round-btn" data-round="4" onclick="selectRound(4)">
                    <div class="round-number">R4</div>
                    <div class="round-name">Pre-Lit</div>
                </div>
            </div>

            <!-- Tone Selection -->
            <div class="section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                Tone
            </div>

            <div class="tone-selector">
                <button class="tone-btn active" data-tone="professional" onclick="selectTone('professional')">Professional</button>
                <button class="tone-btn" data-tone="aggressive" onclick="selectTone('aggressive')">Aggressive</button>
                <button class="tone-btn" data-tone="formal" onclick="selectTone('formal')">Formal</button>
            </div>

            <!-- Bureaus -->
            <div class="section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <line x1="9" y1="9" x2="15" y2="9"/>
                    <line x1="9" y1="15" x2="15" y2="15"/>
                </svg>
                Bureaus
            </div>

            <div class="bureau-checkboxes">
                <label class="bureau-checkbox">
                    <input type="checkbox" id="bureauEquifax" checked> Equifax
                </label>
                <label class="bureau-checkbox">
                    <input type="checkbox" id="bureauExperian" checked> Experian
                </label>
                <label class="bureau-checkbox">
                    <input type="checkbox" id="bureauTransunion" checked> TransUnion
                </label>
            </div>

            <!-- Custom Instructions -->
            <div class="custom-instructions">
                <div class="section-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                    Custom Instructions (Optional)
                </div>
                <textarea id="customInstructions" placeholder="Add any specific instructions for the AI..."></textarea>
            </div>

            <!-- Generate Button -->
            <button class="generate-btn" id="generateBtn" onclick="generateLetters()" disabled>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
                Generate Letters
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-panel">
            <!-- Items to Dispute -->
            <div class="items-panel" id="itemsPanel" style="display: none;">
                <div class="items-header">
                    <div class="section-title" style="margin-bottom: 0;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11l3 3L22 4"/>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                        </svg>
                        Select Items to Dispute
                    </div>
                    <div>
                        <span class="items-count" id="itemsCount">0 items</span>
                        <button class="select-all-btn" onclick="toggleAllItems()">Select All</button>
                    </div>
                </div>
                <div id="itemsList" style="max-height: 200px; overflow-y: auto; margin-top: 0.5rem;"></div>
            </div>

            <!-- Generated Letters -->
            <div class="letters-container" id="lettersContainer">
                <div class="empty-state" id="emptyState">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    <p>Select a client and click "Generate Letters" to create AI-powered dispute letters</p>
                </div>

                <div id="letterOutput" style="display: none;">
                    <div class="letter-tabs" id="letterTabs"></div>
                    <div class="letter-content" id="letterContent"></div>
                    <div class="letter-actions">
                        <button class="action-btn btn-copy" onclick="copyLetter()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                            Copy
                        </button>
                        <button class="action-btn btn-regenerate" onclick="showRegenerateModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"/>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                            </svg>
                            Regenerate with Feedback
                        </button>
                        <button class="action-btn btn-save" onclick="saveLetter()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                <polyline points="17 21 17 13 7 13 7 21"/>
                                <polyline points="7 3 7 8 15 8"/>
                            </svg>
                            Save Letter
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-content">
        <div class="spinner"></div>
        <p>Generating dispute letters...</p>
        <p style="font-size: 0.875rem; color: #6b7280;">This may take 15-30 seconds</p>
    </div>
</div>

<!-- Regenerate Modal -->
<div class="loading-overlay" id="regenerateModal" style="display: none;">
    <div class="loading-content" style="max-width: 500px; text-align: left;">
        <h3 style="margin-bottom: 1rem;">Regenerate with Feedback</h3>
        <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">
            Provide feedback to improve the letter. The AI will regenerate it incorporating your suggestions.
        </p>
        <textarea id="regenerateFeedback" style="width: 100%; min-height: 100px; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;" placeholder="E.g., Make it more aggressive, add specific case citations, emphasize the balance discrepancy..."></textarea>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button class="action-btn btn-copy" onclick="closeRegenerateModal()">Cancel</button>
            <button class="action-btn btn-regenerate" onclick="regenerateWithFeedback()">Regenerate</button>
        </div>
    </div>
</div>

<script>
    let allClients = [];
    let selectedClient = null;
    let selectedRound = 1;
    let selectedTone = 'professional';
    let disputeItems = [];
    let generatedLetters = {};
    let currentBureau = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadClients();
    });

    async function loadClients() {
        try {
            const response = await fetch('/api/ai-dispute-writer/dashboard');
            const data = await response.json();

            if (data.success && data.active_clients) {
                allClients = data.active_clients;
                renderClientList(allClients);
            }
        } catch (error) {
            console.error('Error loading clients:', error);
        }
    }

    function renderClientList(clients) {
        const container = document.getElementById('clientList');

        if (!clients || clients.length === 0) {
            container.innerHTML = '<div class="empty-state" style="padding: 1rem;">No active clients found</div>';
            return;
        }

        container.innerHTML = clients.map(c => `
            <div class="client-item ${selectedClient?.id === c.id ? 'selected' : ''}"
                 onclick="selectClient(${c.id}, '${c.name}', ${c.current_round})">
                <div class="client-name">${c.name}</div>
                <div class="client-info">Round ${c.current_round} | ${c.dispute_status || 'N/A'}</div>
            </div>
        `).join('');
    }

    function filterClients() {
        const search = document.getElementById('clientSearch').value.toLowerCase();
        const filtered = allClients.filter(c =>
            c.name.toLowerCase().includes(search)
        );
        renderClientList(filtered);
    }

    async function selectClient(id, name, currentRound) {
        selectedClient = { id, name, currentRound };

        // Update UI
        document.querySelectorAll('.client-item').forEach(el => el.classList.remove('selected'));
        event.currentTarget.classList.add('selected');

        // Enable generate button
        document.getElementById('generateBtn').disabled = false;

        // Load client details
        try {
            const response = await fetch(`/api/ai-dispute-writer/dashboard?client_id=${id}`);
            const data = await response.json();

            if (data.success) {
                // Show dispute items
                disputeItems = data.dispute_items || [];
                renderDisputeItems();

                // Show suggestion
                if (data.suggestion) {
                    showSuggestion(data.suggestion);
                }

                // Set recommended round
                if (data.suggestion?.next_round) {
                    selectRound(data.suggestion.next_round);
                }
            }
        } catch (error) {
            console.error('Error loading client:', error);
        }
    }

    function renderDisputeItems() {
        const container = document.getElementById('itemsList');
        const panel = document.getElementById('itemsPanel');

        if (!disputeItems || disputeItems.length === 0) {
            panel.style.display = 'none';
            return;
        }

        panel.style.display = 'block';
        document.getElementById('itemsCount').textContent = `${disputeItems.length} items`;

        container.innerHTML = disputeItems.map(item => `
            <label class="item-checkbox">
                <input type="checkbox" value="${item.id}" checked>
                <div class="item-details">
                    <div class="item-creditor">${item.creditor || 'Unknown Creditor'}</div>
                    <div class="item-meta">${item.bureau} | ${item.type || 'N/A'} | ${item.status || 'N/A'}</div>
                </div>
            </label>
        `).join('');
    }

    function toggleAllItems() {
        const checkboxes = document.querySelectorAll('#itemsList input[type="checkbox"]');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
    }

    function showSuggestion(suggestion) {
        const banner = document.getElementById('suggestionBanner');
        const text = document.getElementById('suggestionText');

        text.textContent = suggestion.message;
        banner.style.display = 'flex';
    }

    function selectRound(round) {
        selectedRound = round;
        document.querySelectorAll('.round-btn').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.dataset.round) === round);
        });
    }

    function selectTone(tone) {
        selectedTone = tone;
        document.querySelectorAll('.tone-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tone === tone);
        });
    }

    function getSelectedBureaus() {
        const bureaus = [];
        if (document.getElementById('bureauEquifax').checked) bureaus.push('Equifax');
        if (document.getElementById('bureauExperian').checked) bureaus.push('Experian');
        if (document.getElementById('bureauTransunion').checked) bureaus.push('TransUnion');
        return bureaus;
    }

    function getSelectedItems() {
        const checkboxes = document.querySelectorAll('#itemsList input[type="checkbox"]:checked');
        return Array.from(checkboxes).map(cb => parseInt(cb.value));
    }

    async function generateLetters() {
        if (!selectedClient) {
            alert('Please select a client first');
            return;
        }

        const bureaus = getSelectedBureaus();
        if (bureaus.length === 0) {
            alert('Please select at least one bureau');
            return;
        }

        const selectedItems = getSelectedItems();
        const customInstructions = document.getElementById('customInstructions').value;

        // Show loading
        document.getElementById('loadingOverlay').style.display = 'flex';

        try {
            const response = await fetch('/api/ai-dispute-writer/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    client_id: selectedClient.id,
                    round: selectedRound,
                    selected_items: selectedItems.length > 0 ? selectedItems : null,
                    bureaus: bureaus,
                    custom_instructions: customInstructions || null,
                    tone: selectedTone,
                }),
            });

            const data = await response.json();

            if (data.success && data.letters) {
                generatedLetters = data.letters;
                renderLetters();
            } else {
                alert(data.error || 'Failed to generate letters');
            }
        } catch (error) {
            console.error('Error generating letters:', error);
            alert('Error generating letters. Please try again.');
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }

    function renderLetters() {
        const bureaus = Object.keys(generatedLetters);

        if (bureaus.length === 0) {
            return;
        }

        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('letterOutput').style.display = 'block';

        // Render tabs
        const tabsContainer = document.getElementById('letterTabs');
        tabsContainer.innerHTML = bureaus.map((bureau, i) => `
            <button class="letter-tab ${i === 0 ? 'active' : ''}"
                    data-bureau="${bureau}"
                    onclick="showLetter('${bureau}')">
                ${bureau}
            </button>
        `).join('');

        // Show first letter
        currentBureau = bureaus[0];
        showLetter(bureaus[0]);
    }

    function showLetter(bureau) {
        currentBureau = bureau;

        // Update tabs
        document.querySelectorAll('.letter-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.bureau === bureau);
        });

        // Show content
        document.getElementById('letterContent').textContent = generatedLetters[bureau] || 'No content';
    }

    function copyLetter() {
        const content = generatedLetters[currentBureau];
        if (content) {
            navigator.clipboard.writeText(content).then(() => {
                alert('Letter copied to clipboard');
            });
        }
    }

    async function saveLetter() {
        if (!selectedClient || !currentBureau || !generatedLetters[currentBureau]) {
            alert('No letter to save');
            return;
        }

        try {
            const response = await fetch('/api/ai-dispute-writer/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    client_id: selectedClient.id,
                    bureau: currentBureau,
                    content: generatedLetters[currentBureau],
                    round: selectedRound,
                }),
            });

            const data = await response.json();

            if (data.success) {
                alert('Letter saved successfully');
            } else {
                alert(data.error || 'Failed to save letter');
            }
        } catch (error) {
            console.error('Error saving letter:', error);
            alert('Error saving letter');
        }
    }

    function showRegenerateModal() {
        document.getElementById('regenerateModal').style.display = 'flex';
        document.getElementById('regenerateFeedback').value = '';
    }

    function closeRegenerateModal() {
        document.getElementById('regenerateModal').style.display = 'none';
    }

    async function regenerateWithFeedback() {
        const feedback = document.getElementById('regenerateFeedback').value;

        if (!feedback) {
            alert('Please provide feedback');
            return;
        }

        closeRegenerateModal();
        document.getElementById('loadingOverlay').style.display = 'flex';

        try {
            const response = await fetch('/api/ai-dispute-writer/regenerate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    client_id: selectedClient.id,
                    bureau: currentBureau,
                    original_letter: generatedLetters[currentBureau],
                    feedback: feedback,
                    round: selectedRound,
                }),
            });

            const data = await response.json();

            if (data.success && data.letter) {
                generatedLetters[currentBureau] = data.letter;
                showLetter(currentBureau);
            } else {
                alert(data.error || 'Failed to regenerate letter');
            }
        } catch (error) {
            console.error('Error regenerating letter:', error);
            alert('Error regenerating letter');
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }
</script>
{% endblock %}
