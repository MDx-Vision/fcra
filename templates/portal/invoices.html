{% extends "portal/base_portal.html" %}

{% block title %}Invoices - Client Portal{% endblock %}

{% block portal_content %}
<div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Invoices</h1>
            <p class="text-muted mb-0">View and download your invoices</p>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="bi bi-receipt text-primary fs-4"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Total Invoiced</div>
                            <div class="h4 mb-0" id="totalInvoiced">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="bi bi-check-circle text-success fs-4"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Total Paid</div>
                            <div class="h4 mb-0" id="totalPaid">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="bi bi-clock text-warning fs-4"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Amount Due</div>
                            <div class="h4 mb-0" id="amountDue">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice List -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="border-0 ps-4">Invoice #</th>
                            <th class="border-0">Date</th>
                            <th class="border-0">Due Date</th>
                            <th class="border-0">Total</th>
                            <th class="border-0">Status</th>
                            <th class="border-0 pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTableBody">
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="text-muted mt-2 mb-0">Loading invoices...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Detail Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Invoice Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoiceModalContent">
                <!-- Invoice details loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btnDownloadPdf">
                    <i class="bi bi-download me-2"></i>Download PDF
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.status-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}
.status-draft { background: #e5e7eb; color: #374151; }
.status-sent { background: #dbeafe; color: #1d4ed8; }
.status-viewed { background: #ede9fe; color: #7c3aed; }
.status-paid { background: #dcfce7; color: #16a34a; }
.status-partial { background: #fef3c7; color: #d97706; }
.status-overdue { background: #fee2e2; color: #dc2626; }
.status-cancelled { background: #e5e7eb; color: #6b7280; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadInvoices();
});

function formatCurrency(cents) {
    return '$' + (cents / 100).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function loadInvoices() {
    fetch('/portal/api/invoices')
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById('invoicesTableBody');

            if (!data.success || !data.invoices || data.invoices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            <i class="bi bi-receipt fs-1 d-block mb-3 opacity-50"></i>
                            No invoices found
                        </td>
                    </tr>
                `;
                return;
            }

            // Calculate totals
            let totalInvoiced = 0;
            let totalPaid = 0;
            let totalDue = 0;

            data.invoices.forEach(inv => {
                totalInvoiced += inv.total;
                totalPaid += inv.amount_paid;
                totalDue += inv.amount_due;
            });

            document.getElementById('totalInvoiced').textContent = formatCurrency(totalInvoiced);
            document.getElementById('totalPaid').textContent = formatCurrency(totalPaid);
            document.getElementById('amountDue').textContent = formatCurrency(totalDue);

            tbody.innerHTML = data.invoices.map(inv => `
                <tr>
                    <td class="ps-4">
                        <a href="#" onclick="viewInvoice(${inv.id}); return false;" class="fw-medium text-decoration-none">
                            ${inv.invoice_number}
                        </a>
                    </td>
                    <td>${inv.invoice_date || '-'}</td>
                    <td>${inv.due_date || '-'}</td>
                    <td>${formatCurrency(inv.total)}</td>
                    <td>
                        <span class="status-badge status-${inv.status}">${inv.status_display || inv.status}</span>
                    </td>
                    <td class="pe-4">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewInvoice(${inv.id})">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="downloadPdf(${inv.id})">
                            <i class="bi bi-download"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        });
}

function viewInvoice(id) {
    fetch(`/portal/api/invoices/${id}`)
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                alert('Error: ' + data.error);
                return;
            }

            const inv = data.invoice;

            document.getElementById('invoiceModalContent').innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-1">Invoice Number</h6>
                        <h4>${inv.invoice_number}</h4>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <span class="status-badge status-${inv.status} fs-6">${inv.status_display || inv.status}</span>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">From</h6>
                        <p class="mb-0"><strong>${inv.company_name || 'Brightpath Ascend Group'}</strong></p>
                    </div>
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-6">
                                <h6 class="text-muted mb-2">Invoice Date</h6>
                                <p>${inv.invoice_date || '-'}</p>
                            </div>
                            <div class="col-6">
                                <h6 class="text-muted mb-2">Due Date</h6>
                                <p>${inv.due_date || '-'}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th class="text-end">Qty</th>
                            <th class="text-end">Price</th>
                            <th class="text-end">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(inv.items || []).map(item => `
                            <tr>
                                <td>${item.description}</td>
                                <td class="text-end">${item.quantity}</td>
                                <td class="text-end">${formatCurrency(item.unit_price)}</td>
                                <td class="text-end">${formatCurrency(item.amount)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <div class="row">
                    <div class="col-md-6 offset-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td>Subtotal</td>
                                <td class="text-end">${formatCurrency(inv.subtotal)}</td>
                            </tr>
                            ${inv.tax_amount ? `
                            <tr>
                                <td>Tax</td>
                                <td class="text-end">${formatCurrency(inv.tax_amount)}</td>
                            </tr>
                            ` : ''}
                            <tr class="border-top">
                                <td><strong>Total</strong></td>
                                <td class="text-end"><strong>${formatCurrency(inv.total)}</strong></td>
                            </tr>
                            ${inv.amount_paid > 0 ? `
                            <tr class="text-success">
                                <td>Paid</td>
                                <td class="text-end">${formatCurrency(inv.amount_paid)}</td>
                            </tr>
                            ` : ''}
                            ${inv.amount_due > 0 ? `
                            <tr class="border-top">
                                <td><strong>Amount Due</strong></td>
                                <td class="text-end"><strong>${formatCurrency(inv.amount_due)}</strong></td>
                            </tr>
                            ` : ''}
                        </table>
                    </div>
                </div>

                ${inv.notes ? `
                <div class="mt-4 p-3 bg-light rounded">
                    <h6 class="text-muted mb-2">Notes</h6>
                    <p class="mb-0">${inv.notes}</p>
                </div>
                ` : ''}
            `;

            document.getElementById('btnDownloadPdf').onclick = () => downloadPdf(id);

            new bootstrap.Modal(document.getElementById('invoiceModal')).show();
        });
}

function downloadPdf(id) {
    window.open(`/portal/api/invoices/${id}/pdf`, '_blank');
}
</script>
{% endblock %}
