{% extends "portal/base_portal.html" %}
{% set active_tab = 'profile' %}
{% block title %}Profile{% endblock %}
{% block content %}

<!-- Profile Header -->
<div class="card animate-fade-in" style="background: linear-gradient(135deg, #0a2540 0%, #1e3a5f 100%); color: white; padding: 32px; margin-bottom: 24px; border: none;" data-testid="profile-header">
    <div style="display: flex; align-items: center; gap: 24px; flex-wrap: wrap;">
        <div style="width: 88px; height: 88px; border-radius: 50%; background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 3px solid rgba(255,255,255,0.2);">
            <span style="font-size: 36px; font-weight: 700; color: white;">{{ (current_user.first_name or 'C')[0] }}</span>
        </div>
        <div style="flex: 1; min-width: 200px;">
            <h2 style="font-family: 'Playfair Display', serif; font-size: 28px; font-weight: 600; margin: 0 0 4px 0;">{{ current_user.first_name }} {{ current_user.last_name }}</h2>
            <p style="font-size: 14px; color: #9ca3af; margin: 0 0 12px 0;">Client since {{ client.created_at.strftime('%B %Y') if client and client.created_at else 'N/A' }}</p>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(13, 148, 136, 0.2); border-radius: 6px; font-size: 13px; font-weight: 600; color: #14b8a6;">ğŸ›¡ï¸ Round {{ client.current_round|default(1) if client else 1 }}</span>
                <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 13px; font-weight: 500; color: white;">âœ… Portal Active</span>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;" class="stats-grid-responsive" data-testid="quick-actions">
    <a href="{{ url_for('portal.documents') }}" class="card animate-fade-in-up" data-delay="100" style="text-align: center; padding: 24px; text-decoration: none; cursor: pointer;">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸ“¤</div>
        <div style="font-size: 15px; font-weight: 600; color: #1e3a5f;">Upload Document</div>
    </a>
    <a href="{{ url_for('portal.dashboard') }}" class="card animate-fade-in-up" data-delay="200" style="text-align: center; padding: 24px; text-decoration: none; cursor: pointer;">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸ“Š</div>
        <div style="font-size: 15px; font-weight: 600; color: #1e3a5f;">View Case</div>
    </a>
    <a href="{{ url_for('portal.learn') }}" class="card animate-fade-in-up" data-delay="300" style="text-align: center; padding: 24px; text-decoration: none; cursor: pointer;">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸ“–</div>
        <div style="font-size: 15px; font-weight: 600; color: #1e3a5f;">Learn FCRA</div>
    </a>
</div>

<!-- Personal Info -->
<div class="card animate-fade-in-up" data-delay="400" style="margin-bottom: 24px;" data-testid="personal-info">
    <div class="card-title">ğŸ‘¤ Personal Information</div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;" class="two-col-responsive">
        <div>
            <label style="display: block; font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Full Name</label>
            <input type="text" value="{{ current_user.first_name }} {{ current_user.last_name }}" disabled style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 15px; background: #f9fafb; color: #1e3a5f;">
        </div>
        <div>
            <label style="display: block; font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Email</label>
            <input type="email" value="{{ current_user.email }}" disabled style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 15px; background: #f9fafb; color: #1e3a5f;">
        </div>
        <div>
            <label style="display: block; font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Phone</label>
            <input type="tel" value="{{ client.phone|default('') if client else '' }}" disabled style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 15px; background: #f9fafb; color: #1e3a5f;">
        </div>
        <div>
            <label style="display: block; font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Current Round</label>
            <input type="text" value="Round {{ client.current_round|default(1) if client else 1 }}" disabled style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 15px; background: #f9fafb; color: #1e3a5f;">
        </div>
    </div>
    <p style="font-size: 13px; color: #9ca3af; margin: 20px 0 0 0;">Need to update your contact information? Contact us and we'll help.</p>
</div>

<!-- Detailed Status Link -->
<div class="card animate-fade-in-up" data-delay="500" style="margin-bottom: 24px; background: #f9fafb; border: 1px solid #e5e7eb;" data-testid="status-link">
    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
        <div>
            <h4 style="font-size: 16px; font-weight: 600; color: #1e3a5f; margin: 0 0 4px 0;">ğŸ“‹ Detailed Bureau Status</h4>
            <p style="font-size: 14px; color: #6b7280; margin: 0;">View and update individual account statuses across all bureaus.</p>
        </div>
        <a href="{{ url_for('portal.status') }}" style="display: inline-flex; align-items: center; gap: 6px; padding: 12px 20px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-weight: 600; color: #1e3a5f; cursor: pointer; text-decoration: none;">
            View Status â†’
        </a>
    </div>
</div>

<!-- Contact -->
<div class="card animate-fade-in-up" data-delay="600" style="margin-bottom: 24px;" data-testid="contact-section">
    <div class="card-title">ğŸ“ Get in Touch</div>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;" class="stats-grid-responsive">
        <a href="tel:9179094051" style="display: flex; flex-direction: column; align-items: center; padding: 24px; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb; text-decoration: none; transition: all 0.2s ease;">
            <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%); display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
                <span style="font-size: 20px;">ğŸ“</span>
            </div>
            <div style="font-size: 14px; font-weight: 600; color: #1e3a5f; margin-bottom: 4px;">Phone</div>
            <div style="font-size: 15px; font-weight: 500; color: #0d9488;">(917) 909-4051</div>
        </a>
        <a href="mailto:support@brightpathascend.com" style="display: flex; flex-direction: column; align-items: center; padding: 24px; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb; text-decoration: none; transition: all 0.2s ease;">
            <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%); display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
                <span style="font-size: 20px;">ğŸ“§</span>
            </div>
            <div style="font-size: 14px; font-weight: 600; color: #1e3a5f; margin-bottom: 4px;">Email</div>
            <div style="font-size: 14px; font-weight: 500; color: #0d9488; word-break: break-all;">support@brightpath...</div>
        </a>
        <a href="https://brightpathascendgroup.com" target="_blank" style="display: flex; flex-direction: column; align-items: center; padding: 24px; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb; text-decoration: none; transition: all 0.2s ease;">
            <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%); display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
                <span style="font-size: 20px;">ğŸŒ</span>
            </div>
            <div style="font-size: 14px; font-weight: 600; color: #1e3a5f; margin-bottom: 4px;">Website</div>
            <div style="font-size: 14px; font-weight: 500; color: #0d9488;">brightpathascend...</div>
        </a>
    </div>

    <!-- Message Form -->
    <div style="background: #f9fafb; border-radius: 12px; padding: 24px;">
        <h4 style="font-size: 16px; font-weight: 600; color: #1e3a5f; margin: 0 0 16px 0;">Send Us a Message</h4>
        <form action="{{ url_for('portal.send_message') }}" method="POST" data-testid="contact-form">
                        <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Subject</label>
                <select name="subject" style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white;">
                    <option>General Question</option>
                    <option>Update My Information</option>
                    <option>Document Help</option>
                    <option>Technical Issue</option>
                    <option>Other</option>
                </select>
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Message</label>
                <textarea name="message" style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; resize: vertical; min-height: 100px;" placeholder="How can we help?"></textarea>
            </div>
            <button type="submit" class="submit-btn" style="width: 100%;">Send Message</button>
        </form>
    </div>
</div>

<!-- WhatsApp Notifications -->
<div class="card animate-fade-in-up" data-delay="650" style="margin-bottom: 24px;" data-testid="whatsapp-section">
    <div class="card-title">ğŸ’¬ WhatsApp Notifications</div>
    <p style="font-size: 14px; color: #6b7280; margin: 0 0 20px 0;">
        Get case updates and send documents via WhatsApp for faster communication.
    </p>

    <div id="whatsapp-status" style="margin-bottom: 20px;">
        <!-- Status will be loaded dynamically -->
        <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #f9fafb; border-radius: 8px;">
            <div style="width: 10px; height: 10px; border-radius: 50%; background: #9ca3af;" id="whatsapp-status-indicator"></div>
            <span style="font-size: 14px; color: #6b7280;" id="whatsapp-status-text">Loading...</span>
        </div>
    </div>

    <!-- WhatsApp Number Input -->
    <div id="whatsapp-setup" style="display: none;">
        <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">WhatsApp Number</label>
            <div style="display: flex; gap: 12px;">
                <input type="tel" id="whatsapp-number" placeholder="+1 (555) 123-4567"
                       value="{{ client.phone|default('') if client else '' }}"
                       style="flex: 1; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 15px;">
                <button type="button" id="send-verification-btn" onclick="requestWhatsAppVerification()"
                        style="padding: 12px 20px; background: #25D366; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                    Send Code
                </button>
            </div>
            <p style="font-size: 12px; color: #9ca3af; margin: 8px 0 0 0;">
                We'll send a verification code to this number via WhatsApp.
            </p>
        </div>
    </div>

    <!-- Verification Code Input -->
    <div id="whatsapp-verify" style="display: none;">
        <div style="padding: 16px; background: #fef3c7; border-radius: 8px; margin-bottom: 16px;">
            <p style="font-size: 14px; color: #92400e; margin: 0;">
                <strong>Verification code sent!</strong> Check your WhatsApp for a 6-digit code.
            </p>
        </div>
        <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Enter Verification Code</label>
            <div style="display: flex; gap: 12px;">
                <input type="text" id="verification-code" placeholder="123456" maxlength="6"
                       style="flex: 1; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 18px; letter-spacing: 4px; text-align: center;">
                <button type="button" id="verify-btn" onclick="verifyWhatsApp()"
                        style="padding: 12px 20px; background: #0d9488; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    Verify
                </button>
            </div>
        </div>
        <button type="button" onclick="showWhatsAppSetup()" style="padding: 8px 16px; background: transparent; color: #6b7280; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; cursor: pointer;">
            â† Change Number
        </button>
    </div>

    <!-- Verified State -->
    <div id="whatsapp-verified" style="display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: rgba(13, 148, 136, 0.1); border-radius: 8px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: #25D366; display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-size: 20px;">âœ“</span>
                </div>
                <div>
                    <div style="font-size: 14px; font-weight: 600; color: #0d9488;">WhatsApp Verified</div>
                    <div style="font-size: 13px; color: #6b7280;" id="verified-number"></div>
                </div>
            </div>
            <button type="button" onclick="optOutWhatsApp()" style="padding: 8px 16px; background: transparent; color: #ef4444; border: 1px solid #ef4444; border-radius: 6px; font-size: 13px; cursor: pointer;">
                Disable
            </button>
        </div>
        <p style="font-size: 13px; color: #6b7280; margin: 0;">
            You'll receive case updates and can send us documents via WhatsApp. Send <strong>HELP</strong> anytime for available commands.
        </p>
    </div>
</div>

<script>
// WhatsApp verification functions
function loadWhatsAppStatus() {
    fetch('/api/portal/whatsapp/status')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                updateWhatsAppUI(data);
            }
        })
        .catch(err => {
            document.getElementById('whatsapp-status-text').textContent = 'Unable to load status';
        });
}

function updateWhatsAppUI(data) {
    const statusIndicator = document.getElementById('whatsapp-status-indicator');
    const statusText = document.getElementById('whatsapp-status-text');
    const setupDiv = document.getElementById('whatsapp-setup');
    const verifyDiv = document.getElementById('whatsapp-verify');
    const verifiedDiv = document.getElementById('whatsapp-verified');
    const verifiedNumber = document.getElementById('verified-number');

    if (data.whatsapp_verified && data.whatsapp_opt_in) {
        // Verified and opted in
        statusIndicator.style.background = '#25D366';
        statusText.textContent = 'WhatsApp notifications enabled';
        setupDiv.style.display = 'none';
        verifyDiv.style.display = 'none';
        verifiedDiv.style.display = 'block';
        verifiedNumber.textContent = data.whatsapp_number || '';
    } else {
        // Not verified
        statusIndicator.style.background = '#9ca3af';
        statusText.textContent = 'WhatsApp not enabled';
        setupDiv.style.display = 'block';
        verifyDiv.style.display = 'none';
        verifiedDiv.style.display = 'none';
    }
}

function showWhatsAppSetup() {
    document.getElementById('whatsapp-setup').style.display = 'block';
    document.getElementById('whatsapp-verify').style.display = 'none';
}

function requestWhatsAppVerification() {
    const number = document.getElementById('whatsapp-number').value.trim();
    if (!number) {
        alert('Please enter your WhatsApp number');
        return;
    }

    const btn = document.getElementById('send-verification-btn');
    btn.disabled = true;
    btn.textContent = 'Sending...';

    fetch('/api/portal/whatsapp/request-verification', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({whatsapp_number: number})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('whatsapp-setup').style.display = 'none';
            document.getElementById('whatsapp-verify').style.display = 'block';
        } else {
            alert(data.error || 'Failed to send verification code');
        }
    })
    .catch(err => {
        alert('Error sending verification code');
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Send Code';
    });
}

function verifyWhatsApp() {
    const code = document.getElementById('verification-code').value.trim();
    if (!code || code.length !== 6) {
        alert('Please enter the 6-digit verification code');
        return;
    }

    const btn = document.getElementById('verify-btn');
    btn.disabled = true;
    btn.textContent = 'Verifying...';

    fetch('/api/portal/whatsapp/verify', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({code: code})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadWhatsAppStatus();
        } else {
            alert(data.error || 'Invalid verification code');
        }
    })
    .catch(err => {
        alert('Error verifying code');
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Verify';
    });
}

function optOutWhatsApp() {
    if (!confirm('Are you sure you want to disable WhatsApp notifications?')) {
        return;
    }

    fetch('/api/portal/whatsapp/opt-out', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadWhatsAppStatus();
        } else {
            alert(data.error || 'Failed to opt out');
        }
    })
    .catch(err => {
        alert('Error opting out');
    });
}

// Load status on page load
document.addEventListener('DOMContentLoaded', loadWhatsAppStatus);
</script>

<!-- Referral -->
<div class="card animate-fade-in-up" data-delay="700" style="background: linear-gradient(135deg, #0a2540 0%, #1e3a5f 100%); color: white; margin-bottom: 24px; border: none;" data-testid="referral-section">
    <div style="text-align: center; margin-bottom: 24px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ</div>
        <h3 style="font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 600; margin: 0 0 8px 0;">Know Someone Who Could Use Our Services?</h3>
        <p style="font-size: 15px; color: #9ca3af; margin: 0;">Refer a friend and help them restore their credit too!</p>
    </div>

    <!-- Referral Code -->
    <div style="background: rgba(13, 148, 136, 0.15); border: 1px solid rgba(13, 148, 136, 0.3); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 24px;">
        <div style="font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Your Referral Code</div>
        <div style="font-family: 'DM Sans', monospace; font-size: 32px; font-weight: 700; color: #14b8a6; letter-spacing: 2px;">{{ client.referral_code|default('N/A') if client else 'N/A' }}</div>
    </div>

    <!-- Referral Form -->
    <form action="{{ url_for('portal.submit_referral') }}" method="POST">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;" class="two-col-responsive">
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #9ca3af; margin-bottom: 8px;">Their Name</label>
                <input type="text" name="referral_name" placeholder="John Smith" style="width: 100%; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.05); color: white;">
            </div>
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #9ca3af; margin-bottom: 8px;">Their Phone</label>
                <input type="tel" name="referral_phone" placeholder="(555) 123-4567" style="width: 100%; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.05); color: white;">
            </div>
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #9ca3af; margin-bottom: 8px;">Their Email</label>
                <input type="email" name="referral_email" placeholder="john@example.com" style="width: 100%; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.05); color: white;">
            </div>
            <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #9ca3af; margin-bottom: 8px;">Your Name</label>
                <input type="text" name="your_name" value="{{ current_user.first_name }} {{ current_user.last_name }}" style="width: 100%; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.05); color: white;">
            </div>
            <div style="grid-column: span 2;" class="two-col-responsive">
                <button type="submit" style="width: 100%; padding: 14px 24px; background: #14b8a6; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">Submit Referral</button>
            </div>
        </div>
    </form>
</div>

<!-- Account Status -->
<div class="card animate-fade-in-up" data-delay="800" data-testid="security-section">
    <div class="card-title">ğŸ” Security & Account</div>

    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;" class="stats-grid-responsive">
        <div style="padding: 16px; background: rgba(13, 148, 136, 0.1); border-left: 4px solid #0d9488; border-radius: 8px;">
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Case Status</div>
            <div style="font-size: 15px; font-weight: 600; color: #0d9488;">Active</div>
        </div>
        <div style="padding: 16px; background: rgba(13, 148, 136, 0.1); border-left: 4px solid #0d9488; border-radius: 8px;">
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Client Since</div>
            <div style="font-size: 15px; font-weight: 600; color: #0d9488;">{{ client.created_at.strftime('%B %Y') if client and client.created_at else 'N/A' }}</div>
        </div>
        <div style="padding: 16px; background: rgba(13, 148, 136, 0.1); border-left: 4px solid #0d9488; border-radius: 8px;">
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Portal Access</div>
            <div style="font-size: 15px; font-weight: 600; color: #0d9488;">Active</div>
        </div>
    </div>
</div>

{% endblock %}
