{% extends "portal/base_portal.html" %}
{% set active_tab = 'booking' %}
{% block title %}Book Q&A Call{% endblock %}
{% block content %}

<!-- Hero Section -->
<div class="card animate-fade-in" style="background: linear-gradient(135deg, #0a2540 0%, #1e3a5f 100%); color: white; text-align: center; padding: 48px 24px; margin-bottom: 24px; border: none;" data-testid="booking-hero">
    <p style="font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 3px; color: #14b8a6; margin: 0 0 16px 0;">Questions about your analysis?</p>
    <h2 style="font-family: 'Playfair Display', serif; font-size: 42px; font-weight: 600; margin: 0 0 16px 0;">Book a Q&A Call</h2>
    <p style="font-size: 16px; opacity: 0.8; margin: 0;">Schedule a free 15-minute call to discuss your case</p>
</div>

<!-- My Bookings Section -->
<div class="card animate-fade-in-up" data-delay="100" style="margin-bottom: 24px;" data-testid="my-bookings">
    <div class="card-title">Your Scheduled Calls</div>

    <div id="my-bookings-list">
        <div style="text-align: center; padding: 24px; color: #6b7280;">
            Loading your bookings...
        </div>
    </div>
</div>

<!-- Available Slots Section -->
<div class="card animate-fade-in-up" data-delay="200" data-testid="available-slots">
    <div class="card-title">Available Time Slots</div>
    <p style="color: #6b7280; margin-bottom: 24px;">Select a time that works for you. All calls are 15 minutes.</p>

    <!-- Date Filter -->
    <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;" data-testid="date-filter">
        <button class="date-filter-btn active" data-days="7" style="padding: 8px 16px; border-radius: 8px; border: 1px solid #e5e7eb; background: #0d9488; color: white; cursor: pointer; font-weight: 500;">
            Next 7 Days
        </button>
        <button class="date-filter-btn" data-days="14" style="padding: 8px 16px; border-radius: 8px; border: 1px solid #e5e7eb; background: white; cursor: pointer; font-weight: 500;">
            Next 14 Days
        </button>
        <button class="date-filter-btn" data-days="30" style="padding: 8px 16px; border-radius: 8px; border: 1px solid #e5e7eb; background: white; cursor: pointer; font-weight: 500;">
            Next 30 Days
        </button>
    </div>

    <!-- Slots Grid -->
    <div id="slots-container" data-testid="slots-container">
        <div style="text-align: center; padding: 48px; color: #6b7280;">
            <div style="font-size: 32px; margin-bottom: 12px;">Loading slots...</div>
        </div>
    </div>
</div>

<!-- Booking Confirmation Modal -->
<div id="booking-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;" data-testid="booking-modal">
    <div style="background: white; border-radius: 16px; padding: 32px; max-width: 400px; width: 90%; margin: 24px;">
        <h3 style="font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600; color: #1e3a5f; margin: 0 0 16px 0;">Confirm Booking</h3>
        <div id="modal-slot-details" style="margin-bottom: 24px;">
            <div style="background: #f0fdfa; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                <div style="font-size: 12px; color: #0f766e; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Date & Time</div>
                <div id="modal-datetime" style="font-size: 18px; font-weight: 600; color: #1e3a5f;"></div>
            </div>
            <div style="background: #f3f4f6; border-radius: 12px; padding: 16px;">
                <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Duration</div>
                <div style="font-size: 18px; font-weight: 600; color: #1e3a5f;">15 Minutes</div>
            </div>
        </div>
        <div style="margin-bottom: 24px;">
            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Notes (optional)</label>
            <textarea id="booking-notes" rows="3" placeholder="Any specific questions you'd like to discuss?" style="width: 100%; border: 1px solid #d1d5db; border-radius: 8px; padding: 12px; font-size: 14px; resize: vertical;"></textarea>
        </div>
        <div style="display: flex; gap: 12px;">
            <button onclick="closeBookingModal()" style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; background: white; cursor: pointer; font-weight: 500;">
                Cancel
            </button>
            <button onclick="confirmBooking()" style="flex: 1; padding: 12px; border-radius: 8px; border: none; background: #0d9488; color: white; cursor: pointer; font-weight: 600;">
                Confirm Booking
            </button>
        </div>
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div id="cancel-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;" data-testid="cancel-modal">
    <div style="background: white; border-radius: 16px; padding: 32px; max-width: 400px; width: 90%; margin: 24px;">
        <h3 style="font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600; color: #1e3a5f; margin: 0 0 16px 0;">Cancel Booking?</h3>
        <p style="color: #6b7280; margin-bottom: 24px;">Are you sure you want to cancel this booking? The time slot will become available for others.</p>
        <div id="cancel-booking-details" style="background: #fef2f2; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
            <div id="cancel-datetime" style="font-size: 16px; font-weight: 600; color: #991b1b;"></div>
        </div>
        <div style="display: flex; gap: 12px;">
            <button onclick="closeCancelModal()" style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; background: white; cursor: pointer; font-weight: 500;">
                Keep Booking
            </button>
            <button onclick="confirmCancel()" style="flex: 1; padding: 12px; border-radius: 8px; border: none; background: #dc2626; color: white; cursor: pointer; font-weight: 600;">
                Cancel Booking
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedSlotId = null;
let cancelBookingId = null;

// Load bookings and slots on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMyBookings();
    loadAvailableSlots(7);

    // Date filter buttons
    document.querySelectorAll('.date-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.date-filter-btn').forEach(b => {
                b.classList.remove('active');
                b.style.background = 'white';
                b.style.color = '#374151';
            });
            this.classList.add('active');
            this.style.background = '#0d9488';
            this.style.color = 'white';
            loadAvailableSlots(parseInt(this.dataset.days));
        });
    });
});

function loadMyBookings() {
    fetch('/api/portal/bookings')
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('my-bookings-list');
            if (!data.bookings || data.bookings.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 24px; color: #6b7280;">
                        <div style="font-size: 32px; margin-bottom: 12px;">No upcoming calls scheduled</div>
                        <p>Select a time slot below to book your Q&A call.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.bookings.map(booking => {
                const date = new Date(booking.slot_date + 'T' + booking.slot_time);
                const dateStr = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                const statusColor = booking.status === 'confirmed' ? '#059669' : '#d97706';

                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 12px;" data-testid="booking-item">
                        <div>
                            <div style="font-weight: 600; color: #1e3a5f; margin-bottom: 4px;">${dateStr}</div>
                            <div style="color: #6b7280;">${timeStr} (15 min)</div>
                            ${booking.notes ? `<div style="font-size: 13px; color: #9ca3af; margin-top: 4px;">${booking.notes}</div>` : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="padding: 4px 12px; background: ${statusColor}20; color: ${statusColor}; border-radius: 12px; font-size: 13px; font-weight: 500; text-transform: capitalize;">
                                ${booking.status}
                            </span>
                            <button onclick="openCancelModal(${booking.id}, '${dateStr}', '${timeStr}')" style="padding: 8px 16px; border-radius: 8px; border: 1px solid #fecaca; background: #fef2f2; color: #dc2626; cursor: pointer; font-weight: 500; font-size: 13px;">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        })
        .catch(err => {
            console.error('Error loading bookings:', err);
            document.getElementById('my-bookings-list').innerHTML = `
                <div style="text-align: center; padding: 24px; color: #dc2626;">
                    Error loading bookings. Please refresh the page.
                </div>
            `;
        });
}

function loadAvailableSlots(days) {
    fetch(`/api/portal/booking-slots?days=${days}`)
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('slots-container');
            if (!data.slots || data.slots.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 48px; color: #6b7280;">
                        <div style="font-size: 32px; margin-bottom: 12px;">No available slots</div>
                        <p>Please check back later or contact us directly.</p>
                    </div>
                `;
                return;
            }

            // Group slots by date
            const slotsByDate = {};
            data.slots.forEach(slot => {
                if (!slotsByDate[slot.slot_date]) {
                    slotsByDate[slot.slot_date] = [];
                }
                slotsByDate[slot.slot_date].push(slot);
            });

            container.innerHTML = Object.entries(slotsByDate).map(([date, slots]) => {
                const dateObj = new Date(date + 'T00:00:00');
                const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

                return `
                    <div style="margin-bottom: 24px;" data-testid="date-group">
                        <h4 style="font-size: 16px; font-weight: 600; color: #1e3a5f; margin: 0 0 12px 0;">${dateStr}</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${slots.map(slot => {
                                const time = new Date('1970-01-01T' + slot.slot_time);
                                const timeStr = time.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                                return `
                                    <button onclick="openBookingModal(${slot.id}, '${dateStr}', '${timeStr}')"
                                            style="padding: 10px 20px; border-radius: 8px; border: 1px solid #0d9488; background: white; color: #0d9488; cursor: pointer; font-weight: 500; transition: all 0.2s;"
                                            onmouseover="this.style.background='#0d9488'; this.style.color='white';"
                                            onmouseout="this.style.background='white'; this.style.color='#0d9488';"
                                            data-testid="slot-button">
                                        ${timeStr}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        })
        .catch(err => {
            console.error('Error loading slots:', err);
            document.getElementById('slots-container').innerHTML = `
                <div style="text-align: center; padding: 48px; color: #dc2626;">
                    Error loading slots. Please refresh the page.
                </div>
            `;
        });
}

function openBookingModal(slotId, dateStr, timeStr) {
    selectedSlotId = slotId;
    document.getElementById('modal-datetime').textContent = `${dateStr} at ${timeStr}`;
    document.getElementById('booking-notes').value = '';
    document.getElementById('booking-modal').style.display = 'flex';
}

function closeBookingModal() {
    document.getElementById('booking-modal').style.display = 'none';
    selectedSlotId = null;
}

function confirmBooking() {
    if (!selectedSlotId) return;

    const notes = document.getElementById('booking-notes').value;

    fetch('/api/portal/bookings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            slot_id: selectedSlotId,
            notes: notes,
            booking_type: 'qa_call'
        })
    })
    .then(r => r.json())
    .then(data => {
        closeBookingModal();
        if (data.success) {
            // Show success message
            alert('Booking confirmed! You will receive a confirmation email shortly.');
            // Reload both sections
            loadMyBookings();
            const activeDays = document.querySelector('.date-filter-btn.active').dataset.days;
            loadAvailableSlots(parseInt(activeDays));
        } else {
            alert(data.error || 'Error creating booking. Please try again.');
        }
    })
    .catch(err => {
        console.error('Error booking slot:', err);
        alert('Error creating booking. Please try again.');
    });
}

function openCancelModal(bookingId, dateStr, timeStr) {
    cancelBookingId = bookingId;
    document.getElementById('cancel-datetime').textContent = `${dateStr} at ${timeStr}`;
    document.getElementById('cancel-modal').style.display = 'flex';
}

function closeCancelModal() {
    document.getElementById('cancel-modal').style.display = 'none';
    cancelBookingId = null;
}

function confirmCancel() {
    if (!cancelBookingId) return;

    fetch(`/api/portal/bookings/${cancelBookingId}`, {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(data => {
        closeCancelModal();
        if (data.success) {
            alert('Booking cancelled successfully.');
            loadMyBookings();
            const activeDays = document.querySelector('.date-filter-btn.active').dataset.days;
            loadAvailableSlots(parseInt(activeDays));
        } else {
            alert(data.error || 'Error cancelling booking. Please try again.');
        }
    })
    .catch(err => {
        console.error('Error cancelling booking:', err);
        alert('Error cancelling booking. Please try again.');
    });
}

// Close modals on outside click
document.getElementById('booking-modal').addEventListener('click', function(e) {
    if (e.target === this) closeBookingModal();
});
document.getElementById('cancel-modal').addEventListener('click', function(e) {
    if (e.target === this) closeCancelModal();
});
</script>
{% endblock %}
