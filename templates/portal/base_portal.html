<!DOCTYPE html>
<html lang="en" data-portal="client">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>{% block title %}Client Portal{% endblock %} - Brightpath</title>

    {# PWA Meta Tags #}
    <meta name="description" content="Manage your credit repair journey with Brightpath Ascend Group">
    <meta name="theme-color" content="#14b8a6" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Brightpath">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Brightpath">
    <meta name="msapplication-TileColor" content="#14b8a6">
    <meta name="msapplication-TileImage" content="/static/images/pwa/icon-144x144.png">

    {# PWA Manifest #}
    <link rel="manifest" href="/static/manifest.json">

    {# PWA Icons #}
    <link rel="apple-touch-icon" href="/static/images/pwa/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/pwa/icon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/images/pwa/icon-72x72.png">

    {# Theme: Flash Prevention (must be before stylesheets) #}
    {% include 'includes/theme_head.html' %}

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/portal-redesign.css') }}">
    <style>
        /* Accessibility - Skip Link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--theme-bg-inverse, #1a1a2e);
            color: var(--theme-text-inverse, white);
            padding: 8px 16px;
            z-index: 10000;
            text-decoration: none;
            font-weight: 600;
            border-radius: 0 0 8px 0;
        }
        .skip-link:focus {
            top: 0;
        }
        /* Focus visible for keyboard navigation */
        *:focus-visible {
            outline: 3px solid var(--theme-accent, #319795);
            outline-offset: 2px;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Accessibility: Skip to main content link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <header class="header" role="banner" data-testid="portal-header">
        <div class="logo" data-testid="portal-logo">
            <img src="/static/images/logo.png" alt="Brightpath Ascend" style="height: 40px; margin-right: 10px; background: transparent;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="logo-icon" style="display: none;">âš–ï¸</div>
            <span class="logo-text">Brightpath</span>
        </div>
        <div class="user-info" data-testid="user-info">
            {# Theme Toggle Button #}
            {% include 'includes/theme_toggle.html' %}
            <span class="user-name" data-testid="client-name">{{ current_user.first_name if current_user.first_name else 'Client' }}</span>
            <div class="user-avatar" data-testid="user-avatar">{{ (current_user.first_name or 'C')[0] }}</div>
        </div>
    </header>

    {# Determine client stage for navigation - default to 'active' for legacy clients #}
    {% set client_stage = current_user.client.client_stage if current_user and current_user.client else 'active' %}
    {% set has_full_access = client_stage == 'active' %}
    {% set is_onboarding = client_stage in ['onboarding', 'pending_payment', 'payment_failed'] %}

    <nav class="nav-tabs" role="navigation" aria-label="Main navigation" data-testid="portal-nav">
        {# Setup/Onboarding - always visible during onboarding phase #}
        {% if is_onboarding or has_full_access %}
        <a href="{{ url_for('portal.onboarding') }}" class="nav-tab {% if active_tab == 'onboarding' %}active{% endif %}" data-testid="nav-onboarding">
            <span class="nav-icon" aria-hidden="true">ğŸš€</span><span class="nav-label">Setup</span>
        </a>
        {% endif %}

        {# Agreements - visible during onboarding phase #}
        {% if is_onboarding %}
        <a href="{{ url_for('portal.croa_agreements') }}" class="nav-tab {% if active_tab == 'agreements' %}active{% endif %}" data-testid="nav-agreements">
            <span class="nav-icon" aria-hidden="true">ğŸ“</span><span class="nav-label">Agreements</span>
        </a>
        {% endif %}

        {# Case Dashboard - only for active clients #}
        {% if has_full_access %}
        <a href="{{ url_for('portal.dashboard') }}" class="nav-tab {% if active_tab == 'case' %}active{% endif %}" data-testid="nav-case">
            <span class="nav-icon" aria-hidden="true">ğŸ“Š</span><span class="nav-label">Case</span>
        </a>
        {% endif %}

        {# Journey/Timeline - only for active clients #}
        {% if has_full_access %}
        <a href="{{ url_for('portal.timeline') }}" class="nav-tab {% if active_tab == 'timeline' %}active{% endif %}" data-testid="nav-timeline">
            <span class="nav-icon" aria-hidden="true">ğŸ“ˆ</span><span class="nav-label">Journey</span>
        </a>
        {% endif %}

        {# Documents - only for active clients #}
        {% if has_full_access %}
        <a href="{{ url_for('portal.documents') }}" class="nav-tab {% if active_tab == 'documents' %}active{% endif %}" data-testid="nav-documents">
            <span class="nav-icon" aria-hidden="true">ğŸ“</span><span class="nav-label">Documents</span>
        </a>
        {% endif %}

        {# Messages - only for active clients #}
        {% if has_full_access %}
        <a href="{{ url_for('portal.messages') }}" class="nav-tab {% if active_tab == 'messages' %}active{% endif %}" data-testid="nav-messages">
            <span class="nav-icon" aria-hidden="true">ğŸ’¬</span><span class="nav-label">Messages</span>
        </a>
        {% endif %}

        {# Invoices - only for active clients #}
        {% if has_full_access %}
        <a href="{{ url_for('portal.portal_invoices') }}" class="nav-tab {% if active_tab == 'invoices' %}active{% endif %}" data-testid="nav-invoices">
            <span class="nav-icon" aria-hidden="true">ğŸ“„</span><span class="nav-label">Invoices</span>
        </a>
        {% endif %}

        {# Payment Plans - only for active clients #}
        {% if has_full_access %}
        <a href="{{ url_for('portal.portal_payment_plans') }}" class="nav-tab {% if active_tab == 'payment-plans' %}active{% endif %}" data-testid="nav-payment-plans">
            <span class="nav-icon" aria-hidden="true">ğŸ’³</span><span class="nav-label">Plans</span>
        </a>
        {% endif %}

        {# Book Call - only for active clients #}
        {% if has_full_access %}
        <a href="{{ url_for('portal.booking') }}" class="nav-tab {% if active_tab == 'booking' %}active{% endif %}" data-testid="nav-booking">
            <span class="nav-icon" aria-hidden="true">ğŸ“</span><span class="nav-label">Book Call</span>
        </a>
        {% endif %}

        {# Subscription - only for active clients #}
        {% if has_full_access %}
        <a href="{{ url_for('portal.subscription') }}" class="nav-tab {% if active_tab == 'subscription' %}active{% endif %}" data-testid="nav-subscription">
            <span class="nav-icon" aria-hidden="true">ğŸ’³</span><span class="nav-label">Subscription</span>
        </a>
        {% endif %}

        {# Profile - always visible during onboarding and active #}
        <a href="{{ url_for('portal.profile') }}" class="nav-tab {% if active_tab == 'profile' %}active{% endif %}" data-testid="nav-profile">
            <span class="nav-icon" aria-hidden="true">ğŸ‘¤</span><span class="nav-label">Profile</span>
        </a>

        {# Logout - always visible #}
        <a href="{{ url_for('portal_logout') }}" class="nav-tab" data-testid="nav-logout">
            <span class="nav-icon" aria-hidden="true">ğŸšª</span><span class="nav-label">Logout</span>
        </a>
    </nav>

    <main class="main-content" id="main-content" role="main">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}" style="padding: 12px 16px; margin-bottom: 16px; border-radius: 8px; background: {% if category == 'success' %}var(--theme-success-bg, #d1fae5){% else %}var(--theme-danger-bg, #fee2e2){% endif %}; color: {% if category == 'success' %}var(--theme-success, #065f46){% else %}var(--theme-danger, #991b1b){% endif %};">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </main>

    <nav class="mobile-nav" data-testid="mobile-nav">
        {# Mobile nav also respects stage-based access #}
        {% if is_onboarding %}
        {# Onboarding mobile nav: Setup and Profile only #}
        <a href="{{ url_for('portal.onboarding') }}" class="mobile-nav-tab {% if active_tab == 'onboarding' %}active{% endif %}" data-testid="mobile-nav-onboarding">
            <span>ğŸš€</span><span>Setup</span>
        </a>
        <a href="{{ url_for('portal.croa_agreements') }}" class="mobile-nav-tab {% if active_tab == 'agreements' %}active{% endif %}" data-testid="mobile-nav-agreements">
            <span>ğŸ“</span><span>Sign</span>
        </a>
        <a href="{{ url_for('portal.profile') }}" class="mobile-nav-tab {% if active_tab == 'profile' %}active{% endif %}" data-testid="mobile-nav-profile">
            <span>ğŸ‘¤</span><span>Profile</span>
        </a>
        <a href="{{ url_for('portal_logout') }}" class="mobile-nav-tab" data-testid="mobile-nav-logout">
            <span>ğŸšª</span><span>Exit</span>
        </a>
        {% else %}
        {# Active clients get full mobile nav #}
        <a href="{{ url_for('portal.dashboard') }}" class="mobile-nav-tab {% if active_tab == 'case' %}active{% endif %}" data-testid="mobile-nav-case">
            <span>ğŸ“Š</span><span>Case</span>
        </a>
        <a href="{{ url_for('portal.documents') }}" class="mobile-nav-tab {% if active_tab == 'documents' %}active{% endif %}" data-testid="mobile-nav-documents">
            <span>ğŸ“</span><span>Docs</span>
        </a>
        <a href="{{ url_for('portal.messages') }}" class="mobile-nav-tab {% if active_tab == 'messages' %}active{% endif %}" data-testid="mobile-nav-messages">
            <span>ğŸ’¬</span><span>Chat</span>
        </a>
        <a href="{{ url_for('portal.booking') }}" class="mobile-nav-tab {% if active_tab == 'booking' %}active{% endif %}" data-testid="mobile-nav-booking">
            <span>ğŸ“</span><span>Book</span>
        </a>
        <a href="{{ url_for('portal.subscription') }}" class="mobile-nav-tab {% if active_tab == 'subscription' %}active{% endif %}" data-testid="mobile-nav-subscription">
            <span>ğŸ’³</span><span>Billing</span>
        </a>
        <a href="{{ url_for('portal.profile') }}" class="mobile-nav-tab {% if active_tab == 'profile' %}active{% endif %}" data-testid="mobile-nav-profile">
            <span>ğŸ‘¤</span><span>Profile</span>
        </a>
        {% endif %}
    </nav>

    <script src="{{ url_for('static', filename='js/portal-redesign.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme-service.js') }}"></script>
    <script src="{{ url_for('static', filename='js/pwa.js') }}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>
