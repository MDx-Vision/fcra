<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoices - Brightpath Ascend FCRA Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    {% include 'includes/dashboard_sidebar_styles.html' %}
</head>
<body>
    {% include 'includes/dashboard_sidebar.html' %}
<div class="main-content">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Invoices</h1>
            <p class="text-muted mb-0">Create and manage client invoices</p>
        </div>
        <button class="btn btn-success" onclick="showCreateModal()" data-testid="create-invoice-btn">
            <i class="bi bi-plus-lg me-2"></i>Create Invoice
        </button>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4" id="statsCards">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="bi bi-receipt text-primary fs-4"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Total Invoiced</div>
                            <div class="h4 mb-0" id="totalInvoiced">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="bi bi-check-circle text-success fs-4"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Total Paid</div>
                            <div class="h4 mb-0" id="totalPaid">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="bi bi-clock text-warning fs-4"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Outstanding</div>
                            <div class="h4 mb-0" id="totalOutstanding">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="bi bi-exclamation-circle text-danger fs-4"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Overdue</div>
                            <div class="h4 mb-0" id="overdueCount">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small">Status</label>
                    <select class="form-select" id="filterStatus" onchange="loadInvoices()">
                        <option value="">All Statuses</option>
                        <option value="draft">Draft</option>
                        <option value="sent">Sent</option>
                        <option value="viewed">Viewed</option>
                        <option value="paid">Paid</option>
                        <option value="partial">Partially Paid</option>
                        <option value="overdue">Overdue</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">From Date</label>
                    <input type="date" class="form-control" id="filterFromDate" onchange="loadInvoices()">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">To Date</label>
                    <input type="date" class="form-control" id="filterToDate" onchange="loadInvoices()">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Search</label>
                    <input type="text" class="form-control" id="filterSearch" placeholder="Invoice # or client..." onkeyup="debounceSearch()">
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice List -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="invoicesTable">
                    <thead class="bg-light">
                        <tr>
                            <th class="border-0 ps-4">Invoice #</th>
                            <th class="border-0">Client</th>
                            <th class="border-0">Date</th>
                            <th class="border-0">Due Date</th>
                            <th class="border-0">Total</th>
                            <th class="border-0">Paid</th>
                            <th class="border-0">Status</th>
                            <th class="border-0 pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTableBody">
                        <tr>
                            <td colspan="8" class="text-center py-5">
                                <div class="spinner-border text-success" role="status"></div>
                                <p class="text-muted mt-2 mb-0">Loading invoices...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Invoice Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoiceModalTitle">Create Invoice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="invoiceForm">
                    <input type="hidden" id="invoiceId">

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Client <span class="text-danger">*</span></label>
                            <select class="form-select" id="invoiceClient" required>
                                <option value="">Select client...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" id="invoiceTitle" placeholder="Invoice title (optional)">
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label">Invoice Date</label>
                            <input type="date" class="form-control" id="invoiceDate">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="invoiceDueDate">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tax Rate (%)</label>
                            <input type="number" class="form-control" id="invoiceTaxRate" value="0" min="0" max="100" step="0.01">
                        </div>
                    </div>

                    <!-- Line Items -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label mb-0">Line Items</label>
                            <button type="button" class="btn btn-sm btn-outline-success" onclick="addLineItem()">
                                <i class="bi bi-plus-lg me-1"></i>Add Item
                            </button>
                        </div>
                        <div id="lineItemsContainer">
                            <!-- Line items will be added here -->
                        </div>
                    </div>

                    <!-- Totals -->
                    <div class="bg-light rounded p-3 mb-4">
                        <div class="row">
                            <div class="col-md-6 offset-md-6">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal:</span>
                                    <span id="invoiceSubtotal">$0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Tax:</span>
                                    <span id="invoiceTax">$0.00</span>
                                </div>
                                <div class="d-flex justify-content-between fw-bold border-top pt-2">
                                    <span>Total:</span>
                                    <span id="invoiceTotal">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Notes (visible to client)</label>
                            <textarea class="form-control" id="invoiceNotes" rows="3"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Internal Notes</label>
                            <textarea class="form-control" id="invoiceInternalNotes" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveInvoice()">
                    <i class="bi bi-check-lg me-2"></i>Save Invoice
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Invoice Modal -->
<div class="modal fade" id="viewInvoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Invoice Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewInvoiceContent">
                <!-- Invoice details loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-primary" id="btnDownloadPdf">
                    <i class="bi bi-download me-2"></i>Download PDF
                </button>
                <button type="button" class="btn btn-primary" id="btnSendInvoice">
                    <i class="bi bi-envelope me-2"></i>Send to Client
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Record Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <input type="hidden" id="paymentInvoiceId">

                    <div class="alert alert-info mb-3">
                        <strong>Amount Due:</strong> <span id="paymentAmountDue">$0.00</span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Payment Amount <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="paymentAmount" step="0.01" min="0.01" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <select class="form-select" id="paymentMethod">
                            <option value="stripe">Stripe</option>
                            <option value="paypal">PayPal</option>
                            <option value="cash">Cash</option>
                            <option value="check">Check</option>
                            <option value="zelle">Zelle</option>
                            <option value="venmo">Venmo</option>
                            <option value="cashapp">Cash App</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Transaction ID</label>
                        <input type="text" class="form-control" id="paymentTransactionId" placeholder="Optional reference">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="paymentNotes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="recordPayment()">
                    <i class="bi bi-check-lg me-2"></i>Record Payment
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.line-item-row {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
}
.line-item-row .remove-item {
    opacity: 0.5;
    transition: opacity 0.2s;
}
.line-item-row:hover .remove-item {
    opacity: 1;
}
.status-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}
.status-draft { background: #e5e7eb; color: #374151; }
.status-sent { background: #dbeafe; color: #1d4ed8; }
.status-viewed { background: #ede9fe; color: #7c3aed; }
.status-paid { background: #dcfce7; color: #16a34a; }
.status-partial { background: #fef3c7; color: #d97706; }
.status-overdue { background: #fee2e2; color: #dc2626; }
.status-cancelled { background: #e5e7eb; color: #6b7280; }
</style>

<script>
let clients = [];
let currentInvoice = null;
let lineItemIndex = 0;
let searchTimeout = null;

document.addEventListener('DOMContentLoaded', function() {
    loadClients();
    loadInvoices();
    loadStats();

    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('invoiceDate').value = today;

    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];
});

function formatCurrency(cents) {
    return '$' + (cents / 100).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function loadClients() {
    fetch('/api/clients?limit=1000')
        .then(r => r.json())
        .then(data => {
            if (data.clients) {
                clients = data.clients;
                const select = document.getElementById('invoiceClient');
                clients.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = `${c.name} (${c.email || 'No email'})`;
                    select.appendChild(option);
                });
            }
        });
}

function loadStats() {
    fetch('/api/invoices/stats')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.stats) {
                document.getElementById('totalInvoiced').textContent = formatCurrency(data.stats.total_invoiced || 0);
                document.getElementById('totalPaid').textContent = formatCurrency(data.stats.total_paid || 0);
                document.getElementById('totalOutstanding').textContent = formatCurrency(data.stats.total_outstanding || 0);

                const overdue = data.stats.by_status?.overdue?.count || 0;
                document.getElementById('overdueCount').textContent = overdue;
            }
        });
}

function loadInvoices() {
    const status = document.getElementById('filterStatus').value;
    const fromDate = document.getElementById('filterFromDate').value;
    const toDate = document.getElementById('filterToDate').value;
    const search = document.getElementById('filterSearch').value.toLowerCase();

    let url = '/api/invoices?limit=100';
    if (status) url += `&status=${status}`;
    if (fromDate) url += `&from_date=${fromDate}`;
    if (toDate) url += `&to_date=${toDate}`;

    fetch(url)
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById('invoicesTableBody');

            if (!data.success || !data.invoices || data.invoices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5 text-muted">
                            <i class="bi bi-receipt fs-1 d-block mb-3 opacity-50"></i>
                            No invoices found
                        </td>
                    </tr>
                `;
                return;
            }

            let invoices = data.invoices;

            // Client-side search filter
            if (search) {
                invoices = invoices.filter(inv =>
                    inv.invoice_number.toLowerCase().includes(search) ||
                    (inv.billing_name || '').toLowerCase().includes(search)
                );
            }

            tbody.innerHTML = invoices.map(inv => {
                const client = clients.find(c => c.id === inv.client_id);
                const clientName = inv.billing_name || (client ? client.name : 'Unknown');

                return `
                    <tr>
                        <td class="ps-4">
                            <a href="#" onclick="viewInvoice(${inv.id}); return false;" class="fw-medium text-decoration-none">
                                ${inv.invoice_number}
                            </a>
                        </td>
                        <td>${clientName}</td>
                        <td>${inv.invoice_date || '-'}</td>
                        <td>${inv.due_date || '-'}</td>
                        <td>${formatCurrency(inv.total)}</td>
                        <td>${formatCurrency(inv.amount_paid)}</td>
                        <td>
                            <span class="status-badge status-${inv.status}">${inv.status_display || inv.status}</span>
                        </td>
                        <td class="pe-4">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                    Actions
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="viewInvoice(${inv.id}); return false;">
                                        <i class="bi bi-eye me-2"></i>View
                                    </a></li>
                                    ${inv.status === 'draft' ? `
                                        <li><a class="dropdown-item" href="#" onclick="editInvoice(${inv.id}); return false;">
                                            <i class="bi bi-pencil me-2"></i>Edit
                                        </a></li>
                                    ` : ''}
                                    ${['sent', 'viewed', 'partial', 'overdue'].includes(inv.status) ? `
                                        <li><a class="dropdown-item" href="#" onclick="showPaymentModal(${inv.id}, ${inv.amount_due}); return false;">
                                            <i class="bi bi-cash me-2"></i>Record Payment
                                        </a></li>
                                    ` : ''}
                                    ${inv.status !== 'paid' && inv.status !== 'cancelled' ? `
                                        <li><a class="dropdown-item" href="#" onclick="sendInvoice(${inv.id}); return false;">
                                            <i class="bi bi-envelope me-2"></i>Send
                                        </a></li>
                                    ` : ''}
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="downloadPdf(${inv.id}); return false;">
                                        <i class="bi bi-download me-2"></i>Download PDF
                                    </a></li>
                                    ${inv.status === 'draft' ? `
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteInvoice(${inv.id}); return false;">
                                            <i class="bi bi-trash me-2"></i>Delete
                                        </a></li>
                                    ` : ''}
                                    ${inv.status !== 'paid' && inv.status !== 'cancelled' ? `
                                        <li><a class="dropdown-item text-danger" href="#" onclick="voidInvoice(${inv.id}); return false;">
                                            <i class="bi bi-x-circle me-2"></i>Void
                                        </a></li>
                                    ` : ''}
                                </ul>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        });
}

function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(loadInvoices, 300);
}

function showCreateModal() {
    document.getElementById('invoiceModalTitle').textContent = 'Create Invoice';
    document.getElementById('invoiceForm').reset();
    document.getElementById('invoiceId').value = '';
    document.getElementById('lineItemsContainer').innerHTML = '';
    lineItemIndex = 0;

    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('invoiceDate').value = today;
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];

    // Add one empty line item
    addLineItem();

    new bootstrap.Modal(document.getElementById('invoiceModal')).show();
}

function addLineItem(item = null) {
    const container = document.getElementById('lineItemsContainer');
    const idx = lineItemIndex++;

    const html = `
        <div class="line-item-row" id="lineItem${idx}">
            <div class="row g-2 align-items-end">
                <div class="col-md-5">
                    <label class="form-label small">Description</label>
                    <input type="text" class="form-control" id="itemDesc${idx}" value="${item?.description || ''}"
                           onchange="calculateTotals()" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Quantity</label>
                    <input type="number" class="form-control" id="itemQty${idx}" value="${item?.quantity || 1}"
                           min="0.01" step="0.01" onchange="calculateTotals()">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Unit Price</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="itemPrice${idx}"
                               value="${item?.unit_price ? (item.unit_price / 100).toFixed(2) : ''}"
                               min="0" step="0.01" onchange="calculateTotals()">
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Amount</label>
                    <div class="form-control-plaintext fw-medium" id="itemAmount${idx}">$0.00</div>
                </div>
                <div class="col-md-1 text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-item" onclick="removeLineItem(${idx})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    calculateTotals();
}

function removeLineItem(idx) {
    const el = document.getElementById(`lineItem${idx}`);
    if (el) {
        el.remove();
        calculateTotals();
    }
}

function calculateTotals() {
    let subtotal = 0;
    const taxRate = parseFloat(document.getElementById('invoiceTaxRate').value) || 0;

    document.querySelectorAll('[id^="lineItem"]').forEach(row => {
        const idx = row.id.replace('lineItem', '');
        const qty = parseFloat(document.getElementById(`itemQty${idx}`)?.value) || 0;
        const price = parseFloat(document.getElementById(`itemPrice${idx}`)?.value) || 0;
        const amount = qty * price * 100; // Convert to cents
        subtotal += amount;

        const amountEl = document.getElementById(`itemAmount${idx}`);
        if (amountEl) amountEl.textContent = formatCurrency(amount);
    });

    const tax = subtotal * (taxRate / 100);
    const total = subtotal + tax;

    document.getElementById('invoiceSubtotal').textContent = formatCurrency(subtotal);
    document.getElementById('invoiceTax').textContent = formatCurrency(tax);
    document.getElementById('invoiceTotal').textContent = formatCurrency(total);
}

function saveInvoice() {
    const clientId = document.getElementById('invoiceClient').value;
    if (!clientId) {
        alert('Please select a client');
        return;
    }

    // Collect line items
    const items = [];
    document.querySelectorAll('[id^="lineItem"]').forEach(row => {
        const idx = row.id.replace('lineItem', '');
        const desc = document.getElementById(`itemDesc${idx}`)?.value;
        const qty = parseFloat(document.getElementById(`itemQty${idx}`)?.value) || 1;
        const price = parseFloat(document.getElementById(`itemPrice${idx}`)?.value) || 0;

        if (desc && price > 0) {
            items.push({
                description: desc,
                quantity: qty,
                unit_price: Math.round(price * 100), // Convert to cents
                item_type: 'service'
            });
        }
    });

    if (items.length === 0) {
        alert('Please add at least one line item');
        return;
    }

    const data = {
        client_id: parseInt(clientId),
        items: items,
        invoice_date: document.getElementById('invoiceDate').value,
        due_date: document.getElementById('invoiceDueDate').value,
        title: document.getElementById('invoiceTitle').value,
        notes: document.getElementById('invoiceNotes').value,
        internal_notes: document.getElementById('invoiceInternalNotes').value,
        tax_rate: (parseFloat(document.getElementById('invoiceTaxRate').value) || 0) / 100
    };

    const invoiceId = document.getElementById('invoiceId').value;
    const url = invoiceId ? `/api/invoices/${invoiceId}` : '/api/invoices';
    const method = invoiceId ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('invoiceModal')).hide();
            loadInvoices();
            loadStats();
            alert(invoiceId ? 'Invoice updated!' : 'Invoice created!');
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(err => alert('Error: ' + err.message));
}

function viewInvoice(id) {
    fetch(`/api/invoices/${id}?include_payments=true`)
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                alert('Error: ' + data.error);
                return;
            }

            currentInvoice = data.invoice;
            const inv = data.invoice;

            document.getElementById('viewInvoiceContent').innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-1">Invoice Number</h6>
                        <h4>${inv.invoice_number}</h4>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <span class="status-badge status-${inv.status} fs-6">${inv.status_display || inv.status}</span>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">Bill To</h6>
                        <p class="mb-0"><strong>${inv.billing_name}</strong></p>
                        <p class="mb-0">${inv.billing_email || ''}</p>
                        <p class="mb-0">${(inv.billing_address || '').replace(/\n/g, '<br>')}</p>
                    </div>
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-6">
                                <h6 class="text-muted mb-2">Invoice Date</h6>
                                <p>${inv.invoice_date || '-'}</p>
                            </div>
                            <div class="col-6">
                                <h6 class="text-muted mb-2">Due Date</h6>
                                <p>${inv.due_date || '-'}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th class="text-end">Qty</th>
                            <th class="text-end">Unit Price</th>
                            <th class="text-end">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(inv.items || []).map(item => `
                            <tr>
                                <td>${item.description}</td>
                                <td class="text-end">${item.quantity}</td>
                                <td class="text-end">${formatCurrency(item.unit_price)}</td>
                                <td class="text-end">${formatCurrency(item.amount)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <div class="row">
                    <div class="col-md-6 offset-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td>Subtotal</td>
                                <td class="text-end">${formatCurrency(inv.subtotal)}</td>
                            </tr>
                            ${inv.discount_amount ? `
                            <tr>
                                <td>Discount</td>
                                <td class="text-end text-danger">-${formatCurrency(inv.discount_amount)}</td>
                            </tr>
                            ` : ''}
                            ${inv.tax_amount ? `
                            <tr>
                                <td>Tax (${(inv.tax_rate * 100).toFixed(1)}%)</td>
                                <td class="text-end">${formatCurrency(inv.tax_amount)}</td>
                            </tr>
                            ` : ''}
                            <tr class="border-top">
                                <td><strong>Total</strong></td>
                                <td class="text-end"><strong>${formatCurrency(inv.total)}</strong></td>
                            </tr>
                            <tr class="text-success">
                                <td>Paid</td>
                                <td class="text-end">${formatCurrency(inv.amount_paid)}</td>
                            </tr>
                            ${inv.amount_due > 0 ? `
                            <tr class="border-top">
                                <td><strong>Amount Due</strong></td>
                                <td class="text-end"><strong>${formatCurrency(inv.amount_due)}</strong></td>
                            </tr>
                            ` : ''}
                        </table>
                    </div>
                </div>

                ${inv.notes ? `
                <div class="mt-4 p-3 bg-light rounded">
                    <h6 class="text-muted mb-2">Notes</h6>
                    <p class="mb-0">${inv.notes}</p>
                </div>
                ` : ''}

                ${(inv.payments && inv.payments.length > 0) ? `
                <div class="mt-4">
                    <h6>Payment History</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Method</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${inv.payments.map(p => `
                                <tr>
                                    <td>${new Date(p.paid_at).toLocaleDateString()}</td>
                                    <td>${p.payment_method}</td>
                                    <td class="text-end">${formatCurrency(p.amount)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}
            `;

            document.getElementById('btnDownloadPdf').onclick = () => downloadPdf(id);
            document.getElementById('btnSendInvoice').onclick = () => sendInvoice(id);

            new bootstrap.Modal(document.getElementById('viewInvoiceModal')).show();
        });
}

function showPaymentModal(invoiceId, amountDue) {
    document.getElementById('paymentInvoiceId').value = invoiceId;
    document.getElementById('paymentAmountDue').textContent = formatCurrency(amountDue);
    document.getElementById('paymentAmount').value = (amountDue / 100).toFixed(2);
    document.getElementById('paymentAmount').max = (amountDue / 100).toFixed(2);
    document.getElementById('paymentForm').reset();
    document.getElementById('paymentAmount').value = (amountDue / 100).toFixed(2);

    new bootstrap.Modal(document.getElementById('paymentModal')).show();
}

function recordPayment() {
    const invoiceId = document.getElementById('paymentInvoiceId').value;
    const amount = Math.round(parseFloat(document.getElementById('paymentAmount').value) * 100);

    if (!amount || amount <= 0) {
        alert('Please enter a valid amount');
        return;
    }

    fetch(`/api/invoices/${invoiceId}/payments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            amount: amount,
            payment_method: document.getElementById('paymentMethod').value,
            transaction_id: document.getElementById('paymentTransactionId').value,
            notes: document.getElementById('paymentNotes').value
        })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
            loadInvoices();
            loadStats();
            alert(result.fully_paid ? 'Payment recorded. Invoice is now paid in full!' : 'Payment recorded successfully!');
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    });
}

function sendInvoice(id) {
    if (!confirm('Send this invoice to the client?')) return;

    fetch(`/api/invoices/${id}/send`, { method: 'POST' })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                loadInvoices();
                alert('Invoice sent successfully!');
            } else {
                alert('Error: ' + (result.error || 'Failed to send invoice'));
            }
        });
}

function downloadPdf(id) {
    // First generate PDF if needed
    fetch(`/api/invoices/${id}/pdf`, { method: 'POST' })
        .then(r => r.json())
        .then(result => {
            if (result.success || result.pdf_filename) {
                window.open(`/api/invoices/${id}/pdf`, '_blank');
            } else {
                alert('Error generating PDF: ' + (result.error || 'Unknown error'));
            }
        });
}

function deleteInvoice(id) {
    if (!confirm('Delete this invoice? This cannot be undone.')) return;

    fetch(`/api/invoices/${id}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                loadInvoices();
                loadStats();
            } else {
                alert('Error: ' + (result.error || 'Failed to delete'));
            }
        });
}

function voidInvoice(id) {
    const reason = prompt('Reason for voiding this invoice:');
    if (reason === null) return;

    fetch(`/api/invoices/${id}/void`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason: reason })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            loadInvoices();
            loadStats();
        } else {
            alert('Error: ' + (result.error || 'Failed to void'));
        }
    });
}

// Calculate totals when tax rate changes
document.getElementById('invoiceTaxRate').addEventListener('change', calculateTotals);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
