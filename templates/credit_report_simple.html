<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three Bureau Credit Report - {{ client_name }}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; font-size: 12px; background: #fff; color: #333; padding: 20px; }

        .report-header { text-align: center; margin-bottom: 20px; }
        .report-header h1 { font-size: 24px; color: #2c5282; margin-bottom: 5px; }
        .report-date { text-align: right; font-size: 14px; margin-bottom: 20px; }

        .section { margin-bottom: 25px; border: 1px solid #ccc; }
        .section-header { background: #2c5282; color: white; padding: 8px 12px; font-weight: bold; font-size: 14px; }
        .section-note { background: #f7fafc; padding: 8px 12px; font-size: 11px; color: #666; border-bottom: 1px solid #ccc; }

        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; vertical-align: top; }
        th { background: #4a5568; color: white; font-weight: bold; text-align: center; }
        th.tu { background: #3182ce; }
        th.ex { background: #c53030; }
        th.eq { background: #d69e2e; }

        .label-col { width: 180px; background: #f7fafc; font-weight: bold; }
        .bureau-col { width: 27%; }

        .account-header { background: #2d3748; color: white; padding: 8px 12px; font-weight: bold; }

        .payment-grid { font-size: 10px; }
        .payment-grid th, .payment-grid td { padding: 3px 4px; text-align: center; }
        .payment-ok { background: #c6f6d5; color: #22543d; }
        .payment-30 { background: #fefcbf; color: #744210; }
        .payment-60 { background: #fed7aa; color: #9c4221; }
        .payment-90 { background: #feb2b2; color: #9b2c2c; }
        .payment-co { background: #e53e3e; color: white; }
        .payment-na { background: #e2e8f0; color: #718096; }

        .score-value { font-size: 24px; font-weight: bold; text-align: center; }

        @media print {
            .section { page-break-inside: avoid; }
            .account-section { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="report-header">
        <h1>Three Bureau Credit Report</h1>
    </div>
    <div class="report-date"><strong>Report Date:</strong> {{ report_date }}</div>

    <!-- Personal Information -->
    <div class="section">
        <div class="section-header">Personal Information</div>
        <div class="section-note">Below is your personal information as it appears in your credit file.</div>
        <table>
            <thead>
                <tr>
                    <th class="label-col"></th>
                    <th class="bureau-col tu">TransUnion</th>
                    <th class="bureau-col ex">Experian</th>
                    <th class="bureau-col eq">Equifax</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="label-col">Credit Report Date:</td>
                    <td>{{ report_date }}</td>
                    <td>{{ report_date }}</td>
                    <td>{{ report_date }}</td>
                </tr>
                {% set tu = personal_info.get('transunion', {}) %}
                {% set ex = personal_info.get('experian', {}) %}
                {% set eq = personal_info.get('equifax', {}) %}
                <tr>
                    <td class="label-col">Name:</td>
                    <td>{{ tu.get('names', [])|join('<br>')|safe or personal_info.get('name', 'N/A') }}</td>
                    <td>{{ ex.get('names', [])|join('<br>')|safe or personal_info.get('name', 'N/A') }}</td>
                    <td>{{ eq.get('names', [])|join('<br>')|safe or personal_info.get('name', 'N/A') }}</td>
                </tr>
                {% if tu.get('also_known_as') or ex.get('also_known_as') or eq.get('also_known_as') %}
                <tr>
                    <td class="label-col">Also Known As:</td>
                    <td>{% for aka in tu.get('also_known_as', []) %}{{ aka }}<br>{% endfor %}-</td>
                    <td>{% for aka in ex.get('also_known_as', []) %}{{ aka }}<br>{% endfor %}-</td>
                    <td>{% for aka in eq.get('also_known_as', []) %}{{ aka }}<br>{% endfor %}-</td>
                </tr>
                {% endif %}
                {% if tu.get('former_names') or ex.get('former_names') or eq.get('former_names') %}
                <tr>
                    <td class="label-col">Former:</td>
                    <td>{% for name in tu.get('former_names', []) %}{{ name }}<br>{% endfor %}-</td>
                    <td>{% for name in ex.get('former_names', []) %}{{ name }}<br>{% endfor %}-</td>
                    <td>{% for name in eq.get('former_names', []) %}{{ name }}<br>{% endfor %}-</td>
                </tr>
                {% endif %}
                <tr>
                    <td class="label-col">Date of Birth:</td>
                    <td>{{ tu.get('dob') or personal_info.get('dob', 'N/A') }}</td>
                    <td>{{ ex.get('dob') or personal_info.get('dob', 'N/A') }}</td>
                    <td>{{ eq.get('dob') or personal_info.get('dob', 'N/A') }}</td>
                </tr>
                <tr>
                    <td class="label-col">Current Address:</td>
                    <td>{{ tu.get('current_address') or personal_info.get('address', 'N/A') }}</td>
                    <td>{{ ex.get('current_address') or personal_info.get('address', 'N/A') }}</td>
                    <td>{{ eq.get('current_address') or personal_info.get('address', 'N/A') }}</td>
                </tr>
                {% if tu.get('previous_addresses') or ex.get('previous_addresses') or eq.get('previous_addresses') %}
                <tr>
                    <td class="label-col">Previous Address(es):</td>
                    <td>{% for addr in tu.get('previous_addresses', []) %}{% if addr is mapping %}{{ addr.address }}{% if addr.date %} <small>({{ addr.date }})</small>{% endif %}{% else %}{{ addr }}{% endif %}<br>{% endfor %}</td>
                    <td>{% for addr in ex.get('previous_addresses', []) %}{% if addr is mapping %}{{ addr.address }}{% if addr.date %} <small>({{ addr.date }})</small>{% endif %}{% else %}{{ addr }}{% endif %}<br>{% endfor %}</td>
                    <td>{% for addr in eq.get('previous_addresses', []) %}{% if addr is mapping %}{{ addr.address }}{% if addr.date %} <small>({{ addr.date }})</small>{% endif %}{% else %}{{ addr }}{% endif %}<br>{% endfor %}</td>
                </tr>
                {% endif %}
                <tr>
                    <td class="label-col">Employers:</td>
                    <td>{% for emp in tu.get('employers', []) %}{{ emp.name }}{% if emp.date_updated %} ({{ emp.date_updated }}){% endif %}<br>{% endfor %}</td>
                    <td>{% for emp in ex.get('employers', []) %}{{ emp.name }}{% if emp.date_updated %} ({{ emp.date_updated }}){% endif %}<br>{% endfor %}</td>
                    <td>{% for emp in eq.get('employers', []) %}{{ emp.name }}{% if emp.date_updated %} ({{ emp.date_updated }}){% endif %}<br>{% endfor %}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Credit Score -->
    <div class="section">
        <div class="section-header">Credit Score</div>
        <div class="section-note">Your Credit Score is a representation of your overall credit health.</div>
        <table>
            <thead>
                <tr>
                    <th class="label-col"></th>
                    <th class="bureau-col tu">TransUnion</th>
                    <th class="bureau-col ex">Experian</th>
                    <th class="bureau-col eq">Equifax</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="label-col">Credit Score:</td>
                    <td class="score-value">{{ scores.get('transunion', 'N/A') }}</td>
                    <td class="score-value">{{ scores.get('experian', 'N/A') }}</td>
                    <td class="score-value">{{ scores.get('equifax', 'N/A') }}</td>
                </tr>
                <tr>
                    <td class="label-col">Lender Rank:</td>
                    <td>{{ scores.get('lender_rank', {}).get('transunion', 'N/A') if scores.get('lender_rank') else 'N/A' }}</td>
                    <td>{{ scores.get('lender_rank', {}).get('experian', 'N/A') if scores.get('lender_rank') else 'N/A' }}</td>
                    <td>{{ scores.get('lender_rank', {}).get('equifax', 'N/A') if scores.get('lender_rank') else 'N/A' }}</td>
                </tr>
                <tr>
                    <td class="label-col">Score Scale:</td>
                    <td>{{ scores.get('score_scale', {}).get('transunion', '300-850') if scores.get('score_scale') else '300-850' }}</td>
                    <td>{{ scores.get('score_scale', {}).get('experian', '300-850') if scores.get('score_scale') else '300-850' }}</td>
                    <td>{{ scores.get('score_scale', {}).get('equifax', '300-850') if scores.get('score_scale') else '300-850' }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Summary -->
    <div class="section">
        <div class="section-header">Summary</div>
        <div class="section-note">Below is an overview of your present and past credit status.</div>
        {% set s_tu = summary.get('transunion', {}) %}
        {% set s_ex = summary.get('experian', {}) %}
        {% set s_eq = summary.get('equifax', {}) %}
        <table>
            <thead>
                <tr>
                    <th class="label-col"></th>
                    <th class="bureau-col tu">TransUnion</th>
                    <th class="bureau-col ex">Experian</th>
                    <th class="bureau-col eq">Equifax</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="label-col">Total Accounts:</td>
                    <td>{{ s_tu.get('total_accounts') or summary.get('total_accounts', '-') }}</td>
                    <td>{{ s_ex.get('total_accounts') or summary.get('total_accounts', '-') }}</td>
                    <td>{{ s_eq.get('total_accounts') or summary.get('total_accounts', '-') }}</td>
                </tr>
                <tr>
                    <td class="label-col">Open Accounts:</td>
                    <td>{{ s_tu.get('open_accounts') or summary.get('open_accounts', '-') }}</td>
                    <td>{{ s_ex.get('open_accounts') or summary.get('open_accounts', '-') }}</td>
                    <td>{{ s_eq.get('open_accounts') or summary.get('open_accounts', '-') }}</td>
                </tr>
                <tr>
                    <td class="label-col">Closed Accounts:</td>
                    <td>{{ s_tu.get('closed_accounts') or summary.get('closed_accounts', '-') }}</td>
                    <td>{{ s_ex.get('closed_accounts') or summary.get('closed_accounts', '-') }}</td>
                    <td>{{ s_eq.get('closed_accounts') or summary.get('closed_accounts', '-') }}</td>
                </tr>
                <tr>
                    <td class="label-col">Delinquent:</td>
                    <td>{{ s_tu.get('delinquent') or summary.get('delinquent_accounts', '-') }}</td>
                    <td>{{ s_ex.get('delinquent') or summary.get('delinquent_accounts', '-') }}</td>
                    <td>{{ s_eq.get('delinquent') or summary.get('delinquent_accounts', '-') }}</td>
                </tr>
                <tr>
                    <td class="label-col">Derogatory:</td>
                    <td>{{ s_tu.get('derogatory') or summary.get('derogatory_accounts', '-') }}</td>
                    <td>{{ s_ex.get('derogatory') or summary.get('derogatory_accounts', '-') }}</td>
                    <td>{{ s_eq.get('derogatory') or summary.get('derogatory_accounts', '-') }}</td>
                </tr>
                <tr>
                    <td class="label-col">Collection:</td>
                    <td>{{ s_tu.get('collection') or summary.get('collection', '-') }}</td>
                    <td>{{ s_ex.get('collection') or summary.get('collection', '-') }}</td>
                    <td>{{ s_eq.get('collection') or summary.get('collection', '-') }}</td>
                </tr>
                <tr>
                    <td class="label-col">Balances:</td>
                    <td>{{ s_tu.get('balances') or summary.get('total_balances', '-') }}</td>
                    <td>{{ s_ex.get('balances') or summary.get('total_balances', '-') }}</td>
                    <td>{{ s_eq.get('balances') or summary.get('total_balances', '-') }}</td>
                </tr>
                <tr>
                    <td class="label-col">Payments:</td>
                    <td>{{ s_tu.get('payments') or summary.get('total_payments', '-') }}</td>
                    <td>{{ s_ex.get('payments') or summary.get('total_payments', '-') }}</td>
                    <td>{{ s_eq.get('payments') or summary.get('total_payments', '-') }}</td>
                </tr>
                <tr>
                    <td class="label-col">Public Records:</td>
                    <td>{{ s_tu.get('public_records') or summary.get('public_records', '-') }}</td>
                    <td>{{ s_ex.get('public_records') or summary.get('public_records', '-') }}</td>
                    <td>{{ s_eq.get('public_records') or summary.get('public_records', '-') }}</td>
                </tr>
                <tr>
                    <td class="label-col">Inquiries (2 years):</td>
                    <td>{{ s_tu.get('inquiries') or summary.get('total_inquiries', '-') }}</td>
                    <td>{{ s_ex.get('inquiries') or summary.get('total_inquiries', '-') }}</td>
                    <td>{{ s_eq.get('inquiries') or summary.get('total_inquiries', '-') }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Account History -->
    <div class="section">
        <div class="section-header">Account History</div>
        <div class="section-note">Information on accounts you have opened in the past is displayed below.</div>

        {% for account in accounts %}
        <div class="account-section" style="margin-bottom: 15px;">
            <div class="account-header">{{ account.creditor or 'Unknown Creditor' }}</div>
            <table>
                <thead>
                    <tr>
                        <th class="label-col"></th>
                        <th class="bureau-col tu">TransUnion</th>
                        <th class="bureau-col ex">Experian</th>
                        <th class="bureau-col eq">Equifax</th>
                    </tr>
                </thead>
                {% set tu = account.bureaus.transunion if account.bureaus else {} %}
                {% set ex = account.bureaus.experian if account.bureaus else {} %}
                {% set eq = account.bureaus.equifax if account.bureaus else {} %}
                <tbody>
                    <tr>
                        <td class="label-col">Account #:</td>
                        <td>{{ tu.account_number or tu.number or account.account_number or '' }}</td>
                        <td>{{ ex.account_number or ex.number or account.account_number or '' }}</td>
                        <td>{{ eq.account_number or eq.number or account.account_number or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">Account Type:</td>
                        <td>{{ tu.account_type or tu.type or account.account_type or '' }}</td>
                        <td>{{ ex.account_type or ex.type or account.account_type or '' }}</td>
                        <td>{{ eq.account_type or eq.type or account.account_type or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">Account Type - Detail:</td>
                        <td>{{ tu.type_detail or account.account_type_detail or '' }}</td>
                        <td>{{ ex.type_detail or account.account_type_detail or '' }}</td>
                        <td>{{ eq.type_detail or account.account_type_detail or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">Bureau Code:</td>
                        <td>{{ tu.bureau_code or account.bureau_code or '' }}</td>
                        <td>{{ ex.bureau_code or account.bureau_code or '' }}</td>
                        <td>{{ eq.bureau_code or account.bureau_code or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">Account Status:</td>
                        <td>{{ tu.account_status or tu.status or account.account_status or '' }}</td>
                        <td>{{ ex.account_status or ex.status or account.account_status or '' }}</td>
                        <td>{{ eq.account_status or eq.status or account.account_status or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">Monthly Payment:</td>
                        <td>{{ tu.payment_amount or tu.monthly_payment or account.monthly_payment or '' }}</td>
                        <td>{{ ex.payment_amount or ex.monthly_payment or account.monthly_payment or '' }}</td>
                        <td>{{ eq.payment_amount or eq.monthly_payment or account.monthly_payment or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">Date Opened:</td>
                        <td>{{ tu.date_opened or account.date_opened or '' }}</td>
                        <td>{{ ex.date_opened or account.date_opened or '' }}</td>
                        <td>{{ eq.date_opened or account.date_opened or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">Balance:</td>
                        <td>{{ tu.balance or account.balance or '' }}</td>
                        <td>{{ ex.balance or account.balance or '' }}</td>
                        <td>{{ eq.balance or account.balance or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">No. of Months (terms):</td>
                        <td>{{ tu.term_length or account.term_length or '' }}</td>
                        <td>{{ ex.term_length or account.term_length or '' }}</td>
                        <td>{{ eq.term_length or account.term_length or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">High Credit:</td>
                        <td>{{ tu.high_balance or tu.high_credit or account.high_credit or '' }}</td>
                        <td>{{ ex.high_balance or ex.high_credit or account.high_credit or '' }}</td>
                        <td>{{ eq.high_balance or eq.high_credit or account.high_credit or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">Credit Limit:</td>
                        <td>{{ tu.credit_limit or account.credit_limit or '' }}</td>
                        <td>{{ ex.credit_limit or account.credit_limit or '' }}</td>
                        <td>{{ eq.credit_limit or account.credit_limit or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">Past Due:</td>
                        <td>{{ tu.past_due or account.past_due or '' }}</td>
                        <td>{{ ex.past_due or account.past_due or '' }}</td>
                        <td>{{ eq.past_due or account.past_due or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">Payment Status:</td>
                        <td>{{ tu.payment_status or account.payment_status or '' }}</td>
                        <td>{{ ex.payment_status or account.payment_status or '' }}</td>
                        <td>{{ eq.payment_status or account.payment_status or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">Last Reported:</td>
                        <td>{{ tu.date_reported or tu.last_reported or account.last_reported or '' }}</td>
                        <td>{{ ex.date_reported or ex.last_reported or account.last_reported or '' }}</td>
                        <td>{{ eq.date_reported or eq.last_reported or account.last_reported or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">Comments:</td>
                        <td>{{ tu.comments or account.comments or '' }}</td>
                        <td>{{ ex.comments or account.comments or '' }}</td>
                        <td>{{ eq.comments or account.comments or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">Date Last Active:</td>
                        <td>{{ tu.last_activity or tu.last_active or account.last_active or '' }}</td>
                        <td>{{ ex.last_activity or ex.last_active or account.last_active or '' }}</td>
                        <td>{{ eq.last_activity or eq.last_active or account.last_active or '' }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">Date of Last Payment:</td>
                        <td>{{ tu.last_payment or account.last_payment or '' }}</td>
                        <td>{{ ex.last_payment or account.last_payment or '' }}</td>
                        <td>{{ eq.last_payment or account.last_payment or '' }}</td>
                    </tr>
                </tbody>
            </table>

            {% if account.payment_history and account.payment_history|length > 0 %}
            <div style="margin-top: 10px;">
                <strong>Extended Payment History</strong>
                <table class="payment-grid" style="margin-top: 5px;">
                    <thead>
                        <tr>
                            <th style="width: 80px;"></th>
                            {% for entry in account.payment_history[:24] %}
                            <th>{{ entry.month[:3] if entry.month else '' }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>TransUnion</strong></td>
                            {% for entry in account.payment_history[:24] %}
                            <td class="{% if entry.transunion == 'OK' %}payment-ok{% elif entry.transunion == '30' %}payment-30{% elif entry.transunion == '60' %}payment-60{% elif entry.transunion == '90' %}payment-90{% elif entry.transunion in ['CO', 'CL'] %}payment-co{% else %}payment-na{% endif %}">{{ entry.transunion or '' }}</td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td><strong>Experian</strong></td>
                            {% for entry in account.payment_history[:24] %}
                            <td class="{% if entry.experian == 'OK' %}payment-ok{% elif entry.experian == '30' %}payment-30{% elif entry.experian == '60' %}payment-60{% elif entry.experian == '90' %}payment-90{% elif entry.experian in ['CO', 'CL'] %}payment-co{% else %}payment-na{% endif %}">{{ entry.experian or '' }}</td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td><strong>Equifax</strong></td>
                            {% for entry in account.payment_history[:24] %}
                            <td class="{% if entry.equifax == 'OK' %}payment-ok{% elif entry.equifax == '30' %}payment-30{% elif entry.equifax == '60' %}payment-60{% elif entry.equifax == '90' %}payment-90{% elif entry.equifax in ['CO', 'CL'] %}payment-co{% else %}payment-na{% endif %}">{{ entry.equifax or '' }}</td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Inquiries -->
    {% if inquiries and inquiries|length > 0 %}
    <div class="section">
        <div class="section-header">Inquiries</div>
        <div class="section-note">Below are the names of people and/or organizations who have obtained a copy of your Credit Report.</div>
        <table>
            <thead>
                <tr>
                    <th>Creditor Name</th>
                    <th>Type of Business</th>
                    <th>Date of Inquiry</th>
                    <th>Credit Bureau</th>
                </tr>
            </thead>
            <tbody>
                {% for inq in inquiries %}
                <tr>
                    <td>{{ inq.company or inq.creditor or 'N/A' }}</td>
                    <td>{{ inq.type or 'N/A' }}</td>
                    <td>{{ inq.date or 'N/A' }}</td>
                    <td>
                        {% if inq.bureau %}
                            {{ inq.bureau }}
                        {% else %}
                            {% set bureaus = [] %}
                            {% if inq.transunion %}{% set _ = bureaus.append('TU') %}{% endif %}
                            {% if inq.experian %}{% set _ = bureaus.append('EX') %}{% endif %}
                            {% if inq.equifax %}{% set _ = bureaus.append('EQ') %}{% endif %}
                            {{ bureaus|join(', ') or 'N/A' }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Public Information -->
    <div class="section">
        <div class="section-header">Public Information</div>
        <div class="section-note">Below is an overview of your public records.</div>
        <table>
            <tbody>
                {% if public_records and public_records|length > 0 %}
                {% for record in public_records %}
                <tr>
                    <td>{{ record.type }}: {{ record.description }}</td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td style="text-align: center; padding: 15px;"><strong>None Reported</strong></td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Creditor Contacts -->
    {% if creditor_contacts and creditor_contacts|length > 0 %}
    <div class="section">
        <div class="section-header">Creditor Contacts</div>
        <div class="section-note">The names of people and/or organizations who have obtained a copy of your credit report are listed below.</div>
        <table>
            <thead>
                <tr>
                    <th>Creditor Name</th>
                    <th>Address</th>
                    <th>Phone Number</th>
                </tr>
            </thead>
            <tbody>
                {% for contact in creditor_contacts %}
                <tr>
                    <td>{{ contact.name }}</td>
                    <td>{{ contact.address }}</td>
                    <td>{{ contact.phone }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

</body>
</html>
