<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Score Tracker - Brightpath Ascend FCRA Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {% include 'includes/dashboard_sidebar_styles.html' %}
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #1a1a2e; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-header h1 { font-size: 1.75rem; color: #1a1a2e; }
        .page-header-subtitle { color: #64748b; margin-top: 5px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 12px 24px; border: none; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; color: #666; transition: all 0.2s; }
        .tab-btn.active { background: linear-gradient(135deg, #008080, #32CD32); color: white; }
        .tab-btn:hover:not(.active) { background: #e8f5f5; color: #008080; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .quick-estimate { background: white; border-radius: 16px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .quick-estimate h2 { margin-bottom: 20px; color: #1a1a2e; }
        .estimate-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: end; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-weight: 600; color: #666; font-size: 0.9rem; }
        .form-group input, .form-group select { padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #008080; }
        .btn-estimate { background: linear-gradient(135deg, #008080, #32CD32); color: white; border: none; padding: 14px 30px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        .btn-estimate:hover { transform: translateY(-2px); }
        .estimate-result { margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #e8f5f5, #e8ffe8); border-radius: 12px; display: none; }
        .estimate-result.show { display: block; }
        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; text-align: center; }
        .result-item { background: white; padding: 20px; border-radius: 12px; }
        .result-item .label { font-size: 0.85rem; color: #666; margin-bottom: 5px; }
        .result-item .value { font-size: 1.8rem; font-weight: 700; }
        .result-item .value.green { color: #32CD32; }
        .result-item .value.teal { color: #008080; }
        
        .item-selector { background: white; border-radius: 16px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .item-selector h2 { margin-bottom: 10px; }
        .item-selector p { color: #666; margin-bottom: 20px; }
        .selected-items { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; min-height: 50px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .selected-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid #e0e0e0; }
        .selected-item .remove { cursor: pointer; color: #dc3545; font-weight: bold; }
        .selected-item .count-input { width: 50px; padding: 4px 8px; border: 1px solid #e0e0e0; border-radius: 4px; text-align: center; }
        
        .category-accordion { margin-bottom: 15px; }
        .category-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #f8f9fa; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .category-header:hover { background: #e8f5f5; }
        .category-header.open { border-radius: 8px 8px 0 0; }
        .category-header h3 { display: flex; align-items: center; gap: 10px; }
        .category-dot { width: 12px; height: 12px; border-radius: 50%; }
        .category-items { display: none; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px; overflow: hidden; }
        .category-items.open { display: block; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; }
        .item-row:last-child { border-bottom: none; }
        .item-row:hover { background: #f8f9fa; }
        .item-info { flex: 1; }
        .item-name { font-weight: 600; color: #1a1a2e; }
        .item-desc { font-size: 0.85rem; color: #666; margin-top: 2px; }
        .item-impact { text-align: right; margin-right: 15px; }
        .item-impact .points { font-weight: 700; color: #008080; }
        .item-impact .range { font-size: 0.8rem; color: #666; }
        .severity-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .btn-add-item { background: #008080; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
        .btn-add-item:hover { background: #006666; }
        
        .detailed-result { margin-top: 30px; }
        .breakdown-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .breakdown-table th, .breakdown-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        .breakdown-table th { background: #f8f9fa; font-weight: 600; color: #666; }
        .breakdown-table tr:hover { background: #f8f9fa; }
        
        .clients-section { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .clients-section h2 { margin-bottom: 20px; }
        .search-box { margin-bottom: 20px; }
        .search-box input { width: 100%; max-width: 400px; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; }
        .client-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .client-card { background: #f8f9fa; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .client-card:hover { border-color: #008080; transform: translateY(-2px); }
        .client-card h3 { margin-bottom: 15px; color: #1a1a2e; }
        .score-display { display: flex; gap: 15px; margin-bottom: 15px; }
        .score-box { flex: 1; text-align: center; padding: 12px; background: white; border-radius: 8px; }
        .score-box .label { font-size: 0.75rem; color: #666; margin-bottom: 4px; }
        .score-box .score { font-size: 1.4rem; font-weight: 700; }
        .score-box .score.poor { color: #dc3545; }
        .score-box .score.fair { color: #fd7e14; }
        .score-box .score.good { color: #ffc107; }
        .score-box .score.very-good { color: #20c997; }
        .score-box .score.excellent { color: #28a745; }
        .progress-bar { height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #008080, #32CD32); border-radius: 4px; transition: width 0.5s; }
        .stats-row { display: flex; justify-content: space-between; font-size: 0.85rem; color: #666; }
        .improvement-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .improvement-badge.positive { background: #d4edda; color: #155724; }
        .improvement-badge.neutral { background: #e2e3e5; color: #383d41; }
        .no-data { text-align: center; padding: 40px; color: #666; }
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .estimate-form { grid-template-columns: 1fr; }
            .tabs { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    {% set active_page = 'credit-tracker' %}
    {% include 'includes/dashboard_sidebar.html' %}
    
    <main class="main-content">
        <div class="page-header">
            <div>
                <h1>Credit Score Improvement Tracker</h1>
                <p class="page-header-subtitle">Track and estimate credit score improvements for clients</p>
            </div>
        </div>
        
        <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('quick')">Quick Estimate</button>
            <button class="tab-btn" onclick="switchTab('detailed')">Detailed Calculator</button>
            <button class="tab-btn" onclick="switchTab('clients')">Client Progress</button>
        </div>
        
        <div id="quick-tab" class="tab-content active">
            <div class="quick-estimate">
                <h2>Quick Score Improvement Estimator</h2>
                <p style="color: #666; margin-bottom: 20px;">Enter a current score and number of negative items for a rough estimate. For more accurate projections, use the Detailed Calculator tab.</p>
                <div class="estimate-form">
                    <div class="form-group">
                        <label>Current Average Score</label>
                        <input type="number" id="currentScore" placeholder="e.g., 580" min="300" max="850">
                    </div>
                    <div class="form-group">
                        <label>Number of Negative Items</label>
                        <input type="number" id="numNegatives" placeholder="e.g., 8" min="0" max="50">
                    </div>
                    <button class="btn-estimate" onclick="calculateEstimate()">Calculate Estimate</button>
                </div>
                <div class="estimate-result" id="estimateResult">
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="label">Current Score</div>
                            <div class="value" id="resCurrentScore">--</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Projected Score</div>
                            <div class="value teal" id="resProjectedScore">--</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Potential Gain</div>
                            <div class="value green" id="resPotentialGain">--</div>
                        </div>
                        <div class="result-item">
                            <div class="label">New Range</div>
                            <div class="value" id="resNewRange">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="detailed-tab" class="tab-content">
            <div class="item-selector">
                <h2>Detailed Score Impact Calculator</h2>
                <p>Select specific negative items to see exactly how removing each one could impact the credit score. Different items have very different effects on scores.</p>
                
                <div class="form-group" style="max-width: 300px; margin-bottom: 20px;">
                    <label>Current Average Score</label>
                    <input type="number" id="detailedCurrentScore" placeholder="e.g., 580" min="300" max="850" value="550">
                </div>
                
                <h3 style="margin-bottom: 15px;">Selected Items to Remove:</h3>
                <div class="selected-items" id="selectedItems">
                    <span style="color: #999;">Click items below to add them to your calculation</span>
                </div>
                
                <button class="btn-estimate" onclick="calculateDetailedEstimate()" style="margin-bottom: 30px;">Calculate Detailed Estimate</button>
                
                <h3 style="margin-bottom: 15px;">Available Negative Item Types:</h3>
                <div id="itemCategories">
                    <div class="no-data">Loading item types...</div>
                </div>
                
                <div class="detailed-result" id="detailedResult" style="display: none;">
                    <div class="estimate-result show">
                        <h3 style="margin-bottom: 20px;">Projected Improvement</h3>
                        <div class="result-grid">
                            <div class="result-item">
                                <div class="label">Current Score</div>
                                <div class="value" id="detResCurrentScore">--</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Conservative</div>
                                <div class="value teal" id="detResMinScore">--</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Most Likely</div>
                                <div class="value green" id="detResAvgScore">--</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Best Case</div>
                                <div class="value green" id="detResMaxScore">--</div>
                            </div>
                        </div>
                        
                        <h4 style="margin: 25px 0 10px;">Impact Breakdown by Item:</h4>
                        <table class="breakdown-table">
                            <thead>
                                <tr>
                                    <th>Item Type</th>
                                    <th>Count</th>
                                    <th>Impact Per Item</th>
                                    <th>Total Impact</th>
                                    <th>Severity</th>
                                </tr>
                            </thead>
                            <tbody id="breakdownBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="clients-tab" class="tab-content">
            <div class="clients-section">
                <h2>Client Score Progress</h2>
                <div class="search-box">
                    <input type="text" id="searchClients" placeholder="Search clients..." onkeyup="filterClients()">
                </div>
                <div class="client-grid" id="clientGrid">
                    <div class="no-data">Loading clients...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let allClients = [];
        let itemTypes = {};
        let selectedItems = [];
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'clients' && allClients.length === 0) {
                loadClients();
            }
        }
        
        async function loadItemTypes() {
            try {
                const response = await fetch('/api/credit-score/item-types');
                const data = await response.json();
                if (data.success) {
                    itemTypes = data.data.categories;
                    renderItemCategories();
                }
            } catch (error) {
                console.error('Error loading item types:', error);
            }
        }
        
        function renderItemCategories() {
            const container = document.getElementById('itemCategories');
            let html = '';
            
            const categoryOrder = ['payment_history', 'derogatory', 'public_record', 'utilization', 'inquiry', 'error', 'fraud', 'account_status', 'other'];
            
            categoryOrder.forEach(catKey => {
                const category = itemTypes[catKey];
                if (!category) return;
                
                html += `
                    <div class="category-accordion">
                        <div class="category-header" onclick="toggleCategory('${catKey}')">
                            <h3>
                                <span class="category-dot" style="background: ${category.color}"></span>
                                ${category.label}
                            </h3>
                            <span>${category.items.length} items</span>
                        </div>
                        <div class="category-items" id="cat-${catKey}">
                            ${category.items.map(item => `
                                <div class="item-row">
                                    <div class="item-info">
                                        <div class="item-name">${item.label}</div>
                                        <div class="item-desc">${item.description}</div>
                                    </div>
                                    <div class="item-impact">
                                        <div class="points">+${item.impact.avg} pts avg</div>
                                        <div class="range">${item.impact.min}-${item.impact.max} range</div>
                                    </div>
                                    <span class="severity-badge" style="background: ${item.severity_color}20; color: ${item.severity_color}">${item.severity}</span>
                                    <button class="btn-add-item" onclick="addItem('${item.key}', '${item.label}')">+ Add</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function toggleCategory(catKey) {
            const items = document.getElementById(`cat-${catKey}`);
            const header = items.previousElementSibling;
            items.classList.toggle('open');
            header.classList.toggle('open');
        }
        
        function addItem(key, label) {
            const existing = selectedItems.find(i => i.type === key);
            if (existing) {
                existing.count++;
            } else {
                selectedItems.push({ type: key, label: label, count: 1 });
            }
            renderSelectedItems();
        }
        
        function removeItem(key) {
            selectedItems = selectedItems.filter(i => i.type !== key);
            renderSelectedItems();
        }
        
        function updateItemCount(key, count) {
            const item = selectedItems.find(i => i.type === key);
            if (item) {
                item.count = Math.max(1, parseInt(count) || 1);
            }
            renderSelectedItems();
        }
        
        function renderSelectedItems() {
            const container = document.getElementById('selectedItems');
            if (selectedItems.length === 0) {
                container.innerHTML = '<span style="color: #999;">Click items below to add them to your calculation</span>';
                return;
            }
            
            container.innerHTML = selectedItems.map(item => `
                <div class="selected-item">
                    <span>${item.label}</span>
                    <input type="number" class="count-input" value="${item.count}" min="1" max="20" 
                           onchange="updateItemCount('${item.type}', this.value)">
                    <span class="remove" onclick="removeItem('${item.type}')">&times;</span>
                </div>
            `).join('');
        }
        
        async function calculateDetailedEstimate() {
            if (selectedItems.length === 0) {
                alert('Please add at least one item to calculate');
                return;
            }
            
            const currentScore = parseInt(document.getElementById('detailedCurrentScore').value) || 550;
            
            try {
                const response = await fetch('/api/credit-score/estimate-detailed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        current_score: currentScore, 
                        items: selectedItems.map(i => ({ type: i.type, count: i.count }))
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    const result = data.data;
                    document.getElementById('detResCurrentScore').textContent = result.current_score;
                    document.getElementById('detResMinScore').textContent = result.projected.min;
                    document.getElementById('detResAvgScore').textContent = result.projected.avg;
                    document.getElementById('detResMaxScore').textContent = result.projected.max;
                    
                    const tbody = document.getElementById('breakdownBody');
                    tbody.innerHTML = result.item_breakdown.map(item => `
                        <tr>
                            <td><strong>${item.label}</strong></td>
                            <td>${item.count}</td>
                            <td>+${item.impact.per_item} pts</td>
                            <td><strong>+${item.impact.avg} pts</strong></td>
                            <td><span class="severity-badge" style="background: #${getSeverityColor(item.severity)}20; color: #${getSeverityColor(item.severity)}">${item.severity}</span></td>
                        </tr>
                    `).join('');
                    
                    const totalRow = `
                        <tr style="background: #f8f9fa; font-weight: bold;">
                            <td>TOTAL</td>
                            <td>${result.total_items}</td>
                            <td>-</td>
                            <td>+${result.improvement.avg} pts (${result.improvement.min}-${result.improvement.max})</td>
                            <td>-</td>
                        </tr>
                    `;
                    tbody.innerHTML += totalRow;
                    
                    document.getElementById('detailedResult').style.display = 'block';
                }
            } catch (error) {
                console.error('Error calculating detailed estimate:', error);
            }
        }
        
        function getSeverityColor(severity) {
            const colors = {
                'low': '22c55e',
                'moderate': 'eab308',
                'high': 'f97316',
                'severe': 'ef4444',
                'critical': 'dc2626'
            };
            return colors[severity] || 'eab308';
        }
        
        async function loadClients() {
            try {
                const response = await fetch('/api/clients');
                const data = await response.json();
                if (data.success) {
                    allClients = data.clients || [];
                    await loadClientScores();
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                document.getElementById('clientGrid').innerHTML = '<div class="no-data">Error loading clients</div>';
            }
        }
        
        async function loadClientScores() {
            const grid = document.getElementById('clientGrid');
            
            if (allClients.length === 0) {
                grid.innerHTML = '<div class="no-data">No clients found. Add clients to track their credit scores.</div>';
                return;
            }
            
            const clientCards = await Promise.all(allClients.slice(0, 20).map(async (client) => {
                try {
                    const response = await fetch(`/api/credit-score/summary/${client.id}`);
                    const data = await response.json();
                    return { client, summary: data.data };
                } catch {
                    return { client, summary: { has_data: false } };
                }
            }));
            
            grid.innerHTML = clientCards.map(({ client, summary }) => {
                if (!summary.has_data) {
                    return `
                        <div class="client-card" onclick="window.location='/dashboard/credit-tracker/${client.id}'">
                            <h3>${client.name}</h3>
                            <div class="no-data" style="padding: 20px 0;">No score data yet</div>
                            <button class="btn-estimate" style="width: 100%;">Add Score Data</button>
                        </div>
                    `;
                }
                
                const scoreClass = getScoreClass(summary.current_score);
                const progressPct = summary.removal_percentage || 0;
                const gainText = summary.points_gained >= 0 ? `+${summary.points_gained}` : summary.points_gained;
                
                return `
                    <div class="client-card" onclick="window.location='/dashboard/credit-tracker/${client.id}'">
                        <h3>${client.name}</h3>
                        <div class="score-display">
                            <div class="score-box">
                                <div class="label">Starting</div>
                                <div class="score">${summary.starting_score || '--'}</div>
                            </div>
                            <div class="score-box">
                                <div class="label">Current</div>
                                <div class="score ${scoreClass}">${summary.current_score || '--'}</div>
                            </div>
                            <div class="score-box">
                                <div class="label">Gained</div>
                                <div class="score ${summary.points_gained > 0 ? 'excellent' : ''}">${gainText}</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPct}%"></div>
                        </div>
                        <div class="stats-row">
                            <span>${summary.items_removed || 0} of ${summary.starting_negatives || 0} items removed</span>
                            <span class="improvement-badge ${summary.points_gained > 0 ? 'positive' : 'neutral'}">${progressPct}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getScoreClass(score) {
            if (!score) return '';
            if (score >= 800) return 'excellent';
            if (score >= 740) return 'very-good';
            if (score >= 670) return 'good';
            if (score >= 580) return 'fair';
            return 'poor';
        }
        
        function filterClients() {
            const search = document.getElementById('searchClients').value.toLowerCase();
            const cards = document.querySelectorAll('.client-card');
            cards.forEach(card => {
                const name = card.querySelector('h3').textContent.toLowerCase();
                card.style.display = name.includes(search) ? 'block' : 'none';
            });
        }
        
        async function calculateEstimate() {
            const currentScore = parseInt(document.getElementById('currentScore').value) || 550;
            const numNegatives = parseInt(document.getElementById('numNegatives').value) || 0;
            
            try {
                const response = await fetch('/api/credit-score/estimate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_score: currentScore, num_negatives: numNegatives })
                });
                
                const data = await response.json();
                if (data.success) {
                    const result = data.data;
                    document.getElementById('resCurrentScore').textContent = result.current_score;
                    document.getElementById('resProjectedScore').textContent = result.projected.avg;
                    document.getElementById('resPotentialGain').textContent = `+${result.improvement.avg}`;
                    document.getElementById('resNewRange').textContent = result.projected_range;
                    document.getElementById('estimateResult').classList.add('show');
                }
            } catch (error) {
                console.error('Error calculating estimate:', error);
            }
        }
        
        loadItemTypes();
    </script>
    </main>
</body>
</html>
