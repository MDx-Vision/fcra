{% extends "staff/base_staff.html" %}
{% block title %}Clients{% endblock %}

{% block extra_css %}
<style>
    /* Bulk Actions Toolbar */
    .bulk-actions-bar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 20px;
        padding: 16px;
        background: var(--apple-gray-50);
        border-radius: 12px;
        border: 1px solid var(--apple-gray-200);
    }

    .action-btn-toolbar {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 14px;
        background: white;
        border: 1px solid var(--apple-gray-200);
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        color: var(--apple-gray-600);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .action-btn-toolbar:hover {
        background: var(--apple-teal);
        color: white;
        border-color: var(--apple-teal);
    }

    .action-btn-toolbar svg {
        flex-shrink: 0;
        width: 14px;
        height: 14px;
    }

    /* Advanced Filter Tabs */
    .filter-tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

    .filter-tab {
        padding: 8px 16px;
        background: white;
        border: 1px solid var(--apple-gray-200);
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        color: var(--apple-gray-500);
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
    }

    .filter-tab:hover {
        border-color: var(--apple-teal);
        color: var(--apple-teal);
    }

    .filter-tab.active {
        background: var(--apple-teal);
        color: white;
        border-color: var(--apple-teal);
    }

    /* Enhanced Table Styles */
    .clients-table-enhanced {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .clients-table-enhanced th {
        text-align: left;
        padding: 12px 10px;
        background: var(--apple-gray-50);
        font-weight: 600;
        color: var(--apple-gray-600);
        border-bottom: 2px solid var(--apple-gray-200);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .clients-table-enhanced td {
        padding: 12px 10px;
        border-bottom: 1px solid var(--apple-gray-100);
        vertical-align: middle;
    }

    .clients-table-enhanced tr:hover {
        background: var(--apple-gray-50);
    }

    /* Action Icons */
    .action-icons {
        display: flex;
        gap: 4px;
    }

    .icon-btn {
        width: 26px;
        height: 26px;
        border: 1px solid var(--apple-gray-200);
        border-radius: 6px;
        background: white;
        font-size: 11px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--apple-gray-600);
    }

    .icon-btn:hover {
        background: var(--apple-teal);
        color: white;
        border-color: var(--apple-teal);
    }

    .icon-btn.analyze { color: #3b82f6; }
    .icon-btn.case { color: var(--apple-teal); }
    .icon-btn.docs { color: #8b5cf6; }
    .icon-btn.send { color: #f59e0b; }
    .icon-btn.upload { color: #10b981; }
    .icon-btn.portal { color: #ec4899; }

    /* Doc Icons */
    .doc-icons {
        display: flex;
        gap: 4px;
    }

    .doc-icon {
        opacity: 0.25;
        font-size: 14px;
        cursor: help;
    }

    .doc-icon.active {
        opacity: 1;
    }

    /* Status Badge Enhanced */
    .status-badge-enhanced {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        display: inline-block;
    }

    .status-badge-enhanced.active {
        background: rgba(5, 150, 105, 0.12);
        color: var(--apple-green);
    }

    .status-badge-enhanced.lead {
        background: rgba(245, 158, 11, 0.12);
        color: #d97706;
    }

    .status-badge-enhanced.pending {
        background: rgba(59, 130, 246, 0.12);
        color: #3b82f6;
    }

    .status-badge-enhanced.cancelled {
        background: rgba(220, 38, 38, 0.12);
        color: var(--apple-red);
    }

    .status-badge-enhanced.paused {
        background: var(--apple-gray-100);
        color: var(--apple-gray-600);
    }

    .status-badge-enhanced.completed {
        background: rgba(13, 148, 136, 0.12);
        color: var(--apple-teal);
    }

    /* Selection counter */
    .selection-counter {
        display: none;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--apple-navy);
        color: white;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
    }

    .selection-counter.visible {
        display: inline-flex;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Clients</h1>
    <div style="display: flex; gap: 12px; align-items: center;">
        <span class="selection-counter" id="selectionCounter">
            <span id="selectedCount">0</span> selected
        </span>
        <button class="btn btn-secondary" onclick="exportClients()">Export</button>
        <button class="btn btn-primary" onclick="showAddClientModal()">+ Add Client</button>
    </div>
</div>

<!-- Bulk Action Toolbar -->
<div class="bulk-actions-bar">
    <button class="action-btn-toolbar" onclick="selectAllClients()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
        Select All
    </button>
    <button class="action-btn-toolbar" onclick="bulkUpdate()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        Bulk Update
    </button>
    <button class="action-btn-toolbar" onclick="goToInvoices()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>
        Invoices
    </button>
    <button class="action-btn-toolbar" onclick="openMarketing()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><path d="M22 6l-10 7L2 6"/></svg>
        Marketing
    </button>
    <button class="action-btn-toolbar" onclick="openVAManager()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
        VA Manager
    </button>
    <button class="action-btn-toolbar" onclick="openTools()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>
        Tools
    </button>
    <button class="action-btn-toolbar" onclick="openEmails()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><path d="M22 6l-10 7L2 6"/></svg>
        E-mails
    </button>
    <button class="action-btn-toolbar" onclick="postPortals()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>
        Post Portals
    </button>
    <button class="action-btn-toolbar" onclick="openNotes()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>
        My Notes
    </button>
</div>

<!-- Advanced Filter Tabs -->
<div class="filter-tabs">
    <a href="{{ url_for('staff_portal.clients') }}?filter=mark1" class="filter-tab {% if filter == 'mark1' %}active{% endif %}">Mark 1</a>
    <a href="{{ url_for('staff_portal.clients') }}?filter=mark2" class="filter-tab {% if filter == 'mark2' %}active{% endif %}">Mark 2</a>
    <a href="{{ url_for('staff_portal.clients') }}?filter=affiliates" class="filter-tab {% if filter == 'affiliates' %}active{% endif %}">Affiliates</a>
    <a href="{{ url_for('staff_portal.clients') }}?filter=active" class="filter-tab {% if filter == 'active' %}active{% endif %}">Active</a>
    <a href="{{ url_for('staff_portal.clients') }}?filter=leads" class="filter-tab {% if filter == 'leads' %}active{% endif %}">Leads</a>
    <a href="{{ url_for('staff_portal.clients') }}?filter=cancelled" class="filter-tab {% if filter == 'cancelled' %}active{% endif %}">Cancelled</a>
    <a href="{{ url_for('staff_portal.clients') }}?filter=paused" class="filter-tab {% if filter == 'paused' %}active{% endif %}">Paused</a>
    <a href="{{ url_for('staff_portal.clients') }}?filter=followup" class="filter-tab {% if filter == 'followup' %}active{% endif %}">Follow Up</a>
    <a href="{{ url_for('staff_portal.clients') }}?filter=signups" class="filter-tab {% if filter == 'signups' %}active{% endif %}">Signups</a>
    <a href="{{ url_for('staff_portal.clients') }}?filter=last25" class="filter-tab {% if filter == 'last25' %}active{% endif %}">Last 25</a>
    <a href="{{ url_for('staff_portal.clients') }}" class="filter-tab {% if not filter %}active{% endif %}">Show All</a>
</div>

<!-- Search Bar -->
<form method="GET" action="{{ url_for('staff_portal.clients') }}" class="search-bar">
    {% if filter %}<input type="hidden" name="filter" value="{{ filter }}">{% endif %}
    <span style="font-size: 18px; color: var(--apple-gray-400);">Search</span>
    <input type="text" name="search" id="clientSearch" value="{{ search or '' }}" placeholder="Search by name, email, or phone..." autocomplete="off">
    <button type="submit" class="btn btn-primary btn-sm">Search</button>
    {% if search %}
    <a href="{{ url_for('staff_portal.clients') }}{% if filter %}?filter={{ filter }}{% endif %}" class="btn btn-secondary btn-sm">Clear</a>
    {% endif %}
</form>

<!-- Clients Table -->
<div class="card animate-fade-in-up">
    {% if clients %}
    <table class="clients-table-enhanced" id="clientsTable">
        <thead>
            <tr>
                <th style="width: 40px;"><input type="checkbox" id="select-all" onclick="selectAllClients()"></th>
                <th style="width: 160px;">Actions</th>
                <th style="width: 90px;">Docs</th>
                <th>Client</th>
                <th>Status</th>
                <th>Case Score</th>
                <th>Round</th>
                <th>Tags</th>
                <th>Follow Up</th>
                <th>Last Activity</th>
            </tr>
        </thead>
        <tbody>
            {% for client in clients %}
            <tr data-client-id="{{ client.id }}" data-name="{{ client.name|lower }}" data-email="{{ client.email|lower }}">
                <td>
                    <input type="checkbox" name="client_select" value="{{ client.id }}" onchange="updateSelectionCount()">
                </td>
                <td>
                    <div class="action-icons">
                        <button class="icon-btn analyze" title="Analyze Case" onclick="analyzeClient({{ client.id }})">A</button>
                        <button class="icon-btn case" title="View Case" onclick="viewCase({{ client.id }})">C</button>
                        <button class="icon-btn docs" title="Documents" onclick="viewDocs({{ client.id }})">D</button>
                        <button class="icon-btn send" title="Send Letter" onclick="sendLetter({{ client.id }})">S</button>
                        <button class="icon-btn upload" title="Upload" onclick="uploadDoc({{ client.id }})">U</button>
                        <button class="icon-btn portal" title="Client Portal" onclick="viewPortal({{ client.id }})">P</button>
                    </div>
                </td>
                <td>
                    <div class="doc-icons">
                        <span class="doc-icon {% if client.has_credit_report %}active{% endif %}" title="Credit Report">ðŸ“„</span>
                        <span class="doc-icon {% if client.has_id %}active{% endif %}" title="ID Document">ðŸªª</span>
                        <span class="doc-icon {% if client.has_proof %}active{% endif %}" title="Proof of Address">ðŸ“‹</span>
                    </div>
                </td>
                <td>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--apple-teal); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">
                            {{ client.initials }}
                        </div>
                        <div>
                            <div style="font-weight: 600; color: var(--apple-navy-dark); font-size: 13px;">{{ client.name }}</div>
                            <div style="font-size: 11px; color: var(--apple-gray-500);">{{ client.email }}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="status-badge-enhanced {{ client.status_class }}">{{ client.status }}</span>
                </td>
                <td>
                    {% if client.case_score %}
                    <div style="width: 36px; height: 36px; border-radius: 50%; background: {% if client.case_score >= 70 %}var(--apple-green){% elif client.case_score >= 40 %}var(--apple-yellow){% else %}var(--apple-red){% endif %}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 11px;">
                        {{ client.case_score }}
                    </div>
                    {% else %}
                    <span style="color: var(--apple-gray-400);">--</span>
                    {% endif %}
                </td>
                <td>
                    <span style="font-weight: 500; font-size: 13px;">R{{ client.round or 1 }}</span>
                </td>
                <td style="font-size: 12px; color: var(--apple-gray-600);">
                    {{ client.tags or '-' }}
                </td>
                <td style="font-size: 12px; color: var(--apple-gray-600);">
                    {{ client.follow_up_date or '-' }}
                </td>
                <td style="color: var(--apple-gray-500); font-size: 12px;">{{ client.last_activity }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">No clients found</div>
        <p>No clients match your current filter.</p>
        <button class="btn btn-primary" onclick="showAddClientModal()" style="margin-top: 16px;">Add First Client</button>
    </div>
    {% endif %}
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div style="display: flex; justify-content: center; gap: 8px; margin-top: 24px;">
    {% for p in range(1, total_pages + 1) %}
    <a href="{{ url_for('staff_portal.clients') }}?page={{ p }}{% if filter %}&filter={{ filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}"
       class="btn {% if p == page %}btn-primary{% else %}btn-secondary{% endif %} btn-sm">{{ p }}</a>
    {% endfor %}
</div>
{% endif %}

<!-- Add Client Modal -->
<div id="addClientModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 500; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 32px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="font-family: var(--font-display); font-size: 24px; color: var(--apple-navy-dark);">Add New Client</h2>
            <button onclick="hideAddClientModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--apple-gray-400);">&times;</button>
        </div>
        <form action="{{ url_for('staff_portal.add_client') }}" method="POST">
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--apple-gray-700);">First Name</label>
                <input type="text" name="first_name" required style="width: 100%; padding: 12px; border: 1px solid var(--apple-gray-300); border-radius: 8px;">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--apple-gray-700);">Last Name</label>
                <input type="text" name="last_name" required style="width: 100%; padding: 12px; border: 1px solid var(--apple-gray-300); border-radius: 8px;">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--apple-gray-700);">Email</label>
                <input type="email" name="email" required style="width: 100%; padding: 12px; border: 1px solid var(--apple-gray-300); border-radius: 8px;">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--apple-gray-700);">Phone</label>
                <input type="tel" name="phone" style="width: 100%; padding: 12px; border: 1px solid var(--apple-gray-300); border-radius: 8px;">
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" onclick="hideAddClientModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Client</button>
            </div>
        </form>
    </div>
</div>

<!-- Quick Actions Modal -->
<div id="quickActionsModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 500; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; max-width: 400px; width: 90%; padding: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="font-family: var(--font-display); font-size: 20px; color: var(--apple-navy-dark);">Quick Actions</h3>
            <button onclick="hideQuickActions()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--apple-gray-400);">&times;</button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 12px;" id="quickActionsContent">
            <a href="#" class="btn btn-secondary" style="justify-content: flex-start;" id="actionViewCase">View Full Case</a>
            <a href="#" class="btn btn-secondary" style="justify-content: flex-start;" id="actionGenerateLetter">Generate Letter</a>
            <a href="#" class="btn btn-secondary" style="justify-content: flex-start;" id="actionUploadDoc">Upload Document</a>
            <a href="#" class="btn btn-secondary" style="justify-content: flex-start;" id="actionSendEmail">Send Email</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Modal Functions
function showAddClientModal() {
    document.getElementById('addClientModal').style.display = 'flex';
}

function hideAddClientModal() {
    document.getElementById('addClientModal').style.display = 'none';
}

function quickAction(clientId) {
    document.getElementById('actionViewCase').href = '/staff/clients/' + clientId;
    document.getElementById('actionGenerateLetter').href = '/staff/clients/' + clientId + '#letters';
    document.getElementById('actionUploadDoc').href = '/staff/clients/' + clientId + '#documents';
    document.getElementById('actionSendEmail').href = '/staff/clients/' + clientId + '#communication';
    document.getElementById('quickActionsModal').style.display = 'flex';
}

function hideQuickActions() {
    document.getElementById('quickActionsModal').style.display = 'none';
}

// Bulk Selection Functions
function selectAllClients() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"][name="client_select"]');
    const selectAllCheckbox = document.getElementById('select-all');
    const allChecked = selectAllCheckbox.checked;
    checkboxes.forEach(cb => cb.checked = allChecked);
    updateSelectionCount();
}

function updateSelectionCount() {
    const selected = getSelectedClients();
    const counter = document.getElementById('selectionCounter');
    const countSpan = document.getElementById('selectedCount');
    countSpan.textContent = selected.length;
    if (selected.length > 0) {
        counter.classList.add('visible');
    } else {
        counter.classList.remove('visible');
    }
}

function getSelectedClients() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"][name="client_select"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

// Bulk Action Functions
function bulkUpdate() {
    const selected = getSelectedClients();
    if (selected.length === 0) {
        alert('Please select at least one client');
        return;
    }
    window.location.href = '/staff/clients/bulk-update?ids=' + selected.join(',');
}

function goToInvoices() {
    window.location.href = '/staff/invoices';
}

function openMarketing() {
    window.location.href = '/staff/marketing';
}

function openVAManager() {
    window.location.href = '/staff/va-manager';
}

function openTools() {
    alert('Tools menu coming soon');
}

function openEmails() {
    const selected = getSelectedClients();
    window.location.href = '/staff/emails' + (selected.length ? '?client_ids=' + selected.join(',') : '');
}

function postPortals() {
    const selected = getSelectedClients();
    if (selected.length === 0) {
        alert('Please select at least one client');
        return;
    }
    window.location.href = '/staff/post-portals?ids=' + selected.join(',');
}

function openNotes() {
    window.location.href = '/staff/notes';
}

// Client Action Functions (Quick Icon Buttons)
function analyzeClient(id) {
    window.location.href = '/staff/clients/' + id + '/analyze';
}

function viewCase(id) {
    window.location.href = '/staff/clients/' + id;
}

function viewDocs(id) {
    window.location.href = '/staff/clients/' + id + '#documents';
}

function sendLetter(id) {
    window.location.href = '/staff/clients/' + id + '/send-letter';
}

function uploadDoc(id) {
    window.location.href = '/staff/clients/' + id + '/upload';
}

function viewPortal(id) {
    window.open('/portal/?client_id=' + id, '_blank');
}

// Search and Filter Functions
function filterClients(query) {
    const rows = document.querySelectorAll('#clientsTable tbody tr');
    const q = query.toLowerCase();
    rows.forEach(row => {
        const name = row.dataset.name || '';
        const email = row.dataset.email || '';
        if (name.includes(q) || email.includes(q)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function exportClients() {
    window.location.href = '{{ url_for("staff_portal.export_clients") }}?filter={{ filter }}{% if search %}&search={{ search }}{% endif %}';
}

function sortClients(sortBy) {
    window.location.href = '{{ url_for("staff_portal.clients") }}?filter={{ filter }}{% if search %}&search={{ search }}{% endif %}&sort=' + sortBy;
}

// Close modals on backdrop click
document.getElementById('addClientModal').addEventListener('click', function(e) {
    if (e.target === this) hideAddClientModal();
});
document.getElementById('quickActionsModal').addEventListener('click', function(e) {
    if (e.target === this) hideQuickActions();
});
</script>
{% endblock %}
