<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ furnisher.name }} - Furnisher Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    {% include 'includes/dashboard_sidebar_styles.html' %}
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        .main-content { margin-left: 260px; padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { font-size: 28px; font-weight: 700; color: #1a1a2e; }
        .btn {
            padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px;
            font-weight: 600; cursor: pointer; display: inline-flex; align-items: center;
            gap: 8px; text-decoration: none; transition: all 0.2s;
        }
        .btn-primary { background: linear-gradient(135deg, #319795 0%, #84cc16 100%); color: #1a1a2e; }
        .btn-secondary { background: white; color: #1a1a2e; border: 2px solid #e2e8f0; }
        .btn-secondary:hover { border-color: #84cc16; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card-title { font-size: 18px; font-weight: 600; color: #1a1a2e; margin-bottom: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; }
        .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: #64748b; font-size: 14px; }
        .info-value { color: #1a1a2e; font-weight: 500; font-size: 14px; text-align: right; }
        .full-width { grid-column: 1 / -1; }
        .strategy-box {
            background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%);
            border: 2px solid #84cc16;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .strategy-title { font-weight: 600; color: #166534; font-size: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .strategy-text { color: #166534; font-size: 14px; line-height: 1.6; }
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #f8fafc; border-radius: 10px; padding: 15px; text-align: center; }
        .stat-box-value { font-size: 24px; font-weight: 700; color: #1a1a2e; }
        .stat-box-label { font-size: 11px; color: #64748b; text-transform: uppercase; margin-top: 5px; }
        .round-chart { display: flex; gap: 15px; margin-top: 20px; }
        .round-bar { flex: 1; }
        .round-bar-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .round-bar-title { font-size: 13px; font-weight: 600; color: #1a1a2e; }
        .round-bar-value { font-size: 13px; font-weight: 600; color: #84cc16; }
        .round-bar-track { height: 24px; background: #e2e8f0; border-radius: 12px; overflow: hidden; display: flex; }
        .round-bar-deleted { background: #84cc16; height: 100%; }
        .round-bar-updated { background: #3b82f6; height: 100%; }
        .round-bar-verified { background: #ef4444; height: 100%; }
        .legend { display: flex; gap: 20px; margin-top: 15px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #64748b; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
        .legend-dot.deleted { background: #84cc16; }
        .legend-dot.updated { background: #3b82f6; }
        .legend-dot.verified { background: #ef4444; }
        .client-list { margin-top: 15px; }
        .client-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px;
            cursor: pointer; transition: all 0.2s;
        }
        .client-item:hover { background: #f1f5f9; }
        .client-name { font-weight: 500; color: #1a1a2e; }
        .client-status { font-size: 12px; padding: 4px 10px; border-radius: 12px; }
        .status-deleted { background: #dcfce7; color: #166534; }
        .status-updated { background: #dbeafe; color: #1e40af; }
        .status-sent { background: #fef3c7; color: #92400e; }
        .status-verified { background: #fee2e2; color: #991b1b; }
        .industry-badge {
            display: inline-block; padding: 4px 12px; border-radius: 12px;
            font-size: 12px; font-weight: 500; text-transform: capitalize;
        }
        .industry-bank { background: #dbeafe; color: #1e40af; }
        .industry-collection_agency { background: #fee2e2; color: #991b1b; }
        .industry-credit_card { background: #dcfce7; color: #166534; }
        .industry-auto_loan { background: #fef3c7; color: #92400e; }
        .industry-mortgage { background: #f3e8ff; color: #7c3aed; }
        .industry-medical { background: #fce7f3; color: #be185d; }
        .industry-utility { background: #e0e7ff; color: #3730a3; }
        .industry-student_loan { background: #cffafe; color: #0e7490; }
        .industry-other { background: #f1f5f9; color: #475569; }
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white; border-radius: 16px; width: 600px; max-width: 90vw;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-header { padding: 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 20px; font-weight: 600; color: #1a1a2e; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; }
        .modal-body { padding: 24px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; color: #1a1a2e; margin-bottom: 8px; }
        .form-input {
            width: 100%; padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 8px;
            font-size: 14px;
        }
        .form-input:focus { outline: none; border-color: #84cc16; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .modal-footer { padding: 20px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 10px; }
        @media (max-width: 1200px) {
            .grid { grid-template-columns: 1fr; }
            .grid-3 { grid-template-columns: 1fr; }
            .stat-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    {% set active_page = 'furnishers' %}
    {% include 'includes/dashboard_sidebar.html' %}
    
    <main class="main-content">
        <div class="header">
            <div>
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 5px;">
                    <h1>{{ furnisher.name }}</h1>
                    {% if furnisher.industry %}
                    <span class="industry-badge industry-{{ furnisher.industry }}">{{ furnisher.industry.replace('_', ' ') }}</span>
                    {% endif %}
                </div>
                {% if furnisher.parent_company %}
                <p style="color: #64748b;">Subsidiary of {{ furnisher.parent_company }}</p>
                {% endif %}
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="openEditModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    Edit
                </button>
                <a href="/dashboard/furnishers" class="btn btn-secondary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                    Back
                </a>
            </div>
        </div>
        
        <div class="strategy-box">
            <div class="strategy-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                Recommended Strategy
            </div>
            <div class="strategy-text">{{ strategy }}</div>
        </div>
        
        <div class="stat-grid">
            <div class="stat-box">
                <div class="stat-box-value">{{ stats.total_disputes if stats else 0 }}</div>
                <div class="stat-box-label">Total Disputes</div>
            </div>
            <div class="stat-box">
                <div class="stat-box-value">{{ "%.1f"|format(stats.avg_response_days) if stats and stats.avg_response_days else '—' }}</div>
                <div class="stat-box-label">Avg Response Days</div>
            </div>
            <div class="stat-box">
                <div class="stat-box-value">{{ stats.settlement_count if stats else 0 }}</div>
                <div class="stat-box-label">Settlements</div>
            </div>
            <div class="stat-box">
                <div class="stat-box-value">${{ "{:,.0f}".format(stats.settlement_avg) if stats and stats.settlement_avg else '0' }}</div>
                <div class="stat-box-label">Avg Settlement</div>
            </div>
        </div>
        
        <div class="grid">
            <div class="card">
                <div class="card-title">Dispute Outcomes by Round</div>
                {% if stats and stats.total_disputes > 0 %}
                {% set r1_total = (stats.round_1_verified or 0) + (stats.round_1_deleted or 0) + (stats.round_1_updated or 0) %}
                {% set r2_total = (stats.round_2_verified or 0) + (stats.round_2_deleted or 0) + (stats.round_2_updated or 0) %}
                {% set r3_total = (stats.round_3_verified or 0) + (stats.round_3_deleted or 0) + (stats.round_3_updated or 0) %}
                
                <div class="round-chart">
                    <div class="round-bar">
                        <div class="round-bar-header">
                            <span class="round-bar-title">Round 1</span>
                            <span class="round-bar-value">{% if r1_total > 0 %}{{ ((stats.round_1_deleted or 0) / r1_total * 100)|round(0)|int }}% deleted{% else %}No data{% endif %}</span>
                        </div>
                        <div class="round-bar-track">
                            {% if r1_total > 0 %}
                            <div class="round-bar-deleted" style="width: {{ ((stats.round_1_deleted or 0) / r1_total * 100)|round(0)|int }}%"></div>
                            <div class="round-bar-updated" style="width: {{ ((stats.round_1_updated or 0) / r1_total * 100)|round(0)|int }}%"></div>
                            <div class="round-bar-verified" style="width: {{ ((stats.round_1_verified or 0) / r1_total * 100)|round(0)|int }}%"></div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="round-bar">
                        <div class="round-bar-header">
                            <span class="round-bar-title">Round 2</span>
                            <span class="round-bar-value">{% if r2_total > 0 %}{{ ((stats.round_2_deleted or 0) / r2_total * 100)|round(0)|int }}% deleted{% else %}No data{% endif %}</span>
                        </div>
                        <div class="round-bar-track">
                            {% if r2_total > 0 %}
                            <div class="round-bar-deleted" style="width: {{ ((stats.round_2_deleted or 0) / r2_total * 100)|round(0)|int }}%"></div>
                            <div class="round-bar-updated" style="width: {{ ((stats.round_2_updated or 0) / r2_total * 100)|round(0)|int }}%"></div>
                            <div class="round-bar-verified" style="width: {{ ((stats.round_2_verified or 0) / r2_total * 100)|round(0)|int }}%"></div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="round-bar">
                        <div class="round-bar-header">
                            <span class="round-bar-title">Round 3+</span>
                            <span class="round-bar-value">{% if r3_total > 0 %}{{ ((stats.round_3_deleted or 0) / r3_total * 100)|round(0)|int }}% deleted{% else %}No data{% endif %}</span>
                        </div>
                        <div class="round-bar-track">
                            {% if r3_total > 0 %}
                            <div class="round-bar-deleted" style="width: {{ ((stats.round_3_deleted or 0) / r3_total * 100)|round(0)|int }}%"></div>
                            <div class="round-bar-updated" style="width: {{ ((stats.round_3_updated or 0) / r3_total * 100)|round(0)|int }}%"></div>
                            <div class="round-bar-verified" style="width: {{ ((stats.round_3_verified or 0) / r3_total * 100)|round(0)|int }}%"></div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-dot deleted"></div> Deleted</div>
                    <div class="legend-item"><div class="legend-dot updated"></div> Updated</div>
                    <div class="legend-item"><div class="legend-dot verified"></div> Verified (No Change)</div>
                </div>
                {% else %}
                <p style="color: #94a3b8; text-align: center; padding: 40px;">No dispute data available yet</p>
                {% endif %}
            </div>
            
            <div class="card">
                <div class="card-title">Contact Information</div>
                <div class="info-row">
                    <span class="info-label">Address</span>
                    <span class="info-value">{{ furnisher.address or '—' }}</span>
                </div>
                {% if furnisher.dispute_address %}
                <div class="info-row">
                    <span class="info-label">Dispute Address</span>
                    <span class="info-value">{{ furnisher.dispute_address }}</span>
                </div>
                {% endif %}
                <div class="info-row">
                    <span class="info-label">Phone</span>
                    <span class="info-value">{{ furnisher.phone or '—' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Fax</span>
                    <span class="info-value">{{ furnisher.fax or '—' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email</span>
                    <span class="info-value">{{ furnisher.email or '—' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Website</span>
                    <span class="info-value">
                        {% if furnisher.website %}
                        <a href="{{ furnisher.website if furnisher.website.startswith('http') else 'https://' + furnisher.website }}" target="_blank" style="color: #319795;">{{ furnisher.website }}</a>
                        {% else %}—{% endif %}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="grid">
            <div class="card">
                <div class="card-title">Method of Verification (MOV)</div>
                {% if stats and stats.mov_requests_sent > 0 %}
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #1a1a2e;">{{ stats.mov_requests_sent }}</div>
                        <div style="font-size: 12px; color: #64748b;">MOV Requests</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #84cc16;">{{ stats.mov_provided or 0 }}</div>
                        <div style="font-size: 12px; color: #64748b;">MOV Provided</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #ef4444;">{{ stats.mov_failed or 0 }}</div>
                        <div style="font-size: 12px; color: #64748b;">MOV Failed</div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: {{ '#dcfce7' if (stats.mov_failed or 0) > (stats.mov_provided or 0) else '#fee2e2' }}; border-radius: 8px; text-align: center;">
                    <span style="font-weight: 600; color: {{ '#166534' if (stats.mov_failed or 0) > (stats.mov_provided or 0) else '#991b1b' }};">
                        {% if (stats.mov_failed or 0) > (stats.mov_provided or 0) %}
                        High MOV failure rate - Good target for MOV demands
                        {% else %}
                        Usually provides MOV - Consider alternative strategies
                        {% endif %}
                    </span>
                </div>
                {% else %}
                <p style="color: #94a3b8; text-align: center; padding: 40px;">No MOV data available yet</p>
                {% endif %}
            </div>
            
            <div class="card">
                <div class="card-title">Violations & Issues</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                    <div style="padding: 20px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 32px; font-weight: 700; color: #ef4444;">{{ stats.violation_count if stats else 0 }}</div>
                        <div style="font-size: 12px; color: #64748b;">FCRA Violations</div>
                    </div>
                    <div style="padding: 20px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 32px; font-weight: 700; color: #f97316;">{{ stats.reinsertion_count if stats else 0 }}</div>
                        <div style="font-size: 12px; color: #64748b;">Reinsertions</div>
                    </div>
                </div>
                {% if stats and (stats.violation_count or stats.reinsertion_count) %}
                <div style="margin-top: 15px; padding: 15px; background: #fee2e2; border-radius: 8px; text-align: center;">
                    <span style="font-weight: 600; color: #991b1b;">
                        History of violations - Document everything carefully
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">Related Cases ({{ related_clients|length }})</div>
            {% if related_clients %}
            <div class="client-list">
                {% for client in related_clients %}
                <div class="client-item" onclick="window.location.href='/dashboard/client/{{ client.id }}'">
                    <div>
                        <div class="client-name">{{ client.name }}</div>
                        <div style="font-size: 12px; color: #64748b;">Round {{ client.dispute_round or 1 }}</div>
                    </div>
                    <span class="client-status status-{{ client.status or 'sent' }}">{{ (client.status or 'Pending')|replace('_', ' ')|title }}</span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="color: #94a3b8; text-align: center; padding: 40px;">No related cases found</p>
            {% endif %}
        </div>
        
        {% if furnisher.notes %}
        <div class="card">
            <div class="card-title">Notes</div>
            <p style="color: #334155; line-height: 1.6;">{{ furnisher.notes }}</p>
        </div>
        {% endif %}
    </main>
    
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Edit Furnisher</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Company Name *</label>
                    <input type="text" id="editName" class="form-input" value="{{ furnisher.name }}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Industry</label>
                        <select id="editIndustry" class="form-input">
                            <option value="">Select...</option>
                            {% for ind in industries %}
                            <option value="{{ ind }}" {% if furnisher.industry == ind %}selected{% endif %}>{{ ind.replace('_', ' ').title() }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Parent Company</label>
                        <input type="text" id="editParent" class="form-input" value="{{ furnisher.parent_company or '' }}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Mailing Address</label>
                    <textarea id="editAddress" class="form-input" rows="2">{{ furnisher.address or '' }}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Dispute Address (if different)</label>
                    <textarea id="editDisputeAddress" class="form-input" rows="2">{{ furnisher.dispute_address or '' }}</textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="text" id="editPhone" class="form-input" value="{{ furnisher.phone or '' }}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fax</label>
                        <input type="text" id="editFax" class="form-input" value="{{ furnisher.fax or '' }}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="editEmail" class="form-input" value="{{ furnisher.email or '' }}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="text" id="editWebsite" class="form-input" value="{{ furnisher.website or '' }}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="editNotes" class="form-input" rows="3">{{ furnisher.notes or '' }}</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveFurnisher()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <script>
        const furnisherId = {{ furnisher.id }};
        
        function openEditModal() {
            document.getElementById('editModal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }
        
        async function saveFurnisher() {
            const name = document.getElementById('editName').value.trim();
            if (!name) {
                alert('Furnisher name is required');
                return;
            }
            
            const data = {
                name: name,
                industry: document.getElementById('editIndustry').value,
                parent_company: document.getElementById('editParent').value,
                address: document.getElementById('editAddress').value,
                dispute_address: document.getElementById('editDisputeAddress').value,
                phone: document.getElementById('editPhone').value,
                fax: document.getElementById('editFax').value,
                email: document.getElementById('editEmail').value,
                website: document.getElementById('editWebsite').value,
                notes: document.getElementById('editNotes').value
            };
            
            try {
                const response = await fetch(`/api/furnishers/${furnisherId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    window.location.reload();
                } else {
                    alert(result.error || 'Failed to update furnisher');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to update furnisher');
            }
        }
    </script>
</body>
</html>