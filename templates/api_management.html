<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Management - Brightpath Ascend FCRA Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    {% include 'includes/dashboard_sidebar_styles.html' %}
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        
        .main-content {
            margin-left: 260px;
            padding: 30px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a2e;
        }
        .header-actions { display: flex; gap: 15px; }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #319795 0%, #84cc16 100%);
            color: #1a1a2e;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(49, 151, 149, 0.4); }
        .btn-secondary {
            background: white;
            color: #1a1a2e;
            border: 2px solid #e2e8f0;
        }
        .btn-secondary:hover { border-color: #84cc16; }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-card.highlight {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
        }
        .stat-card h3 {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .stat-card.highlight h3 { color: #94a3b8; }
        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a2e;
        }
        .stat-card.highlight .stat-value { color: white; }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a2e;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th, .table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .table th {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .table td { font-size: 14px; color: #1a1a2e; }
        .table tr:hover { background: #f8fafc; }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-success { background: #dcfce7; color: #15803d; }
        .badge-warning { background: #fef3c7; color: #b45309; }
        .badge-danger { background: #fee2e2; color: #dc2626; }
        .badge-info { background: #e0f2fe; color: #0369a1; }
        
        .scope-tag {
            display: inline-block;
            padding: 3px 8px;
            background: #f1f5f9;
            border-radius: 4px;
            font-size: 11px;
            font-family: 'Monaco', 'Consolas', monospace;
            color: #475569;
            margin: 2px;
        }
        
        .key-prefix {
            font-family: 'Monaco', 'Consolas', monospace;
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .modal-title { font-size: 20px; font-weight: 600; color: #1a1a2e; }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }
        
        .form-group { margin-bottom: 20px; }
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #319795;
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
        }
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #319795;
        }
        .checkbox-item label {
            font-size: 13px;
            color: #374151;
        }
        
        .api-key-display {
            background: #1a1a2e;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .api-key-display code {
            color: #84cc16;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            word-break: break-all;
        }
        .copy-btn {
            background: #319795;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
        }
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            border-radius: 8px;
        }
        .tab:hover { background: #f1f5f9; }
        .tab.active { background: #319795; color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .usage-chart {
            height: 200px;
            background: linear-gradient(180deg, #f0fdf4 0%, white 100%);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            margin-top: 16px;
        }
        .chart-bar {
            flex: 1;
            background: linear-gradient(180deg, #319795 0%, #84cc16 100%);
            border-radius: 4px 4px 0 0;
            min-height: 10px;
            position: relative;
        }
        .chart-bar:hover { opacity: 0.8; }
        .chart-bar-label {
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #64748b;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }
        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        .empty-state h3 {
            font-size: 18px;
            color: #374151;
            margin-bottom: 8px;
        }
        
        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .stats-grid { grid-template-columns: 1fr; }
            .checkbox-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    {% set active_page = 'api-keys' %}
    {% include 'includes/dashboard_sidebar.html' %}

    <main class="main-content">
        <div class="header">
            <h1>API Management</h1>
            <div class="header-actions">
                <a href="/dashboard/api-docs" class="btn btn-secondary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    View API Docs
                </a>
                <button class="btn btn-primary" onclick="openModal('createKeyModal')">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Generate API Key
                </button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card highlight">
                <h3>Total API Keys</h3>
                <div class="stat-value">{{ stats.total_keys }}</div>
            </div>
            <div class="stat-card">
                <h3>Active Keys</h3>
                <div class="stat-value">{{ stats.active_keys }}</div>
            </div>
            <div class="stat-card">
                <h3>Total Webhooks</h3>
                <div class="stat-value">{{ stats.total_webhooks }}</div>
            </div>
            <div class="stat-card">
                <h3>Active Webhooks</h3>
                <div class="stat-value">{{ stats.active_webhooks }}</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('keys')">API Keys</button>
            <button class="tab" onclick="switchTab('webhooks')">Webhooks</button>
            <button class="tab" onclick="switchTab('usage')">Usage Analytics</button>
        </div>

        <div id="keys-tab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">API Keys</h2>
                </div>
                {% if api_keys %}
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Key Prefix</th>
                            <th>Scopes</th>
                            <th>Rate Limits</th>
                            <th>Status</th>
                            <th>Last Used</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key in api_keys %}
                        <tr>
                            <td><strong>{{ key.name }}</strong></td>
                            <td><span class="key-prefix">{{ key.key_prefix }}...</span></td>
                            <td>
                                {% for scope in (key.scopes or [])[:3] %}
                                <span class="scope-tag">{{ scope }}</span>
                                {% endfor %}
                                {% if (key.scopes or [])|length > 3 %}
                                <span class="scope-tag">+{{ (key.scopes or [])|length - 3 }} more</span>
                                {% endif %}
                            </td>
                            <td>{{ key.rate_limit_per_minute }}/min, {{ key.rate_limit_per_day }}/day</td>
                            <td>
                                {% if key.is_active %}
                                <span class="badge badge-success">Active</span>
                                {% else %}
                                <span class="badge badge-danger">Revoked</span>
                                {% endif %}
                            </td>
                            <td>{{ key.last_used_at.strftime('%Y-%m-%d %H:%M') if key.last_used_at else 'Never' }}</td>
                            <td>{{ key.created_at.strftime('%Y-%m-%d') if key.created_at else 'N/A' }}</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="viewKeyUsage({{ key.id }})">Usage</button>
                                {% if key.is_active %}
                                <button class="btn btn-danger btn-sm" onclick="revokeKey({{ key.id }}, '{{ key.name }}')">Revoke</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
                    <h3>No API Keys</h3>
                    <p>Create your first API key to enable third-party integrations.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div id="webhooks-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Webhooks</h2>
                    <button class="btn btn-primary btn-sm" onclick="openModal('createWebhookModal')">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Add Webhook
                    </button>
                </div>
                {% if webhooks %}
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>URL</th>
                            <th>Events</th>
                            <th>Status</th>
                            <th>Last Triggered</th>
                            <th>Failures</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for webhook in webhooks %}
                        <tr>
                            <td><strong>{{ webhook.name }}</strong></td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">{{ webhook.url }}</td>
                            <td>
                                {% for event in (webhook.events or [])[:2] %}
                                <span class="scope-tag">{{ event }}</span>
                                {% endfor %}
                                {% if (webhook.events or [])|length > 2 %}
                                <span class="scope-tag">+{{ (webhook.events or [])|length - 2 }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if webhook.is_active %}
                                <span class="badge badge-success">Active</span>
                                {% else %}
                                <span class="badge badge-danger">Disabled</span>
                                {% endif %}
                            </td>
                            <td>{{ webhook.last_triggered.strftime('%Y-%m-%d %H:%M') if webhook.last_triggered else 'Never' }}</td>
                            <td>
                                {% if webhook.failure_count > 0 %}
                                <span class="badge badge-warning">{{ webhook.failure_count }}</span>
                                {% else %}
                                <span class="badge badge-success">0</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteWebhook({{ webhook.id }}, '{{ webhook.name }}')">Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                    <h3>No Webhooks</h3>
                    <p>Add webhooks to receive real-time notifications about platform events.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div id="usage-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">API Usage Analytics</h2>
                </div>
                <div id="usageContent">
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <h3>Select an API Key</h3>
                        <p>Click "Usage" on an API key to view detailed analytics.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="createKeyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Generate New API Key</h2>
                <button class="modal-close" onclick="closeModal('createKeyModal')">&times;</button>
            </div>
            <form id="createKeyForm" onsubmit="createApiKey(event)">
                <div class="form-group">
                    <label class="form-label">Key Name *</label>
                    <input type="text" name="name" class="form-input" placeholder="e.g., Production Integration" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Scopes</label>
                    <div class="checkbox-grid">
                        {% for scope in scopes %}
                        <div class="checkbox-item">
                            <input type="checkbox" name="scopes" value="{{ scope }}" id="scope_{{ loop.index }}">
                            <label for="scope_{{ loop.index }}">{{ scope }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Rate Limit (per minute)</label>
                    <input type="number" name="rate_limit_per_minute" class="form-input" value="60" min="1" max="1000">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Rate Limit (per day)</label>
                    <input type="number" name="rate_limit_per_day" class="form-input" value="10000" min="1" max="1000000">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Expires In (days, leave empty for no expiration)</label>
                    <input type="number" name="expires_in_days" class="form-input" placeholder="e.g., 365" min="1">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Generate API Key</button>
            </form>
        </div>
    </div>

    <div id="keyCreatedModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">API Key Created Successfully</h2>
                <button class="modal-close" onclick="closeModal('keyCreatedModal'); location.reload();">&times;</button>
            </div>
            <p style="color: #dc2626; font-weight: 500; margin-bottom: 16px;">
                Store this API key securely - it will not be shown again!
            </p>
            <div class="api-key-display">
                <code id="newApiKey"></code>
            </div>
            <button class="copy-btn" onclick="copyApiKey()">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline; vertical-align: middle; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                Copy to Clipboard
            </button>
        </div>
    </div>

    <div id="createWebhookModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create Webhook</h2>
                <button class="modal-close" onclick="closeModal('createWebhookModal')">&times;</button>
            </div>
            <form id="createWebhookForm" onsubmit="createWebhook(event)">
                <div class="form-group">
                    <label class="form-label">Webhook Name *</label>
                    <input type="text" name="name" class="form-input" placeholder="e.g., Slack Notifications" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">URL *</label>
                    <input type="url" name="url" class="form-input" placeholder="https://your-server.com/webhook" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Events</label>
                    <div class="checkbox-grid">
                        {% for event in webhook_events %}
                        <div class="checkbox-item">
                            <input type="checkbox" name="events" value="{{ event }}" id="event_{{ loop.index }}">
                            <label for="event_{{ loop.index }}">{{ event }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Create Webhook</button>
            </form>
        </div>
    </div>

    <script>
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        }
        
        async function createApiKey(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            const scopes = Array.from(form.querySelectorAll('input[name="scopes"]:checked')).map(cb => cb.value);
            
            const data = {
                name: formData.get('name'),
                scopes: scopes,
                rate_limit_per_minute: parseInt(formData.get('rate_limit_per_minute')) || 60,
                rate_limit_per_day: parseInt(formData.get('rate_limit_per_day')) || 10000
            };
            
            const expiresIn = formData.get('expires_in_days');
            if (expiresIn) {
                data.expires_in_days = parseInt(expiresIn);
            }
            
            try {
                const response = await fetch('/api/keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('createKeyModal');
                    document.getElementById('newApiKey').textContent = result.api_key;
                    openModal('keyCreatedModal');
                    form.reset();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error creating API key: ' + err.message);
            }
        }
        
        function copyApiKey() {
            const key = document.getElementById('newApiKey').textContent;
            navigator.clipboard.writeText(key).then(() => {
                alert('API key copied to clipboard!');
            });
        }
        
        async function revokeKey(keyId, keyName) {
            if (!confirm(`Are you sure you want to revoke the API key "${keyName}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/keys/${keyId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error revoking key: ' + err.message);
            }
        }
        
        async function viewKeyUsage(keyId) {
            switchTab('usage');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[2].classList.add('active');
            
            const usageContent = document.getElementById('usageContent');
            usageContent.innerHTML = '<div class="empty-state"><p>Loading usage data...</p></div>';
            
            try {
                const response = await fetch(`/api/keys/${keyId}/usage?days=30`);
                const result = await response.json();
                
                if (result.success) {
                    const dailyUsage = result.daily_usage || {};
                    const dates = Object.keys(dailyUsage).slice(-14);
                    const maxCount = Math.max(...Object.values(dailyUsage), 1);
                    
                    let barsHtml = dates.map(date => {
                        const count = dailyUsage[date] || 0;
                        const height = (count / maxCount * 150) + 10;
                        return `<div class="chart-bar" style="height: ${height}px;" title="${date}: ${count} requests">
                            <span class="chart-bar-label">${date.slice(-5)}</span>
                        </div>`;
                    }).join('');
                    
                    if (!barsHtml) {
                        barsHtml = '<div class="empty-state" style="flex: 1;"><p>No usage data yet</p></div>';
                    }
                    
                    usageContent.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                            <div class="stat-card">
                                <h3>Total Requests</h3>
                                <div class="stat-value">${result.total_requests || 0}</div>
                            </div>
                            <div class="stat-card">
                                <h3>Success Rate</h3>
                                <div class="stat-value">${(result.success_rate || 0).toFixed(1)}%</div>
                            </div>
                            <div class="stat-card">
                                <h3>Avg Response Time</h3>
                                <div class="stat-value">${(result.avg_response_time_ms || 0).toFixed(0)}ms</div>
                            </div>
                            <div class="stat-card">
                                <h3>Errors</h3>
                                <div class="stat-value">${result.error_requests || 0}</div>
                            </div>
                        </div>
                        <h3 style="margin-bottom: 12px; color: #374151;">Daily Requests (Last 14 Days)</h3>
                        <div class="usage-chart">${barsHtml}</div>
                        <h3 style="margin: 24px 0 12px; color: #374151;">Top Endpoints</h3>
                        <table class="table">
                            <thead><tr><th>Endpoint</th><th>Requests</th></tr></thead>
                            <tbody>
                                ${Object.entries(result.top_endpoints || {}).map(([ep, count]) => 
                                    `<tr><td>${ep}</td><td>${count}</td></tr>`
                                ).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    usageContent.innerHTML = `<div class="empty-state"><p>Error: ${result.error}</p></div>`;
                }
            } catch (err) {
                usageContent.innerHTML = `<div class="empty-state"><p>Error loading usage data: ${err.message}</p></div>`;
            }
        }
        
        async function createWebhook(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            const events = Array.from(form.querySelectorAll('input[name="events"]:checked')).map(cb => cb.value);
            
            if (events.length === 0) {
                alert('Please select at least one event');
                return;
            }
            
            const data = {
                name: formData.get('name'),
                url: formData.get('url'),
                events: events
            };
            
            try {
                const response = await fetch('/api/webhooks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Webhook created! Secret: ' + result.secret + '\n\nStore this secret securely!');
                    closeModal('createWebhookModal');
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error creating webhook: ' + err.message);
            }
        }
        
        async function deleteWebhook(webhookId, webhookName) {
            if (!confirm(`Are you sure you want to delete the webhook "${webhookName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/webhooks/${webhookId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error deleting webhook: ' + err.message);
            }
        }
    </script>
</body>
</html>
