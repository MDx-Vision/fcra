<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automation Tools - Brightpath Ascend FCRA Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            padding: 20px;
            z-index: 100;
            overflow-y: auto;
        }
        .logo {
            display: flex;
            align-items: center;
            color: white;
            font-size: 20px;
            font-weight: 700;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
        }
        .logo img { height: 40px; margin-right: 10px; }
        .logo span { color: #84cc16; }
        .nav-section { margin-bottom: 25px; }
        .nav-section-title {
            color: #64748b;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #94a3b8;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.2s;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: linear-gradient(135deg, #319795 0%, #84cc16 100%); color: #1a1a2e; font-weight: 600; }
        .nav-item svg { width: 20px; height: 20px; margin-right: 12px; }
        .main-content {
            margin-left: 260px;
            padding: 20px 30px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a2e;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            text-decoration: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #319795 0%, #84cc16 100%);
            color: #1a1a2e;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(49, 151, 149, 0.3); }
        .btn-secondary {
            background: white;
            color: #1a1a2e;
            border: 1px solid #e2e8f0;
        }
        .btn-secondary:hover { border-color: #84cc16; }
        .btn-sm {
            padding: 6px 12px;
            font-size: 11px;
        }
        .btn-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .btn-danger:hover { background: #fecaca; }

        .top-nav {
            display: flex;
            gap: 2px;
            background: #e2e8f0;
            padding: 3px;
            border-radius: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .top-nav-btn {
            padding: 10px 18px;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .top-nav-btn:hover { background: white; color: #1a1a2e; }
        .top-nav-btn.active { background: #1a1a2e; color: white; }

        .content-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #84cc16;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: #f8fafc;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .checkbox-item:hover { background: #f1f5f9; }
        .checkbox-item.checked { background: #dcfce7; border-color: #84cc16; }
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #84cc16;
        }
        .checkbox-item span {
            font-size: 13px;
            color: #334155;
        }

        .bureau-section {
            margin-bottom: 20px;
        }
        .bureau-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bureau-section-title .badge {
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
        }

        .quick-select-btns {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .data-table th {
            text-align: left;
            padding: 10px 8px;
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
            background: #f8fafc;
            white-space: nowrap;
        }
        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
            vertical-align: middle;
        }
        .data-table tr:hover { background: #f8fafc; }

        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-processing { background: #dbeafe; color: #1e40af; }
        .status-complete { background: #dcfce7; color: #166534; }
        .status-mailed { background: #e0e7ff; color: #4338ca; }
        .status-transit { background: #fef3c7; color: #92400e; }
        .status-delivered { background: #dcfce7; color: #166534; }
        .status-scheduled { background: #dbeafe; color: #1e40af; }
        .status-failed { background: #fee2e2; color: #991b1b; }

        .urgency-overdue { background: #fee2e2; color: #991b1b; }
        .urgency-critical { background: #ffedd5; color: #c2410c; }
        .urgency-high { background: #fef3c7; color: #92400e; }
        .urgency-normal { background: #f1f5f9; color: #64748b; }

        .deadline-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .deadline-stat {
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid #e2e8f0;
        }
        .deadline-stat.overdue { border-left-color: #ef4444; }
        .deadline-stat.critical { border-left-color: #f97316; }
        .deadline-stat.high { border-left-color: #eab308; }
        .deadline-stat.normal { border-left-color: #94a3b8; }
        .deadline-stat .count {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a2e;
        }
        .deadline-stat .label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filters-row {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-btn {
            padding: 6px 14px;
            background: #f1f5f9;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            color: #64748b;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .filter-btn.active { background: #1a1a2e; color: white; }
        .filter-btn:hover { background: #e2e8f0; }
        .filter-btn.active:hover { background: #1a1a2e; }

        .actions-cell {
            display: flex;
            gap: 5px;
            flex-wrap: nowrap;
        }

        .results-panel {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
        }
        .results-panel.hidden { display: none; }
        .results-panel h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 15px;
        }
        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .result-row:last-child { border-bottom: none; }
        .result-row.total {
            background: linear-gradient(135deg, #319795 0%, #84cc16 100%);
            margin: 15px -20px -20px -20px;
            padding: 15px 20px;
            border-radius: 0 0 12px 12px;
            color: #1a1a2e;
        }
        .result-label {
            font-size: 13px;
            color: #64748b;
        }
        .result-row.total .result-label {
            color: #1a1a2e;
            font-weight: 600;
        }
        .result-value {
            font-size: 15px;
            font-weight: 600;
            color: #1a1a2e;
        }
        .result-row.total .result-value {
            font-size: 20px;
            font-weight: 700;
        }

        .likelihood-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .likelihood-high { background: #dcfce7; color: #166534; }
        .likelihood-medium { background: #fef3c7; color: #92400e; }
        .likelihood-low { background: #fee2e2; color: #991b1b; }

        .damages-list {
            margin-top: 15px;
        }
        .damage-item {
            display: grid;
            grid-template-columns: 200px 120px 1fr 40px;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .damage-item select,
        .damage-item input {
            padding: 8px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
        }
        .remove-damage {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fee2e2;
            color: #991b1b;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        .remove-damage:hover { background: #fecaca; }

        .add-damage-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #f1f5f9;
            border: 1px dashed #94a3b8;
            border-radius: 6px;
            color: #64748b;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .add-damage-btn:hover {
            background: #e2e8f0;
            border-color: #84cc16;
            color: #1a1a2e;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        .empty-state h3 {
            font-size: 16px;
            color: #1a1a2e;
            margin-bottom: 8px;
        }
        .empty-state p {
            font-size: 13px;
            margin-bottom: 15px;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-top-color: #319795;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #166534;
            color: white;
            border-radius: 8px;
            font-weight: 500;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .toast.error { background: #991b1b; }
        .toast.show { display: block; }

        @media (max-width: 1200px) {
            .form-grid { grid-template-columns: 1fr; }
            .checkbox-grid { grid-template-columns: repeat(2, 1fr); }
            .damage-item { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .sidebar { width: 0; padding: 0; }
            .main-content { margin-left: 0; }
            .checkbox-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="logo"><img src="/static/images/logo.png" alt="Brightpath Ascend"><span>Brightpath Ascend</span></div>
        <div class="nav-section">
            <div class="nav-section-title">Main</div>
            <a href="/dashboard" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
                Dashboard
            </a>
            <a href="/dashboard/contacts" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                Contact List
            </a>
            <a href="/dashboard/clients" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                Cases
            </a>
            <a href="/dashboard/signups" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                Signups & Payments
            </a>
            <a href="/dashboard/queue" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                Processing Queue
            </a>
            <a href="/dashboard/documents" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                Documents
            </a>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">Client Management</div>
            <a href="/dashboard/automation-tools" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                Automation Tools
            </a>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">Cases</div>
            <a href="/dashboard/cases?status=stage1_complete" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/></svg>
                Pending Review
            </a>
            <a href="/dashboard/cases?status=stage2_complete" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                Ready to Deliver
            </a>
            <a href="/dashboard/settlements" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                Settlements
            </a>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">Tools</div>
            <a href="/dashboard/reports" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                Reports
            </a>
            <a href="/dashboard/settings" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                Settings
            </a>
        </div>
    </nav>
    
    <main class="main-content">
        <div class="header">
            <h1>Automation Tools</h1>
            <a href="/dashboard" class="btn btn-secondary">Back to Dashboard</a>
        </div>

        <div class="top-nav">
            <button class="top-nav-btn active" data-tab="freeze-letters" onclick="switchTab('freeze-letters')">Freeze Letters</button>
            <button class="top-nav-btn" data-tab="validation-letters" onclick="switchTab('validation-letters')">Validation Letters</button>
            <button class="top-nav-btn" data-tab="deadlines" onclick="switchTab('deadlines')">Deadlines</button>
            <button class="top-nav-btn" data-tab="dispute-rounds" onclick="switchTab('dispute-rounds')">Dispute Rounds</button>
            <button class="top-nav-btn" data-tab="settlement-calculator" onclick="switchTab('settlement-calculator')">Settlement Calculator</button>
            <button class="top-nav-btn" data-tab="certified-mail" onclick="switchTab('certified-mail')">Certified Mail</button>
            <button class="top-nav-btn" data-tab="notarization" onclick="switchTab('notarization')">Notarization</button>
            <button class="top-nav-btn" data-tab="advanced-letters" onclick="switchTab('advanced-letters')">Advanced Letters</button>
        </div>

        <div id="tab-freeze-letters" class="tab-content active">
            <div class="content-card">
                <div class="section-title">Generate Freeze Letters</div>
                
                <div class="form-group" style="max-width: 400px;">
                    <label>Select Client</label>
                    <select id="freezeClientSelect">
                        <option value="">-- Select a Client --</option>
                        {% for client in clients %}
                        <option value="{{ client.id }}">{{ client.first_name }} {{ client.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="bureau-section">
                    <div class="bureau-section-title">
                        Primary Credit Bureaus
                        <span class="badge">Big 3</span>
                    </div>
                    <div class="checkbox-grid" id="primaryBureaus">
                        <label class="checkbox-item">
                            <input type="checkbox" name="bureau" value="equifax"> <span>Equifax</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="bureau" value="experian"> <span>Experian</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="bureau" value="transunion"> <span>TransUnion</span>
                        </label>
                    </div>
                </div>

                <div class="bureau-section">
                    <div class="bureau-section-title">
                        Secondary Bureaus
                        <span class="badge">Specialty</span>
                    </div>
                    <div class="checkbox-grid" id="secondaryBureaus">
                        <label class="checkbox-item">
                            <input type="checkbox" name="bureau" value="innovis"> <span>Innovis</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="bureau" value="chexsystems"> <span>ChexSystems</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="bureau" value="clarity_services"> <span>Clarity Services</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="bureau" value="lexisnexis"> <span>LexisNexis</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="bureau" value="corelogic"> <span>CoreLogic</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="bureau" value="factor_trust"> <span>Factor Trust</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="bureau" value="microbilt"> <span>MicroBilt</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="bureau" value="lexisnexis_risk"> <span>LexisNexis Risk</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="bureau" value="datax"> <span>DataX</span>
                        </label>
                    </div>
                </div>

                <div class="quick-select-btns">
                    <button class="btn btn-secondary btn-sm" onclick="selectAllPrimary()">Select All Primary</button>
                    <button class="btn btn-secondary btn-sm" onclick="selectAllSecondary()">Select All Secondary</button>
                    <button class="btn btn-secondary btn-sm" onclick="clearAllBureaus()">Clear All</button>
                </div>

                <button class="btn btn-primary" onclick="generateFreezeLetters()" id="generateFreezeBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    Generate Freeze Letters
                </button>
            </div>

            <div class="content-card">
                <div class="section-title">Recent Freeze Letter Batches</div>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="freezeLettersTable">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Date</th>
                                <th>Bureaus</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="empty-state">
                                    <p>No freeze letter batches yet</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-validation-letters" class="tab-content">
            <div class="content-card">
                <div class="section-title">Collection Debt Validation Letters (FDCPA)</div>
                <p style="color: #64748b; margin-bottom: 20px; font-size: 13px;">
                    Generate FDCPA-compliant debt validation letters for collection accounts. Letters auto-populate with client PII from the database.
                </p>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Client</label>
                        <select id="validationClientSelect">
                            <option value="">-- Select Client --</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Case (Optional - Auto-detect Collections)</label>
                        <select id="validationCaseSelect">
                            <option value="">-- No Case (Manual Entry) --</option>
                        </select>
                    </div>
                </div>

                <div id="manualCollectionEntry" style="margin-top: 20px;">
                    <div class="section-title">Collection Account Details</div>
                    <p style="color: #64748b; margin-bottom: 15px; font-size: 12px;">
                        Or select from common collection agencies:
                        <select id="commonAgencySelect" onchange="fillCommonAgency()" style="margin-left: 10px; padding: 5px; border-radius: 4px; border: 1px solid #e2e8f0;">
                            <option value="">-- Common Agencies --</option>
                        </select>
                    </p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Collection Agency Name *</label>
                            <input type="text" id="collectionCreditorName" placeholder="Portfolio Recovery Associates">
                        </div>
                        <div class="form-group">
                            <label>Agency Address</label>
                            <input type="text" id="collectionAddress" placeholder="123 Collection St">
                        </div>
                        <div class="form-group">
                            <label>City, State ZIP</label>
                            <input type="text" id="collectionCityStateZip" placeholder="City, ST 12345">
                        </div>
                        <div class="form-group">
                            <label>Original Creditor</label>
                            <input type="text" id="collectionOriginalCreditor" placeholder="Original bank or creditor name">
                        </div>
                        <div class="form-group">
                            <label>Account Number</label>
                            <input type="text" id="collectionAccountNumber" placeholder="Account reference number">
                        </div>
                        <div class="form-group">
                            <label>Claimed Balance ($)</label>
                            <input type="number" id="collectionBalance" placeholder="0.00" step="0.01">
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateValidationLetter()" id="generateValidationBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Generate Validation Letter
                    </button>
                    <button class="btn btn-secondary" onclick="autoGenerateFromCase()" id="autoGenerateBtn" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                        Auto-Generate from Case Analysis
                    </button>
                </div>
            </div>

            <div class="content-card">
                <div class="section-title">What These Letters Do</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #22c55e;">
                        <div style="font-weight: 600; color: #166534; margin-bottom: 5px;">Demand Debt Validation</div>
                        <div style="font-size: 12px; color: #15803d;">Forces collector to prove the debt is valid under FDCPA Section 809</div>
                    </div>
                    <div style="padding: 15px; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <div style="font-weight: 600; color: #1e40af; margin-bottom: 5px;">Stop Collection Activity</div>
                        <div style="font-size: 12px; color: #1d4ed8;">Collector must cease until validation is provided</div>
                    </div>
                    <div style="padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 5px;">Request Documentation</div>
                        <div style="font-size: 12px; color: #b45309;">Original contract, chain of assignment, DOFD, payment history</div>
                    </div>
                    <div style="padding: 15px; background: #fee2e2; border-radius: 8px; border-left: 4px solid #ef4444;">
                        <div style="font-weight: 600; color: #991b1b; margin-bottom: 5px;">Create Legal Record</div>
                        <div style="font-size: 12px; color: #dc2626;">Documented proof for FDCPA/FCRA violations if ignored</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-deadlines" class="tab-content">
            <div class="deadline-stats">
                <div class="deadline-stat overdue">
                    <div class="count" id="overdueCount">0</div>
                    <div class="label">Overdue</div>
                </div>
                <div class="deadline-stat critical">
                    <div class="count" id="criticalCount">0</div>
                    <div class="label">Critical (1-3 days)</div>
                </div>
                <div class="deadline-stat high">
                    <div class="count" id="highCount">0</div>
                    <div class="label">High (4-7 days)</div>
                </div>
                <div class="deadline-stat normal">
                    <div class="count" id="normalCount">0</div>
                    <div class="label">Normal (8+ days)</div>
                </div>
            </div>

            <div class="content-card">
                <div class="filters-row">
                    <button class="filter-btn active" data-deadline-filter="all" onclick="filterDeadlines('all')">All</button>
                    <button class="filter-btn" data-deadline-filter="overdue" onclick="filterDeadlines('overdue')">Overdue</button>
                    <button class="filter-btn" data-deadline-filter="week" onclick="filterDeadlines('week')">This Week</button>
                    <button class="filter-btn" data-deadline-filter="month" onclick="filterDeadlines('month')">This Month</button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="data-table" id="deadlinesTable">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Deadline Type</th>
                                <th>Bureau</th>
                                <th>Due Date</th>
                                <th>Days Left</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="deadlinesTableBody">
                            <tr>
                                <td colspan="7" class="empty-state">
                                    <p>Loading deadlines...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-dispute-rounds" class="tab-content">
            <div class="deadline-stats">
                <div class="deadline-stat" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border: 1px solid #86efac;">
                    <div class="count" id="readyToAdvanceCount">0</div>
                    <div class="label">Ready to Advance</div>
                </div>
                <div class="deadline-stat" style="background: linear-gradient(135deg, #fef9c3 0%, #fef08a 100%); border: 1px solid #fde047;">
                    <div class="count" id="incompleteRoundsCount">0</div>
                    <div class="label">Incomplete Rounds</div>
                </div>
                <div class="deadline-stat" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border: 1px solid #a5b4fc;">
                    <div class="count" id="activeDeadlinesCount">0</div>
                    <div class="label">Active Deadlines</div>
                </div>
                <div class="deadline-stat" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 1px solid #fca5a5;">
                    <div class="count" id="overdueDeadlinesCount">0</div>
                    <div class="label">Overdue Responses</div>
                </div>
            </div>

            <div class="content-card">
                <div class="section-title">
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Clients Ready to Advance Round
                    </span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="readyToAdvanceTable">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Current Round</th>
                                <th>Bureaus Responded</th>
                                <th>Items Deleted</th>
                                <th>Success Rate</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="readyToAdvanceBody">
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <p>Loading data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="content-card">
                <div class="section-title">
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#eab308" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        Clients with Incomplete Rounds (Waiting for Bureau Responses)
                    </span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="incompleteRoundsTable">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Current Round</th>
                                <th>Bureaus Responded</th>
                                <th>Bureaus Pending</th>
                                <th>Round Started</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="incompleteRoundsBody">
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <p>Loading data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="content-card">
                <div class="section-title">Manual Round Advancement</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Client</label>
                        <select id="advanceRoundClientSelect">
                            <option value="">-- Select a Client --</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.first_name }} {{ client.last_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>New Round</label>
                        <select id="newRoundSelect">
                            <option value="1">Round 1 - Initial Dispute</option>
                            <option value="2">Round 2 - MOV Request</option>
                            <option value="3">Round 3 - Pre-Litigation</option>
                            <option value="4">Round 4 - Final Demand</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="advanceRoundManual()" id="advanceRoundBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="13 17 18 12 13 7"/>
                        <polyline points="6 17 11 12 6 7"/>
                    </svg>
                    Advance to Selected Round
                </button>
            </div>
        </div>

        <div id="tab-settlement-calculator" class="tab-content">
            <div class="content-card">
                <div class="section-title">Calculate Settlement Value</div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Client</label>
                        <select id="settlementClientSelect">
                            <option value="">-- Select a Client --</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.first_name }} {{ client.last_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Total Violations</label>
                        <input type="number" id="totalViolations" min="0" value="0" onchange="updateViolationFields()">
                    </div>
                    <div class="form-group">
                        <label>Willful Violations</label>
                        <input type="number" id="willfulViolations" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>Negligent Violations</label>
                        <input type="number" id="negligentViolations" min="0" value="0">
                    </div>
                </div>

                <div class="section-title" style="margin-top: 25px;">Actual Damages</div>
                <div class="damages-list" id="damagesList">
                </div>
                <button class="add-damage-btn" onclick="addDamageItem()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Add Damage Item
                </button>

                <div style="margin-top: 25px;">
                    <button class="btn btn-primary" onclick="calculateSettlement()" id="calculateBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        Calculate Settlement
                    </button>
                </div>

                <div class="results-panel hidden" id="settlementResults">
                    <h3>Settlement Analysis</h3>
                    <div class="result-row">
                        <span class="result-label">Statutory Damages</span>
                        <span class="result-value" id="statutoryDamages">$0 - $0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Punitive Damages</span>
                        <span class="result-value" id="punitiveDamages">$0 - $0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Actual Damages Total</span>
                        <span class="result-value" id="actualDamagesTotal">$0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Attorney Fees Estimate</span>
                        <span class="result-value" id="attorneyFees">$0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Settlement Likelihood</span>
                        <span class="result-value" id="settlementLikelihood">
                            <span class="likelihood-badge likelihood-medium">Medium</span>
                        </span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Recommended Demand</span>
                        <span class="result-value" id="recommendedDemand">$0</span>
                    </div>
                    <div class="result-row total">
                        <span class="result-label">Total Recovery Range</span>
                        <span class="result-value" id="totalRecoveryRange">$0 - $0</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-certified-mail" class="tab-content">
            <div class="content-card">
                <div class="section-title">Recent Certified Mailings</div>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="certifiedMailTable">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Recipient</th>
                                <th>Document Type</th>
                                <th>Tracking #</th>
                                <th>Status</th>
                                <th>Cost</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" class="empty-state">
                                    <h3>No certified mailings yet</h3>
                                    <p>Certified mail tracking will appear here once letters are mailed</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-notarization" class="tab-content">
            <div class="content-card">
                <div class="section-title">Recent Notarization Orders</div>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="notarizationTable">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Document</th>
                                <th>Status</th>
                                <th>Session Link</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="empty-state">
                                    <h3>No notarization orders yet</h3>
                                    <p>Online notarization requests will appear here</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-advanced-letters" class="tab-content">
            <div class="content-card">
                <div class="section-title">Advanced Dispute Letter Templates</div>
                <p style="color: #64748b; margin-bottom: 20px; font-size: 13px;">
                    Generate legally-compliant dispute letters based on the Credit Repair Warfare guide. These templates include proper legal citations and professional formatting for maximum effectiveness.
                </p>

                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div onclick="selectAdvancedLetterType('respa-qwr')" id="letter-card-respa-qwr" class="letter-type-card" style="padding: 15px; background: #f8fafc; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="background: #dbeafe; color: #1e40af; padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">RESPA</span>
                            <span style="font-weight: 600; color: #1a1a2e;">Qualified Written Request</span>
                        </div>
                        <p style="font-size: 12px; color: #64748b; margin: 0;">For mortgage servicers - 12 U.S.C. 2605(e)</p>
                    </div>

                    <div onclick="selectAdvancedLetterType('reg-z')" id="letter-card-reg-z" class="letter-type-card" style="padding: 15px; background: #f8fafc; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="background: #dcfce7; color: #166534; padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">REG Z</span>
                            <span style="font-weight: 600; color: #1a1a2e;">Payment Crediting Dispute</span>
                        </div>
                        <p style="font-size: 12px; color: #64748b; margin: 0;">Late payment removal - 12 C.F.R. 1026.36(c)(1)(i)</p>
                    </div>

                    <div onclick="selectAdvancedLetterType('fdcpa-validation')" id="letter-card-fdcpa-validation" class="letter-type-card" style="padding: 15px; background: #f8fafc; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="background: #fef3c7; color: #92400e; padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">FDCPA</span>
                            <span style="font-weight: 600; color: #1a1a2e;">Validation Demand</span>
                        </div>
                        <p style="font-size: 12px; color: #64748b; margin: 0;">For debt collectors - 15 U.S.C. 1692g</p>
                    </div>

                    <div onclick="selectAdvancedLetterType('605b-block')" id="letter-card-605b-block" class="letter-type-card" style="padding: 15px; background: #f8fafc; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="background: #fee2e2; color: #991b1b; padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">605B</span>
                            <span style="font-weight: 600; color: #1a1a2e;">Identity Theft Block</span>
                        </div>
                        <p style="font-size: 12px; color: #64748b; margin: 0;">For ID theft victims - requires FTC affidavit</p>
                    </div>

                    <div onclick="selectAdvancedLetterType('623-furnisher')" id="letter-card-623-furnisher" class="letter-type-card" style="padding: 15px; background: #f8fafc; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="background: #e0e7ff; color: #4338ca; padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">623</span>
                            <span style="font-weight: 600; color: #1a1a2e;">Direct Furnisher Dispute</span>
                        </div>
                        <p style="font-size: 12px; color: #64748b; margin: 0;">Bypass bureau - direct to furnisher</p>
                    </div>

                    <div onclick="selectAdvancedLetterType('reinsertion')" id="letter-card-reinsertion" class="letter-type-card" style="padding: 15px; background: #f8fafc; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="background: #fce7f3; color: #9d174d; padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">611</span>
                            <span style="font-weight: 600; color: #1a1a2e;">Reinsertion Challenge</span>
                        </div>
                        <p style="font-size: 12px; color: #64748b; margin: 0;">For 611(a)(5)(B) violations</p>
                    </div>

                    <div onclick="selectAdvancedLetterType('mov-request')" id="letter-card-mov-request" class="letter-type-card" style="padding: 15px; background: #f8fafc; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="background: #cffafe; color: #0e7490; padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">MOV</span>
                            <span style="font-weight: 600; color: #1a1a2e;">Method of Verification Request</span>
                        </div>
                        <p style="font-size: 12px; color: #64748b; margin: 0;">611(a)(6)(B)(iii) - expose superficial checks</p>
                    </div>
                </div>
            </div>

            <div id="advanced-letter-form-respa-qwr" class="advanced-letter-form content-card" style="display: none;">
                <div class="section-title" style="display: flex; align-items: center; gap: 10px;">
                    <span style="background: #dbeafe; color: #1e40af; padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">RESPA QWR</span>
                    RESPA Qualified Written Request - 12 U.S.C. 2605(e)
                </div>
                <p style="color: #64748b; margin-bottom: 20px; font-size: 13px;">
                    A Qualified Written Request (QWR) compels mortgage servicers to investigate disputed account information. Servicers must respond within 30 days or face statutory damages of $2,000+ per violation.
                </p>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Client *</label>
                        <select id="respaClientSelect">
                            <option value="">-- Select Client --</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.first_name }} {{ client.last_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Mortgage Servicer Name *</label>
                        <input type="text" id="respaServicerName" placeholder="e.g., Wells Fargo Home Mortgage">
                    </div>
                    <div class="form-group">
                        <label>Servicer Address *</label>
                        <input type="text" id="respaServicerAddress" placeholder="Street Address">
                    </div>
                    <div class="form-group">
                        <label>City, State ZIP *</label>
                        <input type="text" id="respaServicerCityStateZip" placeholder="City, ST 12345">
                    </div>
                    <div class="form-group">
                        <label>Loan/Account Number *</label>
                        <input type="text" id="respaLoanNumber" placeholder="Loan account number">
                    </div>
                    <div class="form-group">
                        <label>Property Address</label>
                        <input type="text" id="respaPropertyAddress" placeholder="Property address for the mortgage">
                    </div>
                    <div class="form-group full-width">
                        <label>Dispute Reason / Issues *</label>
                        <textarea id="respaDisputeReason" rows="4" placeholder="Describe the payment crediting issues, escrow discrepancies, or other account errors you are disputing..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label>Specific Relief Requested</label>
                        <textarea id="respaReliefRequested" rows="3" placeholder="e.g., Correct payment history, remove late payment notations, provide complete payment application history..."></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateAdvancedLetter('respa-qwr')" id="generateRespaBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Generate RESPA QWR Letter
                    </button>
                    <button class="btn btn-secondary" onclick="previewAdvancedLetter('respa-qwr')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        Preview Letter
                    </button>
                </div>
            </div>

            <div id="advanced-letter-form-reg-z" class="advanced-letter-form content-card" style="display: none;">
                <div class="section-title" style="display: flex; align-items: center; gap: 10px;">
                    <span style="background: #dcfce7; color: #166534; padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">REG Z</span>
                    Regulation Z Payment Crediting Dispute - 12 C.F.R. 1026.36(c)(1)(i)
                </div>
                <p style="color: #64748b; margin-bottom: 20px; font-size: 13px;">
                    Under Regulation Z, creditors must credit payments as of the date received. Late payment notations resulting from delayed crediting violate federal law. This letter demands correction and removal of improper late marks.
                </p>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Client *</label>
                        <select id="regzClientSelect">
                            <option value="">-- Select Client --</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.first_name }} {{ client.last_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Creditor/Lender Name *</label>
                        <input type="text" id="regzCreditorName" placeholder="e.g., Chase Bank, N.A.">
                    </div>
                    <div class="form-group">
                        <label>Creditor Address *</label>
                        <input type="text" id="regzCreditorAddress" placeholder="Street Address">
                    </div>
                    <div class="form-group">
                        <label>City, State ZIP *</label>
                        <input type="text" id="regzCreditorCityStateZip" placeholder="City, ST 12345">
                    </div>
                    <div class="form-group">
                        <label>Account Number *</label>
                        <input type="text" id="regzAccountNumber" placeholder="Account number">
                    </div>
                    <div class="form-group">
                        <label>Account Type *</label>
                        <select id="regzAccountType">
                            <option value="">-- Select Type --</option>
                            <option value="Mortgage">Mortgage</option>
                            <option value="Auto Loan">Auto Loan</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Personal Loan">Personal Loan</option>
                            <option value="Student Loan">Student Loan</option>
                            <option value="Home Equity">Home Equity Line</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Payment Date(s) in Question *</label>
                        <input type="text" id="regzPaymentDates" placeholder="e.g., March 15, 2024; April 14, 2024">
                    </div>
                    <div class="form-group">
                        <label>Late Payment Month(s) Reported</label>
                        <input type="text" id="regzLateMonths" placeholder="e.g., March 2024, April 2024">
                    </div>
                    <div class="form-group full-width">
                        <label>Payment Evidence Details</label>
                        <textarea id="regzPaymentEvidence" rows="3" placeholder="Describe evidence of on-time payment: bank statement confirmation numbers, payment receipts, etc."></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateAdvancedLetter('reg-z')" id="generateRegzBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Generate Reg Z Dispute Letter
                    </button>
                    <button class="btn btn-secondary" onclick="previewAdvancedLetter('reg-z')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        Preview Letter
                    </button>
                </div>
            </div>

            <div id="advanced-letter-form-fdcpa-validation" class="advanced-letter-form content-card" style="display: none;">
                <div class="section-title" style="display: flex; align-items: center; gap: 10px;">
                    <span style="background: #fef3c7; color: #92400e; padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">FDCPA</span>
                    FDCPA Validation Demand - 15 U.S.C. 1692g
                </div>
                <p style="color: #64748b; margin-bottom: 20px; font-size: 13px;">
                    Under the FDCPA, debt collectors must validate debts upon consumer request. They must provide signed agreements, chain of assignment, and itemized accounting. Collection activity must cease until validation is provided.
                </p>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Client *</label>
                        <select id="fdcpaClientSelect">
                            <option value="">-- Select Client --</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.first_name }} {{ client.last_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Collection Agency Name *</label>
                        <input type="text" id="fdcpaCollectorName" placeholder="e.g., Portfolio Recovery Associates">
                    </div>
                    <div class="form-group">
                        <label>Collector Address *</label>
                        <input type="text" id="fdcpaCollectorAddress" placeholder="Street Address">
                    </div>
                    <div class="form-group">
                        <label>City, State ZIP *</label>
                        <input type="text" id="fdcpaCollectorCityStateZip" placeholder="City, ST 12345">
                    </div>
                    <div class="form-group">
                        <label>Account/Reference Number</label>
                        <input type="text" id="fdcpaAccountNumber" placeholder="Their reference number">
                    </div>
                    <div class="form-group">
                        <label>Original Creditor Name</label>
                        <input type="text" id="fdcpaOriginalCreditor" placeholder="Original creditor if known">
                    </div>
                    <div class="form-group">
                        <label>Amount Claimed ($)</label>
                        <input type="number" id="fdcpaAmountClaimed" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Date of First Collection Contact</label>
                        <input type="date" id="fdcpaFirstContactDate">
                    </div>
                    <div class="form-group full-width">
                        <label>Dispute Basis</label>
                        <textarea id="fdcpaDisputeBasis" rows="3" placeholder="Explain why you dispute this debt: not my account, wrong amount, statute of limitations, etc."></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateAdvancedLetter('fdcpa-validation')" id="generateFdcpaBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Generate FDCPA Validation Letter
                    </button>
                    <button class="btn btn-secondary" onclick="previewAdvancedLetter('fdcpa-validation')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        Preview Letter
                    </button>
                </div>
            </div>

            <div id="advanced-letter-form-605b-block" class="advanced-letter-form content-card" style="display: none;">
                <div class="section-title" style="display: flex; align-items: center; gap: 10px;">
                    <span style="background: #fee2e2; color: #991b1b; padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">605B</span>
                    Identity Theft Block Request - 15 U.S.C. 1681c-2
                </div>
                <p style="color: #64748b; margin-bottom: 20px; font-size: 13px;">
                    Section 605B requires CRAs to block fraudulent accounts within 4 business days when provided with a police report and FTC Identity Theft Affidavit. This is a powerful remedy for true identity theft victims.
                </p>

                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 0 8px 8px 0; margin-bottom: 20px;">
                    <strong style="color: #92400e;"> Important Requirements:</strong>
                    <ul style="margin: 10px 0 0 20px; color: #92400e; font-size: 13px;">
                        <li>Valid FTC Identity Theft Affidavit (Form 14039 or IdentityTheft.gov report)</li>
                        <li>Police Report or FTC Identity Theft Report</li>
                        <li>Documentation identifying fraudulent accounts</li>
                    </ul>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Client *</label>
                        <select id="block605bClientSelect">
                            <option value="">-- Select Client --</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.first_name }} {{ client.last_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Target Bureau *</label>
                        <select id="block605bBureau">
                            <option value="">-- Select Bureau --</option>
                            <option value="Equifax">Equifax</option>
                            <option value="Experian">Experian</option>
                            <option value="TransUnion">TransUnion</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Police Report Number *</label>
                        <input type="text" id="block605bPoliceReport" placeholder="Report number">
                    </div>
                    <div class="form-group">
                        <label>Police Report Date</label>
                        <input type="date" id="block605bPoliceDate">
                    </div>
                    <div class="form-group">
                        <label>FTC Report Number</label>
                        <input type="text" id="block605bFtcReport" placeholder="FTC Identity Theft Report number">
                    </div>
                    <div class="form-group">
                        <label>Date ID Theft Discovered</label>
                        <input type="date" id="block605bDiscoveryDate">
                    </div>
                    <div class="form-group full-width">
                        <label>Fraudulent Accounts to Block *</label>
                        <textarea id="block605bFraudAccounts" rows="4" placeholder="List each fraudulent account:
- Creditor Name, Account #XXXX, Amount $X,XXX
- Creditor Name, Account #YYYY, Amount $X,XXX"></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateAdvancedLetter('605b-block')" id="generate605bBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Generate 605B Block Request
                    </button>
                    <button class="btn btn-secondary" onclick="previewAdvancedLetter('605b-block')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        Preview Letter
                    </button>
                </div>
            </div>

            <div id="advanced-letter-form-623-furnisher" class="advanced-letter-form content-card" style="display: none;">
                <div class="section-title" style="display: flex; align-items: center; gap: 10px;">
                    <span style="background: #e0e7ff; color: #4338ca; padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">623</span>
                    Direct Furnisher Dispute - 15 U.S.C. 1681s-2(a)(8)
                </div>
                <p style="color: #64748b; margin-bottom: 20px; font-size: 13px;">
                    Section 623 allows consumers to dispute directly with furnishers after receiving a notice under 611(a)(6)(A). Furnishers must investigate within 30 days. This bypasses the CRA and creates direct furnisher liability.
                </p>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Client *</label>
                        <select id="furnisher623ClientSelect">
                            <option value="">-- Select Client --</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.first_name }} {{ client.last_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Furnisher/Creditor Name *</label>
                        <input type="text" id="furnisher623Name" placeholder="e.g., Capital One, N.A.">
                    </div>
                    <div class="form-group">
                        <label>Furnisher Address *</label>
                        <input type="text" id="furnisher623Address" placeholder="Street Address">
                    </div>
                    <div class="form-group">
                        <label>City, State ZIP *</label>
                        <input type="text" id="furnisher623CityStateZip" placeholder="City, ST 12345">
                    </div>
                    <div class="form-group">
                        <label>Account Number *</label>
                        <input type="text" id="furnisher623AccountNumber" placeholder="Account number">
                    </div>
                    <div class="form-group">
                        <label>Prior CRA Dispute Date</label>
                        <input type="date" id="furnisher623PriorDisputeDate">
                    </div>
                    <div class="form-group">
                        <label>CRA Investigation Result</label>
                        <select id="furnisher623CraResult">
                            <option value="">-- Select Result --</option>
                            <option value="Verified">Verified as Accurate</option>
                            <option value="Updated">Updated/Modified</option>
                            <option value="NoResponse">No Response Within 30 Days</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bureau Previously Disputed</label>
                        <select id="furnisher623Bureau">
                            <option value="">-- Select Bureau --</option>
                            <option value="Equifax">Equifax</option>
                            <option value="Experian">Experian</option>
                            <option value="TransUnion">TransUnion</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Specific Inaccuracy Being Disputed *</label>
                        <textarea id="furnisher623Inaccuracy" rows="4" placeholder="Describe the specific inaccurate information: wrong balance, incorrect payment history, account doesn't belong to me, etc."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label>Supporting Evidence Available</label>
                        <textarea id="furnisher623Evidence" rows="3" placeholder="Describe any documentation you have: statements, payment records, correspondence, etc."></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateAdvancedLetter('623-furnisher')" id="generate623Btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Generate 623 Direct Dispute
                    </button>
                    <button class="btn btn-secondary" onclick="previewAdvancedLetter('623-furnisher')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        Preview Letter
                    </button>
                </div>
            </div>

            <div id="advanced-letter-form-reinsertion" class="advanced-letter-form content-card" style="display: none;">
                <div class="section-title" style="display: flex; align-items: center; gap: 10px;">
                    <span style="background: #fce7f3; color: #9d174d; padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">611</span>
                    Reinsertion Challenge Letter - 15 U.S.C. 1681i(a)(5)(B)
                </div>
                <p style="color: #64748b; margin-bottom: 20px; font-size: 13px;">
                    Section 611(a)(5)(B) prohibits CRAs from reinserting deleted information without proper certification and consumer notification. Violations carry statutory damages of $100-$1,000 per occurrence plus actual damages and attorney fees.
                </p>

                <div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 15px; border-radius: 0 8px 8px 0; margin-bottom: 20px;">
                    <strong style="color: #991b1b;"> High-Value Violation:</strong>
                    <p style="margin: 10px 0 0 0; color: #991b1b; font-size: 13px;">
                        Reinsertion violations are per-se FCRA violations that often indicate willful noncompliance. Document the original deletion date and reinsertion date carefully.
                    </p>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Client *</label>
                        <select id="reinsertionClientSelect">
                            <option value="">-- Select Client --</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.first_name }} {{ client.last_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Target Bureau *</label>
                        <select id="reinsertionBureau">
                            <option value="">-- Select Bureau --</option>
                            <option value="Equifax">Equifax</option>
                            <option value="Experian">Experian</option>
                            <option value="TransUnion">TransUnion</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date Item Was Deleted *</label>
                        <input type="date" id="reinsertionDeletedDate">
                    </div>
                    <div class="form-group">
                        <label>Date Item Was Reinserted *</label>
                        <input type="date" id="reinsertionReinsertedDate">
                    </div>
                    <div class="form-group">
                        <label>Creditor/Furnisher Name *</label>
                        <input type="text" id="reinsertionCreditorName" placeholder="Name of creditor for reinserted item">
                    </div>
                    <div class="form-group">
                        <label>Account Number</label>
                        <input type="text" id="reinsertionAccountNumber" placeholder="Account number">
                    </div>
                    <div class="form-group">
                        <label>Original Dispute Confirmation #</label>
                        <input type="text" id="reinsertionConfirmation" placeholder="Original dispute confirmation number">
                    </div>
                    <div class="form-group">
                        <label>5-Day Notice Received?</label>
                        <select id="reinsertionNoticeReceived">
                            <option value="No">No - No notice received</option>
                            <option value="Yes">Yes - Received 5-day notice</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Description of Reinserted Information</label>
                        <textarea id="reinsertionDescription" rows="3" placeholder="Describe the information that was deleted and then reinserted..."></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateAdvancedLetter('reinsertion')" id="generateReinsertionBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Generate Reinsertion Challenge
                    </button>
                    <button class="btn btn-secondary" onclick="previewAdvancedLetter('reinsertion')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        Preview Letter
                    </button>
                </div>
            </div>

            <div id="advanced-letter-form-mov-request" class="advanced-letter-form content-card" style="display: none;">
                <div class="section-title" style="display: flex; align-items: center; gap: 10px;">
                    <span style="background: #cffafe; color: #0e7490; padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">MOV</span>
                    Method of Verification Request - 15 U.S.C. 1681i(a)(6)(B)(iii)
                </div>
                <p style="color: #64748b; margin-bottom: 20px; font-size: 13px;">
                    Section 611(a)(6)(B)(iii) requires CRAs to provide the method of verification upon request. This exposes superficial "e-OSCAR" verifications and creates evidence for litigation when CRAs fail to conduct meaningful investigations.
                </p>

                <div style="background: #dcfce7; border-left: 4px solid #22c55e; padding: 15px; border-radius: 0 8px 8px 0; margin-bottom: 20px;">
                    <strong style="color: #166534;"> Strategic Use:</strong>
                    <p style="margin: 10px 0 0 0; color: #166534; font-size: 13px;">
                        MOV requests often reveal that CRAs merely sent an e-OSCAR request with 2-digit codes and accepted furnisher's "verified" response without independent investigation. This supports willfulness claims.
                    </p>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Client *</label>
                        <select id="movClientSelect">
                            <option value="">-- Select Client --</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.first_name }} {{ client.last_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Target Bureau *</label>
                        <select id="movBureau">
                            <option value="">-- Select Bureau --</option>
                            <option value="Equifax">Equifax</option>
                            <option value="Experian">Experian</option>
                            <option value="TransUnion">TransUnion</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Original Dispute Date *</label>
                        <input type="date" id="movDisputeDate">
                    </div>
                    <div class="form-group">
                        <label>Dispute Confirmation Number</label>
                        <input type="text" id="movConfirmationNumber" placeholder="CRA confirmation number">
                    </div>
                    <div class="form-group">
                        <label>Investigation Result Date</label>
                        <input type="date" id="movResultDate">
                    </div>
                    <div class="form-group">
                        <label>Investigation Result</label>
                        <select id="movResult">
                            <option value="">-- Select Result --</option>
                            <option value="Verified">Verified as Accurate</option>
                            <option value="Updated">Updated/Modified</option>
                            <option value="Remains">Remains - No Change</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Creditor/Furnisher Name *</label>
                        <input type="text" id="movCreditorName" placeholder="Name of creditor for disputed item">
                    </div>
                    <div class="form-group">
                        <label>Account Number</label>
                        <input type="text" id="movAccountNumber" placeholder="Account number">
                    </div>
                    <div class="form-group full-width">
                        <label>Original Dispute Reason</label>
                        <textarea id="movDisputeReason" rows="3" placeholder="What was disputed in the original dispute?"></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateAdvancedLetter('mov-request')" id="generateMovBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Generate MOV Request Letter
                    </button>
                    <button class="btn btn-secondary" onclick="previewAdvancedLetter('mov-request')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        Preview Letter
                    </button>
                </div>
            </div>

            <div id="advanced-letter-preview" class="content-card" style="display: none;">
                <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Letter Preview</span>
                    <button class="btn btn-secondary btn-sm" onclick="closeLetterPreview()">Close Preview</button>
                </div>
                <div id="letterPreviewContent" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 30px; font-family: 'Times New Roman', serif; line-height: 1.6; max-height: 600px; overflow-y: auto;">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                    <button class="btn btn-primary" onclick="downloadPreviewAsPDF()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Download PDF
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="toast" class="toast"></div>

    <script>
        function switchTab(tabId) {
            document.querySelectorAll('.top-nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');

            if (tabId === 'deadlines') {
                loadDeadlines();
            }
            if (tabId === 'dispute-rounds') {
                loadDisputeRoundSummary();
            }
        }

        async function loadDisputeRoundSummary() {
            try {
                const response = await fetch('/api/dispute/round-summary');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('readyToAdvanceCount').textContent = data.stats.ready_count || 0;
                    document.getElementById('incompleteRoundsCount').textContent = data.stats.incomplete_count || 0;
                    document.getElementById('activeDeadlinesCount').textContent = data.stats.active_deadlines || 0;
                    document.getElementById('overdueDeadlinesCount').textContent = data.stats.overdue_deadlines || 0;
                    
                    renderReadyToAdvanceTable(data.ready_to_advance);
                    renderIncompleteRoundsTable(data.incomplete_rounds);
                }
            } catch (error) {
                console.error('Error loading dispute round summary:', error);
                showToast('Error loading dispute rounds data', true);
            }
        }

        function getRoundLabel(roundNum) {
            const labels = {
                1: 'Round 1 - Initial Dispute',
                2: 'Round 2 - MOV Request',
                3: 'Round 3 - Pre-Litigation',
                4: 'Round 4 - Final Demand'
            };
            return labels[roundNum] || `Round ${roundNum}`;
        }

        function getBureauBadges(bureaus) {
            return bureaus.map(b => {
                const colors = {
                    'Experian': '#0066cc',
                    'TransUnion': '#1a9d49',
                    'Equifax': '#b71c1c'
                };
                const color = colors[b] || '#64748b';
                return `<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;background:${color}15;color:${color};border:1px solid ${color}40;margin-right:4px;">${b}</span>`;
            }).join('');
        }

        function renderReadyToAdvanceTable(clients) {
            const tbody = document.getElementById('readyToAdvanceBody');
            
            if (!clients || clients.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><h3>No clients ready to advance</h3><p>Clients will appear here when all 3 bureaus respond</p></td></tr>`;
                return;
            }

            tbody.innerHTML = clients.map(client => {
                const nextRound = (client.current_round || 1) + 1;
                const canAdvance = nextRound <= 4;
                
                return `
                    <tr>
                        <td><strong>${client.name}</strong></td>
                        <td>${getRoundLabel(client.current_round)}</td>
                        <td>${getBureauBadges(client.bureaus_responded)}</td>
                        <td><span style="color:#16a34a;font-weight:600;">${client.total_deleted}</span></td>
                        <td>
                            <span style="padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;${client.success_rate >= 50 ? 'background:#dcfce7;color:#166534;' : 'background:#fef3c7;color:#92400e;'}">
                                ${client.success_rate.toFixed(1)}%
                            </span>
                        </td>
                        <td>
                            ${canAdvance ? 
                                `<button class="btn btn-primary btn-sm" onclick="advanceClientRound(${client.id}, ${nextRound})">
                                    Advance to Round ${nextRound}
                                </button>` : 
                                `<span class="status-badge status-completed">Final Round Complete</span>`
                            }
                            <button class="btn btn-secondary btn-sm" onclick="viewRoundHistory(${client.id})" style="margin-left:5px;">
                                History
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderIncompleteRoundsTable(clients) {
            const tbody = document.getElementById('incompleteRoundsBody');
            
            if (!clients || clients.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><h3>No incomplete rounds</h3><p>All active clients have complete rounds</p></td></tr>`;
                return;
            }

            tbody.innerHTML = clients.map(client => {
                const roundStarted = client.round_started_at ? new Date(client.round_started_at).toLocaleDateString() : 'N/A';
                
                return `
                    <tr>
                        <td><strong>${client.name}</strong></td>
                        <td>${getRoundLabel(client.current_round)}</td>
                        <td>${getBureauBadges(client.bureaus_responded)}</td>
                        <td>${getBureauBadges(client.bureaus_missing)}</td>
                        <td>${roundStarted}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="viewRoundHistory(${client.id})">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function advanceClientRound(clientId, newRound) {
            if (!confirm(`Are you sure you want to advance this client to Round ${newRound}? This will create new 30-day deadlines for all bureaus.`)) {
                return;
            }

            try {
                const response = await fetch('/api/dispute/advance-round', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: clientId,
                        new_round: newRound
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast(`Successfully advanced to Round ${newRound}! ${data.deadlines_created.length} deadlines created.`);
                    loadDisputeRoundSummary();
                } else {
                    showToast(data.error || 'Failed to advance round', true);
                }
            } catch (error) {
                showToast('Error advancing round: ' + error.message, true);
            }
        }

        async function advanceRoundManual() {
            const clientId = document.getElementById('advanceRoundClientSelect').value;
            const newRound = parseInt(document.getElementById('newRoundSelect').value);

            if (!clientId) {
                showToast('Please select a client', true);
                return;
            }

            if (!confirm(`Advance this client to ${getRoundLabel(newRound)}?`)) {
                return;
            }

            const btn = document.getElementById('advanceRoundBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Advancing...';

            try {
                const response = await fetch('/api/dispute/advance-round', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: parseInt(clientId),
                        new_round: newRound
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast(`Successfully advanced to Round ${newRound}! ${data.deadlines_created.length} deadlines created.`);
                    loadDisputeRoundSummary();
                } else {
                    showToast(data.error || 'Failed to advance round', true);
                }
            } catch (error) {
                showToast('Error advancing round: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg> Advance to Selected Round';
            }
        }

        async function viewRoundHistory(clientId) {
            try {
                const response = await fetch(`/api/dispute/client/${clientId}/round-history`);
                const data = await response.json();
                
                if (data.success) {
                    showRoundHistoryModal(data);
                } else {
                    showToast(data.error || 'Failed to load round history', true);
                }
            } catch (error) {
                showToast('Error loading round history: ' + error.message, true);
            }
        }

        function showRoundHistoryModal(data) {
            const existingModal = document.getElementById('roundHistoryModal');
            if (existingModal) existingModal.remove();

            let historyHtml = '';
            if (data.round_history && data.round_history.length > 0) {
                historyHtml = data.round_history.map(round => {
                    const bureauRows = Object.entries(round.bureaus).map(([bureau, info]) => `
                        <div style="display:flex;justify-content:space-between;padding:8px;background:#f8fafc;border-radius:6px;margin-bottom:5px;">
                            <span><strong>${bureau}</strong></span>
                            <span style="color:${info.response_type === 'deleted' ? '#16a34a' : '#64748b'}">
                                ${info.response_type} (Deleted: ${info.items_deleted}, Verified: ${info.items_verified})
                            </span>
                        </div>
                    `).join('');

                    return `
                        <div style="margin-bottom:20px;padding:15px;border:1px solid #e2e8f0;border-radius:8px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                <h4 style="margin:0;">Round ${round.round}</h4>
                                <span style="padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;${round.is_complete ? 'background:#dcfce7;color:#166534;' : 'background:#fef3c7;color:#92400e;'}">
                                    ${round.is_complete ? 'Complete' : 'In Progress'}
                                </span>
                            </div>
                            ${bureauRows}
                            <div style="margin-top:10px;padding-top:10px;border-top:1px solid #e2e8f0;display:flex;gap:20px;">
                                <span>Success Rate: <strong style="color:#16a34a;">${round.success_rate.toFixed(1)}%</strong></span>
                                <span>Deleted: <strong>${round.total_deleted}</strong></span>
                                <span>Verified: <strong>${round.total_verified}</strong></span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                historyHtml = '<p style="color:#64748b;text-align:center;">No round history available</p>';
            }

            const modal = document.createElement('div');
            modal.id = 'roundHistoryModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;';
            
            modal.innerHTML = `
                <div style="background:white;padding:30px;border-radius:12px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h3 style="margin:0;">Round History - ${data.client_name}</h3>
                        <button onclick="document.getElementById('roundHistoryModal').remove();" style="background:none;border:none;font-size:24px;cursor:pointer;color:#64748b;">&times;</button>
                    </div>
                    <div style="margin-bottom:15px;padding:10px;background:#f1f5f9;border-radius:6px;">
                        <strong>Current Status:</strong> Round ${data.current_round} - ${data.dispute_status}
                    </div>
                    ${historyHtml}
                </div>
            `;
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) modal.remove();
            });
            
            document.body.appendChild(modal);
        }

        function selectAllPrimary() {
            document.querySelectorAll('#primaryBureaus input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
                cb.closest('.checkbox-item').classList.add('checked');
            });
        }

        function selectAllSecondary() {
            document.querySelectorAll('#secondaryBureaus input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
                cb.closest('.checkbox-item').classList.add('checked');
            });
        }

        function clearAllBureaus() {
            document.querySelectorAll('input[name="bureau"]').forEach(cb => {
                cb.checked = false;
                cb.closest('.checkbox-item').classList.remove('checked');
            });
        }

        document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                this.closest('.checkbox-item').classList.toggle('checked', this.checked);
            });
        });

        async function generateFreezeLetters() {
            const clientId = document.getElementById('freezeClientSelect').value;
            if (!clientId) {
                showToast('Please select a client', true);
                return;
            }

            const selectedBureaus = Array.from(document.querySelectorAll('input[name="bureau"]:checked'))
                .map(cb => cb.value);
            
            if (selectedBureaus.length === 0) {
                showToast('Please select at least one bureau', true);
                return;
            }

            const btn = document.getElementById('generateFreezeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Generating...';

            try {
                const response = await fetch('/api/freeze-letters/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: clientId,
                        bureaus: selectedBureaus
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast('Freeze letters generated successfully!');
                    loadFreezeLetterBatches();
                } else {
                    showToast(data.error || 'Failed to generate letters', true);
                }
            } catch (error) {
                showToast('Error generating letters: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Generate Freeze Letters';
            }
        }

        async function loadFreezeLetterBatches() {
            try {
                const response = await fetch('/api/freeze-letters/recent');
                const data = await response.json();
                
                const tbody = document.querySelector('#freezeLettersTable tbody');
                
                if (data.batches && data.batches.length > 0) {
                    tbody.innerHTML = data.batches.map(batch => `
                        <tr>
                            <td>${batch.client_name}</td>
                            <td>${new Date(batch.created_at).toLocaleDateString()}</td>
                            <td>${batch.bureaus.join(', ')}</td>
                            <td><span class="status-badge status-${batch.status}">${batch.status}</span></td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="downloadFreezePDF('${batch.id}')">PDF</button>
                                <button class="btn btn-secondary btn-sm" onclick="downloadFreezeDocx('${batch.id}')">Word</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading freeze letter batches:', error);
            }
        }

        function downloadFreezePDF(batchId) {
            window.open(`/api/freeze-letters/download/${batchId}?format=pdf`, '_blank');
        }
        
        function downloadFreezeDocx(batchId) {
            window.open(`/api/freeze-letters/download/${batchId}?format=docx`, '_blank');
        }

        let commonAgencies = [];
        
        async function loadCommonAgencies() {
            try {
                const response = await fetch('/api/validation-letters/agencies');
                const data = await response.json();
                if (data.success) {
                    commonAgencies = data.agencies;
                    const select = document.getElementById('commonAgencySelect');
                    commonAgencies.forEach((agency, idx) => {
                        const option = document.createElement('option');
                        option.value = idx;
                        option.textContent = agency.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading common agencies:', error);
            }
        }
        
        function fillCommonAgency() {
            const select = document.getElementById('commonAgencySelect');
            const idx = select.value;
            if (idx !== '' && commonAgencies[idx]) {
                const agency = commonAgencies[idx];
                document.getElementById('collectionCreditorName').value = agency.name;
                document.getElementById('collectionAddress').value = agency.address;
                document.getElementById('collectionCityStateZip').value = agency.city_state_zip;
            }
        }
        
        document.getElementById('validationClientSelect').addEventListener('change', async function() {
            const clientId = this.value;
            const caseSelect = document.getElementById('validationCaseSelect');
            caseSelect.innerHTML = '<option value="">-- No Case (Manual Entry) --</option>';
            
            if (clientId) {
                try {
                    const response = await fetch(`/api/cases/client/${clientId}`);
                    const data = await response.json();
                    if (data.cases) {
                        data.cases.forEach(c => {
                            const option = document.createElement('option');
                            option.value = c.id;
                            option.textContent = `Case #${c.id} - ${c.status} (${new Date(c.created_at).toLocaleDateString()})`;
                            caseSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Error loading cases:', error);
                }
            }
        });
        
        document.getElementById('validationCaseSelect').addEventListener('change', function() {
            const caseId = this.value;
            const autoBtn = document.getElementById('autoGenerateBtn');
            autoBtn.disabled = !caseId;
        });
        
        async function generateValidationLetter() {
            const clientId = document.getElementById('validationClientSelect').value;
            if (!clientId) {
                showToast('Please select a client', true);
                return;
            }
            
            const creditorName = document.getElementById('collectionCreditorName').value.trim();
            if (!creditorName) {
                showToast('Collection agency name is required', true);
                return;
            }
            
            const btn = document.getElementById('generateValidationBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Generating...';
            
            try {
                const response = await fetch('/api/validation-letters/single', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: parseInt(clientId),
                        collection_info: {
                            creditor_name: creditorName,
                            creditor_address: document.getElementById('collectionAddress').value.trim(),
                            creditor_city_state_zip: document.getElementById('collectionCityStateZip').value.trim(),
                            original_creditor: document.getElementById('collectionOriginalCreditor').value.trim(),
                            account_number: document.getElementById('collectionAccountNumber').value.trim(),
                            balance: parseFloat(document.getElementById('collectionBalance').value) || 0
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Validation letter generated! Choose format to download.');
                    showDownloadOptions(data.pdf_path, data.docx_path);
                } else {
                    showToast(data.error || 'Failed to generate letter', true);
                }
            } catch (error) {
                showToast('Error generating letter: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Generate Validation Letter';
            }
        }
        
        async function autoGenerateFromCase() {
            const caseId = document.getElementById('validationCaseSelect').value;
            if (!caseId) {
                showToast('Please select a case first', true);
                return;
            }
            
            const btn = document.getElementById('autoGenerateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Scanning case...';
            
            try {
                const response = await fetch(`/api/validation-letters/auto-generate/${caseId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.letters_generated > 0) {
                        showToast(`Generated ${data.letters_generated} validation letters! Choose format.`);
                        showDownloadOptions(data.pdf_path, data.docx_path);
                    } else {
                        showToast(data.message || 'No collection accounts detected in analysis');
                    }
                } else {
                    showToast(data.error || 'Failed to auto-generate letters', true);
                }
            } catch (error) {
                showToast('Error: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> Auto-Generate from Case Analysis';
            }
        }
        
        loadCommonAgencies();
        
        function showDownloadOptions(pdfPath, docxPath) {
            const existingModal = document.getElementById('downloadOptionsModal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'downloadOptionsModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;';
            
            modal.innerHTML = `
                <div style="background:white;padding:30px;border-radius:12px;max-width:400px;width:90%;text-align:center;">
                    <h3 style="margin:0 0 20px;color:#1e293b;">Download Letter</h3>
                    <p style="color:#64748b;margin-bottom:25px;">Choose your preferred format:</p>
                    <div style="display:flex;gap:15px;justify-content:center;">
                        ${pdfPath ? `<button onclick="window.open('/${pdfPath}','_blank');document.getElementById('downloadOptionsModal').remove();" class="btn btn-primary" style="flex:1;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                            PDF
                        </button>` : ''}
                        ${docxPath ? `<button onclick="window.open('/${docxPath}','_blank');document.getElementById('downloadOptionsModal').remove();" class="btn btn-secondary" style="flex:1;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                            Word
                        </button>` : ''}
                    </div>
                    <button onclick="document.getElementById('downloadOptionsModal').remove();" style="margin-top:20px;background:none;border:none;color:#94a3b8;cursor:pointer;font-size:14px;">Cancel</button>
                </div>
            `;
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) modal.remove();
            });
            
            document.body.appendChild(modal);
        }

        async function loadDeadlines() {
            try {
                const response = await fetch('/api/deadlines/upcoming');
                const data = await response.json();
                
                if (data.success && data.deadlines) {
                    renderDeadlines(data.deadlines);
                    updateDeadlineStats(data.deadlines);
                }
            } catch (error) {
                console.error('Error loading deadlines:', error);
            }
        }

        function renderDeadlines(deadlines) {
            const tbody = document.getElementById('deadlinesTableBody');
            
            if (deadlines.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><p>No upcoming deadlines</p></td></tr>';
                return;
            }

            tbody.innerHTML = deadlines.map(deadline => {
                const urgencyClass = getUrgencyClass(deadline.days_left);
                return `
                    <tr>
                        <td>${deadline.client_name}</td>
                        <td>${deadline.type}</td>
                        <td>${deadline.bureau || '-'}</td>
                        <td>${new Date(deadline.due_date).toLocaleDateString()}</td>
                        <td><span class="status-badge ${urgencyClass}">${deadline.days_left} days</span></td>
                        <td><span class="status-badge status-${deadline.status}">${deadline.status}</span></td>
                        <td class="actions-cell">
                            <button class="btn btn-secondary btn-sm" onclick="completeDeadline('${deadline.id}')">Complete</button>
                            <button class="btn btn-secondary btn-sm" onclick="extendDeadline('${deadline.id}', 15)">+15 days</button>
                            <button class="btn btn-secondary btn-sm" onclick="extendDeadline('${deadline.id}', 30)">+30 days</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getUrgencyClass(daysLeft) {
            if (daysLeft < 0) return 'urgency-overdue';
            if (daysLeft <= 3) return 'urgency-critical';
            if (daysLeft <= 7) return 'urgency-high';
            return 'urgency-normal';
        }

        function updateDeadlineStats(deadlines) {
            const stats = {
                overdue: deadlines.filter(d => d.days_left < 0).length,
                critical: deadlines.filter(d => d.days_left >= 0 && d.days_left <= 3).length,
                high: deadlines.filter(d => d.days_left > 3 && d.days_left <= 7).length,
                normal: deadlines.filter(d => d.days_left > 7).length
            };
            
            document.getElementById('overdueCount').textContent = stats.overdue;
            document.getElementById('criticalCount').textContent = stats.critical;
            document.getElementById('highCount').textContent = stats.high;
            document.getElementById('normalCount').textContent = stats.normal;
        }

        function filterDeadlines(filter) {
            document.querySelectorAll('[data-deadline-filter]').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-deadline-filter="${filter}"]`).classList.add('active');
            loadDeadlines(filter);
        }

        async function completeDeadline(id) {
            try {
                const response = await fetch(`/api/deadlines/${id}/complete`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showToast('Deadline marked as complete');
                    loadDeadlines();
                }
            } catch (error) {
                showToast('Error completing deadline', true);
            }
        }

        async function extendDeadline(id, days) {
            try {
                const response = await fetch(`/api/deadlines/${id}/extend`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days: days })
                });
                const data = await response.json();
                if (data.success) {
                    showToast(`Deadline extended by ${days} days`);
                    loadDeadlines();
                }
            } catch (error) {
                showToast('Error extending deadline', true);
            }
        }

        let damageItemCount = 0;

        function addDamageItem() {
            damageItemCount++;
            const damagesList = document.getElementById('damagesList');
            const item = document.createElement('div');
            item.className = 'damage-item';
            item.id = `damage-${damageItemCount}`;
            item.innerHTML = `
                <select name="damageType">
                    <option value="credit_denial">Credit Denial</option>
                    <option value="higher_interest">Higher Interest</option>
                    <option value="emotional_distress">Emotional Distress</option>
                    <option value="lost_employment">Lost Employment</option>
                    <option value="medical_costs">Medical Costs</option>
                    <option value="time_spent">Time Spent</option>
                </select>
                <input type="number" name="damageAmount" placeholder="Amount ($)" min="0" step="0.01">
                <input type="text" name="damageDescription" placeholder="Description">
                <button class="remove-damage" onclick="removeDamageItem(${damageItemCount})">&times;</button>
            `;
            damagesList.appendChild(item);
        }

        function removeDamageItem(id) {
            const item = document.getElementById(`damage-${id}`);
            if (item) item.remove();
        }

        async function calculateSettlement() {
            const clientId = document.getElementById('settlementClientSelect').value;
            const totalViolations = parseInt(document.getElementById('totalViolations').value) || 0;
            const willfulViolations = parseInt(document.getElementById('willfulViolations').value) || 0;
            const negligentViolations = parseInt(document.getElementById('negligentViolations').value) || 0;

            const damages = [];
            document.querySelectorAll('.damage-item').forEach(item => {
                const type = item.querySelector('[name="damageType"]').value;
                const amount = parseFloat(item.querySelector('[name="damageAmount"]').value) || 0;
                const description = item.querySelector('[name="damageDescription"]').value;
                if (amount > 0) {
                    damages.push({ type, amount, description });
                }
            });

            const btn = document.getElementById('calculateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Calculating...';

            try {
                const response = await fetch('/api/settlement/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: clientId,
                        total_violations: totalViolations,
                        willful_violations: willfulViolations,
                        negligent_violations: negligentViolations,
                        actual_damages: damages
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    displaySettlementResults(data);
                } else {
                    showToast(data.error || 'Calculation failed', true);
                }
            } catch (error) {
                showToast('Error calculating settlement: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> Calculate Settlement';
            }
        }

        function displaySettlementResults(data) {
            const resultsPanel = document.getElementById('settlementResults');
            resultsPanel.classList.remove('hidden');

            document.getElementById('statutoryDamages').textContent = 
                `$${formatNumber(data.statutory_min)} - $${formatNumber(data.statutory_max)}`;
            document.getElementById('punitiveDamages').textContent = 
                `$${formatNumber(data.punitive_min)} - $${formatNumber(data.punitive_max)}`;
            document.getElementById('actualDamagesTotal').textContent = 
                `$${formatNumber(data.actual_damages_total)}`;
            document.getElementById('attorneyFees').textContent = 
                `$${formatNumber(data.attorney_fees)}`;
            
            const likelihoodBadge = document.getElementById('settlementLikelihood');
            const likelihoodClass = data.likelihood === 'High' ? 'likelihood-high' : 
                                   data.likelihood === 'Medium' ? 'likelihood-medium' : 'likelihood-low';
            likelihoodBadge.innerHTML = `<span class="likelihood-badge ${likelihoodClass}">${data.likelihood}</span>`;
            
            document.getElementById('recommendedDemand').textContent = 
                `$${formatNumber(data.recommended_demand)}`;
            document.getElementById('totalRecoveryRange').textContent = 
                `$${formatNumber(data.total_min)} - $${formatNumber(data.total_max)}`;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-US').format(Math.round(num));
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab');
            if (tab) {
                switchTab(tab);
            }
        });

        let currentAdvancedLetterType = null;
        let currentLetterContent = null;

        function selectAdvancedLetterType(letterType) {
            document.querySelectorAll('.letter-type-card').forEach(card => {
                card.style.borderColor = 'transparent';
                card.style.background = '#f8fafc';
            });
            
            const selectedCard = document.getElementById(`letter-card-${letterType}`);
            if (selectedCard) {
                selectedCard.style.borderColor = '#84cc16';
                selectedCard.style.background = '#f0fdf4';
            }
            
            document.querySelectorAll('.advanced-letter-form').forEach(form => {
                form.style.display = 'none';
            });
            
            const formDiv = document.getElementById(`advanced-letter-form-${letterType}`);
            if (formDiv) {
                formDiv.style.display = 'block';
                formDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            document.getElementById('advanced-letter-preview').style.display = 'none';
            currentAdvancedLetterType = letterType;
        }

        function getClientInfo(clientId) {
            const select = document.querySelector(`select option[value="${clientId}"]`);
            if (select) {
                return select.textContent;
            }
            return 'Client';
        }

        function formatDate(date) {
            return new Date(date || Date.now()).toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function generateLetterContent(letterType) {
            const today = formatDate();
            let content = '';
            
            switch(letterType) {
                case 'respa-qwr':
                    content = generateRespaQwrLetter(today);
                    break;
                case 'reg-z':
                    content = generateRegZLetter(today);
                    break;
                case 'fdcpa-validation':
                    content = generateFdcpaLetter(today);
                    break;
                case '605b-block':
                    content = generate605bLetter(today);
                    break;
                case '623-furnisher':
                    content = generate623Letter(today);
                    break;
                case 'reinsertion':
                    content = generateReinsertionLetter(today);
                    break;
                case 'mov-request':
                    content = generateMovLetter(today);
                    break;
            }
            
            return content;
        }

        function generateRespaQwrLetter(today) {
            const clientName = getClientInfo(document.getElementById('respaClientSelect').value);
            const servicerName = document.getElementById('respaServicerName').value || '[SERVICER NAME]';
            const servicerAddress = document.getElementById('respaServicerAddress').value || '[ADDRESS]';
            const servicerCityStateZip = document.getElementById('respaServicerCityStateZip').value || '[CITY, STATE ZIP]';
            const loanNumber = document.getElementById('respaLoanNumber').value || '[LOAN NUMBER]';
            const propertyAddress = document.getElementById('respaPropertyAddress').value || '[PROPERTY ADDRESS]';
            const disputeReason = document.getElementById('respaDisputeReason').value || '[DISPUTE REASON]';
            const reliefRequested = document.getElementById('respaReliefRequested').value || 'correction of account records and removal of any inaccurate information reported to credit bureaus';

            return `
<div style="text-align: right; margin-bottom: 30px;">
    <strong>${today}</strong><br>
    <em>QUALIFIED WRITTEN REQUEST</em><br>
    <em>Sent via Certified Mail, Return Receipt Requested</em>
</div>

<div style="margin-bottom: 25px;">
    <strong>${servicerName}</strong><br>
    ${servicerAddress}<br>
    ${servicerCityStateZip}
</div>

<div style="margin-bottom: 20px;">
    <strong>Re: Qualified Written Request Under RESPA</strong><br>
    Loan Number: ${loanNumber}<br>
    Property Address: ${propertyAddress}
</div>

<p>Dear Sir or Madam:</p>

<p>This letter constitutes a <strong>"Qualified Written Request"</strong> under Section 6 of the Real Estate Settlement Procedures Act (RESPA), 12 U.S.C. 2605(e), and its implementing regulation, Regulation X, 12 C.F.R. 1024.35.</p>

<p><strong>I. STATEMENT OF DISPUTE</strong></p>

<p>I am writing to dispute the following error(s) and/or request information regarding my mortgage loan account:</p>

<p style="margin-left: 20px; padding: 15px; background: #f8f9fa; border-left: 3px solid #1a1a2e;">${disputeReason}</p>

<p><strong>II. LEGAL AUTHORITY</strong></p>

<p>Pursuant to 12 U.S.C. 2605(e)(2), you are required to:</p>
<ul style="margin-left: 20px;">
    <li>Acknowledge receipt of this QWR within five (5) business days</li>
    <li>Within thirty (30) business days of receipt, either:
        <ul>
            <li>Make appropriate corrections to my account; OR</li>
            <li>Conduct an investigation and provide a written explanation of why you believe the account is correct</li>
        </ul>
    </li>
    <li>Provide the name and telephone number of an employee who can assist with this matter</li>
</ul>

<p><strong>III. REQUESTED DOCUMENTS AND INFORMATION</strong></p>

<p>Pursuant to 12 C.F.R. 1024.36, I hereby request copies of the following documents and information:</p>
<ol style="margin-left: 20px;">
    <li>Complete payment history from loan origination to present</li>
    <li>Complete escrow analysis for the past three (3) years</li>
    <li>All account statements for the past three (3) years</li>
    <li>Documentation of how each payment was applied (principal, interest, escrow, fees)</li>
    <li>Documentation of any fees or charges assessed to my account</li>
    <li>All correspondence related to my account for the past three (3) years</li>
    <li>Complete loan modification documentation, if applicable</li>
    <li>Any and all records of credit reporting related to this account</li>
</ol>

<p><strong>IV. RELIEF REQUESTED</strong></p>

<p>I request ${reliefRequested}.</p>

<p><strong>V. NOTICE OF STATUTORY PENALTIES</strong></p>

<p>Please be advised that failure to comply with the requirements of RESPA may result in:</p>
<ul style="margin-left: 20px;">
    <li>Actual damages plus additional damages not to exceed $2,000 per violation (12 U.S.C. 2605(f)(1))</li>
    <li>Class action liability up to $1,000,000 or 1% of net worth (12 U.S.C. 2605(f)(2))</li>
    <li>Reasonable attorneys' fees and costs (12 U.S.C. 2605(f)(3))</li>
</ul>

<p><strong>VI. PRESERVATION OF RIGHTS</strong></p>

<p>This letter is sent without prejudice to any and all rights and remedies I may have under federal and state law. I expressly reserve all such rights.</p>

<p>Please respond to this Qualified Written Request at the address listed below.</p>

<div style="margin-top: 40px;">
    <p>Sincerely,</p>
    <br><br><br>
    <p>____________________________<br>
    ${clientName}<br>
    [CLIENT ADDRESS]</p>
</div>

<div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #ccc; font-size: 11px; color: #666;">
    <strong>Enclosures:</strong> Copy of identification, copy of recent statement (if available)
</div>
`;
        }

        function generateRegZLetter(today) {
            const clientName = getClientInfo(document.getElementById('regzClientSelect').value);
            const creditorName = document.getElementById('regzCreditorName').value || '[CREDITOR NAME]';
            const creditorAddress = document.getElementById('regzCreditorAddress').value || '[ADDRESS]';
            const creditorCityStateZip = document.getElementById('regzCreditorCityStateZip').value || '[CITY, STATE ZIP]';
            const accountNumber = document.getElementById('regzAccountNumber').value || '[ACCOUNT NUMBER]';
            const accountType = document.getElementById('regzAccountType').value || '[ACCOUNT TYPE]';
            const paymentDates = document.getElementById('regzPaymentDates').value || '[PAYMENT DATES]';
            const lateMonths = document.getElementById('regzLateMonths').value || '[LATE MONTHS REPORTED]';
            const paymentEvidence = document.getElementById('regzPaymentEvidence').value || 'bank statements and payment confirmation records';

            return `
<div style="text-align: right; margin-bottom: 30px;">
    <strong>${today}</strong><br>
    <em>REGULATION Z DISPUTE - PAYMENT CREDITING VIOLATION</em><br>
    <em>Sent via Certified Mail, Return Receipt Requested</em>
</div>

<div style="margin-bottom: 25px;">
    <strong>${creditorName}</strong><br>
    ${creditorAddress}<br>
    ${creditorCityStateZip}
</div>

<div style="margin-bottom: 20px;">
    <strong>Re: Regulation Z Payment Crediting Dispute</strong><br>
    Account Number: ${accountNumber}<br>
    Account Type: ${accountType}
</div>

<p>Dear Sir or Madam:</p>

<p>I am writing to formally dispute late payment notations on my account based on your violation of <strong>Regulation Z, 12 C.F.R. 1026.36(c)(1)(i)</strong>, which mandates timely crediting of consumer payments.</p>

<p><strong>I. LEGAL FRAMEWORK</strong></p>

<p>Under Regulation Z, 12 C.F.R. 1026.36(c)(1)(i):</p>
<blockquote style="margin-left: 20px; padding: 15px; background: #f8f9fa; border-left: 3px solid #166534; font-style: italic;">
"A servicer shall credit a periodic payment to the consumer's loan account as of the date of receipt, except when a delay in crediting does not result in any charge to the consumer or in the reporting of negative information to a consumer reporting agency..."
</blockquote>

<p><strong>II. STATEMENT OF FACTS</strong></p>

<p>On the following date(s), I made timely payment(s) on my account:</p>
<p style="margin-left: 20px; padding: 15px; background: #f8f9fa; border-left: 3px solid #1a1a2e;"><strong>Payment Date(s):</strong> ${paymentDates}</p>

<p>However, your records incorrectly show late payment(s) for:</p>
<p style="margin-left: 20px; padding: 15px; background: #fee2e2; border-left: 3px solid #991b1b;"><strong>Late Months Reported:</strong> ${lateMonths}</p>

<p><strong>III. EVIDENCE OF TIMELY PAYMENT</strong></p>

<p>I have documentation supporting my timely payment(s), including: ${paymentEvidence}</p>

<p><strong>IV. VIOLATION AND HARM</strong></p>

<p>Your failure to properly credit my payment(s) as of the date of receipt resulted in:</p>
<ol style="margin-left: 20px;">
    <li>Improper late fee assessment (if applicable)</li>
    <li>False derogatory credit reporting</li>
    <li>Damage to my credit score and creditworthiness</li>
    <li>Potential denial of credit or higher interest rates</li>
</ol>

<p><strong>V. DEMAND FOR CORRECTION</strong></p>

<p>Pursuant to Regulation Z and the Fair Credit Reporting Act, I demand that you:</p>
<ol style="margin-left: 20px;">
    <li>Immediately investigate this payment crediting issue</li>
    <li>Correct your internal records to reflect the proper payment date(s)</li>
    <li>Remove all late payment notations from all credit bureaus (Equifax, Experian, TransUnion)</li>
    <li>Refund any improperly assessed late fees</li>
    <li>Provide written confirmation of corrections within 30 days</li>
</ol>

<p><strong>VI. NOTICE OF LEGAL LIABILITY</strong></p>

<p>Please be advised that violations of Regulation Z and the FCRA may subject you to:</p>
<ul style="margin-left: 20px;">
    <li>Actual damages suffered by the consumer</li>
    <li>Statutory damages up to $1,000 per violation under FCRA 1681n</li>
    <li>Punitive damages for willful noncompliance</li>
    <li>Reasonable attorneys' fees and costs</li>
</ul>

<p>I expect a written response within thirty (30) days confirming the correction of my account and credit reporting.</p>

<div style="margin-top: 40px;">
    <p>Sincerely,</p>
    <br><br><br>
    <p>____________________________<br>
    ${clientName}<br>
    [CLIENT ADDRESS]</p>
</div>

<div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #ccc; font-size: 11px; color: #666;">
    <strong>Enclosures:</strong> Copies of payment evidence, bank statements
</div>
`;
        }

        function generateFdcpaLetter(today) {
            const clientName = getClientInfo(document.getElementById('fdcpaClientSelect').value);
            const collectorName = document.getElementById('fdcpaCollectorName').value || '[COLLECTION AGENCY]';
            const collectorAddress = document.getElementById('fdcpaCollectorAddress').value || '[ADDRESS]';
            const collectorCityStateZip = document.getElementById('fdcpaCollectorCityStateZip').value || '[CITY, STATE ZIP]';
            const accountNumber = document.getElementById('fdcpaAccountNumber').value || '[REFERENCE NUMBER]';
            const originalCreditor = document.getElementById('fdcpaOriginalCreditor').value || '[ORIGINAL CREDITOR]';
            const amountClaimed = document.getElementById('fdcpaAmountClaimed').value || '[AMOUNT]';
            const disputeBasis = document.getElementById('fdcpaDisputeBasis').value || 'I dispute the validity of this alleged debt in its entirety.';

            return `
<div style="text-align: right; margin-bottom: 30px;">
    <strong>${today}</strong><br>
    <em>DEBT VALIDATION DEMAND UNDER FDCPA</em><br>
    <em>Sent via Certified Mail, Return Receipt Requested</em>
</div>

<div style="margin-bottom: 25px;">
    <strong>${collectorName}</strong><br>
    ${collectorAddress}<br>
    ${collectorCityStateZip}
</div>

<div style="margin-bottom: 20px;">
    <strong>Re: Debt Validation Request Under 15 U.S.C. 1692g</strong><br>
    Your Reference: ${accountNumber}<br>
    Alleged Original Creditor: ${originalCreditor}<br>
    Amount Claimed: $${amountClaimed}
</div>

<p>Dear Sir or Madam:</p>

<p>I am in receipt of your communication regarding an alleged debt. Pursuant to my rights under the <strong>Fair Debt Collection Practices Act (FDCPA), 15 U.S.C. 1692g</strong>, I hereby formally dispute this alleged debt and demand complete validation.</p>

<p><strong>I. DISPUTE STATEMENT</strong></p>

<p style="margin-left: 20px; padding: 15px; background: #fef3c7; border-left: 3px solid #92400e;">${disputeBasis}</p>

<p><strong>II. VALIDATION DEMAND</strong></p>

<p>Under 15 U.S.C. 1692g(b), you must cease collection activity until you provide the following validation:</p>

<ol style="margin-left: 20px;">
    <li><strong>Proof of Standing:</strong>
        <ul>
            <li>Complete chain of title/assignment from original creditor to your company</li>
            <li>Bill of sale or assignment agreement with my account specifically referenced</li>
            <li>Proof you are authorized to collect this debt in my state</li>
        </ul>
    </li>
    <li><strong>Account Documentation:</strong>
        <ul>
            <li>Original signed credit agreement or contract bearing my signature</li>
            <li>Complete account statements from account opening to charge-off</li>
            <li>Itemized accounting of all charges, fees, interest, and payments</li>
        </ul>
    </li>
    <li><strong>Verification Information:</strong>
        <ul>
            <li>Name and address of the original creditor</li>
            <li>Exact date of alleged default or charge-off</li>
            <li>Date of last payment received</li>
            <li>Amount owed on date of charge-off vs. amount now claimed</li>
        </ul>
    </li>
    <li><strong>Licensing:</strong>
        <ul>
            <li>Your company's debt collector license number for my state</li>
            <li>Proof of bonding as required by state law</li>
        </ul>
    </li>
</ol>

<p><strong>III. NOTICE OF STATUTORY RIGHTS</strong></p>

<p>Under the FDCPA, you are required to:</p>
<ul style="margin-left: 20px;">
    <li><strong>Cease all collection activity</strong> until validation is provided (1692g(b))</li>
    <li>Not report this account to credit bureaus while disputed and unvalidated</li>
    <li>Provide validation within 30 days of this request</li>
</ul>

<p><strong>IV. WARNING REGARDING CREDIT REPORTING</strong></p>

<p>Reporting an unvalidated, disputed debt to any credit reporting agency constitutes:</p>
<ul style="margin-left: 20px;">
    <li>A violation of the FDCPA, 15 U.S.C. 1692e (false representation)</li>
    <li>A violation of the FCRA, 15 U.S.C. 1681s-2(a)(1)(B) (duty to report accurately)</li>
</ul>

<p><strong>V. STATUTORY PENALTIES</strong></p>

<p>Failure to comply with the FDCPA may result in liability for:</p>
<ul style="margin-left: 20px;">
    <li>Actual damages</li>
    <li>Statutory damages up to $1,000 per action (15 U.S.C. 1692k)</li>
    <li>Attorney's fees and costs</li>
</ul>

<p>If you cannot provide complete validation as demanded, you must:</p>
<ol style="margin-left: 20px;">
    <li>Cease all collection efforts immediately</li>
    <li>Delete any credit reporting related to this account</li>
    <li>Confirm in writing that you are closing your file</li>
</ol>

<div style="margin-top: 40px;">
    <p>Sincerely,</p>
    <br><br><br>
    <p>____________________________<br>
    ${clientName}<br>
    [CLIENT ADDRESS]</p>
</div>

<div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #ccc; font-size: 11px; color: #666;">
    <strong>cc:</strong> File copy for potential litigation
</div>
`;
        }

        function generate605bLetter(today) {
            const clientName = getClientInfo(document.getElementById('block605bClientSelect').value);
            const bureau = document.getElementById('block605bBureau').value || '[BUREAU]';
            const policeReport = document.getElementById('block605bPoliceReport').value || '[REPORT NUMBER]';
            const policeDate = document.getElementById('block605bPoliceDate').value ? formatDate(document.getElementById('block605bPoliceDate').value) : '[DATE]';
            const ftcReport = document.getElementById('block605bFtcReport').value || '[FTC REPORT NUMBER]';
            const fraudAccounts = document.getElementById('block605bFraudAccounts').value || '[LIST FRAUDULENT ACCOUNTS]';

            const bureauAddresses = {
                'Equifax': 'Equifax Information Services LLC\nP.O. Box 105069\nAtlanta, GA 30348-5069',
                'Experian': 'Experian\nP.O. Box 4500\nAllen, TX 75013',
                'TransUnion': 'TransUnion LLC\nConsumer Dispute Center\nP.O. Box 2000\nChester, PA 19016'
            };

            return `
<div style="text-align: right; margin-bottom: 30px;">
    <strong>${today}</strong><br>
    <em>IDENTITY THEFT BLOCK REQUEST UNDER 605B</em><br>
    <em>Sent via Certified Mail, Return Receipt Requested</em>
</div>

<div style="margin-bottom: 25px;">
    <strong>${bureau}</strong><br>
    ${bureauAddresses[bureau] || '[BUREAU ADDRESS]'}
</div>

<div style="margin-bottom: 20px;">
    <strong>Re: Request to Block Fraudulent Information Under 15 U.S.C. 1681c-2</strong><br>
    Identity Theft Victim Block Request
</div>

<p>Dear Sir or Madam:</p>

<p>I am a victim of identity theft and hereby request that you <strong>block</strong> the following fraudulent information from my credit file pursuant to <strong>Section 605B of the Fair Credit Reporting Act, 15 U.S.C. 1681c-2</strong>.</p>

<p><strong>I. LEGAL AUTHORITY</strong></p>

<p>Under 15 U.S.C. 1681c-2(a):</p>
<blockquote style="margin-left: 20px; padding: 15px; background: #f8f9fa; border-left: 3px solid #991b1b; font-style: italic;">
"A consumer reporting agency shall block the reporting of any information in the file of a consumer that the consumer identifies as information that resulted from an alleged identity theft, not later than 4 business days after the date of receipt [of required documents]."
</blockquote>

<p><strong>II. REQUIRED DOCUMENTS ENCLOSED</strong></p>

<p>As required by 1681c-2(a), I am providing:</p>
<ol style="margin-left: 20px;">
    <li><strong>Identity Theft Report:</strong>
        <ul>
            <li>Police Report Number: ${policeReport}</li>
            <li>Police Report Date: ${policeDate}</li>
            <li>FTC Identity Theft Report: ${ftcReport}</li>
        </ul>
    </li>
    <li><strong>Identification Documentation:</strong>
        <ul>
            <li>Copy of government-issued photo ID</li>
            <li>Proof of current address</li>
        </ul>
    </li>
    <li><strong>Statement identifying fraudulent information</strong> (see below)</li>
</ol>

<p><strong>III. FRAUDULENT INFORMATION TO BE BLOCKED</strong></p>

<p>The following accounts/information resulted from identity theft and must be blocked:</p>
<div style="margin-left: 20px; padding: 15px; background: #fee2e2; border-left: 3px solid #991b1b;">
<pre style="margin: 0; white-space: pre-wrap;">${fraudAccounts}</pre>
</div>

<p><strong>IV. CERTIFICATION</strong></p>

<p>I hereby certify that:</p>
<ol style="margin-left: 20px;">
    <li>I did not authorize the opening of the account(s) listed above</li>
    <li>I did not authorize any charges or transactions on these account(s)</li>
    <li>The information identified is inaccurate and resulted from identity theft</li>
    <li>All information provided in this letter is true and correct</li>
</ol>

<p><strong>V. YOUR OBLIGATIONS</strong></p>

<p>Upon receipt of this request and required documents, you must:</p>
<ul style="margin-left: 20px;">
    <li>Block the identified information within <strong>4 business days</strong> (1681c-2(a))</li>
    <li>Notify the furnisher(s) that the information was blocked due to identity theft</li>
    <li>Provide written confirmation of the block to me</li>
</ul>

<p><strong>VI. PENALTIES FOR NON-COMPLIANCE</strong></p>

<p>Failure to comply with 605B may result in liability under FCRA 1681n and 1681o, including actual damages, statutory damages, punitive damages, and attorney's fees.</p>

<div style="margin-top: 40px;">
    <p>Sincerely,</p>
    <br><br><br>
    <p>____________________________<br>
    ${clientName}<br>
    [CLIENT ADDRESS]</p>
</div>

<div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #ccc; font-size: 11px; color: #666;">
    <strong>Enclosures:</strong><br>
    1. Copy of Police Report<br>
    2. FTC Identity Theft Affidavit/Report<br>
    3. Copy of Government-Issued ID<br>
    4. Proof of Address
</div>
`;
        }

        function generate623Letter(today) {
            const clientName = getClientInfo(document.getElementById('furnisher623ClientSelect').value);
            const furnisherName = document.getElementById('furnisher623Name').value || '[FURNISHER NAME]';
            const furnisherAddress = document.getElementById('furnisher623Address').value || '[ADDRESS]';
            const furnisherCityStateZip = document.getElementById('furnisher623CityStateZip').value || '[CITY, STATE ZIP]';
            const accountNumber = document.getElementById('furnisher623AccountNumber').value || '[ACCOUNT NUMBER]';
            const priorDisputeDate = document.getElementById('furnisher623PriorDisputeDate').value ? formatDate(document.getElementById('furnisher623PriorDisputeDate').value) : '[DATE]';
            const craResult = document.getElementById('furnisher623CraResult').value || 'Verified';
            const bureau = document.getElementById('furnisher623Bureau').value || '[BUREAU]';
            const inaccuracy = document.getElementById('furnisher623Inaccuracy').value || '[SPECIFIC INACCURACY]';
            const evidence = document.getElementById('furnisher623Evidence').value || 'documentation demonstrating the inaccuracy';

            return `
<div style="text-align: right; margin-bottom: 30px;">
    <strong>${today}</strong><br>
    <em>DIRECT DISPUTE TO FURNISHER UNDER 623</em><br>
    <em>Sent via Certified Mail, Return Receipt Requested</em>
</div>

<div style="margin-bottom: 25px;">
    <strong>${furnisherName}</strong><br>
    ${furnisherAddress}<br>
    ${furnisherCityStateZip}
</div>

<div style="margin-bottom: 20px;">
    <strong>Re: Direct Dispute Under 15 U.S.C. 1681s-2(a)(8)</strong><br>
    Account Number: ${accountNumber}
</div>

<p>Dear Sir or Madam:</p>

<p>Pursuant to my rights under <strong>Section 623 of the Fair Credit Reporting Act, 15 U.S.C. 1681s-2(a)(8)</strong>, I am submitting this direct dispute regarding inaccurate information you are reporting to consumer reporting agencies.</p>

<p><strong>I. STATUTORY BASIS FOR DIRECT DISPUTE</strong></p>

<p>Under 15 U.S.C. 1681s-2(a)(8)(A):</p>
<blockquote style="margin-left: 20px; padding: 15px; background: #f8f9fa; border-left: 3px solid #4338ca; font-style: italic;">
"After receiving notice... of a dispute with regard to the completeness or accuracy of any information provided by a person to a consumer reporting agency, the person shall... conduct an investigation with respect to the disputed information."
</blockquote>

<p><strong>II. PRIOR CRA DISPUTE</strong></p>

<p>I previously disputed this account through ${bureau} on ${priorDisputeDate}. The investigation result was: <strong>${craResult}</strong>.</p>

<p>This result was unsatisfactory because the information remains inaccurate.</p>

<p><strong>III. SPECIFIC INACCURACY</strong></p>

<p>The information you are reporting is inaccurate as follows:</p>
<div style="margin-left: 20px; padding: 15px; background: #e0e7ff; border-left: 3px solid #4338ca;">
${inaccuracy}
</div>

<p><strong>IV. SUPPORTING EVIDENCE</strong></p>

<p>I have ${evidence} which supports my dispute.</p>

<p><strong>V. YOUR OBLIGATIONS UNDER 623</strong></p>

<p>As a furnisher of information, you are required to:</p>
<ol style="margin-left: 20px;">
    <li>Conduct a reasonable investigation of this dispute within <strong>30 days</strong></li>
    <li>Review all relevant information I have provided</li>
    <li>Report the results of the investigation to me</li>
    <li>If the information is found inaccurate, incomplete, or unverifiable:
        <ul>
            <li>Modify the information</li>
            <li>Delete the information, or</li>
            <li>Permanently block reporting of the information</li>
        </ul>
    </li>
    <li>Notify all CRAs to which you reported the information of any corrections</li>
</ol>

<p><strong>VI. NOTICE OF LIABILITY</strong></p>

<p>Under 15 U.S.C. 1681s-2(b) and 1681n, furnishers who fail to conduct a proper investigation or who report information they know or should know is inaccurate may be liable for:</p>
<ul style="margin-left: 20px;">
    <li>Actual damages</li>
    <li>Statutory damages of $100-$1,000 per violation</li>
    <li>Punitive damages for willful violations</li>
    <li>Attorney's fees and costs</li>
</ul>

<p>I expect your written response within thirty (30) days.</p>

<div style="margin-top: 40px;">
    <p>Sincerely,</p>
    <br><br><br>
    <p>____________________________<br>
    ${clientName}<br>
    [CLIENT ADDRESS]</p>
</div>

<div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #ccc; font-size: 11px; color: #666;">
    <strong>Enclosures:</strong> Prior CRA dispute results, supporting documentation
</div>
`;
        }

        function generateReinsertionLetter(today) {
            const clientName = getClientInfo(document.getElementById('reinsertionClientSelect').value);
            const bureau = document.getElementById('reinsertionBureau').value || '[BUREAU]';
            const deletedDate = document.getElementById('reinsertionDeletedDate').value ? formatDate(document.getElementById('reinsertionDeletedDate').value) : '[DELETION DATE]';
            const reinsertedDate = document.getElementById('reinsertionReinsertedDate').value ? formatDate(document.getElementById('reinsertionReinsertedDate').value) : '[REINSERTION DATE]';
            const creditorName = document.getElementById('reinsertionCreditorName').value || '[CREDITOR NAME]';
            const accountNumber = document.getElementById('reinsertionAccountNumber').value || '[ACCOUNT NUMBER]';
            const confirmation = document.getElementById('reinsertionConfirmation').value || '[CONFIRMATION NUMBER]';
            const noticeReceived = document.getElementById('reinsertionNoticeReceived').value;
            const description = document.getElementById('reinsertionDescription').value || '[DESCRIPTION OF REINSERTED INFORMATION]';

            const bureauAddresses = {
                'Equifax': 'Equifax Information Services LLC\nP.O. Box 105069\nAtlanta, GA 30348-5069',
                'Experian': 'Experian\nP.O. Box 4500\nAllen, TX 75013',
                'TransUnion': 'TransUnion LLC\nConsumer Dispute Center\nP.O. Box 2000\nChester, PA 19016'
            };

            return `
<div style="text-align: right; margin-bottom: 30px;">
    <strong>${today}</strong><br>
    <em style="color: #991b1b;">REINSERTION VIOLATION NOTICE - 611(a)(5)(B)</em><br>
    <em>Sent via Certified Mail, Return Receipt Requested</em>
</div>

<div style="margin-bottom: 25px;">
    <strong>${bureau}</strong><br>
    ${bureauAddresses[bureau] || '[BUREAU ADDRESS]'}
</div>

<div style="margin-bottom: 20px;">
    <strong>Re: Illegal Reinsertion of Previously Deleted Information</strong><br>
    <strong>FCRA 611(a)(5)(B) Violation Notice</strong><br>
    Original Dispute Confirmation: ${confirmation}
</div>

<p>Dear Sir or Madam:</p>

<p style="background: #fee2e2; padding: 15px; border-radius: 8px; border: 1px solid #fecaca;">
<strong> NOTICE:</strong> This letter documents your violation of <strong>15 U.S.C. 1681i(a)(5)(B)</strong> regarding the illegal reinsertion of previously deleted information.
</p>

<p><strong>I. FACTUAL BACKGROUND</strong></p>

<table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
    <tr style="background: #f8fafc;">
        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">Original Deletion Date:</td>
        <td style="padding: 10px; border: 1px solid #e2e8f0;">${deletedDate}</td>
    </tr>
    <tr>
        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">Reinsertion Discovered:</td>
        <td style="padding: 10px; border: 1px solid #e2e8f0;">${reinsertedDate}</td>
    </tr>
    <tr style="background: #f8fafc;">
        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">Creditor/Furnisher:</td>
        <td style="padding: 10px; border: 1px solid #e2e8f0;">${creditorName}</td>
    </tr>
    <tr>
        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">Account Number:</td>
        <td style="padding: 10px; border: 1px solid #e2e8f0;">${accountNumber}</td>
    </tr>
    <tr style="background: #f8fafc;">
        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">5-Day Notice Received:</td>
        <td style="padding: 10px; border: 1px solid #e2e8f0;">${noticeReceived === 'Yes' ? 'Yes' : '<strong style="color: #991b1b;">NO - VIOLATION</strong>'}</td>
    </tr>
</table>

<p><strong>Description of Reinserted Information:</strong></p>
<div style="margin-left: 20px; padding: 15px; background: #fee2e2; border-left: 3px solid #991b1b;">
${description}
</div>

<p><strong>II. LEGAL VIOLATION</strong></p>

<p>Section 611(a)(5)(B) of the FCRA, 15 U.S.C. 1681i(a)(5)(B), states:</p>
<blockquote style="margin-left: 20px; padding: 15px; background: #f8f9fa; border-left: 3px solid #9d174d; font-style: italic;">
"If any information is deleted from a consumer's file... the information may not be reinserted in the file by the consumer reporting agency unless the person who furnishes the information certifies that the information is complete and accurate... [and] the agency provides... written notice to the consumer... not later than 5 business days."
</blockquote>

<p><strong>III. YOUR VIOLATIONS</strong></p>

<p>You have violated 611(a)(5)(B) by:</p>
<ol style="margin-left: 20px;">
    ${noticeReceived === 'No' ? '<li><strong>Failure to provide 5-day written notice</strong> of reinsertion as required</li>' : ''}
    <li><strong>Reinserting information</strong> that was previously deleted as inaccurate</li>
    <li><strong>Failing to obtain proper certification</strong> from the furnisher that the information is complete and accurate</li>
</ol>

<p><strong>IV. STATUTORY DAMAGES</strong></p>

<p>Under FCRA 1681n, willful violations subject you to:</p>
<ul style="margin-left: 20px;">
    <li>Actual damages</li>
    <li>Statutory damages of <strong>$100 to $1,000 per violation</strong></li>
    <li>Punitive damages</li>
    <li>Attorney's fees and costs</li>
</ul>

<p><strong>V. IMMEDIATE DEMAND</strong></p>

<p>I demand that you:</p>
<ol style="margin-left: 20px;">
    <li><strong>Immediately re-delete</strong> the improperly reinserted information</li>
    <li>Provide written confirmation of deletion within 5 business days</li>
    <li>Provide copies of any certification received from the furnisher</li>
    <li>Explain why proper notice procedures were not followed</li>
</ol>

<p>This letter serves as documentation for potential litigation. I reserve all rights under the FCRA.</p>

<div style="margin-top: 40px;">
    <p>Sincerely,</p>
    <br><br><br>
    <p>____________________________<br>
    ${clientName}<br>
    [CLIENT ADDRESS]</p>
</div>

<div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #ccc; font-size: 11px; color: #666;">
    <strong>Enclosures:</strong> Original deletion confirmation, current credit report showing reinsertion
</div>
`;
        }

        function generateMovLetter(today) {
            const clientName = getClientInfo(document.getElementById('movClientSelect').value);
            const bureau = document.getElementById('movBureau').value || '[BUREAU]';
            const disputeDate = document.getElementById('movDisputeDate').value ? formatDate(document.getElementById('movDisputeDate').value) : '[DISPUTE DATE]';
            const confirmationNumber = document.getElementById('movConfirmationNumber').value || '[CONFIRMATION NUMBER]';
            const resultDate = document.getElementById('movResultDate').value ? formatDate(document.getElementById('movResultDate').value) : '[RESULT DATE]';
            const result = document.getElementById('movResult').value || 'Verified';
            const creditorName = document.getElementById('movCreditorName').value || '[CREDITOR NAME]';
            const accountNumber = document.getElementById('movAccountNumber').value || '[ACCOUNT NUMBER]';
            const disputeReason = document.getElementById('movDisputeReason').value || '[ORIGINAL DISPUTE REASON]';

            const bureauAddresses = {
                'Equifax': 'Equifax Information Services LLC\nP.O. Box 105069\nAtlanta, GA 30348-5069',
                'Experian': 'Experian\nP.O. Box 4500\nAllen, TX 75013',
                'TransUnion': 'TransUnion LLC\nConsumer Dispute Center\nP.O. Box 2000\nChester, PA 19016'
            };

            return `
<div style="text-align: right; margin-bottom: 30px;">
    <strong>${today}</strong><br>
    <em>METHOD OF VERIFICATION REQUEST</em><br>
    <em>Sent via Certified Mail, Return Receipt Requested</em>
</div>

<div style="margin-bottom: 25px;">
    <strong>${bureau}</strong><br>
    ${bureauAddresses[bureau] || '[BUREAU ADDRESS]'}
</div>

<div style="margin-bottom: 20px;">
    <strong>Re: Request for Method of Verification Under 15 U.S.C. 1681i(a)(6)(B)(iii)</strong><br>
    Prior Dispute Confirmation: ${confirmationNumber}<br>
    Creditor: ${creditorName} | Account: ${accountNumber}
</div>

<p>Dear Sir or Madam:</p>

<p>Pursuant to <strong>Section 611(a)(6)(B)(iii) of the Fair Credit Reporting Act, 15 U.S.C. 1681i(a)(6)(B)(iii)</strong>, I hereby request a detailed description of the procedure used to determine the accuracy and completeness of the disputed information.</p>

<p><strong>I. STATUTORY RIGHT TO METHOD OF VERIFICATION</strong></p>

<p>Under 15 U.S.C. 1681i(a)(6)(B)(iii), upon request, you must provide:</p>
<blockquote style="margin-left: 20px; padding: 15px; background: #cffafe; border-left: 3px solid #0e7490; font-style: italic;">
"A description of the procedure used to determine the accuracy and completeness of the information [that is the subject of the dispute]."
</blockquote>

<p><strong>II. PRIOR DISPUTE DETAILS</strong></p>

<table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
    <tr style="background: #f8fafc;">
        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">Original Dispute Date:</td>
        <td style="padding: 10px; border: 1px solid #e2e8f0;">${disputeDate}</td>
    </tr>
    <tr>
        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">Investigation Result Date:</td>
        <td style="padding: 10px; border: 1px solid #e2e8f0;">${resultDate}</td>
    </tr>
    <tr style="background: #f8fafc;">
        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">Investigation Result:</td>
        <td style="padding: 10px; border: 1px solid #e2e8f0;">${result}</td>
    </tr>
    <tr>
        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">Disputed Information:</td>
        <td style="padding: 10px; border: 1px solid #e2e8f0;">${disputeReason}</td>
    </tr>
</table>

<p><strong>III. SPECIFIC INFORMATION REQUESTED</strong></p>

<p>Please provide the following details about your investigation:</p>
<ol style="margin-left: 20px;">
    <li><strong>Investigation Procedure:</strong>
        <ul>
            <li>What specific steps did you take to investigate my dispute?</li>
            <li>Did you conduct any independent verification beyond e-OSCAR?</li>
            <li>What documents or records did you review?</li>
        </ul>
    </li>
    <li><strong>Communication with Furnisher:</strong>
        <ul>
            <li>Exactly what information was transmitted to the furnisher?</li>
            <li>What were the specific ACDV codes used?</li>
            <li>What response did the furnisher provide?</li>
        </ul>
    </li>
    <li><strong>Verification Details:</strong>
        <ul>
            <li>What specific evidence did the furnisher provide to support accuracy?</li>
            <li>Did you request source documents from the furnisher?</li>
            <li>How did you determine the furnisher's response was adequate?</li>
        </ul>
    </li>
    <li><strong>Records Reviewed:</strong>
        <ul>
            <li>Name and contact information of the person who verified the information</li>
            <li>Date and time of verification</li>
            <li>All correspondence related to this investigation</li>
        </ul>
    </li>
</ol>

<p><strong>IV. PURPOSE OF REQUEST</strong></p>

<p>This information is necessary to determine whether you conducted a <strong>"reasonable investigation"</strong> as required by FCRA 1681i(a)(1)(A). Courts have held that merely forwarding disputes through e-OSCAR and accepting generic responses does not satisfy the reasonableness requirement. <em>See Cushman v. Trans Union Corp., 115 F.3d 220 (3d Cir. 1997)</em>.</p>

<p><strong>V. RESPONSE DEADLINE</strong></p>

<p>Under FCRA 611(a)(7), you must provide this information within <strong>15 days</strong> of receipt of this request.</p>

<p><strong>VI. PRESERVATION OF RIGHTS</strong></p>

<p>This request is made without prejudice to any rights I may have under federal or state law. Failure to provide a complete response may serve as evidence of a deficient investigation in any subsequent legal proceeding.</p>

<div style="margin-top: 40px;">
    <p>Sincerely,</p>
    <br><br><br>
    <p>____________________________<br>
    ${clientName}<br>
    [CLIENT ADDRESS]</p>
</div>

<div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #ccc; font-size: 11px; color: #666;">
    <strong>Enclosures:</strong> Copy of prior investigation results letter
</div>
`;
        }

        function previewAdvancedLetter(letterType) {
            const content = generateLetterContent(letterType);
            
            if (!content || content.includes('[') && content.includes('*')) {
                showToast('Please fill in the required fields before previewing', true);
                return;
            }
            
            currentLetterContent = content;
            document.getElementById('letterPreviewContent').innerHTML = content;
            document.getElementById('advanced-letter-preview').style.display = 'block';
            document.getElementById('advanced-letter-preview').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function closeLetterPreview() {
            document.getElementById('advanced-letter-preview').style.display = 'none';
            currentLetterContent = null;
        }

        async function generateAdvancedLetter(letterType) {
            const clientSelectId = {
                'respa-qwr': 'respaClientSelect',
                'reg-z': 'regzClientSelect',
                'fdcpa-validation': 'fdcpaClientSelect',
                '605b-block': 'block605bClientSelect',
                '623-furnisher': 'furnisher623ClientSelect',
                'reinsertion': 'reinsertionClientSelect',
                'mov-request': 'movClientSelect'
            };
            
            const clientId = document.getElementById(clientSelectId[letterType]).value;
            if (!clientId) {
                showToast('Please select a client', true);
                return;
            }
            
            const content = generateLetterContent(letterType);
            const buttonId = {
                'respa-qwr': 'generateRespaBtn',
                'reg-z': 'generateRegzBtn',
                'fdcpa-validation': 'generateFdcpaBtn',
                '605b-block': 'generate605bBtn',
                '623-furnisher': 'generate623Btn',
                'reinsertion': 'generateReinsertionBtn',
                'mov-request': 'generateMovBtn'
            };
            
            const btn = document.getElementById(buttonId[letterType]);
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Generating...';
            
            try {
                const response = await fetch('/api/advanced-letters/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: parseInt(clientId),
                        letter_type: letterType,
                        letter_content: content
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Letter generated successfully!');
                    showDownloadOptions(data.pdf_path, data.docx_path);
                } else {
                    showToast(data.error || 'Failed to generate letter', true);
                }
            } catch (error) {
                currentLetterContent = content;
                document.getElementById('letterPreviewContent').innerHTML = content;
                document.getElementById('advanced-letter-preview').style.display = 'block';
                document.getElementById('advanced-letter-preview').scrollIntoView({ behavior: 'smooth', block: 'start' });
                showToast('Letter preview ready. Use Print to PDF to save.');
            } finally {
                btn.disabled = false;
                const labels = {
                    'respa-qwr': 'Generate RESPA QWR Letter',
                    'reg-z': 'Generate Reg Z Dispute Letter',
                    'fdcpa-validation': 'Generate FDCPA Validation Letter',
                    '605b-block': 'Generate 605B Block Request',
                    '623-furnisher': 'Generate 623 Direct Dispute',
                    'reinsertion': 'Generate Reinsertion Challenge',
                    'mov-request': 'Generate MOV Request Letter'
                };
                btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> ${labels[letterType]}`;
            }
        }

        function downloadPreviewAsPDF() {
            if (!currentLetterContent) {
                showToast('No letter content to download', true);
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Letter - Print to PDF</title>
                    <style>
                        @page { margin: 1in; }
                        body { 
                            font-family: 'Times New Roman', Times, serif; 
                            font-size: 12pt; 
                            line-height: 1.5;
                            color: #000;
                            max-width: 8.5in;
                            margin: 0 auto;
                            padding: 20px;
                        }
                        p { margin-bottom: 12pt; }
                        blockquote { 
                            margin: 15pt 30pt; 
                            padding: 10pt;
                            background: #f5f5f5;
                            border-left: 3px solid #333;
                        }
                        ul, ol { margin-left: 20pt; }
                        li { margin-bottom: 6pt; }
                        table { border-collapse: collapse; width: 100%; }
                        td { padding: 8pt; border: 1px solid #ccc; }
                        strong { font-weight: bold; }
                    </style>
                </head>
                <body>
                    ${currentLetterContent}
                    <script>
                        window.onload = function() {
                            window.print();
                        }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
    </script>
</body>
</html>
