<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unlock Your Full Analysis - Brightpath Ascend</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            color: #f8fafc;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #22c55e;
            margin-bottom: 8px;
        }

        .greeting {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 16px;
        }

        /* Main Card */
        .purchase-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 32px;
        }

        .card-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .card-header h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .price-display {
            text-align: center;
            margin-bottom: 32px;
        }

        .price-amount {
            font-size: 56px;
            font-weight: 700;
            color: #22c55e;
        }

        .price-note {
            color: #94a3b8;
            font-size: 14px;
            margin-top: 8px;
        }

        /* What's Included */
        .included-section {
            margin-bottom: 32px;
        }

        .included-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #94a3b8;
        }

        .included-list {
            list-style: none;
        }

        .included-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .included-item:last-child {
            border-bottom: none;
        }

        .included-icon {
            width: 24px;
            height: 24px;
            background: rgba(34, 197, 94, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #22c55e;
            font-size: 12px;
        }

        .included-text {
            font-size: 15px;
            color: #e2e8f0;
        }

        /* Credit Notice */
        .credit-notice {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(16, 185, 129, 0.1) 100%);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 32px;
            text-align: center;
        }

        .credit-notice p {
            color: #86efac;
            font-size: 14px;
        }

        .credit-notice strong {
            color: #22c55e;
        }

        /* Payment Form */
        .payment-form {
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        #card-element {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 16px;
        }

        #card-errors {
            color: #ef4444;
            font-size: 14px;
            margin-top: 8px;
        }

        .btn-pay {
            display: block;
            width: 100%;
            padding: 18px 32px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            font-size: 18px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-pay:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(34, 197, 94, 0.3);
        }

        .btn-pay:disabled {
            background: #475569;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-back {
            display: block;
            width: 100%;
            padding: 14px 32px;
            background: transparent;
            color: #94a3b8;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            margin-top: 16px;
            transition: all 0.3s ease;
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
        }

        /* Trust Badges */
        .trust-section {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 32px;
        }

        .trust-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #64748b;
            font-size: 12px;
        }

        /* Loading state */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(34, 197, 94, 0.2);
            border-top-color: #22c55e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 640px) {
            .purchase-card {
                padding: 24px;
            }

            .price-amount {
                font-size: 42px;
            }

            .trust-section {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">Brightpath Ascend</div>
            <h1 class="greeting">Unlock Your Full Analysis</h1>
            <p class="subtitle">Get the complete breakdown, {{ client_name }}</p>
        </div>

        <div class="purchase-card">
            <div class="price-display">
                <div class="price-amount">${{ price }}</div>
                <div class="price-note">One-time payment</div>
            </div>

            <div class="included-section">
                <div class="included-title">WHAT'S INCLUDED</div>
                <ul class="included-list">
                    <li class="included-item">
                        <span class="included-icon">âœ“</span>
                        <span class="included-text">Complete 3-bureau analysis</span>
                    </li>
                    <li class="included-item">
                        <span class="included-icon">âœ“</span>
                        <span class="included-text">Item-by-item breakdown with priorities</span>
                    </li>
                    <li class="included-item">
                        <span class="included-icon">âœ“</span>
                        <span class="included-text">FCRA violation identification</span>
                    </li>
                    <li class="included-item">
                        <span class="included-icon">âœ“</span>
                        <span class="included-text">Personalized dispute strategy</span>
                    </li>
                    <li class="included-item">
                        <span class="included-icon">âœ“</span>
                        <span class="included-text">Estimated case value calculation</span>
                    </li>
                </ul>
            </div>

            <div class="credit-notice">
                <p><strong>$199 credit</strong> applied to Round 1 if you proceed with our program</p>
            </div>

            <div id="payment-form-container">
                <form id="payment-form" class="payment-form">
                    <div class="form-group">
                        <label class="form-label">Card Details</label>
                        <div id="card-element"></div>
                        <div id="card-errors" role="alert"></div>
                    </div>
                    <button type="submit" class="btn-pay" id="submit-btn">
                        Pay ${{ price }} Now
                    </button>
                </form>
                <a href="/analysis/{{ token }}" class="btn-back">Back to Analysis</a>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Processing your payment...</p>
            </div>
        </div>

        <div class="trust-section">
            <div class="trust-badge">
                <span>ðŸ”’</span> Secure Payment
            </div>
            <div class="trust-badge">
                <span>ðŸ’³</span> Powered by Stripe
            </div>
            <div class="trust-badge">
                <span>âœ“</span> Money-back Guarantee
            </div>
        </div>
    </div>

    <script>
        // Initialize Stripe
        const stripe = Stripe('{{ stripe_publishable_key }}');
        const elements = stripe.elements();

        // Create card element
        const cardElement = elements.create('card', {
            style: {
                base: {
                    color: '#f8fafc',
                    fontFamily: '"DM Sans", sans-serif',
                    fontSize: '16px',
                    '::placeholder': {
                        color: '#64748b'
                    }
                },
                invalid: {
                    color: '#ef4444'
                }
            }
        });

        cardElement.mount('#card-element');

        // Handle validation errors
        cardElement.on('change', function(event) {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });

        // Handle form submission
        const form = document.getElementById('payment-form');
        const submitBtn = document.getElementById('submit-btn');
        const loading = document.getElementById('loading');
        const formContainer = document.getElementById('payment-form-container');

        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            try {
                // Create payment intent
                const response = await fetch('/analysis/{{ token }}/purchase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to create payment');
                }

                // Confirm card payment
                formContainer.style.display = 'none';
                loading.classList.add('active');

                const { error, paymentIntent } = await stripe.confirmCardPayment(data.client_secret, {
                    payment_method: {
                        card: cardElement
                    }
                });

                if (error) {
                    throw new Error(error.message);
                }

                if (paymentIntent.status === 'succeeded') {
                    // Confirm payment with backend
                    const confirmResponse = await fetch('/api/analysis/confirm-payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            token: '{{ token }}',
                            payment_intent_id: paymentIntent.id
                        })
                    });

                    const confirmData = await confirmResponse.json();

                    if (confirmData.success) {
                        window.location.href = confirmData.redirect_url || '/analysis/{{ token }}';
                    } else {
                        throw new Error(confirmData.error || 'Failed to confirm payment');
                    }
                }

            } catch (error) {
                loading.classList.remove('active');
                formContainer.style.display = 'block';
                document.getElementById('card-errors').textContent = error.message;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Pay ${{ price }} Now';
            }
        });
    </script>
</body>
</html>
