<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Litigation Review</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0 0 40px;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    #logBox {
      background: #ffecec;
      border: 1px solid #f5c2c7;
      color: #721c24;
      padding: 10px;
      border-radius: 4px;
      font-family: Menlo, Monaco, monospace;
      font-size: 12px;
      height: 130px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .toolbar {
      margin-top: 10px;
      margin-bottom: 20px;
    }
    .toolbar button {
      margin-right: 10px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #e9ecef;
    }
    .toolbar button.primary {
      background: linear-gradient(135deg, #319795, #84cc16);
      border-color: #319795;
      color: white;
    }
    .toolbar button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #dataBox {
      background: #ffffff;
      border-radius: 6px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    pre {
      margin: 0;
      font-size: 12px;
      font-family: Menlo, Monaco, monospace;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
<div class="page">
  <h1>Litigation Review - ID: <span id="analysisIdLabel">?</span></h1>

  <div id="logBox"></div>

  <div class="toolbar">
    <button id="refreshBtn">Refresh Data</button>
    <button id="acceptBtn" class="primary">Accept Case &amp; Generate Letters</button>
    <button id="downloadBtn">Download Report</button>
  </div>

  <div id="dataBox">
    <h2>Analysis Data</h2>
    <pre id="dataPre">{}</pre>
  </div>
</div>

<script>
(function () {
  const logBox      = document.getElementById('logBox');
  const dataPre     = document.getElementById('dataPre');
  const refreshBtn  = document.getElementById('refreshBtn');
  const acceptBtn   = document.getElementById('acceptBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  function log(msg) {
    const ts = new Date().toLocaleTimeString();
    const line = ts + " > " + msg + "\n";
    logBox.textContent += line;
    logBox.scrollTop = logBox.scrollHeight;
    console.log(msg);
  }

  // ✅ Robust extraction of ID from /analysis/1/review or /analysis/1/
  function getAnalysisId() {
    const path = window.location.pathname;
    const match = path.match(/\/analysis\/(\d+)/);
    if (match) return match[1];
    return null;
  }

  async function loadAnalysis() {
    const id = getAnalysisId();
    if (!id) {
      log("❌ Could not determine analysis ID from URL");
      alert("Could not determine analysis ID from URL");
      return;
    }

    log("Analysis ID: " + id);
    log("> Fetching analysis data...");
    const resp = await fetch("/api/analysis/" + id + "/data");
    log("> GET /api/analysis/" + id + "/data");
    log("> Response status: " + resp.status);

    const json = await resp.json();
    dataPre.textContent = JSON.stringify(json, null, 2);
    log("> Data loaded.");
  }

  async function handleApproveClick() {
    const id = getAnalysisId();
    if (!id) {
      alert("No analysis ID found in URL.");
      log("❌ No analysis ID in URL on Approve click");
      return;
    }

    log("Accept Case button clicked for ID " + id);
    acceptBtn.disabled = true;
    acceptBtn.textContent = "Working...";

    try {
      const resp = await fetch("/api/approve/" + id, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      let body = {};
      try {
        body = await resp.json();
      } catch (e) {
        // ignore JSON parse errors, but log
        log("⚠️ Could not parse JSON body");
      }

      log("POST /api/approve/" + id + " -> " + resp.status);
      log("Response body: " + JSON.stringify(body));

      if (!resp.ok || body.success === false) {
        const msg = body.error || ("Server returned status " + resp.status);
        alert("Error: " + msg);
      } else {
        alert("Success: client documents generated.");
        // Reload analysis so stage/letters update
        await loadAnalysis();
      }
    } catch (err) {
      console.error(err);
      log("JS error: " + err.message);
      alert("JS error: " + err.message);
    } finally {
      acceptBtn.disabled = false;
      acceptBtn.textContent = "Accept Case & Generate Letters";
    }
  }

  function handleDownloadClick() {
    const id = getAnalysisId();
    if (!id) {
      alert("No analysis ID found in URL.");
      log("❌ No analysis ID in URL on Download click");
      return;
    }
    log("Download Report clicked for ID " + id);
    window.location.href = "/api/download/analysis/" + id + "/full_report";
  }

  window.addEventListener("load", function () {
    log("PAGE LOADED");

    if (!refreshBtn || !acceptBtn || !downloadBtn) {
      log("❌ One or more buttons not found in DOM");
      return;
    }

    refreshBtn.addEventListener("click", loadAnalysis);
    acceptBtn.addEventListener("click", handleApproveClick);
    downloadBtn.addEventListener("click", handleDownloadClick);

    log("Buttons are wired and enabled.");
    log("Buttons wired, initial load starting...");
    loadAnalysis();
  });
})();
</script>
</body>
</html>
