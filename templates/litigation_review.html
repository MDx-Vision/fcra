<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Litigation Review</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0 0 40px;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    #logBox {
      background: #ffecec;
      border: 1px solid #f5c2c7;
      color: #721c24;
      padding: 10px;
      border-radius: 4px;
      font-family: Menlo, Monaco, monospace;
      font-size: 12px;
      height: 130px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .toolbar {
      margin-top: 10px;
      margin-bottom: 20px;
    }
    .toolbar button {
      margin-right: 10px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #e9ecef;
    }
    .toolbar button.primary {
      background: #0d6efd;
      border-color: #0d6efd;
      color: white;
    }
    .toolbar button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #dataBox {
      background: #ffffff;
      border-radius: 6px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    pre {
      margin: 0;
      font-size: 12px;
      font-family: Menlo, Monaco, monospace;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
<div class="page">
  <h1>Litigation Review - ID: <span id="analysisIdLabel">?</span></h1>

  <div id="logBox"></div>

  <div class="toolbar">
    <button id="refreshBtn">Refresh Data</button>
    <button id="acceptBtn" class="primary">Accept Case &amp; Generate Letters</button>
    <button id="downloadBtn">Download Report</button>
  </div>

  <div id="dataBox">
    <h2>Analysis Data</h2>
    <pre id="dataPre">{}</pre>
  </div>
</div>

<script>
  // Simple logger to the red box
  function appendLog(msg) {
    const log = document.getElementById('logBox');
    const now = new Date().toLocaleTimeString();
    log.textContent += `${now} > ${msg}\n`;
    log.scrollTop = log.scrollHeight;
  }

  function getAnalysisId() {
    const path = window.location.pathname;

    // Expected formats:
    // /analysis/1/review
    // /analysis/1/review/
    // /analysis/1/
    // /analysis/1

    const match = path.match(/\/analysis\/(\d+)/);
    if (match) return match[1];

    return null;
  }

  async function loadAnalysis() {
    const analysisId = getAnalysisId();
    appendLog(`Analysis ID: ${analysisId}`);
    appendLog('Buttons wired, initial load starting...');
    appendLog('Fetching analysis data...');

    const url = `/api/analysis/${analysisId}/data`;
    appendLog(`GET ${url}`);

    try {
      const res = await fetch(url);
      appendLog(`Response status: ${res.status}`);

      const data = await res.json();
      appendLog('Data loaded.');

      const pre = document.getElementById('dataPre');
      pre.textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      appendLog(`Error loading analysis: ${err.message}`);
      alert('Error loading analysis data. Check console for details.');
    }
  }

  async function onAcceptClick() {
    const analysisId = getAnalysisId();
    const url = `/api/approve/${analysisId}`;

    appendLog('Accept Case button clicked.');
    appendLog(`POST ${url}`);

    try {
      const res = await fetch(url, { method: 'POST' });
      appendLog(`Response status: ${res.status}`);

      let bodyText = '';
      let bodyJson = null;

      try {
        bodyJson = await res.json();
        bodyText = JSON.stringify(bodyJson, null, 2);
      } catch (e) {
        bodyText = '(could not parse JSON body)';
      }

      appendLog('Response body: ' + bodyText);

      if (!res.ok || !bodyJson || bodyJson.success === false) {
        const errMsg = bodyJson && bodyJson.error
          ? bodyJson.error
          : 'Unknown error from server';
        alert('Error: ' + errMsg);
        return;
      }

      alert('Success: client documents generated.');
      // Refresh analysis data so stage and other fields update
      await loadAnalysis();

    } catch (err) {
      appendLog(`Network or JS error: ${err.message}`);
      alert('Request failed: ' + err.message);
    }
  }

  async function onDownloadReportClick() {
    const analysisId = getAnalysisId();
    const url = `/api/download/analysis/${analysisId}/full_report`;
    appendLog(`Download Report clicked. Opening ${url}`);
    window.open(url, '_blank');
  }

  function wireButtons() {
    const refreshBtn = document.getElementById('refreshBtn');
    const acceptBtn = document.getElementById('acceptBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    if (!refreshBtn || !acceptBtn || !downloadBtn) {
      appendLog('Error: one or more buttons not found in DOM.');
      return;
    }

    refreshBtn.disabled = false;
    acceptBtn.disabled = false;
    downloadBtn.disabled = false;

    refreshBtn.addEventListener('click', loadAnalysis);
    acceptBtn.addEventListener('click', onAcceptClick);
    downloadBtn.addEventListener('click', onDownloadReportClick);

    appendLog('Buttons are wired and enabled.');
  }

  window.addEventListener('load', () => {
    appendLog('PAGE LOADED');
    wireButtons();
    loadAnalysis();
  });
</script>
</body>
</html>