<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FCRA Litigation Review</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f4f6f8;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 24px;
      color: #222;
    }
    .sub {
      color: #666;
      font-size: 13px;
      margin-bottom: 20px;
    }
    .bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
      justify-content: space-between;
    }
    .btn {
      border: none;
      border-radius: 6px;
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary {
      background: #2563eb;
      color: #fff;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      color: #4b5563;
      margin-left: 6px;
    }
    .tag-green { background: #dcfce7; color: #166534; }
    .tag-red { background: #fee2e2; color: #b91c1c; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 1px 4px rgba(15,23,42,0.06);
    }
    .card h2 {
      font-size: 15px;
      margin: 0 0 8px;
      color: #111827;
    }
    .card p {
      margin: 2px 0;
      font-size: 13px;
      color: #4b5563;
    }
    .stat {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .muted {
      font-size: 12px;
      color: #9ca3af;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 13px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
      font-size: 12px;
      color: #4b5563;
    }
    tbody tr:hover {
      background: #f3f4f6;
    }

    #status {
      margin-top: 10px;
      font-size: 13px;
    }
    #status.ok { color: #166534; }
    #status.err { color: #b91c1c; }
  </style>
</head>
<body>
<div class="page">
  <h1>Litigation Review</h1>
  <div class="sub">
    Analysis ID: <strong id="a-id">{{ analysis_id }}</strong>
    <span id="a-stage-tag" class="tag"></span>
  </div>

  <div class="bar">
    <div>
      <button id="refreshBtn" class="btn btn-secondary">Refresh</button>
      <button id="approveBtn" class="btn btn-primary">Accept Case & Generate Letters</button>
    </div>
    <div>
      <button id="downloadReportBtn" class="btn btn-secondary">Download Full Report PDF</button>
    </div>
  </div>

  <div id="status"></div>

  <div class="grid">
    <div class="card">
      <h2>Case Overview</h2>
      <div class="stat" id="scoreStat">–</div>
      <p id="scoreLabel" class="muted">Score not yet calculated</p>
      <p id="caseStrength"></p>
      <p id="settlementProb"></p>
      <p id="analysisMeta" class="muted"></p>
    </div>

    <div class="card">
      <h2>Standing</h2>
      <p id="standingSummary">Loading…</p>
      <p id="standingDetails" class="muted"></p>
    </div>

    <div class="card">
      <h2>Damages & Exposure</h2>
      <p id="damagesSummary">Loading…</p>
      <p id="damagesDetails" class="muted"></p>
    </div>
  </div>

  <div class="card">
    <h2>Violations</h2>
    <div id="violationsEmpty" class="muted">No violations loaded yet.</div>
    <div id="violationsTableWrapper" style="display:none;">
      <table>
        <thead>
          <tr>
            <th>Bureau</th>
            <th>Account</th>
            <th>Section</th>
            <th>Type</th>
            <th>Willful</th>
          </tr>
        </thead>
        <tbody id="violationsBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const ANALYSIS_ID = Number({{ analysis_id | tojson }});
  console.log("Analysis ID:", ANALYSIS_ID);
  const statusEl = document.getElementById('status');
  const approveBtn = document.getElementById('approveBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const downloadReportBtn = document.getElementById('downloadReportBtn');

  function setStatus(msg, type) {
    statusEl.textContent = msg || '';
    statusEl.className = '';
    if (!msg) return;
    if (type === 'ok') statusEl.classList.add('ok');
    if (type === 'err') statusEl.classList.add('err');
  }

  async function loadPage() {
    try {
      setStatus('Loading analysis…');
      const res = await fetch(`/api/analysis/${ANALYSIS_ID}/data`);
      if (!res.ok) {
        throw new Error('Failed to load analysis');
      }
      const data = await res.json();
      if (!data.success) {
        throw new Error(data.error || 'Unknown error');
      }

      const a = data.analysis || {};
      const standing = data.standing;
      const damages = data.damages;
      const score = data.case_score;
      const violations = data.violations || [];

      // Stage tag
      const stageTag = document.getElementById('a-stage-tag');
      stageTag.textContent = a.stage === 1 ? 'Stage 1' : (a.stage === 2 ? 'Stage 2' : `Stage ${a.stage || '-'}`);
      stageTag.className = 'tag ' + (a.stage === 1 ? 'tag-red' : 'tag-green');

      // Meta
      document.getElementById('analysisMeta').textContent =
        `Round ${a.dispute_round || '-'} • Created ${a.created_at || ''} • Cost $${(a.cost || 0).toFixed(2)}`;

      // Score card
      if (score) {
        document.getElementById('scoreStat').textContent =
          typeof score.total_score === 'number' ? score.total_score.toFixed(1) + '/10' : '–';
        document.getElementById('scoreLabel').textContent = score.recommendation || 'Recommendation pending';
        document.getElementById('caseStrength').textContent =
          score.case_strength ? `Case strength: ${score.case_strength}` : '';
        document.getElementById('settlementProb').textContent =
          typeof score.settlement_probability === 'number'
            ? `Settlement probability: ${Math.round(score.settlement_probability * 100)}%`
            : '';
      } else {
        document.getElementById('scoreStat').textContent = '–';
        document.getElementById('scoreLabel').textContent = 'Score not yet calculated';
      }

      // Standing
      if (standing) {
        const bits = [];
        if (standing.has_concrete_harm) bits.push('Concrete harm');
        if (standing.has_dissemination) bits.push('Dissemination');
        if (standing.has_causation) bits.push('Causation');

        document.getElementById('standingSummary').textContent =
          bits.length ? bits.join(' • ') : 'Standing not yet verified';
        document.getElementById('standingDetails').textContent =
          `Denial letters: ${standing.denial_letters_count || 0}, Verified: ${
            standing.standing_verified ? 'Yes' : 'No'
          }`;
      } else {
        document.getElementById('standingSummary').textContent = 'No standing data saved yet.';
        document.getElementById('standingDetails').textContent = '';
      }

      // Damages
      if (damages) {
        const totalExposure = damages.total_exposure || 0;
        const statutory = damages.statutory_damages_total || 0;
        const actual = damages.actual_damages_total || 0;
        document.getElementById('damagesSummary').textContent =
          `Total exposure: $${totalExposure.toLocaleString()} (Actual $${actual.toLocaleString()}, Statutory $${statutory.toLocaleString()})`;
        document.getElementById('damagesDetails').textContent =
          `Settlement target: $${(damages.settlement_target || 0).toLocaleString()}`;
      } else {
        document.getElementById('damagesSummary').textContent = 'No damages calculated yet.';
        document.getElementById('damagesDetails').textContent = '';
      }

      // Violations
      const tbody = document.getElementById('violationsBody');
      tbody.innerHTML = '';
      if (!violations.length) {
        document.getElementById('violationsEmpty').style.display = 'block';
        document.getElementById('violationsTableWrapper').style.display = 'none';
      } else {
        document.getElementById('violationsEmpty').style.display = 'none';
        document.getElementById('violationsTableWrapper').style.display = 'block';

        violations.forEach(v => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${v.bureau || ''}</td>
            <td>${v.account_name || ''}</td>
            <td>${v.fcra_section || ''}</td>
            <td>${v.violation_type || ''}</td>
            <td>${v.is_willful ? 'Yes' : 'No'}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      setStatus('Loaded.', 'ok');
    } catch (err) {
      console.error(err);
      setStatus(err.message || 'Error loading analysis', 'err');
    }
  }

  refreshBtn.addEventListener('click', () => {
    loadPage();
  });

  approveBtn.addEventListener('click', async () => {
    try {
      approveBtn.disabled = true;
      setStatus('Generating letters and full client package…');

      const res = await fetch(`/api/approve/${ANALYSIS_ID}`, {
        method: 'POST'
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        throw new Error(data.error || 'Stage 2 generation failed');
      }

      setStatus('Stage 2 complete. Letters generated.', 'ok');
      // Reload to update stage + letters list
      loadPage();
    } catch (err) {
      console.error(err);
      setStatus(err.message || 'Error approving analysis', 'err');
    } finally {
      approveBtn.disabled = false;
    }
  });

  downloadReportBtn.addEventListener('click', () => {
    setStatus('Preparing full report PDF…');
    window.location.href = `/api/download/analysis/${ANALYSIS_ID}/full_report`;
  });

  // Initial load
  loadPage();
</script>
</body>
</html>
