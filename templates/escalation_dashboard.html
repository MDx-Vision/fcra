<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Escalation - Brightpath Ascend FCRA Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    {% include 'includes/dashboard_sidebar_styles.html' %}
    <style>

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a2e;
        }
        .header-actions { display: flex; gap: 15px; }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            text-decoration: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #319795 0%, #84cc16 100%);
            color: #1a1a2e;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(49, 151, 149, 0.4); }
        .btn-secondary {
            background: white;
            color: #1a1a2e;
            border: 2px solid #e2e8f0;
        }
        .btn-secondary:hover { border-color: #84cc16; }
        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        .stat-card.highlight {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
        }
        .stat-label {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .stat-card.highlight .stat-label { color: #94a3b8; }
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 8px;
        }
        .stat-card.highlight .stat-value { color: #84cc16; }
        .stat-change {
            font-size: 12px;
            color: #84cc16;
            font-weight: 500;
        }
        .stat-change.negative { color: #ef4444; }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a2e;
        }

        .case-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        .case-item:hover {
            border-color: #84cc16;
            background: #f8fafc;
        }
        .case-item.urgent {
            border-left: 4px solid #ef4444;
        }
        .case-item.high {
            border-left: 4px solid #f97316;
        }
        .case-item.medium {
            border-left: 4px solid #eab308;
        }

        .case-info {
            flex: 1;
        }
        .case-name {
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 4px;
        }
        .case-detail {
            font-size: 13px;
            color: #64748b;
        }

        .priority-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .priority-urgent { background: #fef2f2; color: #ef4444; }
        .priority-high { background: #fff7ed; color: #ea580c; }
        .priority-medium { background: #fefce8; color: #ca8a04; }

        .recommendation-item {
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 12px;
        }
        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .recommendation-action {
            font-weight: 600;
            color: #1a1a2e;
            font-size: 14px;
        }
        .confidence-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .confidence-high { background: #dcfce7; color: #166534; }
        .confidence-medium { background: #fef3c7; color: #92400e; }
        .confidence-low { background: #fee2e2; color: #991b1b; }

        .recommendation-reasoning {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .recommendation-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #94a3b8;
        }

        .action-type-card {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .action-type-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
        }
        .action-type-icon.green { background: #dcfce7; }
        .action-type-icon.blue { background: #dbeafe; }
        .action-type-icon.yellow { background: #fef3c7; }
        .action-type-icon.red { background: #fee2e2; }
        .action-type-icon.purple { background: #f3e8ff; }

        .action-type-info {
            flex: 1;
        }
        .action-type-name {
            font-weight: 600;
            font-size: 14px;
            color: #1a1a2e;
        }
        .action-type-rate {
            font-size: 12px;
            color: #64748b;
        }
        .action-type-bar {
            width: 60px;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }
        .action-type-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #319795 0%, #84cc16 100%);
            border-radius: 3px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }
        .empty-state svg {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        .empty-state h3 {
            color: #64748b;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .empty-state p {
            font-size: 13px;
        }

        .applied-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: #dcfce7;
            color: #166534;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    {% set active_page = 'escalation' %}
    {% include 'includes/dashboard_sidebar.html' %}

    <main class="main-content">
        <div class="header">
            <div>
                <h1>Smart Escalation Engine</h1>
                <p style="color: #64748b; margin-top: 5px;">AI-powered dispute escalation recommendations</p>
            </div>
            <div class="header-actions">
                <a href="/dashboard" class="btn btn-secondary">Back to Dashboard</a>
            </div>
        </div>

        {% if error %}
        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px; padding: 16px; margin-bottom: 20px; color: #991b1b;">
            <strong>Error:</strong> {{ error }}
        </div>
        {% endif %}

        <div class="stats-grid">
            <div class="stat-card highlight">
                <div class="stat-label">Total Recommendations</div>
                <div class="stat-value">{{ stats.total_recommendations or 0 }}</div>
                <div class="stat-change">All time</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Applied</div>
                <div class="stat-value">{{ stats.applied_recommendations or 0 }}</div>
                <div class="stat-change">{{ ((stats.applied_recommendations or 0) / (stats.total_recommendations or 1) * 100)|round|int }}% adoption rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Completed</div>
                <div class="stat-value">{{ stats.completed_recommendations or 0 }}</div>
                <div class="stat-change">With recorded outcomes</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Success Rate</div>
                <div class="stat-value">{{ (stats.overall_success_rate or 0) * 100|round|int }}%</div>
                <div class="stat-change {% if (stats.overall_success_rate or 0) < 0.5 %}negative{% endif %}">Based on outcomes</div>
            </div>
        </div>

        <div class="content-grid">
            <div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Cases Needing Escalation Review</div>
                        <span style="font-size: 13px; color: #64748b;">{{ cases_needing_review|length }} cases</span>
                    </div>

                    {% if cases_needing_review %}
                        {% for case in cases_needing_review %}
                        <div class="case-item {{ case.priority }}">
                            <div class="case-info">
                                <div class="case-name">{{ case.client_name }}</div>
                                <div class="case-detail">
                                    Round {{ case.dispute_round }} | {{ case.reason }}
                                    {% if case.last_response_date %}
                                    <br>Last response: {{ case.last_response_date[:10] }}
                                    {% endif %}
                                </div>
                            </div>
                            <span class="priority-badge priority-{{ case.priority }}">{{ case.priority }}</span>
                            <a href="/dashboard/case/{{ case.client_id }}" class="btn btn-sm btn-secondary" style="margin-left: 10px;">View</a>
                            <button onclick="generateRecommendation({{ case.client_id }})" class="btn btn-sm btn-primary" style="margin-left: 5px;">Analyze</button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            <h3>All Caught Up!</h3>
                            <p>No cases currently need escalation review</p>
                        </div>
                    {% endif %}
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Recent Recommendations</div>
                    </div>

                    {% if recent_recommendations %}
                        {% for rec in recent_recommendations %}
                        <div class="recommendation-item">
                            <div class="recommendation-header">
                                <div>
                                    <div class="recommendation-action">
                                        {{ action_types.get(rec.recommended_action, {}).get('name', rec.recommended_action) }}
                                        {% if rec.applied %}
                                        <span class="applied-badge">Applied</span>
                                        {% endif %}
                                    </div>
                                    <div style="font-size: 12px; color: #94a3b8;">{{ rec.creditor_name or 'Unknown Creditor' }} | {{ rec.bureau or 'All Bureaus' }}</div>
                                </div>
                                <span class="confidence-badge {% if rec.confidence_score >= 0.8 %}confidence-high{% elif rec.confidence_score >= 0.5 %}confidence-medium{% else %}confidence-low{% endif %}">
                                    {{ (rec.confidence_score * 100)|round|int }}% confidence
                                </span>
                            </div>
                            <div class="recommendation-reasoning">{{ rec.reasoning[:200] }}{% if rec.reasoning|length > 200 %}...{% endif %}</div>
                            <div class="recommendation-meta">
                                <span>Round {{ rec.dispute_round }}</span>
                                <span>{{ rec.created_at[:10] if rec.created_at else 'N/A' }}</span>
                                {% if rec.outcome_actual %}
                                <span style="color: #84cc16;">Outcome: {{ rec.outcome_actual }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                            <h3>No Recommendations Yet</h3>
                            <p>Generate recommendations from case reviews</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Top Performing Strategies</div>
                    </div>

                    {% if stats.top_performing %}
                        {% for strategy in stats.top_performing %}
                        <div class="action-type-card">
                            <div class="action-type-icon {% if loop.index <= 2 %}green{% elif loop.index == 3 %}blue{% else %}yellow{% endif %}">
                                {% if strategy.action == 'regulatory_complaint' %}üìã{% elif strategy.action == 'intent_to_sue' %}‚öñÔ∏è{% elif strategy.action == 'direct_furnisher' %}üì§{% elif strategy.action == 'mov_demand' %}üìù{% else %}üîÑ{% endif %}
                            </div>
                            <div class="action-type-info">
                                <div class="action-type-name">{{ action_types.get(strategy.action, {}).get('name', strategy.action) }}</div>
                                <div class="action-type-rate">{{ (strategy.success_rate * 100)|round|int }}% success ({{ strategy.total }} cases)</div>
                            </div>
                            <div class="action-type-bar">
                                <div class="action-type-bar-fill" style="width: {{ strategy.success_rate * 100 }}%;"></div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                            <h3>No Data Yet</h3>
                            <p>Apply recommendations and record outcomes to see statistics</p>
                        </div>
                    {% endif %}
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Action Types</div>
                    </div>

                    {% for key, action in action_types.items() %}
                    <div class="action-type-card" style="cursor: help;" title="{{ action.description }}">
                        <div class="action-type-icon {% if action.escalation_level <= 2 %}green{% elif action.escalation_level == 3 %}yellow{% elif action.escalation_level == 4 %}red{% else %}purple{% endif %}">
                            {% if key == 'standard_redispute' %}üîÑ{% elif key == 'mov_demand' %}üìù{% elif key == 'direct_furnisher' %}üì§{% elif key == 'regulatory_complaint' %}üìã{% elif key == 'intent_to_sue' %}‚öñÔ∏è{% elif key == 'settlement_demand' %}üí∞{% else %}üì¢{% endif %}
                        </div>
                        <div class="action-type-info">
                            <div class="action-type-name">{{ action.name }}</div>
                            <div class="action-type-rate">Level {{ action.escalation_level }} escalation</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Recently Applied</div>
                    </div>

                    {% if applied_recommendations %}
                        {% for rec in applied_recommendations[:5] %}
                        <div style="padding: 10px 0; border-bottom: 1px solid #f1f5f9;">
                            <div style="font-weight: 500; font-size: 13px; color: #1a1a2e;">{{ rec.creditor_name or 'Unknown' }}</div>
                            <div style="font-size: 12px; color: #64748b;">{{ action_types.get(rec.recommended_action, {}).get('name', rec.recommended_action) }}</div>
                            {% if rec.outcome_actual %}
                            <div style="font-size: 11px; color: #84cc16; margin-top: 3px;">Outcome: {{ rec.outcome_actual }}</div>
                            {% else %}
                            <div style="font-size: 11px; color: #94a3b8; margin-top: 3px;">Awaiting outcome</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state" style="padding: 20px;">
                            <p>No applied recommendations yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>

    <script>
        async function generateRecommendation(clientId) {
            try {
                const response = await fetch(`/api/escalation/recommend/${clientId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ save: true })
                });
                const data = await response.json();

                if (data.success) {
                    alert(`Generated ${data.recommendations.length} recommendation(s). Refreshing page...`);
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to generate recommendation'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    </script>
</body>
</html>
