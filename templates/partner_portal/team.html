{% extends 'partner_portal/base.html' %}
{% block title %}Team{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-row">
        <div>
            <h1 class="page-title">Team Management</h1>
            <p class="page-subtitle">Manage your organization's team members</p>
        </div>
        <button class="btn btn-primary" onclick="openInviteModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
                <line x1="20" y1="8" x2="20" y2="14"/>
                <line x1="23" y1="11" x2="17" y2="11"/>
            </svg>
            Invite Member
        </button>
    </div>
</div>

<!-- Team Stats -->
<div class="card stats-summary">
    <div class="stat-item">
        <span class="stat-label">Team Members</span>
        <span class="stat-value">{{ team_members | length }}</span>
    </div>
    <div class="stat-item">
        <span class="stat-label">Max Allowed</span>
        <span class="stat-value">{{ tenant.max_users }}</span>
    </div>
    <div class="stat-item">
        <span class="stat-label">Available Slots</span>
        <span class="stat-value">{{ tenant.max_users - (team_members | length) }}</span>
    </div>
</div>

<!-- Team List -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Team Members</h2>
    </div>

    {% if team_members %}
    <div class="team-grid">
        {% for member in team_members %}
        <div class="team-card">
            <div class="team-avatar">
                {{ member.staff.full_name[0] | upper if member.staff else 'U' }}
            </div>
            <div class="team-info">
                <div class="team-name">{{ member.staff.full_name if member.staff else 'Unknown' }}</div>
                <div class="team-email">{{ member.staff.email if member.staff else '' }}</div>
                <div class="team-meta">
                    <span class="badge {% if member.is_primary_admin %}badge-success{% else %}badge-muted{% endif %}">
                        {% if member.is_primary_admin %}Primary Admin{% else %}{{ member.role | title }}{% endif %}
                    </span>
                    <span class="team-date">Added {{ member.created_at.strftime('%b %d, %Y') if member.created_at else 'N/A' }}</span>
                </div>
            </div>
            {% if not member.is_primary_admin %}
            <button class="team-remove" onclick="removeMember({{ member.id }})" title="Remove member">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
            </button>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
        </svg>
        <p>No team members yet</p>
        <span>Invite team members to help manage your clients</span>
        <button class="btn btn-primary" onclick="openInviteModal()" style="margin-top: 20px;">Invite First Member</button>
    </div>
    {% endif %}
</div>

<!-- Invite Modal -->
<div class="modal-overlay" id="inviteModal" onclick="closeInviteModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>Invite Team Member</h3>
            <button class="modal-close" onclick="closeInviteModal()">&times;</button>
        </div>
        <form id="inviteForm" onsubmit="inviteMember(event)">
            <div class="form-group">
                <label class="form-label">Email Address</label>
                <input type="email" class="form-input" id="inviteEmail" required placeholder="team@example.com">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-input" id="inviteFirstName" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-input" id="inviteLastName" placeholder="Optional">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Role</label>
                <select class="form-input" id="inviteRole">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeInviteModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Send Invitation</button>
            </div>
        </form>
    </div>
</div>

<style>
.header-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.stats-summary {
    display: flex;
    gap: 40px;
    padding: 20px 24px;
    margin-bottom: 20px;
}

.stat-item {
    display: flex;
    flex-direction: column;
}

.stat-item .stat-label {
    font-size: 13px;
    color: var(--theme-text-secondary, #6b7280);
    margin-bottom: 4px;
}

.stat-item .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--theme-text-primary, #111827);
}

.team-grid {
    display: grid;
    gap: 16px;
}

.team-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: var(--theme-bg-tertiary, #f9fafb);
    border-radius: 12px;
    transition: all 0.2s;
}

.team-card:hover {
    background: var(--theme-bg-secondary, #f3f4f6);
}

.team-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--theme-accent, #22c55e) 0%, #16a34a 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 18px;
    flex-shrink: 0;
}

.team-info {
    flex: 1;
}

.team-name {
    font-weight: 600;
    color: var(--theme-text-primary, #111827);
    margin-bottom: 4px;
}

.team-email {
    font-size: 14px;
    color: var(--theme-text-secondary, #6b7280);
    margin-bottom: 8px;
}

.team-meta {
    display: flex;
    align-items: center;
    gap: 12px;
}

.team-date {
    font-size: 12px;
    color: var(--theme-text-secondary, #9ca3af);
}

.team-remove {
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    color: var(--theme-text-secondary, #9ca3af);
    border-radius: 8px;
    transition: all 0.2s;
}

.team-remove:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--theme-text-secondary, #6b7280);
}

.empty-state svg {
    width: 64px;
    height: 64px;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-state p {
    font-weight: 600;
    font-size: 18px;
    margin-bottom: 8px;
    color: var(--theme-text-primary, #374151);
}

/* Modal */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-overlay.active {
    display: flex;
}

.modal {
    background: var(--theme-card-bg, white);
    border-radius: 16px;
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--theme-border-primary, #e5e7eb);
}

.modal-header h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--theme-text-primary, #111827);
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--theme-text-secondary, #6b7280);
    padding: 0;
    line-height: 1;
}

.modal form {
    padding: 24px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function openInviteModal() {
    document.getElementById('inviteModal').classList.add('active');
}

function closeInviteModal(event) {
    if (!event || event.target === event.currentTarget) {
        document.getElementById('inviteModal').classList.remove('active');
        document.getElementById('inviteForm').reset();
    }
}

async function inviteMember(event) {
    event.preventDefault();

    const data = {
        email: document.getElementById('inviteEmail').value,
        first_name: document.getElementById('inviteFirstName').value,
        last_name: document.getElementById('inviteLastName').value,
        role: document.getElementById('inviteRole').value
    };

    try {
        const response = await fetch('/partner/api/team', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            showNotification('Team member invited successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(result.error || 'Failed to invite team member', 'error');
        }
    } catch (err) {
        showNotification('Failed to invite team member', 'error');
    }
}

async function removeMember(memberId) {
    if (!confirm('Are you sure you want to remove this team member?')) return;

    try {
        const response = await fetch(`/partner/api/team/${memberId}`, {
            method: 'DELETE'
        });

        const result = await response.json();
        if (result.success) {
            showNotification('Team member removed', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(result.error || 'Failed to remove team member', 'error');
        }
    } catch (err) {
        showNotification('Failed to remove team member', 'error');
    }
}

function showNotification(message, type) {
    const existing = document.querySelector('.notification');
    if (existing) existing.remove();

    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()">&times;</button>
    `;
    document.body.appendChild(notification);

    setTimeout(() => notification.remove(), 5000);
}

// Add notification styles
const style = document.createElement('style');
style.textContent = `
    .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 16px 20px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
    }
    .notification-success { background: #22c55e; color: white; }
    .notification-error { background: #ef4444; color: white; }
    .notification button {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
