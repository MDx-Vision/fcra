{% extends 'partner_portal/base.html' %}
{% block title %}Branding{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Branding</h1>
    <p class="page-subtitle">Customize your portal's look and feel</p>
</div>

<div class="branding-grid">
    <!-- Logo Upload -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Logo</h2>
        </div>
        <div class="logo-upload">
            <div class="logo-preview">
                {% if tenant.logo_url %}
                <img src="{{ tenant.logo_url }}" alt="Logo" id="logoPreview">
                {% else %}
                <div class="logo-placeholder" id="logoPreview">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21,15 16,10 5,21"/>
                    </svg>
                    <span>No logo uploaded</span>
                </div>
                {% endif %}
            </div>
            <div class="upload-controls">
                <input type="file" id="logoInput" accept="image/*" hidden>
                <button class="btn btn-primary" onclick="document.getElementById('logoInput').click()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Upload Logo
                </button>
                <p class="upload-hint">Recommended: 200x60px, PNG or SVG</p>
            </div>
        </div>
    </div>

    <!-- Favicon Upload -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Favicon</h2>
        </div>
        <div class="logo-upload">
            <div class="favicon-preview">
                {% if tenant.favicon_url %}
                <img src="{{ tenant.favicon_url }}" alt="Favicon" id="faviconPreview">
                {% else %}
                <div class="favicon-placeholder" id="faviconPreview">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                    </svg>
                </div>
                {% endif %}
            </div>
            <div class="upload-controls">
                <input type="file" id="faviconInput" accept=".ico,.png" hidden>
                <button class="btn btn-secondary" onclick="document.getElementById('faviconInput').click()">
                    Upload Favicon
                </button>
                <p class="upload-hint">32x32px, ICO or PNG</p>
            </div>
        </div>
    </div>
</div>

<!-- Colors -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Brand Colors</h2>
    </div>
    <div class="colors-grid">
        <div class="color-picker">
            <label class="form-label">Primary Color</label>
            <div class="color-input-group">
                <input type="color" id="primaryColor" value="{{ tenant.primary_color or '#22c55e' }}">
                <input type="text" class="form-input" id="primaryColorText" value="{{ tenant.primary_color or '#22c55e' }}">
            </div>
        </div>
        <div class="color-picker">
            <label class="form-label">Secondary Color</label>
            <div class="color-input-group">
                <input type="color" id="secondaryColor" value="{{ tenant.secondary_color or '#1a1a2e' }}">
                <input type="text" class="form-input" id="secondaryColorText" value="{{ tenant.secondary_color or '#1a1a2e' }}">
            </div>
        </div>
        <div class="color-picker">
            <label class="form-label">Accent Color</label>
            <div class="color-input-group">
                <input type="color" id="accentColor" value="{{ tenant.accent_color or '#22c55e' }}">
                <input type="text" class="form-input" id="accentColorText" value="{{ tenant.accent_color or '#22c55e' }}">
            </div>
        </div>
    </div>
</div>

<!-- Company Information -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Company Information</h2>
    </div>
    <form id="companyForm">
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Company Name</label>
                <input type="text" class="form-input" id="companyName" value="{{ tenant.company_name or '' }}">
            </div>
            <div class="form-group">
                <label class="form-label">Support Email</label>
                <input type="email" class="form-input" id="supportEmail" value="{{ tenant.support_email or '' }}">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Phone Number</label>
                <input type="tel" class="form-input" id="companyPhone" value="{{ tenant.company_phone or '' }}">
            </div>
            <div class="form-group">
                <label class="form-label">Company Email</label>
                <input type="email" class="form-input" id="companyEmail" value="{{ tenant.company_email or '' }}">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Company Address</label>
            <textarea class="form-input" id="companyAddress" rows="3">{{ tenant.company_address or '' }}</textarea>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Terms of Service URL</label>
                <input type="url" class="form-input" id="termsUrl" value="{{ tenant.terms_url or '' }}" placeholder="https://...">
            </div>
            <div class="form-group">
                <label class="form-label">Privacy Policy URL</label>
                <input type="url" class="form-input" id="privacyUrl" value="{{ tenant.privacy_url or '' }}" placeholder="https://...">
            </div>
        </div>
    </form>
</div>

<!-- Custom CSS -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Custom CSS</h2>
        <span class="badge badge-info">Advanced</span>
    </div>
    <div class="form-group">
        <label class="form-label">Additional CSS Styles</label>
        <textarea class="form-input code-input" id="customCss" rows="8" placeholder="/* Add custom CSS here */&#10;.my-custom-class {&#10;    color: #333;&#10;}">{{ tenant.custom_css or '' }}</textarea>
        <p class="form-hint">Custom CSS will be applied to client-facing pages</p>
    </div>
</div>

<!-- Save Button -->
<div class="save-actions">
    <button class="btn btn-primary btn-lg" onclick="saveBranding()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
            <polyline points="17 21 17 13 7 13 7 21"/>
            <polyline points="7 3 7 8 15 8"/>
        </svg>
        Save Changes
    </button>
</div>

<style>
.branding-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .branding-grid {
        grid-template-columns: 1fr;
    }
}

.logo-upload {
    display: flex;
    align-items: center;
    gap: 24px;
}

.logo-preview {
    width: 200px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px dashed var(--theme-border-primary, #e5e7eb);
    border-radius: 12px;
    background: var(--theme-bg-tertiary, #f9fafb);
    overflow: hidden;
}

.logo-preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

.logo-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    color: var(--theme-text-secondary, #9ca3af);
    font-size: 12px;
}

.logo-placeholder svg {
    width: 32px;
    height: 32px;
}

.favicon-preview {
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px dashed var(--theme-border-primary, #e5e7eb);
    border-radius: 12px;
    background: var(--theme-bg-tertiary, #f9fafb);
    overflow: hidden;
}

.favicon-preview img {
    width: 32px;
    height: 32px;
}

.favicon-placeholder svg {
    width: 24px;
    height: 24px;
    color: var(--theme-text-secondary, #9ca3af);
}

.upload-controls {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.upload-hint {
    font-size: 12px;
    color: var(--theme-text-secondary, #9ca3af);
}

.colors-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 24px;
}

.color-picker {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.color-input-group {
    display: flex;
    gap: 12px;
    align-items: center;
}

.color-input-group input[type="color"] {
    width: 50px;
    height: 40px;
    padding: 0;
    border: 1px solid var(--theme-border-primary, #e5e7eb);
    border-radius: 8px;
    cursor: pointer;
}

.color-input-group .form-input {
    flex: 1;
    font-family: monospace;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}

.code-input {
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 13px;
}

.form-hint {
    font-size: 12px;
    color: var(--theme-text-secondary, #9ca3af);
    margin-top: 8px;
}

.save-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 20px;
}

.btn-lg {
    padding: 14px 28px;
    font-size: 16px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Sync color pickers with text inputs
function syncColors() {
    ['primary', 'secondary', 'accent'].forEach(type => {
        const picker = document.getElementById(`${type}Color`);
        const text = document.getElementById(`${type}ColorText`);

        picker.addEventListener('input', () => {
            text.value = picker.value;
        });

        text.addEventListener('input', () => {
            if (/^#[0-9A-Fa-f]{6}$/.test(text.value)) {
                picker.value = text.value;
            }
        });
    });
}

// Logo upload
document.getElementById('logoInput').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('logo', file);

    try {
        const response = await fetch('/partner/api/branding/logo', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        if (data.success) {
            const preview = document.getElementById('logoPreview');
            if (preview.tagName === 'IMG') {
                preview.src = data.logo_url + '?t=' + Date.now();
            } else {
                preview.innerHTML = `<img src="${data.logo_url}?t=${Date.now()}" alt="Logo">`;
            }
            showNotification('Logo uploaded successfully', 'success');
        } else {
            showNotification(data.error || 'Failed to upload logo', 'error');
        }
    } catch (err) {
        showNotification('Failed to upload logo', 'error');
    }
});

// Favicon upload
document.getElementById('faviconInput').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('favicon', file);

    try {
        const response = await fetch('/partner/api/branding/favicon', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        if (data.success) {
            const preview = document.getElementById('faviconPreview');
            preview.innerHTML = `<img src="${data.favicon_url}?t=${Date.now()}" alt="Favicon">`;
            showNotification('Favicon uploaded successfully', 'success');
        } else {
            showNotification(data.error || 'Failed to upload favicon', 'error');
        }
    } catch (err) {
        showNotification('Failed to upload favicon', 'error');
    }
});

// Save all branding settings
async function saveBranding() {
    const data = {
        company_name: document.getElementById('companyName').value,
        company_phone: document.getElementById('companyPhone').value,
        company_email: document.getElementById('companyEmail').value,
        company_address: document.getElementById('companyAddress').value,
        support_email: document.getElementById('supportEmail').value,
        terms_url: document.getElementById('termsUrl').value,
        privacy_url: document.getElementById('privacyUrl').value,
        primary_color: document.getElementById('primaryColor').value,
        secondary_color: document.getElementById('secondaryColor').value,
        accent_color: document.getElementById('accentColor').value,
        custom_css: document.getElementById('customCss').value
    };

    try {
        const response = await fetch('/partner/api/branding', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            showNotification('Branding updated successfully', 'success');
        } else {
            showNotification(result.error || 'Failed to update branding', 'error');
        }
    } catch (err) {
        showNotification('Failed to update branding', 'error');
    }
}

// Notification helper
function showNotification(message, type) {
    const existing = document.querySelector('.notification');
    if (existing) existing.remove();

    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()">&times;</button>
    `;
    document.body.appendChild(notification);

    setTimeout(() => notification.remove(), 5000);
}

// Add notification styles
const style = document.createElement('style');
style.textContent = `
    .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 16px 20px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
    }
    .notification-success {
        background: #22c55e;
        color: white;
    }
    .notification-error {
        background: #ef4444;
        color: white;
    }
    .notification button {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
`;
document.head.appendChild(style);

// Initialize
syncColors();
</script>
{% endblock %}
