{% extends 'partner_portal/base.html' %}
{% block title %}Settings{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Settings</h1>
    <p class="page-subtitle">Manage your account and preferences</p>
</div>

<!-- Account Settings -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Account Settings</h2>
    </div>
    <form id="accountForm">
        <div class="form-group">
            <label class="form-label">Admin Email</label>
            <input type="email" class="form-input" id="adminEmail" value="{{ tenant.admin_email or '' }}">
            <p class="form-hint">This email is used to log into the partner portal</p>
        </div>
        <div class="form-group">
            <label class="form-label">Organization Name</label>
            <input type="text" class="form-input" value="{{ tenant.name }}" disabled>
            <p class="form-hint">Contact support to change your organization name</p>
        </div>
        <div class="form-group">
            <label class="form-label">Subdomain/Slug</label>
            <input type="text" class="form-input" value="{{ tenant.slug }}" disabled>
        </div>
        {% if tenant.domain %}
        <div class="form-group">
            <label class="form-label">Custom Domain</label>
            <input type="text" class="form-input" value="{{ tenant.domain }}" disabled>
        </div>
        {% endif %}
        <button type="submit" class="btn btn-primary" onclick="saveSettings(event)">Save Changes</button>
    </form>
</div>

<!-- Change Password -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Change Password</h2>
    </div>
    <form id="passwordForm" onsubmit="changePassword(event)">
        <div class="form-group">
            <label class="form-label">Current Password</label>
            <input type="password" class="form-input" id="currentPassword" required>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" class="form-input" id="newPassword" required minlength="8">
            </div>
            <div class="form-group">
                <label class="form-label">Confirm New Password</label>
                <input type="password" class="form-input" id="confirmPassword" required>
            </div>
        </div>
        <p class="form-hint">Password must be at least 8 characters</p>
        <button type="submit" class="btn btn-primary">Change Password</button>
    </form>
</div>

<!-- API Settings -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">API Access</h2>
        <span class="badge badge-info">Developer</span>
    </div>
    <div class="form-group">
        <label class="form-label">API Key</label>
        <div class="api-key-group">
            <input type="password" class="form-input" id="apiKeyInput" value="{{ tenant.api_key or 'Not generated' }}" readonly>
            <button type="button" class="btn btn-secondary" onclick="toggleApiKey()">
                <svg id="eyeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
            </button>
            <button type="button" class="btn btn-secondary" onclick="copyApiKey()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                </svg>
            </button>
        </div>
        <p class="form-hint">Use this key to authenticate API requests</p>
    </div>
    <div class="form-group">
        <label class="form-label">Webhook URL (Optional)</label>
        <input type="url" class="form-input" id="webhookUrl" value="{{ tenant.webhook_url or '' }}" placeholder="https://your-server.com/webhook">
        <p class="form-hint">We'll send event notifications to this URL</p>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-secondary" onclick="regenerateApiKey()">Regenerate API Key</button>
        <button type="button" class="btn btn-primary" onclick="saveSettings(event)">Save Webhook URL</button>
    </div>
</div>

<!-- Subscription Info -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Subscription</h2>
    </div>
    <div class="subscription-info">
        <div class="subscription-plan">
            <span class="plan-name">{{ tenant.subscription_tier | title }} Plan</span>
            <span class="badge badge-success">Active</span>
        </div>
        <div class="plan-limits">
            <div class="limit-item">
                <span class="limit-label">Clients</span>
                <span class="limit-value">{{ tenant.max_clients }} max</span>
            </div>
            <div class="limit-item">
                <span class="limit-label">Team Members</span>
                <span class="limit-value">{{ tenant.max_users }} max</span>
            </div>
        </div>
        <p class="upgrade-hint">Need more capacity? Contact us to upgrade your plan.</p>
    </div>
</div>

<style>
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}

.form-hint {
    font-size: 12px;
    color: var(--theme-text-secondary, #9ca3af);
    margin-top: 6px;
}

.api-key-group {
    display: flex;
    gap: 8px;
}

.api-key-group input {
    flex: 1;
    font-family: monospace;
}

.btn-group {
    display: flex;
    gap: 12px;
    margin-top: 16px;
}

.subscription-info {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.subscription-plan {
    display: flex;
    align-items: center;
    gap: 12px;
}

.plan-name {
    font-size: 20px;
    font-weight: 600;
    color: var(--theme-text-primary, #111827);
}

.plan-limits {
    display: flex;
    gap: 32px;
    padding: 16px;
    background: var(--theme-bg-tertiary, #f9fafb);
    border-radius: 10px;
}

.limit-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.limit-label {
    font-size: 13px;
    color: var(--theme-text-secondary, #6b7280);
}

.limit-value {
    font-weight: 600;
    color: var(--theme-text-primary, #111827);
}

.upgrade-hint {
    font-size: 14px;
    color: var(--theme-text-secondary, #6b7280);
}
</style>
{% endblock %}

{% block scripts %}
<script>
let apiKeyVisible = false;

async function saveSettings(event) {
    if (event) event.preventDefault();

    const data = {
        admin_email: document.getElementById('adminEmail').value,
        webhook_url: document.getElementById('webhookUrl').value
    };

    try {
        const response = await fetch('/partner/api/settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            showNotification('Settings saved successfully', 'success');
        } else {
            showNotification(result.error || 'Failed to save settings', 'error');
        }
    } catch (err) {
        showNotification('Failed to save settings', 'error');
    }
}

async function changePassword(event) {
    event.preventDefault();

    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (newPassword !== confirmPassword) {
        showNotification('Passwords do not match', 'error');
        return;
    }

    const data = {
        current_password: document.getElementById('currentPassword').value,
        new_password: newPassword,
        confirm_password: confirmPassword
    };

    try {
        const response = await fetch('/partner/api/settings/password', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            showNotification('Password changed successfully', 'success');
            document.getElementById('passwordForm').reset();
        } else {
            showNotification(result.error || 'Failed to change password', 'error');
        }
    } catch (err) {
        showNotification('Failed to change password', 'error');
    }
}

function toggleApiKey() {
    const input = document.getElementById('apiKeyInput');
    apiKeyVisible = !apiKeyVisible;
    input.type = apiKeyVisible ? 'text' : 'password';
}

function copyApiKey() {
    const input = document.getElementById('apiKeyInput');
    const originalType = input.type;
    input.type = 'text';
    input.select();
    document.execCommand('copy');
    input.type = originalType;
    showNotification('API key copied to clipboard', 'success');
}

async function regenerateApiKey() {
    if (!confirm('Are you sure you want to regenerate your API key? The old key will stop working immediately.')) {
        return;
    }

    try {
        const response = await fetch('/partner/api/settings/regenerate-api-key', {
            method: 'POST'
        });

        const result = await response.json();
        if (result.success) {
            document.getElementById('apiKeyInput').value = result.api_key;
            showNotification('API key regenerated successfully', 'success');
        } else {
            showNotification(result.error || 'Failed to regenerate API key', 'error');
        }
    } catch (err) {
        showNotification('Failed to regenerate API key', 'error');
    }
}

function showNotification(message, type) {
    const existing = document.querySelector('.notification');
    if (existing) existing.remove();

    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()">&times;</button>
    `;
    document.body.appendChild(notification);

    setTimeout(() => notification.remove(), 5000);
}

// Add notification styles
const style = document.createElement('style');
style.textContent = `
    .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 16px 20px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
    }
    .notification-success { background: #22c55e; color: white; }
    .notification-error { background: #ef4444; color: white; }
    .notification button {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
