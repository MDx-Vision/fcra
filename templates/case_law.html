<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Law Database - Brightpath Ascend FCRA Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    {% include 'includes/dashboard_sidebar_styles.html' %}
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        
        .main-content {
            margin-left: 260px;
            padding: 30px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a2e;
        }
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #319795 0%, #84cc16 100%);
            color: #1a1a2e;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(49, 151, 149, 0.4); }
        .btn-secondary {
            background: white;
            color: #1a1a2e;
            border: 2px solid #e2e8f0;
        }
        .btn-secondary:hover { border-color: #84cc16; }
        .btn-sm { padding: 8px 16px; font-size: 12px; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-card.highlight {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
        }
        .stat-label {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .stat-card.highlight .stat-label { color: #94a3b8; }
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a2e;
        }
        .stat-card.highlight .stat-value { color: #84cc16; }
        
        .content-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a2e;
        }
        
        .filters-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
        }
        .filter-group select, .filter-group input {
            padding: 10px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            min-width: 180px;
        }
        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: #84cc16;
        }
        
        .search-box {
            display: flex;
            align-items: center;
            background: #f8fafc;
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #e2e8f0;
            flex: 1;
            max-width: 400px;
        }
        .search-box input {
            flex: 1;
            border: none;
            background: none;
            font-size: 14px;
            outline: none;
        }
        .search-box svg { color: #94a3b8; margin-right: 10px; }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            text-align: left;
            padding: 12px 15px;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e2e8f0;
        }
        td {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            color: #334155;
        }
        tr:hover { background: #f8fafc; cursor: pointer; }
        
        .case-name {
            font-weight: 600;
            color: #1a1a2e;
        }
        .case-citation {
            font-size: 12px;
            color: #64748b;
            font-style: italic;
        }
        
        .tag {
            display: inline-block;
            padding: 4px 10px;
            background: #e0e7ff;
            color: #3730a3;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin: 2px;
        }
        .tag.court { background: #dbeafe; color: #1e40af; }
        .tag.section { background: #dcfce7; color: #166534; }
        .tag.violation { background: #fef3c7; color: #92400e; }
        
        .relevance-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 14px;
        }
        .relevance-5 { background: #dcfce7; color: #166534; }
        .relevance-4 { background: #d1fae5; color: #065f46; }
        .relevance-3 { background: #fef3c7; color: #92400e; }
        .relevance-2 { background: #fee2e2; color: #991b1b; }
        .relevance-1 { background: #fecaca; color: #7f1d1d; }
        
        .outcome-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .outcome-won { background: #dcfce7; color: #166534; }
        .outcome-lost { background: #fee2e2; color: #991b1b; }
        .outcome-unknown { background: #f1f5f9; color: #64748b; }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: white;
            border-radius: 16px;
            width: 800px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a2e;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }
        .modal-body {
            padding: 24px;
        }
        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .detail-item {
            margin-bottom: 15px;
        }
        .detail-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .detail-value {
            font-size: 14px;
            color: #1a1a2e;
        }
        .detail-value.highlight {
            font-size: 16px;
            font-weight: 600;
        }
        
        .quote-box {
            background: #f8fafc;
            border-left: 4px solid #84cc16;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }
        .quote-text {
            font-style: italic;
            color: #334155;
            margin-bottom: 5px;
        }
        .quote-page {
            font-size: 12px;
            color: #64748b;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #334155;
            margin-bottom: 8px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #84cc16;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        .empty-state h3 {
            font-size: 18px;
            color: #1a1a2e;
            margin-bottom: 10px;
        }
        
        .copy-btn {
            padding: 6px 12px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .copy-btn:hover { background: #e2e8f0; }
        .copy-btn.copied { background: #dcfce7; border-color: #84cc16; color: #166534; }
        
        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .detail-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    {% set active_page = 'case-law' %}
    {% include 'includes/dashboard_sidebar.html' %}
    
    <main class="main-content">
        <div class="header">
            <h1>Case Law Citation Database</h1>
            <div class="header-actions">
                {% if session.get('staff_role') == 'admin' %}
                <button class="btn btn-secondary" onclick="populateDefaultCases()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Populate Default Cases
                </button>
                <button class="btn btn-primary" onclick="openAddModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Add Citation
                </button>
                {% endif %}
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card highlight">
                <div class="stat-label">Total Citations</div>
                <div class="stat-value">{{ total_cases }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Courts Represented</div>
                <div class="stat-value">{{ courts|length }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Violation Types</div>
                <div class="stat-value">{{ violation_types|length }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">FCRA Sections</div>
                <div class="stat-value">{{ fcra_sections|length }}</div>
            </div>
        </div>
        
        <div class="content-section">
            <div class="section-header">
                <div class="section-title">FCRA Case Law Citations</div>
            </div>
            
            <div class="filters-row">
                <div class="search-box">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <input type="text" id="searchInput" placeholder="Search cases..." onkeyup="filterCases()">
                </div>
                
                <div class="filter-group">
                    <label>Court</label>
                    <select id="courtFilter" onchange="filterCases()">
                        <option value="">All Courts</option>
                        {% for court in courts %}
                        <option value="{{ court }}">{{ court }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Violation Type</label>
                    <select id="violationFilter" onchange="filterCases()">
                        <option value="">All Types</option>
                        {% for vt in violation_types %}
                        <option value="{{ vt }}">{{ vt|replace('_', ' ')|title }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>FCRA Section</label>
                    <select id="sectionFilter" onchange="filterCases()">
                        <option value="">All Sections</option>
                        {% for section in fcra_sections %}
                        <option value="{{ section }}">§ {{ section }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            {% if cases %}
            <table id="casesTable">
                <thead>
                    <tr>
                        <th>Case</th>
                        <th>Court</th>
                        <th>Year</th>
                        <th>FCRA Sections</th>
                        <th>Violation Types</th>
                        <th>Relevance</th>
                        <th>Outcome</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for case in cases %}
                    <tr data-case='{{ case|tojson|safe }}' onclick="viewCase({{ case.id }})">
                        <td>
                            <div class="case-name">{{ case.case_name }}</div>
                            <div class="case-citation">{{ case.citation }}</div>
                        </td>
                        <td><span class="tag court">{{ case.court }}</span></td>
                        <td>{{ case.year }}</td>
                        <td>
                            {% for section in (case.fcra_sections or [])[:3] %}
                            <span class="tag section">§{{ section }}</span>
                            {% endfor %}
                            {% if (case.fcra_sections or [])|length > 3 %}
                            <span class="tag">+{{ (case.fcra_sections or [])|length - 3 }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% for vt in (case.violation_types or [])[:2] %}
                            <span class="tag violation">{{ vt|replace('_', ' ')|title }}</span>
                            {% endfor %}
                            {% if (case.violation_types or [])|length > 2 %}
                            <span class="tag">+{{ (case.violation_types or [])|length - 2 }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="relevance-badge relevance-{{ case.relevance_score }}">{{ case.relevance_score }}</span>
                        </td>
                        <td>
                            {% if case.plaintiff_won == true %}
                            <span class="outcome-badge outcome-won">Won</span>
                            {% elif case.plaintiff_won == false %}
                            <span class="outcome-badge outcome-lost">Lost</span>
                            {% else %}
                            <span class="outcome-badge outcome-unknown">N/A</span>
                            {% endif %}
                        </td>
                        <td onclick="event.stopPropagation()">
                            <button class="copy-btn" onclick="copyCitation({{ case.id }}, 'short', this)">Copy Short</button>
                            <button class="copy-btn" onclick="copyCitation({{ case.id }}, 'full', this)">Copy Full</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                <h3>No case law citations yet</h3>
                <p>{% if session.get('staff_role') == 'admin' %}Click "Populate Default Cases" to add FCRA case law{% else %}Contact an administrator to populate the case law database{% endif %}</p>
                {% if session.get('staff_role') == 'admin' %}
                <button class="btn btn-primary" onclick="populateDefaultCases()">Populate Default Cases</button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </main>
    
    <div id="viewModal" class="modal-overlay" onclick="if(event.target===this)closeModal('viewModal')">
        <div class="modal">
            <div class="modal-header">
                <h2 id="viewModalTitle">Case Details</h2>
                <button class="modal-close" onclick="closeModal('viewModal')">&times;</button>
            </div>
            <div class="modal-body" id="viewModalBody">
            </div>
            <div class="modal-footer">
                <button class="copy-btn" onclick="copyCitationFromModal('short')">Copy Short Citation</button>
                <button class="copy-btn" onclick="copyCitationFromModal('full')">Copy Full Citation</button>
                <button class="copy-btn" onclick="copyCitationFromModal('with_holding')">Copy With Holding</button>
                {% if session.get('staff_role') == 'admin' %}
                <button class="btn btn-danger btn-sm" onclick="deleteCase()">Delete</button>
                {% endif %}
                <button class="btn btn-secondary" onclick="closeModal('viewModal')">Close</button>
            </div>
        </div>
    </div>
    
    <div id="addModal" class="modal-overlay" onclick="if(event.target===this)closeModal('addModal')">
        <div class="modal">
            <div class="modal-header">
                <h2>Add Case Law Citation</h2>
                <button class="modal-close" onclick="closeModal('addModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addCaseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Case Name *</label>
                            <input type="text" name="case_name" required placeholder="e.g., Safeco Insurance Co. v. Burr">
                        </div>
                        <div class="form-group">
                            <label>Citation *</label>
                            <input type="text" name="citation" required placeholder="e.g., 551 U.S. 47 (2007)">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Court</label>
                            <input type="text" name="court" placeholder="e.g., Supreme Court, 9th Circuit">
                        </div>
                        <div class="form-group">
                            <label>Year</label>
                            <input type="number" name="year" placeholder="e.g., 2007">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>FCRA Sections (comma-separated)</label>
                            <input type="text" name="fcra_sections" placeholder="e.g., 611, 623, 605B">
                        </div>
                        <div class="form-group">
                            <label>Violation Types (comma-separated)</label>
                            <input type="text" name="violation_types" placeholder="e.g., reinsertion, willfulness">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Key Holding</label>
                        <textarea name="key_holding" placeholder="Main legal principle established by this case"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Full Summary</label>
                        <textarea name="full_summary" placeholder="Detailed case summary"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Damages Awarded ($)</label>
                            <input type="number" name="damages_awarded" step="0.01" placeholder="e.g., 50000.00">
                        </div>
                        <div class="form-group">
                            <label>Plaintiff Won?</label>
                            <select name="plaintiff_won">
                                <option value="">Unknown</option>
                                <option value="true">Yes - Plaintiff Won</option>
                                <option value="false">No - Defendant Won</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Relevance Score (1-5)</label>
                            <select name="relevance_score">
                                <option value="3">3 - Moderate</option>
                                <option value="5">5 - Essential</option>
                                <option value="4">4 - High</option>
                                <option value="2">2 - Low</option>
                                <option value="1">1 - Minimal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tags (comma-separated)</label>
                            <input type="text" name="tags" placeholder="e.g., willfulness, punitive, supreme_court">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea name="notes" placeholder="Additional notes about this case"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveCase()">Save Citation</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentCase = null;
        
        function filterCases() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const court = document.getElementById('courtFilter').value;
            const violation = document.getElementById('violationFilter').value;
            const section = document.getElementById('sectionFilter').value;
            
            const rows = document.querySelectorAll('#casesTable tbody tr');
            rows.forEach(row => {
                const data = JSON.parse(row.dataset.case);
                let show = true;
                
                if (search) {
                    const searchText = (data.case_name + ' ' + data.citation + ' ' + data.key_holding + ' ' + (data.tags || []).join(' ')).toLowerCase();
                    if (!searchText.includes(search)) show = false;
                }
                if (court && data.court !== court) show = false;
                if (violation && !(data.violation_types || []).includes(violation)) show = false;
                if (section && !(data.fcra_sections || []).includes(section)) show = false;
                
                row.style.display = show ? '' : 'none';
            });
        }
        
        function viewCase(id) {
            fetch(`/api/case-law/${id}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        currentCase = data.case;
                        showCaseDetails(data.case);
                    }
                });
        }
        
        function showCaseDetails(c) {
            document.getElementById('viewModalTitle').textContent = c.case_name;
            
            let quotesHtml = '';
            if (c.quote_snippets && c.quote_snippets.length > 0) {
                quotesHtml = '<div class="detail-item" style="grid-column: span 2;"><div class="detail-label">Key Quotes</div>';
                c.quote_snippets.forEach(q => {
                    quotesHtml += `<div class="quote-box"><div class="quote-text">"${q.quote}"</div><div class="quote-page">Page ${q.page}</div></div>`;
                });
                quotesHtml += '</div>';
            }
            
            const tagsHtml = (c.tags || []).map(t => `<span class="tag">${t}</span>`).join(' ');
            const sectionsHtml = (c.fcra_sections || []).map(s => `<span class="tag section">§${s}</span>`).join(' ');
            const violationsHtml = (c.violation_types || []).map(v => `<span class="tag violation">${v.replace(/_/g, ' ')}</span>`).join(' ');
            
            document.getElementById('viewModalBody').innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Citation</div>
                        <div class="detail-value highlight">${c.citation}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Court</div>
                        <div class="detail-value">${c.court || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Year</div>
                        <div class="detail-value">${c.year || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Outcome</div>
                        <div class="detail-value">${c.plaintiff_won === true ? '✅ Plaintiff Won' : c.plaintiff_won === false ? '❌ Defendant Won' : 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Damages Awarded</div>
                        <div class="detail-value">${c.damages_awarded ? '$' + c.damages_awarded.toLocaleString() : 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Relevance Score</div>
                        <div class="detail-value"><span class="relevance-badge relevance-${c.relevance_score}">${c.relevance_score}</span>/5</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">FCRA Sections</div>
                    <div class="detail-value">${sectionsHtml || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Violation Types</div>
                    <div class="detail-value">${violationsHtml || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Key Holding</div>
                    <div class="detail-value">${c.key_holding || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Full Summary</div>
                    <div class="detail-value">${c.full_summary || 'N/A'}</div>
                </div>
                ${quotesHtml}
                <div class="detail-item">
                    <div class="detail-label">Tags</div>
                    <div class="detail-value">${tagsHtml || 'N/A'}</div>
                </div>
                ${c.notes ? `<div class="detail-item"><div class="detail-label">Notes</div><div class="detail-value">${c.notes}</div></div>` : ''}
            `;
            
            document.getElementById('viewModal').classList.add('active');
        }
        
        function copyCitation(id, format, btn) {
            fetch(`/api/case-law/format/${id}?format=${format}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        navigator.clipboard.writeText(data.formatted_citation);
                        btn.classList.add('copied');
                        btn.textContent = 'Copied!';
                        setTimeout(() => {
                            btn.classList.remove('copied');
                            btn.textContent = format === 'short' ? 'Copy Short' : 'Copy Full';
                        }, 2000);
                    }
                });
        }
        
        function copyCitationFromModal(format) {
            if (!currentCase) return;
            fetch(`/api/case-law/format/${currentCase.id}?format=${format}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        navigator.clipboard.writeText(data.formatted_citation);
                        alert('Citation copied to clipboard!');
                    }
                });
        }
        
        function openAddModal() {
            document.getElementById('addCaseForm').reset();
            document.getElementById('addModal').classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function saveCase() {
            const form = document.getElementById('addCaseForm');
            const formData = new FormData(form);
            const data = {};
            
            formData.forEach((value, key) => {
                if (key === 'fcra_sections' || key === 'violation_types' || key === 'tags') {
                    data[key] = value ? value.split(',').map(s => s.trim()).filter(s => s) : [];
                } else if (key === 'year' || key === 'relevance_score') {
                    data[key] = value ? parseInt(value) : null;
                } else if (key === 'damages_awarded') {
                    data[key] = value ? parseFloat(value) : null;
                } else if (key === 'plaintiff_won') {
                    data[key] = value === 'true' ? true : value === 'false' ? false : null;
                } else {
                    data[key] = value || null;
                }
            });
            
            fetch('/api/case-law', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    alert('Case added successfully!');
                    window.location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            });
        }
        
        function deleteCase() {
            if (!currentCase) return;
            if (!confirm(`Are you sure you want to delete "${currentCase.case_name}"?`)) return;
            
            fetch(`/api/case-law/${currentCase.id}`, {method: 'DELETE'})
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        alert('Case deleted!');
                        window.location.reload();
                    } else {
                        alert('Error: ' + result.error);
                    }
                });
        }
        
        function populateDefaultCases() {
            if (!confirm('This will add default FCRA case law citations to the database. Continue?')) return;
            
            fetch('/api/case-law/populate', {method: 'POST'})
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        alert(result.message);
                        window.location.reload();
                    } else {
                        alert('Error: ' + result.error);
                    }
                });
        }
    </script>
</body>
</html>
