<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Portal - Brightpath Ascend Group</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 30px;
        }
        .logo {
            color: white;
            font-size: 20px;
            font-weight: 700;
        }
        .logo span { color: #4ade80; }
        .portal-title {
            color: white;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.8;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .greeting {
            color: white;
            font-size: 14px;
        }
        .greeting strong {
            color: #4ade80;
        }
        .date-display {
            color: rgba(255,255,255,0.6);
            font-size: 13px;
        }
        .nav-tabs {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            padding: 0 30px;
            gap: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .nav-tab {
            padding: 15px 25px;
            color: #64748b;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }
        .nav-tab:hover {
            color: #1a1a2e;
            background: #f8fafc;
        }
        .nav-tab.active {
            color: #4ade80;
            border-bottom-color: #4ade80;
            background: rgba(74, 222, 128, 0.05);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        .status-banner {
            text-align: center;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        .status-banner.pending {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }
        .status-banner.ready {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        }
        .status-banner.processing {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }
        .status-banner h2 {
            font-size: 22px;
            color: #1a1a2e;
            margin-bottom: 10px;
        }
        .status-banner p {
            color: #64748b;
            font-size: 14px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-box {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a2e;
        }
        .stat-value.green { color: #22c55e; }
        .stat-value.blue { color: #3b82f6; }
        .stat-label {
            font-size: 13px;
            color: #64748b;
            margin-top: 5px;
        }
        .progress-timeline {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin: 40px 0;
            padding: 0 20px;
        }
        .progress-timeline::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 60px;
            right: 60px;
            height: 4px;
            background: #e5e7eb;
        }
        .timeline-step {
            text-align: center;
            position: relative;
            z-index: 1;
            flex: 1;
        }
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 600;
            color: #64748b;
            font-size: 14px;
        }
        .timeline-step.complete .step-circle {
            background: #22c55e;
            color: white;
        }
        .timeline-step.current .step-circle {
            background: #3b82f6;
            color: white;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        }
        .step-label {
            font-size: 12px;
            color: #64748b;
        }
        .timeline-step.complete .step-label { color: #22c55e; }
        .timeline-step.current .step-label { color: #3b82f6; font-weight: 600; }
        .violations-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .violation-card {
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        .violation-bureau {
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 5px;
        }
        .violation-type {
            font-size: 13px;
            color: #64748b;
        }
        .document-list {
            margin-top: 15px;
        }
        .document-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .document-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .document-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }
        .document-name {
            font-weight: 500;
            color: #1a1a2e;
        }
        .document-meta {
            font-size: 12px;
            color: #94a3b8;
        }
        .download-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            border: none;
            border-radius: 6px;
            color: #1a1a2e;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            text-decoration: none;
        }
        .download-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 222, 128, 0.3);
        }
        .upload-area {
            border: 2px dashed #e5e7eb;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.05);
        }
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .upload-text {
            color: #64748b;
            margin-bottom: 10px;
        }
        .upload-hint {
            font-size: 12px;
            color: #94a3b8;
        }
        .response-list {
            margin-top: 20px;
        }
        .response-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3b82f6;
        }
        .response-item.verified { border-left-color: #f59e0b; }
        .response-item.deleted { border-left-color: #22c55e; }
        .response-item.investigating { border-left-color: #8b5cf6; }
        .contact-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        .contact-card {
            text-align: center;
            padding: 30px 20px;
            background: #f8fafc;
            border-radius: 12px;
        }
        .contact-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 20px;
        }
        .contact-title {
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 5px;
        }
        .contact-value {
            color: #3b82f6;
            text-decoration: none;
            font-size: 14px;
        }
        .education-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        .education-card {
            padding: 25px;
            background: #f8fafc;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .education-card:hover {
            background: #f1f5f9;
            transform: translateY(-2px);
        }
        .education-title {
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .education-desc {
            font-size: 14px;
            color: #64748b;
            line-height: 1.5;
        }
        .referral-section {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            padding: 30px;
            color: white;
            margin-bottom: 25px;
        }
        .referral-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .referral-title {
            font-size: 20px;
            font-weight: 600;
        }
        .referral-code-box {
            background: rgba(255,255,255,0.1);
            padding: 15px 25px;
            border-radius: 8px;
            text-align: center;
        }
        .referral-code-label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .referral-code-value {
            font-size: 24px;
            font-weight: 700;
            color: #4ade80;
            font-family: monospace;
            letter-spacing: 2px;
        }
        .referral-form {
            background: white;
            border-radius: 12px;
            padding: 25px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .submit-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            border: none;
            border-radius: 8px;
            color: #1a1a2e;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        .submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 222, 128, 0.3);
        }
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .violations-grid { grid-template-columns: 1fr; }
            .contact-grid { grid-template-columns: 1fr; }
            .education-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .nav-tabs { overflow-x: auto; }
            .header { flex-direction: column; gap: 15px; }
        }
        
        /* Status Badge Styles */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }
        .status-badge.status-sent { background: #dbeafe; color: #1e40af; }
        .status-badge.status-deleted { background: #dcfce7; color: #166534; }
        .status-badge.status-updated { background: #fef3c7; color: #92400e; }
        .status-badge.status-in_progress { background: #e0e7ff; color: #3730a3; }
        .status-badge.status-to_do { background: #f3f4f6; color: #374151; }
        .status-badge.status-no_change { background: #fecaca; color: #991b1b; }
        .status-badge.status-no_answer { background: #fed7aa; color: #9a3412; }
        .status-badge.status-on_hold { background: #e5e7eb; color: #4b5563; }
        .status-badge.status-positive { background: #bbf7d0; color: #166534; }
        .status-badge.status-duplicate { background: #f5f5f4; color: #78716c; }
        .status-badge.status-other { background: #f3e8ff; color: #6b21a8; }
        .status-badge.status-frozen { background: #dbeafe; color: #1e40af; }
        .status-badge.status-pending { background: #fef3c7; color: #92400e; }
        .status-badge.status-not_frozen { background: #fecaca; color: #991b1b; }
        
        .comment-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 12px;
        }
        .comment-input:focus {
            outline: none;
            border-color: #4ade80;
        }
        
        .bureau-section {
            border-left: 4px solid #e5e7eb;
        }
        .bureau-section:nth-child(1) { border-left-color: #991b1b; }
        .bureau-section:nth-child(2) { border-left-color: #1e40af; }
        .bureau-section:nth-child(3) { border-left-color: #0369a1; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="logo">Brightpath <span>Ascend</span></div>
            <span class="portal-title">Client Portal</span>
        </div>
        <div class="header-right">
            <div class="greeting">Hello, <strong>{{ client.name if client else 'Client' }}</strong></div>
            <div class="date-display">As of: {{ now.strftime('%m/%d/%Y') if now else '' }}</div>
        </div>
    </header>
    
    <nav class="nav-tabs">
        <a class="nav-tab active" data-tab="summary">Summary</a>
        <a class="nav-tab" data-tab="status">Status</a>
        <a class="nav-tab" data-tab="attachments">Attachments</a>
        <a class="nav-tab" data-tab="contact">Contact Us</a>
        <a class="nav-tab" data-tab="education">Education</a>
        <a class="nav-tab" data-tab="referral">Refer a Friend</a>
    </nav>
    
    <div class="container">
        <!-- Summary Tab -->
        <div class="tab-content active" id="summary">
            {% if analysis and analysis.stage == 2 %}
            <div class="status-banner ready">
                <h2>Your Documents Are Ready!</h2>
                <p>Your comprehensive FCRA litigation package has been prepared and is ready for download.</p>
            </div>
            {% elif analysis and analysis.stage == 1 %}
            <div class="status-banner processing">
                <h2>Analysis In Progress</h2>
                <p>We've identified violations in your credit report. Our team is preparing your documents.</p>
            </div>
            {% else %}
            <div class="status-banner pending">
                <h2>Welcome to Your Portal</h2>
                <p>We're getting started on your case. Check back soon for updates!</p>
            </div>
            {% endif %}
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value">{{ violations|length if violations else 0 }}</div>
                    <div class="stat-label">Violations Found</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value green">{{ score.total_score if score else '-' }}/10</div>
                    <div class="stat-label">Case Strength</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value blue">{{ client.current_dispute_round if client and client.current_dispute_round else 1 }}</div>
                    <div class="stat-label">Dispute Round</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${{ "{:,.0f}".format(damages.total_exposure if damages else 0) }}</div>
                    <div class="stat-label">Potential Recovery</div>
                </div>
            </div>
            
            {% if violations %}
            <div class="card">
                <div class="card-title">Violations Identified</div>
                <div class="violations-grid">
                    {% for v in violations[:6] %}
                    <div class="violation-card">
                        <div class="violation-bureau">{{ v.bureau }}</div>
                        <div class="violation-type">{{ v.violation_type }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% if violations|length > 6 %}
                <p style="text-align: center; margin-top: 15px; color: #64748b;">
                    + {{ violations|length - 6 }} more violations identified
                </p>
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        <!-- Status Tab -->
        <div class="tab-content" id="status">
            <div class="card" style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="card-title" style="margin-bottom: 0; border-bottom: none; padding-bottom: 0;">Credit Report Status for {{ client.name if client else 'Client' }}</div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="showAllItems()" class="submit-btn" style="padding: 8px 15px; font-size: 12px;">Show all</button>
                        <button onclick="submitStatusChanges()" class="submit-btn" style="padding: 8px 15px; font-size: 12px;">Submit changes</button>
                    </div>
                </div>
                <p style="color: #dc2626; font-size: 13px; margin-bottom: 15px;">
                    If there is a derogatory item you don't want to be disputed, please let us know in the Dispute Reason or the Comment field.
                </p>
                <a href="#legend" style="color: #3b82f6; font-size: 13px; text-decoration: underline;">How to use the Status Area?</a>
            </div>
            
            <!-- EQUIFAX Section -->
            <div class="card bureau-section" style="margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/48/Equifax.svg/200px-Equifax.svg.png" alt="Equifax" style="height: 25px;" onerror="this.style.display='none'">
                    <span style="font-weight: 700; font-size: 18px; color: #991b1b;">EQUIFAX</span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="status-table" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e5e7eb;">
                                <th style="text-align: left; padding: 10px; color: #64748b;">Follow up</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Type</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">R</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Creditor</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Account ID</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Status</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Reason</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Comments</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set equifax_items = dispute_items|selectattr('bureau', 'equalto', 'Equifax')|list if dispute_items else [] %}
                            {% if equifax_items %}
                                {% for item in equifax_items %}
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 10px;">{{ item.follow_up_date.strftime('%Y-%m-%d') if item.follow_up_date else 'n/a' }}</td>
                                    <td style="padding: 10px;">{{ item.item_type|title if item.item_type else '' }}</td>
                                    <td style="padding: 10px;">{{ item.dispute_round }}</td>
                                    <td style="padding: 10px;">{{ item.creditor_name or '' }}</td>
                                    <td style="padding: 10px;">{{ item.account_id or 'n/a' }}</td>
                                    <td style="padding: 10px;">
                                        <span class="status-badge status-{{ item.status }}">{{ item.status|upper }}</span>
                                    </td>
                                    <td style="padding: 10px;">{{ item.reason or '' }}</td>
                                    <td style="padding: 10px;"><input type="text" class="comment-input" data-id="{{ item.id }}" value="{{ item.comments or '' }}" placeholder="Add comment"></td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td colspan="8" style="padding: 20px; text-align: center; color: #64748b;">No items tracked yet for Equifax</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                {% if equifax_items %}
                <div style="margin-top: 10px; font-size: 12px; color: #64748b;">
                    Total Items: {{ equifax_items|length }} | 
                    Deleted: {{ equifax_items|selectattr('status', 'equalto', 'deleted')|list|length }} |
                    In Progress: {{ equifax_items|selectattr('status', 'equalto', 'in_progress')|list|length }}
                </div>
                {% endif %}
            </div>
            
            <!-- EXPERIAN Section -->
            <div class="card bureau-section" style="margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/27/Experian_logo.svg/200px-Experian_logo.svg.png" alt="Experian" style="height: 25px;" onerror="this.style.display='none'">
                    <span style="font-weight: 700; font-size: 18px; color: #1e40af;">Experian</span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="status-table" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e5e7eb;">
                                <th style="text-align: left; padding: 10px; color: #64748b;">Follow up</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Type</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">R</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Creditor</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Account ID</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Status</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Reason</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Comments</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set experian_items = dispute_items|selectattr('bureau', 'equalto', 'Experian')|list if dispute_items else [] %}
                            {% if experian_items %}
                                {% for item in experian_items %}
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 10px;">{{ item.follow_up_date.strftime('%Y-%m-%d') if item.follow_up_date else 'n/a' }}</td>
                                    <td style="padding: 10px;">{{ item.item_type|title if item.item_type else '' }}</td>
                                    <td style="padding: 10px;">{{ item.dispute_round }}</td>
                                    <td style="padding: 10px;">{{ item.creditor_name or '' }}</td>
                                    <td style="padding: 10px;">{{ item.account_id or 'n/a' }}</td>
                                    <td style="padding: 10px;">
                                        <span class="status-badge status-{{ item.status }}">{{ item.status|upper }}</span>
                                    </td>
                                    <td style="padding: 10px;">{{ item.reason or '' }}</td>
                                    <td style="padding: 10px;"><input type="text" class="comment-input" data-id="{{ item.id }}" value="{{ item.comments or '' }}" placeholder="Add comment"></td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td colspan="8" style="padding: 20px; text-align: center; color: #64748b;">No items tracked yet for Experian</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                {% if experian_items %}
                <div style="margin-top: 10px; font-size: 12px; color: #64748b;">
                    Total Items: {{ experian_items|length }} | 
                    Deleted: {{ experian_items|selectattr('status', 'equalto', 'deleted')|list|length }} |
                    In Progress: {{ experian_items|selectattr('status', 'equalto', 'in_progress')|list|length }}
                </div>
                {% endif %}
            </div>
            
            <!-- TRANSUNION Section -->
            <div class="card bureau-section" style="margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/85/TransUnion_logo.svg/200px-TransUnion_logo.svg.png" alt="TransUnion" style="height: 25px;" onerror="this.style.display='none'">
                    <span style="font-weight: 700; font-size: 18px; color: #0369a1;">TransUnion</span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="status-table" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e5e7eb;">
                                <th style="text-align: left; padding: 10px; color: #64748b;">Follow up</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Type</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">R</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Creditor</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Account ID</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Status</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Reason</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Comments</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set transunion_items = dispute_items|selectattr('bureau', 'equalto', 'TransUnion')|list if dispute_items else [] %}
                            {% if transunion_items %}
                                {% for item in transunion_items %}
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 10px;">{{ item.follow_up_date.strftime('%Y-%m-%d') if item.follow_up_date else 'n/a' }}</td>
                                    <td style="padding: 10px;">{{ item.item_type|title if item.item_type else '' }}</td>
                                    <td style="padding: 10px;">{{ item.dispute_round }}</td>
                                    <td style="padding: 10px;">{{ item.creditor_name or '' }}</td>
                                    <td style="padding: 10px;">{{ item.account_id or 'n/a' }}</td>
                                    <td style="padding: 10px;">
                                        <span class="status-badge status-{{ item.status }}">{{ item.status|upper }}</span>
                                    </td>
                                    <td style="padding: 10px;">{{ item.reason or '' }}</td>
                                    <td style="padding: 10px;"><input type="text" class="comment-input" data-id="{{ item.id }}" value="{{ item.comments or '' }}" placeholder="Add comment"></td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td colspan="8" style="padding: 20px; text-align: center; color: #64748b;">No items tracked yet for TransUnion</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                {% if transunion_items %}
                <div style="margin-top: 10px; font-size: 12px; color: #64748b;">
                    Total Items: {{ transunion_items|length }} | 
                    Deleted: {{ transunion_items|selectattr('status', 'equalto', 'deleted')|list|length }} |
                    In Progress: {{ transunion_items|selectattr('status', 'equalto', 'in_progress')|list|length }}
                </div>
                {% endif %}
            </div>
            
            <!-- Secondary Bureaus Freeze Section -->
            <div class="card" style="margin-bottom: 20px; border: 2px solid #e5e7eb;">
                <div class="card-title" style="color: #1a1a2e;">Secondary Bureaus Freeze</div>
                <p style="color: #dc2626; font-size: 12px; margin-bottom: 15px; line-height: 1.5;">
                    When you receive a response from a Secondary Bureau that they have FROZEN their report, please let us know by changing the Status to FROZEN as appropriate and then clicking the SUBMIT button. If they respond that they did NOT FREEZE the report, please change to NOT FROZEN instead and click the SUBMIT button. Thank you.
                </p>
                <div style="overflow-x: auto;">
                    <table class="status-table" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e5e7eb;">
                                <th style="text-align: left; padding: 10px; color: #64748b;">Follow up</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Type</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Creditor</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Account ID</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Status</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Secondary Bureau</th>
                                <th style="text-align: left; padding: 10px; color: #64748b;">Comments</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if secondary_freezes %}
                                {% for freeze in secondary_freezes %}
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 10px;">{{ freeze.follow_up_date.strftime('%Y-%m-%d') if freeze.follow_up_date else 'n/a' }}</td>
                                    <td style="padding: 10px;">Freeze</td>
                                    <td style="padding: 10px;">n/a</td>
                                    <td style="padding: 10px;">n/a</td>
                                    <td style="padding: 10px;">
                                        <select class="freeze-status-select" data-id="{{ freeze.id }}" style="padding: 5px; border-radius: 4px; border: 1px solid #e5e7eb; font-size: 12px;">
                                            <option value="pending" {% if freeze.status == 'pending' %}selected{% endif %}>PENDING</option>
                                            <option value="frozen" {% if freeze.status == 'frozen' %}selected{% endif %}>FROZEN</option>
                                            <option value="not_frozen" {% if freeze.status == 'not_frozen' %}selected{% endif %}>NOT FROZEN</option>
                                        </select>
                                    </td>
                                    <td style="padding: 10px; font-weight: 500;">{{ freeze.bureau_name }}</td>
                                    <td style="padding: 10px;"><input type="text" class="freeze-comment-input" data-id="{{ freeze.id }}" value="{{ freeze.comments or '' }}" placeholder="Add comment" style="width: 100%; padding: 5px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td colspan="7" style="padding: 20px; text-align: center; color: #64748b;">No secondary bureau freezes tracked</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="submitFreezeChanges()" class="submit-btn" style="padding: 10px 25px;">Submit changes</button>
                </div>
            </div>
            
            <!-- Status Legend -->
            <div class="card" id="legend">
                <div class="card-title">Legend</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px;">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span class="status-badge status-deleted">DELETED</span>
                        <span style="font-size: 12px; color: #64748b;">Negative item has been removed from report (positive).</span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span class="status-badge status-updated">UPDATED</span>
                        <span style="font-size: 12px; color: #64748b;">Negative item has been updated to positive status (positive).</span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span class="status-badge status-in_progress">IN PROGRESS</span>
                        <span style="font-size: 12px; color: #64748b;">Request for investigation has been sent to the credit bureau or creditor. Expecting return correspondence in mail.</span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span class="status-badge status-to_do">TO DO</span>
                        <span style="font-size: 12px; color: #64748b;">Dispute is scheduled to be sent.</span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span class="status-badge status-no_change">NO CHANGE</span>
                        <span style="font-size: 12px; color: #64748b;">Negative item has been verified. New dispute initiated.</span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span class="status-badge status-no_answer">NO ANSWER</span>
                        <span style="font-size: 12px; color: #64748b;">Request for investigation has been ignored. New dispute initiated.</span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span class="status-badge status-on_hold">ON HOLD</span>
                        <span style="font-size: 12px; color: #64748b;">Item is not being worked on at current time.</span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span class="status-badge status-positive">POSITIVE</span>
                        <span style="font-size: 12px; color: #64748b;">Account is in good standing, no action needed.</span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span class="status-badge status-sent">SENT</span>
                        <span style="font-size: 12px; color: #64748b;">Dispute letter has been sent to the bureau.</span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span class="status-badge status-duplicate">DUPLICATE</span>
                        <span style="font-size: 12px; color: #64748b;">This is a duplicate entry, tracked elsewhere.</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Attachments Tab -->
        <div class="tab-content" id="attachments">
            <div class="card">
                <div class="card-title">Your Documents</div>
                {% if letters %}
                <div class="document-list">
                    {% for letter in letters %}
                    <div class="document-item">
                        <div class="document-info">
                            <div class="document-icon">PDF</div>
                            <div>
                                <div class="document-name">{{ letter.bureau }} Dispute Letter - Round {{ letter.round_number }}</div>
                                <div class="document-meta">Generated {{ letter.created_at.strftime('%m/%d/%Y') if letter.created_at else '' }}</div>
                            </div>
                        </div>
                        {% if letter.file_path %}
                        <a href="/static/generated_letters/{{ letter.file_path|replace('static/generated_letters/', '') }}" class="download-btn" target="_blank">Download</a>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p style="text-align: center; padding: 40px; color: #64748b;">
                    No documents available yet. Check back after your analysis is complete.
                </p>
                {% endif %}
            </div>
            
            <div class="card">
                <div class="card-title">Upload Bureau Response Letters</div>
                <p style="color: #64748b; margin-bottom: 20px; font-size: 14px;">
                    Received a response from a credit bureau? Upload it here so we can track your progress and prepare the next round of disputes.
                </p>
                <div class="upload-area" onclick="document.getElementById('fileUpload').click()">
                    <div class="upload-icon">üìÑ</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div class="upload-hint">PDF, JPG, or PNG (max 10MB)</div>
                </div>
                <input type="file" id="fileUpload" style="display: none;" accept=".pdf,.jpg,.jpeg,.png">
                
                <div class="response-list" id="responseList">
                    {% if cra_responses %}
                        {% for response in cra_responses %}
                        <div class="response-item {{ response.response_type }}">
                            <div>
                                <strong>{{ response.bureau }}</strong> - Round {{ response.dispute_round }}
                                <div style="font-size: 12px; color: #64748b;">
                                    {{ response.response_type|title }} - {{ response.received_date.strftime('%m/%d/%Y') if response.received_date else '' }}
                                </div>
                            </div>
                            {% if response.file_path %}
                            <a href="/{{ response.file_path }}" class="download-btn" target="_blank">View</a>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Contact Us Tab -->
        <div class="tab-content" id="contact">
            <div class="card">
                <div class="card-title">Get in Touch</div>
                <div class="contact-grid">
                    <div class="contact-card">
                        <div class="contact-icon">üìû</div>
                        <div class="contact-title">Phone</div>
                        <a href="tel:9179094051" class="contact-value">(917) 909-4051</a>
                    </div>
                    <div class="contact-card">
                        <div class="contact-icon">üìß</div>
                        <div class="contact-title">Email</div>
                        <a href="mailto:support@brightpathascendgroup.com" class="contact-value">support@brightpathascendgroup.com</a>
                    </div>
                    <div class="contact-card">
                        <div class="contact-icon">üåê</div>
                        <div class="contact-title">Website</div>
                        <a href="https://brightpathascendgroup.com" target="_blank" class="contact-value">brightpathascendgroup.com</a>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">Send Us a Message</div>
                <form id="contactForm">
                    <div class="form-group">
                        <label>Subject</label>
                        <input type="text" placeholder="How can we help you?" required>
                    </div>
                    <div class="form-group">
                        <label>Message</label>
                        <textarea placeholder="Type your message here..." required></textarea>
                    </div>
                    <button type="submit" class="submit-btn">Send Message</button>
                </form>
            </div>
        </div>
        
        <!-- Education Tab -->
        <div class="tab-content" id="education">
            <div class="card">
                <div class="card-title">Credit Education Resources</div>
                <div class="education-grid">
                    <div class="education-card">
                        <div class="education-title">
                            üìä Understanding Credit Scores
                        </div>
                        <div class="education-desc">
                            Learn how credit scores are calculated and what factors have the biggest impact on your score.
                        </div>
                    </div>
                    <div class="education-card">
                        <div class="education-title">
                            üìù Your Rights Under FCRA
                        </div>
                        <div class="education-desc">
                            Understand your legal rights under the Fair Credit Reporting Act and how we use them to protect you.
                        </div>
                    </div>
                    <div class="education-card">
                        <div class="education-title">
                            üí≥ Credit Utilization Tips
                        </div>
                        <div class="education-desc">
                            Discover how to optimize your credit utilization ratio for maximum score improvement.
                        </div>
                    </div>
                    <div class="education-card">
                        <div class="education-title">
                            üè† Building Credit History
                        </div>
                        <div class="education-desc">
                            Strategies for building a strong credit history that lenders trust.
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">Frequently Asked Questions</div>
                <div style="space-y: 15px;">
                    <details style="padding: 15px; background: #f8fafc; border-radius: 8px; margin-bottom: 10px;">
                        <summary style="font-weight: 500; cursor: pointer; color: #1a1a2e;">How long does the dispute process take?</summary>
                        <p style="margin-top: 10px; color: #64748b; font-size: 14px;">
                            Credit bureaus have 30 days to investigate and respond to disputes. The complete process typically takes 3-6 months depending on the number and complexity of issues on your report.
                        </p>
                    </details>
                    <details style="padding: 15px; background: #f8fafc; border-radius: 8px; margin-bottom: 10px;">
                        <summary style="font-weight: 500; cursor: pointer; color: #1a1a2e;">What happens if the bureau doesn't respond?</summary>
                        <p style="margin-top: 10px; color: #64748b; font-size: 14px;">
                            If a bureau fails to respond within 30 days, they must remove the disputed item from your credit report. This is a violation of FCRA that we can use in your favor.
                        </p>
                    </details>
                    <details style="padding: 15px; background: #f8fafc; border-radius: 8px; margin-bottom: 10px;">
                        <summary style="font-weight: 500; cursor: pointer; color: #1a1a2e;">Can I dispute items myself?</summary>
                        <p style="margin-top: 10px; color: #64748b; font-size: 14px;">
                            Yes, you have the right to dispute items directly with the credit bureaus for free. However, our expertise in FCRA law and strategic dispute techniques typically achieves better and faster results.
                        </p>
                    </details>
                </div>
            </div>
        </div>
        
        <!-- Refer a Friend Tab -->
        <div class="tab-content" id="referral">
            <div class="referral-section">
                <div class="referral-header">
                    <div>
                        <div class="referral-title">Know Someone Who Could Use Our Services?</div>
                        <p style="opacity: 0.7; margin-top: 5px;">Refer a friend and help them restore their credit too!</p>
                    </div>
                    <div class="referral-code-box">
                        <div class="referral-code-label">Your Referral Code</div>
                        <div class="referral-code-value">{{ client.referral_code if client and client.referral_code else 'BP' + (client.id|string if client else '0000')[:4].upper() }}</div>
                    </div>
                </div>
            </div>
            
            <div class="referral-form">
                <div class="card-title">Refer a Friend</div>
                <form id="referralForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Their Name</label>
                            <input type="text" id="refName" placeholder="Friend's full name" required>
                        </div>
                        <div class="form-group">
                            <label>Their Phone</label>
                            <input type="tel" id="refPhone" placeholder="(xxx) xxx-xxxx">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Their Email</label>
                            <input type="email" id="refEmail" placeholder="friend@email.com" required>
                        </div>
                        <div class="form-group">
                            <label>Your Name</label>
                            <input type="text" value="{{ client.name if client else '' }}" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Comments (Optional)</label>
                        <textarea id="refComments" placeholder="Any additional information about your referral..."></textarea>
                    </div>
                    <button type="submit" class="submit-btn">Submit Referral</button>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        const tabs = document.querySelectorAll('.nav-tab');
        const contents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });
        
        document.getElementById('contactForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Message sent! We will get back to you soon.');
            this.reset();
        });
        
        document.getElementById('referralForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                referredName: document.getElementById('refName').value,
                referredEmail: document.getElementById('refEmail').value,
                referredPhone: document.getElementById('refPhone').value,
                comments: document.getElementById('refComments').value,
                referringClientId: {{ client.id if client else 0 }}
            };
            
            try {
                const response = await fetch('/api/referral', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('Thank you for your referral! We will reach out to them soon.');
                    this.reset();
                } else {
                    alert('Failed to submit referral. Please try again.');
                }
            } catch (error) {
                console.error('Referral error:', error);
                alert('Connection error. Please try again.');
            }
        });
        
        document.getElementById('fileUpload')?.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const bureau = prompt('Which bureau is this response from? (Experian, TransUnion, or Equifax)');
            if (!bureau) return;
            
            const responseType = prompt('What type of response is this? (verified, deleted, updated, investigating, no_response)');
            if (!responseType) return;
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('clientId', '{{ client.id if client else 0 }}');
            formData.append('caseId', '{{ case.id if case else 0 }}');
            formData.append('bureau', bureau);
            formData.append('disputeRound', '{{ client.current_dispute_round if client and client.current_dispute_round else 1 }}');
            formData.append('responseType', responseType);
            
            try {
                const response = await fetch('/api/cra-response/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Response uploaded successfully!');
                    location.reload();
                } else {
                    alert('Upload failed: ' + result.error);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Connection error. Please try again.');
            }
        });
        
        // Status tab functions
        function showAllItems() {
            document.querySelectorAll('.bureau-section').forEach(section => {
                section.style.display = 'block';
            });
        }
        
        async function submitStatusChanges() {
            const updates = [];
            document.querySelectorAll('.comment-input').forEach(input => {
                const id = input.dataset.id;
                const value = input.value;
                if (id && value !== input.defaultValue) {
                    updates.push({ id: parseInt(id), comments: value });
                }
            });
            
            if (updates.length === 0) {
                alert('No changes to submit.');
                return;
            }
            
            try {
                const response = await fetch('/api/dispute-items/batch-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ updates })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Changes saved successfully!');
                    location.reload();
                } else {
                    alert('Failed to save changes: ' + result.error);
                }
            } catch (error) {
                console.error('Update error:', error);
                alert('Connection error. Please try again.');
            }
        }
        
        async function submitFreezeChanges() {
            const updates = [];
            
            document.querySelectorAll('.freeze-status-select').forEach(select => {
                const id = select.dataset.id;
                const commentInput = document.querySelector(`.freeze-comment-input[data-id="${id}"]`);
                updates.push({
                    id: parseInt(id),
                    status: select.value,
                    comments: commentInput ? commentInput.value : ''
                });
            });
            
            if (updates.length === 0) {
                alert('No changes to submit.');
                return;
            }
            
            try {
                const response = await fetch('/api/secondary-freezes/batch-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ updates })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Freeze status changes saved successfully!');
                    location.reload();
                } else {
                    alert('Failed to save changes: ' + result.error);
                }
            } catch (error) {
                console.error('Update error:', error);
                alert('Connection error. Please try again.');
            }
        }
    </script>
</body>
</html>
