// Exhaustive test for /preview
describe('Credit Report Preview Page', () => {
  beforeEach(() => {
    // Public route - no auth required
    cy.visit('/preview');
  });

  describe('Page Load Tests', () => {
    it('should load without errors', () => {
      cy.url().should('include', '/preview');
      cy.get('body').should('be.visible');
    });

    it('should have correct page title', () => {
      cy.title().should('eq', 'Free Credit Report Violation Preview | Brightpath Ascend');
    });

    it('should not have console errors', () => {
      cy.window().then((win) => {
        cy.stub(win.console, 'error').as('consoleError');
      });
      cy.get('@consoleError').should('not.have.been.called');
    });

    it('should not return server errors', () => {
      cy.request('/preview').its('status').should('eq', 200);
    });
  });

  describe('UI Element Tests', () => {
    it('should display all headings correctly', () => {
      cy.get('h1').should('contain.text', 'Brightpath Ascend');
      cy.get('h2').should('contain.text', 'Free Violation Preview');
      cy.get('h2').should('contain.text', 'AI Analyzing Your Credit Report...');
      cy.get('h2').should('contain.text', 'Your Violation Preview');
      cy.get('h2').should('contain.text', 'Analysis Error');
      cy.get('h3').should('contain.text', 'Top Violations Detected');
      cy.get('h3').should('contain.text', 'What Clients Are Winning');
    });

    it('should display brand logo and tagline', () => {
      cy.get('.fa-shield-alt').should('be.visible');
      cy.get('h1').should('contain.text', 'Brightpath Ascend');
      cy.get('p').should('contain.text', 'FCRA Litigation Automation Platform');
    });

    it('should show all buttons', () => {
      cy.get('#analyzeBtn').should('be.visible').and('contain.text', 'Analyze Now - FREE');
      cy.get('button').contains('Try Again').should('exist');
    });

    it('should display feature badges', () => {
      cy.get('.fa-lock').should('be.visible');
      cy.get('.fa-clock').should('be.visible');
      cy.get('.fa-gavel').should('be.visible');
      cy.get('p').should('contain.text', '100% Secure');
      cy.get('p').should('contain.text', '60-Second Analysis');
      cy.get('p').should('contain.text', 'Legal Expert AI');
    });

    it('should show security disclaimer', () => {
      cy.get('p').should('contain.text', 'Your data is encrypted and never stored');
      cy.get('p').should('contain.text', 'This preview is for informational purposes only');
    });
  });

  describe('File Upload Tests', () => {
    it('should display upload zone initially', () => {
      cy.get('#dropZone').should('be.visible');
      cy.get('#uploadPrompt').should('be.visible');
      cy.get('#fileSelected').should('have.class', 'hidden');
    });

    it('should show upload instructions', () => {
      cy.get('.fa-cloud-upload-alt').should('be.visible');
      cy.get('p').should('contain.text', 'Drop your credit report here');
      cy.get('p').should('contain.text', 'or click to browse');
      cy.get('p').should('contain.text', 'Supports: PDF, HTML, TXT');
    });

    it('should have hidden file input with correct attributes', () => {
      cy.get('#fileInput')
        .should('have.class', 'hidden')
        .should('have.attr', 'type', 'file')
        .should('have.attr', 'accept', '.pdf,.html,.htm,.txt');
    });

    it('should trigger file input when drop zone is clicked', () => {
      cy.get('#dropZone').click();
      cy.get('#fileInput').should('exist');
    });

    it('should handle file selection', () => {
      const fileName = 'test-credit-report.pdf';
      cy.get('#fileInput').selectFile({
        contents: Cypress.Buffer.from('test file content'),
        fileName: fileName,
        mimeType: 'application/pdf'
      }, { force: true });
      
      cy.get('#uploadPrompt').should('have.class', 'hidden');
      cy.get('#fileSelected').should('not.have.class', 'hidden');
      cy.get('#fileName').should('contain.text', fileName);
    });

    it('should show analyze button after file selection', () => {
      cy.get('#fileInput').selectFile({
        contents: Cypress.Buffer.from('test content'),
        fileName: 'test.pdf',
        mimeType: 'application/pdf'
      }, { force: true });
      
      cy.get('#analyzeBtn').should('be.visible').and('not.be.disabled');
    });
  });

  describe('Analysis Flow Tests', () => {
    beforeEach(() => {
      cy.get('#fileInput').selectFile({
        contents: Cypress.Buffer.from('test content'),
        fileName: 'test.pdf',
        mimeType: 'application/pdf'
      }, { force: true });
    });

    it('should show analyzing section when analysis starts', () => {
      cy.intercept('POST', '/api/instant-preview', { delay: 1000, body: { success: true, data: {} } });
      
      cy.get('#analyzeBtn').click();
      cy.get('#uploadSection').should('have.class', 'hidden');
      cy.get('#analyzingSection').should('not.have.class', 'hidden');
    });

    it('should display analysis steps', () => {
      cy.get('#analyzingSection').should('contain.text', 'AI Analyzing Your Credit Report...');
      cy.get('#step1').should('contain.text', 'Parsing Report');
      cy.get('#step2').should('contain.text', 'Detecting Violations');
      cy.get('#step3').should('contain.text', 'Calculating Value');
    });

    it('should show spinning animation during analysis', () => {
      cy.get('#analyzingSection .fa-spin').should('be.visible');
      cy.get('p').should('contain.text', 'This typically takes 30-60 seconds...');
    });
  });

  describe('Results Display Tests', () => {
    beforeEach(() => {
      const mockResults = {
        success: true,
        data: {
          violation_count: 5,
          estimated_value: 8500,
          case_strength: 'Strong',
          violations: [
            { severity: 'high', title: 'Test Violation', description: 'Test Description' },
            { severity: 'medium', title: 'Test Violation 2', description: 'Test Description 2' }
          ]
        }
      };
      
      cy.intercept('POST', '/api/instant-preview', { body: mockResults });
      
      cy.get('#fileInput').selectFile({
        contents: Cypress.Buffer.from('test content'),
        fileName: 'test.pdf',
        mimeType: 'application/pdf'
      }, { force: true });
      
      cy.get('#analyzeBtn').click();
    });

    it('should display results section after successful analysis', () => {
      cy.get('#resultsSection').should('not.have.class', 'hidden');
      cy.get('#analyzingSection').should('have.class', 'hidden');
    });

    it('should show analysis complete badge', () => {
      cy.get('.fa-check-circle').should('be.visible');
      cy.get('span').should('contain.text', 'Analysis Complete');
    });

    it('should display violation statistics', () => {
      cy.get('#violationCount').should('contain.text', '5');
      cy.get('#estimatedValue').should('contain.text', '$8,500');
      cy.get('#caseStrength').should('contain.text', 'Strong');
    });

    it('should show stat card labels', () => {
      cy.get('p').should('contain.text', 'Violations Found');
      cy.get('p').should('contain.text', 'Estimated Value');
      cy.get('p').should('contain.text', 'Case Strength');
    });

    it('should display violations list section', () => {
      cy.get('h3').should('contain.text', 'Top Violations Detected');
      cy.get('#violationsList').should('be.visible');
    });

    it('should show preview disclaimer', () => {
      cy.get('p').should('contain.text', 'This is a Preview Only');
      cy.get('p').should('contain.text', 'A full analysis includes detailed standing assessment');
      cy.get('p').should('contain.text', '$3,500 - $15,000');
    });

    it('should display call-to-action button', () => {
      cy.get('a[href="/signup"]')
        .should('be.visible')
        .and('contain.text', 'Get Full Analysis & Start Your Case');
      cy.get('p').should('contain.text', 'No credit card required to get started');
    });

    it('should show client success examples', () => {
      cy.get('h3').should('contain.text', 'What Clients Are Winning');
      cy.get('p').should('contain.text', 'Inaccurate Account');
      cy.get('p').should('contain.text', '$4,500 Settlement');
      cy.get('p').should('contain.text', 'Mixed File / Wrong Info');
      cy.get('p').should('contain.text', '$12,000 Settlement');
      cy.get('p').should('contain.text', 'Failure to Investigate');
      cy.get('p').should('contain.text', '$8,750 Settlement');
    });
  });

  describe('Error Handling Tests', () => {
    beforeEach(() => {
      cy.get('#fileInput').selectFile({
        contents: Cypress.Buffer.from('test content'),
        fileName: 'test.pdf',
        mimeType: 'application/pdf'
      }, { force: true });
    });

    it('should show error section on analysis failure', () => {
      cy.intercept('POST', '/api/instant-preview', { 
        statusCode: 500,
        body: { success: false, error: 'Analysis failed' }
      });
      
      cy.get('#analyzeBtn').click();
      cy.get('#errorSection').should('not.have.class', 'hidden');
    });

    it('should display error message and retry button', () => {
      cy.intercept('POST', '/api/instant-preview', { 
        statusCode: 500,
        body: { success: false, error: 'Custom error message' }
      });
      
      cy.get('#analyzeBtn').click();
      cy.get('h2').should('contain.text', 'Analysis Error');
      cy.get('.fa-exclamation-circle').should('be.visible');
      cy.get('button').contains('Try Again').should('be.visible');
    });

    it('should handle network errors', () => {
      cy.intercept('POST', '/api/instant-preview', { forceNetworkError: true });
      
      cy.get('#analyzeBtn').click();
      cy.get('#errorSection').should('not.have.class', 'hidden');
    });

    it('should allow retry after error', () => {
      cy.intercept('POST', '/api/instant-preview', { 
        statusCode: 500,
        body: { success: false, error: 'Test error' }
      });
      
      cy.get('#analyzeBtn').click();
      cy.get('button').contains('Try Again').click();
      cy.url().should('include', '/preview');
    });
  });

  describe('Responsive Design Tests', () => {
    const viewports = [
      { device: 'desktop', width: 1280, height: 720 },
      { device: 'tablet', width: 768, height: 1024 },
      { device: 'mobile', width: 375, height: 667 }
    ];

    viewports.forEach(({ device, width, height }) => {
      context(`${device} viewport (${width}x${height})`, () => {
        beforeEach(() => {
          cy.viewport(width, height);
        });

        it('should display header correctly', () => {
          cy.get('h1').should('be.visible');
          cy.get('.fa-shield-alt').should('be.visible');
        });

        it('should show upload section properly', () => {
          cy.get('#dropZone').should('be.visible');
          cy.get('#uploadPrompt').should('be.visible');
        });

        it('should display feature badges in grid', () => {
          cy.get('.fa-lock').should('be.visible');
          cy.get('.fa-clock').should('be.visible');
          cy.get('.fa-gavel').should('be.visible');
        });

        it('should handle file upload on different screen sizes', () => {
          cy.get('#dropZone').should('be.visible').click();
          cy.get('#fileInput').should('exist');
        });
      });
    });
  });

  describe('Accessibility Tests', () => {
    it('should have proper heading hierarchy', () => {
      cy.get('h1').should('have.length.at.least', 1);
      cy.get('h2').should('exist');
      cy.get('h3').should('exist');
    });

    it('should have interactive elements accessible', () => {
      cy.get('#dropZone').should('have.attr', 'class').and('include', 'cursor-pointer');
      cy.get('#analyzeBtn').should('be.visible');
    });

    it('should have meaningful button text', () => {
      cy.get('#analyzeBtn').should('contain.text', 'Analyze Now - FREE');
      cy.get('button').contains('Try Again').should('exist');
    });

    it('should have icons with semantic meaning', () => {
      cy.get('.fa-shield-alt').should('exist');
      cy.get('.fa-cloud-upload-alt').should('exist');
      cy.get('.fa-lock').should('exist');
      cy.get('.fa-clock').should('exist');
      cy.get('.fa-gavel').should('exist');
    });
  });

  describe('User Flow Tests', () => {
    it('should complete full analysis flow successfully', () => {
      const mockResults = {
        success: true,
        data: {
          violation_count: 3,
          estimated_value: 5000,
          case_strength: 'Moderate',
          violations: []
        }
      };
      
      cy.intercept('POST', '/api/instant-preview', { body: mockResults });

      // Upload file
      cy.get('#fileInput').selectFile({
        contents: Cypress.Buffer.from('test content'),
        fileName: 'credit-report.pdf',
        mimeType: 'application/pdf'
      }, { force: true });

      // Verify file selected
      cy.get('#fileName').should('contain.text', 'credit-report.pdf');
      
      // Start analysis
      cy.get('#analyzeBtn').click();
      
      // Verify analyzing state
      cy.get('#analyzingSection').should('not.have.class', 'hidden');
      
      // Verify results
      cy.get('#resultsSection').should('not.have.class', 'hidden');
      cy.get('#violationCount').should('contain.text', '3');
      cy.get('#estimatedValue').should('contain.text', '$5,000');
      cy.get('#caseStrength').should('contain.text', 'Moderate');
    });

    it('should navigate to signup from results', () => {
      const mockResults = {
        success: true,
        data: {
          violation_count: 1,
          estimated_value: 1000,
          case_strength: 'Weak',
          violations: []
        }
      };
      
      cy.intercept('POST', '/api/instant-preview', { body: mockResults });

      cy.get('#fileInput').selectFile({
        contents: Cypress.Buffer.from('test'),
        fileName: 'test.pdf',
        mimeType: 'application/pdf'
      }, { force: true });

      cy.get('#analyzeBtn').click();
      cy.get('a[href="/signup"]').should('have.attr', 'href', '/signup');
    });
  });

  describe('Performance Tests', () => {
    it('should load initial page quickly', () => {
      cy.get('h1').should('be.visible');
      cy.get('#dropZone').should('be.visible');
    });

    it('should handle file selection without delay', () => {
      const start = Date.now();
      cy.get('#fileInput').selectFile({
        contents: Cypress.Buffer.from('test'),
        fileName: 'test.pdf',
        mimeType: 'application/pdf'
      }, { force: true }).then(() => {
        const duration = Date.now() - start;
        expect(duration).to.be.lessThan(1000);
      });
    });
  });
});