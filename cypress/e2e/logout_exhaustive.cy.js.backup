// Exhaustive test for /portal/logout
describe('/portal/logout - Client Login Page', () => {
  beforeEach(() => {
    cy.visit('/portal/logout');
  });

  describe('Page Load Tests', () => {
    it('should load page without errors', () => {
      cy.url().should('include', '/portal/logout');
      cy.get('[data-testid="portal-login-container"]').should('be.visible');
    });

    it('should not have console errors', () => {
      cy.window().then((win) => {
        cy.spy(win.console, 'error').as('consoleError');
      });
      cy.get('@consoleError').should('not.have.been.called');
    });

    it('should have correct page title', () => {
      cy.title().should('contain', 'Client Login - Brightpath Ascend');
    });

    it('should not return server errors', () => {
      cy.request('/portal/logout').its('status').should('eq', 200);
    });
  });

  describe('UI Element Tests', () => {
    it('should display all headings', () => {
      cy.contains('h1', 'Brightpath Ascend').should('be.visible');
      cy.get('[data-testid="login-title"]').should('contain', 'Welcome Back');
      cy.contains('h2', 'Reset Password').should('exist');
      cy.contains('h2', 'Set New Password').should('exist');
    });

    it('should display logo and branding', () => {
      cy.get('img[alt="Brightpath Ascend"]').should('exist');
      cy.contains('Client Portal').should('be.visible');
    });

    it('should display all containers', () => {
      cy.get('[data-testid="portal-login-container"]').should('be.visible');
      cy.get('[data-testid="portal-login-card"]').should('be.visible');
      cy.get('[data-testid="login-form-container"]').should('be.visible');
      cy.get('[data-testid="forgot-form-container"]').should('exist');
      cy.get('[data-testid="reset-form-container"]').should('exist');
    });

    it('should display all buttons', () => {
      cy.get('[data-testid="toggle-password-btn"]').should('be.visible');
      cy.get('[data-testid="portal-login-button"]').should('be.visible').and('contain', 'Sign In');
      cy.get('[data-testid="send-reset-button"]').should('exist');
      cy.get('[data-testid="reset-password-button"]').should('exist');
    });

    it('should display navigation links', () => {
      cy.get('[data-testid="forgot-password-link"]').should('be.visible').and('contain', 'Forgot your password?');
      cy.get('[data-testid="token-access-link"]').should('be.visible').and('contain', 'Use direct link access');
      cy.get('[data-testid="back-to-login-link"]').should('exist');
    });
  });

  describe('Login Form Tests', () => {
    it('should display login form with all required fields', () => {
      cy.get('[data-testid="portal-login-form"]').should('be.visible');
      cy.get('[data-testid="portal-email-input"]').should('be.visible').and('have.attr', 'required');
      cy.get('[data-testid="portal-password-input"]').should('be.visible').and('have.attr', 'required');
    });

    it('should have correct input attributes', () => {
      cy.get('[data-testid="portal-email-input"]')
        .should('have.attr', 'type', 'email')
        .and('have.attr', 'placeholder', 'your@email.com')
        .and('have.attr', 'autocomplete', 'email');

      cy.get('[data-testid="portal-password-input"]')
        .should('have.attr', 'type', 'password')
        .and('have.attr', 'placeholder', 'Enter your password')
        .and('have.attr', 'autocomplete', 'current-password');
    });

    it('should accept input in email field', () => {
      cy.get('[data-testid="portal-email-input"]')
        .type('test@example.com')
        .should('have.value', 'test@example.com');
    });

    it('should accept input in password field', () => {
      cy.get('[data-testid="portal-password-input"]')
        .type('password123')
        .should('have.value', 'password123');
    });

    it('should toggle password visibility', () => {
      cy.get('[data-testid="portal-password-input"]').type('password123');
      cy.get('[data-testid="toggle-password-btn"]').click();
      cy.get('[data-testid="portal-password-input"]').should('have.attr', 'type', 'text');
      cy.get('[data-testid="toggle-password-btn"]').click();
      cy.get('[data-testid="portal-password-input"]').should('have.attr', 'type', 'password');
    });

    it('should submit login form', () => {
      cy.get('[data-testid="portal-email-input"]').type('test@example.com');
      cy.get('[data-testid="portal-password-input"]').type('password123');
      cy.get('[data-testid="portal-login-button"]').click();
      cy.get('[data-testid="portal-login-button"]').should('be.disabled').and('contain', 'Signing in...');
    });

    it('should require email field', () => {
      cy.get('[data-testid="portal-password-input"]').type('password123');
      cy.get('[data-testid="portal-login-button"]').click();
      cy.get('[data-testid="portal-email-input"]:invalid').should('exist');
    });

    it('should require password field', () => {
      cy.get('[data-testid="portal-email-input"]').type('test@example.com');
      cy.get('[data-testid="portal-login-button"]').click();
      cy.get('[data-testid="portal-password-input"]:invalid').should('exist');
    });
  });

  describe('Forgot Password Form Tests', () => {
    beforeEach(() => {
      cy.get('[data-testid="forgot-password-link"]').click();
    });

    it('should show forgot password form when link is clicked', () => {
      cy.get('[data-testid="forgot-form-container"]').should('have.class', 'active');
      cy.get('[data-testid="login-form-container"]').should('have.class', 'hidden');
    });

    it('should display forgot password form elements', () => {
      cy.get('[data-testid="forgot-password-form"]').should('be.visible');
      cy.get('[data-testid="forgot-email-input"]').should('be.visible').and('have.attr', 'required');
      cy.get('[data-testid="send-reset-button"]').should('be.visible').and('contain', 'Send Reset Link');
      cy.get('[data-testid="back-to-login-link"]').should('be.visible');
    });

    it('should accept email input', () => {
      cy.get('[data-testid="forgot-email-input"]')
        .type('test@example.com')
        .should('have.value', 'test@example.com');
    });

    it('should return to login form when back link is clicked', () => {
      cy.get('[data-testid="back-to-login-link"]').click();
      cy.get('[data-testid="login-form-container"]').should('not.have.class', 'hidden');
      cy.get('[data-testid="forgot-form-container"]').should('not.have.class', 'active');
    });

    it('should handle forgot password submission', () => {
      cy.intercept('POST', '/api/portal/forgot-password', { success: true, message: 'Reset link sent' });
      cy.get('[data-testid="forgot-email-input"]').type('test@example.com');
      cy.get('[data-testid="send-reset-button"]').click();
      cy.get('[data-testid="forgot-alert"]').should('not.have.class', 'hidden');
    });

    it('should show error for invalid email submission', () => {
      cy.intercept('POST', '/api/portal/forgot-password', { success: false, error: 'Email not found' });
      cy.get('[data-testid="forgot-email-input"]').type('invalid@example.com');
      cy.get('[data-testid="send-reset-button"]').click();
      cy.get('[data-testid="forgot-alert"]').should('have.class', 'alert-error');
    });

    it('should require email field', () => {
      cy.get('[data-testid="send-reset-button"]').click();
      cy.get('[data-testid="forgot-email-input"]:invalid').should('exist');
    });
  });

  describe('Reset Password Form Tests', () => {
    beforeEach(() => {
      cy.visit('/portal/logout?token=test-reset-token');
    });

    it('should show reset password form when token is present', () => {
      cy.get('[data-testid="reset-form-container"]').should('have.class', 'active');
      cy.get('[data-testid="login-form-container"]').should('have.class', 'hidden');
    });

    it('should display reset password form elements', () => {
      cy.get('[data-testid="reset-password-form"]').should('be.visible');
      cy.get('[data-testid="new-password-input"]').should('be.visible').and('have.attr', 'required');
      cy.get('[data-testid="confirm-password-input"]').should('be.visible').and('have.attr', 'required');
      cy.get('[data-testid="reset-password-button"]').should('be.visible').and('contain', 'Reset Password');
    });

    it('should have correct password input attributes', () => {
      cy.get('[data-testid="new-password-input"]')
        .should('have.attr', 'type', 'password')
        .and('have.attr', 'minlength', '8')
        .and('have.attr', 'placeholder', 'At least 8 characters');

      cy.get('[data-testid="confirm-password-input"]')
        .should('have.attr', 'type', 'password')
        .and('have.attr', 'placeholder', 'Confirm your password');
    });

    it('should accept input in password fields', () => {
      cy.get('[data-testid="new-password-input"]')
        .type('newpassword123')
        .should('have.value', 'newpassword123');

      cy.get('[data-testid="confirm-password-input"]')
        .type('newpassword123')
        .should('have.value', 'newpassword123');
    });

    it('should toggle new password visibility', () => {
      cy.get('[data-testid="new-password-input"]').type('password123');
      cy.get('.password-toggle button').click();
      cy.get('[data-testid="new-password-input"]').should('have.attr', 'type', 'text');
    });

    it('should show error when passwords do not match', () => {
      cy.get('[data-testid="new-password-input"]').type('password123');
      cy.get('[data-testid="confirm-password-input"]').type('different123');
      cy.get('[data-testid="reset-password-button"]').click();
      cy.get('[data-testid="reset-alert"]')
        .should('not.have.class', 'hidden')
        .and('have.class', 'alert-error')
        .and('contain', 'Passwords do not match');
    });

    it('should show error for short password', () => {
      cy.get('[data-testid="new-password-input"]').type('short');
      cy.get('[data-testid="confirm-password-input"]').type('short');
      cy.get('[data-testid="reset-password-button"]').click();
      cy.get('[data-testid="reset-alert"]')
        .should('not.have.class', 'hidden')
        .and('have.class', 'alert-error')
        .and('contain', 'Password must be at least 8 characters');
    });

    it('should handle successful password reset', () => {
      cy.intercept('POST', '/api/portal/reset-password', { success: true, message: 'Password reset successfully' });
      cy.get('[data-testid="new-password-input"]').type('newpassword123');
      cy.get('[data-testid="confirm-password-input"]').type('newpassword123');
      cy.get('[data-testid="reset-password-button"]').click();
      cy.get('[data-testid="reset-alert"]')
        .should('not.have.class', 'hidden')
        .and('have.class', 'alert-success');
    });

    it('should handle reset password error', () => {
      cy.intercept('POST', '/api/portal/reset-password', { success: false, error: 'Invalid token' });
      cy.get('[data-testid="new-password-input"]').type('newpassword123');
      cy.get('[data-testid="confirm-password-input"]').type('newpassword123');
      cy.get('[data-testid="reset-password-button"]').click();
      cy.get('[data-testid="reset-alert"]')
        .should('not.have.class', 'hidden')
        .and('have.class', 'alert-error');
    });
  });

  describe('Token Access Tests', () => {
    it('should prompt for token when token access link is clicked', () => {
      cy.window().then((win) => {
        cy.stub(win, 'prompt').returns('test-token-123');
        cy.stub(win.location, 'href').as('locationHref');
      });
      cy.get('[data-testid="token-access-link"]').click();
      cy.get('@locationHref').should('have.been.calledWith', '/portal/test-token-123');
    });

    it('should extract token from full portal URL', () => {
      cy.window().then((win) => {
        cy.stub(win, 'prompt').returns('https://example.com/portal/test-token-456?param=value');
        cy.stub(win.location, 'href').as('locationHref');
      });
      cy.get('[data-testid="token-access-link"]').click();
      cy.get('@locationHref').should('have.been.calledWith', '/portal/test-token-456');
    });

    it('should handle empty token input', () => {
      cy.window().then((win) => {
        cy.stub(win, 'prompt').returns('');
        cy.stub(win.location, 'href').as('locationHref');
      });
      cy.get('[data-testid="token-access-link"]').click();
      cy.get('@locationHref').should('not.have.been.called');
    });
  });

  describe('Responsive Tests', () => {
    const viewports = [
      { device: 'desktop', width: 1280, height: 720 },
      { device: 'tablet', width: 768, height: 1024 },
      { device: 'mobile', width: 375, height: 667 }
    ];

    viewports.forEach(({ device, width, height }) => {
      it(`should display correctly on ${device}`, () => {
        cy.viewport(width, height);
        cy.get('[data-testid="portal-login-container"]').should('be.visible');
        cy.get('[data-testid="portal-login-card"]').should('be.visible');
        cy.get('[data-testid="portal-login-form"]').should('be.visible');
        cy.get('[data-testid="portal-email-input"]').should('be.visible');
        cy.get('[data-testid="portal-password-input"]').should('be.visible');
        cy.get('[data-testid="portal-login-button"]').should('be.visible');
      });
    });
  });

  describe('Error Handling Tests', () => {
    it('should handle network errors in forgot password', () => {
      cy.intercept('POST', '/api/portal/forgot-password', { forceNetworkError: true });
      cy.get('[data-testid="forgot-password-link"]').click();
      cy.get('[data-testid="forgot-email-input"]').type('test@example.com');
      cy.get('[data-testid="send-reset-button"]').click();
      cy.get('[data-testid="forgot-alert"]')
        .should('not.have.class', 'hidden')
        .and('have.class', 'alert-error')
        .and('contain', 'Connection error');
    });

    it('should handle network errors in reset password', () => {
      cy.visit('/portal/logout?token=test-token');
      cy.intercept('POST', '/api/portal/reset-password', { forceNetworkError: true });
      cy.get('[data-testid="new-password-input"]').type('newpassword123');
      cy.get('[data-testid="confirm-password-input"]').type('newpassword123');
      cy.get('[data-testid="reset-password-button"]').click();
      cy.get('[data-testid="reset-alert"]')
        .should('not.have.class', 'hidden')
        .and('have.class', 'alert-error')
        .and('contain', 'Connection error');
    });

    it('should handle server errors gracefully', () => {
      cy.intercept('POST', '/api/portal/forgot-password', { statusCode: 500 });
      cy.get('[data-testid="forgot-password-link"]').click();
      cy.get('[data-testid="forgot-email-input"]').type('test@example.com');
      cy.get('[data-testid="send-reset-button"]').click();
      cy.get('[data-testid="forgot-alert"]').should('not.have.class', 'hidden');
    });
  });

  describe('Form State Management Tests', () => {
    it('should reset button state after failed forgot password attempt', () => {
      cy.intercept('POST', '/api/portal/forgot-password', { success: false, error: 'Error' });
      cy.get('[data-testid="forgot-password-link"]').click();
      cy.get('[data-testid="forgot-email-input"]').type('test@example.com');
      cy.get('[data-testid="send-reset-button"]').click();
      cy.get('[data-testid="send-reset-button"]')
        .should('not.be.disabled')
        .and('contain', 'Send Reset Link');
    });

    it('should reset button state after failed reset password attempt', () => {
      cy.visit('/portal/logout?token=test-token');
      cy.intercept('POST', '/api/portal/reset-password', { success: false, error: 'Error' });
      cy.get('[data-testid="new-password-input"]').type('newpassword123');
      cy.get('[data-testid="confirm-password-input"]').type('newpassword123');
      cy.get('[data-testid="reset-password-button"]').click();
      cy.get('[data-testid="reset-password-button"]')
        .should('not.be.disabled')
        .and('contain', 'Reset Password');
    });

    it('should clear form alerts when switching between forms', () => {
      cy.get('[data-testid="forgot-password-link"]').click();
      cy.get('[data-testid="back-to-login-link"]').click();
      cy.get('[data-testid="forgot-alert"]').should('have.class', 'hidden');
    });
  });

  describe('Accessibility Tests', () => {
    it('should have proper form labels', () => {
      cy.get('label[for="email"]').should('contain', 'Email Address');
      cy.get('label[for="password"]').should('contain', 'Password');
    });

    it('should have proper button types', () => {
      cy.get('[data-testid="portal-login-button"]').should('have.attr', 'type', 'submit');
      cy.get('[data-testid="toggle-password-btn"]').should('have.attr', 'type', 'button');
    });

    it('should have proper form attributes', () => {
      cy.get('#loginForm').should('have.attr', 'method', 'POST');
      cy.get('#loginForm').should('have.attr', 'action', '/portal/login');
    });
  });
});