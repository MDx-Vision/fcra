// Exhaustive test for /portal/create-password
describe('Client Portal Create Password Page', () => {
  beforeEach(() => {
    cy.visit('/portal/login');
    cy.get('input[name="email"]').type('client@example.com');
    cy.get('input[name="password"]').type('password123');
    cy.get('button[type="submit"]').click();
    cy.url().should('include', '/portal');
    cy.visit('/portal/create-password');
  });

  describe('Page Load Tests', () => {
    it('should load the page without errors', () => {
      cy.url().should('eq', Cypress.config().baseUrl + '/portal/create-password');
      cy.title().should('eq', 'Client Portal - Brightpath Ascend');
    });

    it('should not have any console errors', () => {
      cy.window().then((win) => {
        cy.spy(win.console, 'error').as('consoleError');
      });
      cy.get('@consoleError').should('not.have.been.called');
    });

    it('should not return server errors', () => {
      cy.request('/portal/create-password').its('status').should('eq', 200);
    });
  });

  describe('Header and Navigation Tests', () => {
    it('should display the header with logo and user profile', () => {
      cy.get('.header').should('be.visible');
      cy.get('.logo').should('be.visible');
      cy.get('.logo img').should('have.attr', 'src', '/static/images/logo.png');
      cy.get('.logo span').should('contain.text', 'Brightpath Ascend');
      cy.get('.portal-title').should('contain.text', 'Client Portal');
    });

    it('should display user profile in header', () => {
      cy.get('.user-profile').should('be.visible');
      cy.get('#headerAvatar').should('be.visible');
      cy.get('.greeting').should('contain.text', 'Hello, Client');
      cy.get('.date-display').should('contain.text', 'As of: 12/11/2025');
    });

    it('should have logout link', () => {
      cy.get('a[href="/portal/logout"]').should('be.visible').should('contain.text', 'Logout');
    });

    it('should display all navigation tabs', () => {
      const expectedTabs = [
        'Summary',
        'Score Progress', 
        'Dispute Timeline',
        'Status',
        'Attachments',
        'Upload Documents',
        'My Profile',
        'Contact Us',
        'Refer a Friend'
      ];
      
      cy.get('.nav-tabs .nav-tab').should('have.length', 9);
      expectedTabs.forEach((tabText, index) => {
        cy.get('.nav-tabs .nav-tab').eq(index).should('contain.text', tabText);
      });
    });

    it('should have Summary tab active by default', () => {
      cy.get('.nav-tabs .nav-tab.active').should('contain.text', 'Summary');
    });
  });

  describe('Headings Tests', () => {
    it('should display the main welcome heading', () => {
      cy.get('h2').should('contain.text', 'Welcome to Your Portal');
    });
  });

  describe('Summary Tab Tests', () => {
    it('should display status banner', () => {
      cy.get('.status-banner.pending').should('be.visible');
      cy.get('.status-banner h2').should('contain.text', 'Welcome to Your Portal');
      cy.get('.status-banner p').should('contain.text', "We're getting started on your case. Check back soon for updates!");
    });

    it('should display stats grid with all metrics', () => {
      cy.get('.stats-grid').should('be.visible');
      cy.get('.stat-box').should('have.length', 4);
      
      cy.get('.stat-box').eq(0).within(() => {
        cy.get('.stat-value').should('contain.text', '0');
        cy.get('.stat-label').should('contain.text', 'Violations Found');
      });
      
      cy.get('.stat-box').eq(1).within(() => {
        cy.get('.stat-value.green').should('contain.text', '-/10');
        cy.get('.stat-label').should('contain.text', 'Case Strength');
      });
      
      cy.get('.stat-box').eq(2).within(() => {
        cy.get('.stat-value.blue').should('contain.text', '1');
        cy.get('.stat-label').should('contain.text', 'Dispute Round');
      });
      
      cy.get('.stat-box').eq(3).within(() => {
        cy.get('.stat-value').should('contain.text', '$0');
        cy.get('.stat-label').should('contain.text', 'Potential Recovery');
      });
    });

    it('should display ROI dashboard card', () => {
      cy.get('.card').should('contain.text', 'Your Case Value Analysis');
      cy.get('#roiDashboard').should('be.visible');
    });
  });

  describe('Score Progress Tab Tests', () => {
    beforeEach(() => {
      cy.get('.nav-tab').contains('Score Progress').click();
    });

    it('should switch to score progress tab', () => {
      cy.get('#progress').should('have.class', 'active');
      cy.get('.nav-tab.active').should('contain.text', 'Score Progress');
    });

    it('should display score progress content', () => {
      cy.get('#scoreProgressContent').should('be.visible');
    });

    it('should display score timeline chart', () => {
      cy.get('#clientScoreChart').should('exist');
    });

    it('should display projected improvement section', () => {
      cy.get('#projectionContent').should('be.visible');
    });
  });

  describe('Dispute Timeline Tab Tests', () => {
    beforeEach(() => {
      cy.get('.nav-tab').contains('Dispute Timeline').click();
    });

    it('should switch to dispute timeline tab', () => {
      cy.get('#timeline').should('have.class', 'active');
      cy.get('.nav-tab.active').should('contain.text', 'Dispute Timeline');
    });

    it('should display timeline summary with all counters', () => {
      cy.get('#timelineSummary').should('be.visible');
      cy.get('#lettersSentCount').should('be.visible');
      cy.get('#responsesCount').should('be.visible'); 
      cy.get('#deletedCount').should('be.visible');
      cy.get('#overdueCount').should('be.visible');
    });

    it('should display timeline container', () => {
      cy.get('#timelineContainer').should('be.visible');
    });
  });

  describe('Status Tab Tests', () => {
    beforeEach(() => {
      cy.get('.nav-tab').contains('Status').click();
    });

    it('should switch to status tab', () => {
      cy.get('#status').should('have.class', 'active');
      cy.get('.nav-tab.active').should('contain.text', 'Status');
    });

    it('should display status control buttons', () => {
      cy.get('button').contains('Show all').should('be.visible');
      cy.get('button').contains('Submit changes').should('be.visible').should('have.length', 2);
    });

    it('should display Equifax section with table', () => {
      cy.get('.bureau-section').first().within(() => {
        cy.contains('EQUIFAX').should('be.visible');
        cy.get('.status-table').should('be.visible');
      });
    });

    it('should display Experian section with table', () => {
      cy.get('.bureau-section').eq(1).within(() => {
        cy.contains('Experian').should('be.visible');
        cy.get('.status-table').should('be.visible');
      });
    });

    it('should have correct table headers for all status tables', () => {
      const expectedHeaders = ['Follow up', 'Type', 'R', 'Creditor', 'Account ID', 'Status', 'Reason', 'Comments'];
      
      cy.get('.status-table').each(($table, index) => {
        if (index < 3) {
          cy.wrap($table).find('th').should('have.length', 8);
          expectedHeaders.forEach((header, headerIndex) => {
            cy.wrap($table).find('th').eq(headerIndex).should('contain.text', header);
          });
        }
      });
    });

    it('should display fourth table with different headers', () => {
      cy.get('.status-table').eq(3).within(() => {
        cy.get('th').should('contain.text', 'Secondary Bureau');
        cy.get('th').should('contain.text', 'ðŸ“Ž');
      });
    });
  });

  describe('My Profile Tab Tests', () => {
    beforeEach(() => {
      cy.get('.nav-tab').contains('My Profile').click();
    });

    it('should switch to profile tab', () => {
      cy.get('.nav-tab.active').should('contain.text', 'My Profile');
    });

    it('should display avatar upload buttons', () => {
      cy.get('.btn-upload').should('contain.text', 'Upload Photo');
      cy.get('#removeAvatarBtn').should('contain.text', 'Remove');
    });

    it('should display set password button', () => {
      cy.get('button').contains('Set Password').should('be.visible');
    });
  });

  describe('Contact Us Tab Tests', () => {
    beforeEach(() => {
      cy.get('.nav-tab').contains('Contact Us').click();
    });

    it('should switch to contact tab', () => {
      cy.get('.nav-tab.active').should('contain.text', 'Contact Us');
    });

    it('should display contact form', () => {
      cy.get('#contactForm').should('be.visible');
    });

    it('should have contact form inputs', () => {
      cy.get('#contactForm input[type="text"]').should('have.attr', 'required');
      cy.get('#contactForm textarea').should('have.attr', 'required');
      cy.get('#contactForm input[placeholder="How can we help you?"]').should('exist');
      cy.get('#contactForm textarea[placeholder="Type your message here..."]').should('exist');
    });

    it('should have send message button', () => {
      cy.get('button').contains('Send Message').should('be.visible');
    });
  });

  describe('Upload Documents Tab Tests', () => {
    beforeEach(() => {
      cy.get('.nav-tab').contains('Upload Documents').click();
    });

    it('should display document upload form', () => {
      cy.get('#docUploadForm').should('be.visible');
    });

    it('should display document category buttons', () => {
      const categories = ['CRA Response', 'Collection Letter', 'Legal/Lawsuit', 'Credit Report', 'ID/Proof', 'Other'];
      categories.forEach(category => {
        cy.get('.doc-category-btn').contains(category).should('be.visible');
      });
    });

    it('should have document upload form inputs', () => {
      cy.get('#docCategory').should('have.attr', 'type', 'hidden');
      cy.get('#docType').should('have.attr', 'type', 'hidden');
      cy.get('#docFileInput').should('have.attr', 'type', 'file');
      cy.get('input[type="date"][name="document_date"]').should('exist');
      cy.get('input[type="date"][name="received_date"]').should('exist');
      cy.get('textarea[name="notes"]').should('have.attr', 'placeholder', 'Any additional notes...');
    });

    it('should have back buttons and upload button', () => {
      cy.get('button').contains('â† Back').should('exist');
      cy.get('button').contains('Upload Document').should('be.visible');
    });
  });

  describe('Refer a Friend Tab Tests', () => {
    beforeEach(() => {
      cy.get('.nav-tab').contains('Refer a Friend').click();
    });

    it('should display referral form', () => {
      cy.get('#referralForm').should('be.visible');
    });

    it('should have referral form inputs with correct attributes', () => {
      cy.get('#refName').should('have.attr', 'placeholder', "Friend's full name").should('have.attr', 'required');
      cy.get('#refPhone').should('have.attr', 'type', 'tel').should('have.attr', 'placeholder', '(xxx) xxx-xxxx');
      cy.get('#refEmail').should('have.attr', 'type', 'email').should('have.attr', 'placeholder', 'friend@email.com').should('have.attr', 'required');
      cy.get('#refComments').should('have.attr', 'placeholder', 'Any additional information about your referral...');
    });

    it('should have submit referral button', () => {
      cy.get('button').contains('Submit Referral').should('be.visible');
    });
  });

  describe('Form Functionality Tests', () => {
    it('should validate contact form required fields', () => {
      cy.get('.nav-tab').contains('Contact Us').click();
      cy.get('button').contains('Send Message').click();
      cy.get('#contactForm input[required]').should('have.attr', 'required');
      cy.get('#contactForm textarea[required]').should('have.attr', 'required');
    });

    it('should allow text input in contact form', () => {
      cy.get('.nav-tab').contains('Contact Us').click();
      cy.get('#contactForm input[type="text"]').type('Test question');
      cy.get('#contactForm textarea').type('This is a test message');
      cy.get('#contactForm input[type="text"]').should('have.value', 'Test question');
      cy.get('#contactForm textarea').should('have.value', 'This is a test message');
    });

    it('should validate referral form required fields', () => {
      cy.get('.nav-tab').contains('Refer a Friend').click();
      cy.get('button').contains('Submit Referral').click();
      cy.get('#refName').should('have.attr', 'required');
      cy.get('#refEmail').should('have.attr', 'required');
    });

    it('should allow input in referral form', () => {
      cy.get('.nav-tab').contains('Refer a Friend').click();
      cy.get('#refName').type('John Doe');
      cy.get('#refPhone').type('555-123-4567');
      cy.get('#refEmail').type('john@example.com');
      cy.get('#refComments').type('Great friend who needs help');
      
      cy.get('#refName').should('have.value', 'John Doe');
      cy.get('#refEmail').should('have.value', 'john@example.com');
    });

    it('should handle file upload in document form', () => {
      cy.get('.nav-tab').contains('Upload Documents').click();
      cy.get('#docFileInput').should('exist');
      cy.get('input[type="date"]').should('have.length', 2);
    });

    it('should handle date inputs in document form', () => {
      cy.get('.nav-tab').contains('Upload Documents').click();
      const today = new Date().toISOString().split('T')[0];
      cy.get('input[name="document_date"]').type(today);
      cy.get('input[name="received_date"]').type(today);
      cy.get('input[name="document_date"]').should('have.value', today);
      cy.get('input[name="received_date"]').should('have.value', today);
    });
  });

  describe('Button Functionality Tests', () => {
    it('should test all status tab buttons', () => {
      cy.get('.nav-tab').contains('Status').click();
      cy.get('button').contains('Show all').should('be.visible').click();
      cy.get('button').contains('Submit changes').first().should('be.visible').click();
    });

    it('should test document category buttons', () => {
      cy.get('.nav-tab').contains('Upload Documents').click();
      cy.get('.doc-category-btn').contains('CRA Response').click();
      cy.get('.doc-category-btn').contains('Collection Letter').click();
      cy.get('.doc-category-btn').contains('Legal/Lawsuit').click();
      cy.get('.doc-category-btn').contains('Credit Report').click();
      cy.get('.doc-category-btn').contains('ID/Proof').click();
      cy.get('.doc-category-btn').contains('Other').click();
    });

    it('should test profile buttons', () => {
      cy.get('.nav-tab').contains('My Profile').click();
      cy.get('.btn-upload').should('be.visible');
      cy.get('#removeAvatarBtn').should('be.visible');
      cy.get('button').contains('Set Password').should('be.visible');
    });

    it('should test back buttons in document upload', () => {
      cy.get('.nav-tab').contains('Upload Documents').click();
      cy.get('button').contains('â† Back').should('exist');
    });
  });

  describe('Tab Navigation Tests', () => {
    it('should switch between all tabs correctly', () => {
      const tabs = [
        { name: 'Summary', id: 'summary' },
        { name: 'Score Progress', id: 'progress' },
        { name: 'Dispute Timeline', id: 'timeline' },
        { name: 'Status', id: 'status' },
        { name: 'Upload Documents', id: 'documents' },
        { name: 'My Profile', id: 'profile' },
        { name: 'Contact Us', id: 'contact' },
        { name: 'Refer a Friend', id: 'referral' }
      ];

      tabs.forEach(tab => {
        cy.get('.nav-tab').contains(tab.name).click();
        cy.get('.nav-tab.active').should('contain.text', tab.name);
      });
    });

    it('should click user profile to navigate to profile tab', () => {
      cy.get('.user-profile').click();
      cy.get('.nav-tab.active').should('contain.text', 'My Profile');
    });
  });

  describe('Table Display Tests', () => {
    beforeEach(() => {
      cy.get('.nav-tab').contains('Status').click();
    });

    it('should display empty state messages in tables', () => {
      cy.contains('No items tracked yet for Equifax').should('be.visible');
      cy.contains('No items tracked yet for Experian').should('be.visible');
    });

    it('should have proper table structure', () => {
      cy.get('.status-table').each($table => {
        cy.wrap($table).find('thead').should('exist');
        cy.wrap($table).find('tbody').should('exist');
      });
    });
  });

  describe('Responsive Design Tests', () => {
    const viewports = [
      { width: 1280, height: 720, name: 'Desktop' },
      { width: 768, height: 1024, name: 'Tablet' },
      { width: 375, height: 667, name: 'Mobile' }
    ];

    viewports.forEach(viewport => {
      it(`should display correctly on ${viewport.name} (${viewport.width}x${viewport.height})`, () => {
        cy.viewport(viewport.width, viewport.height);
        cy.get('.header').should('be.visible');
        cy.get('.nav-tabs').should('be.visible');
        cy.get('.container').should('be.visible');
        cy.get('.status-banner').should('be.visible');
        cy.get('.stats-grid').should('be.visible');
      });
    });
  });

  describe('Interactive Elements Tests', () => {
    it('should test all clickable elements are functional', () => {
      cy.get('.nav-tab').each($tab => {
        cy.wrap($tab).should('be.visible').click();
      });
    });

    it('should test form submissions', () => {
      cy.get('.nav-tab').contains('Contact Us').click();
      cy.get('#contactForm input[type="text"]').type('Test');
      cy.get('#contactForm textarea').type('Test message');
      cy.get('button').contains('Send Message').click();
    });
  });

  describe('Error Handling Tests', () => {
    it('should handle invalid form data gracefully', () => {
      cy.get('.nav-tab').contains('Refer a Friend').click();
      cy.get('#refEmail').type('invalid-email');
      cy.get('button').contains('Submit Referral').click();
    });

    it('should handle empty required fields', () => {
      cy.get('.nav-tab').contains('Contact Us').click();
      cy.get('button').contains('Send Message').click();
      cy.get('#contactForm input[required]').should('be.invalid');
    });
  });

  describe('Card and Panel Tests', () => {
    it('should display all cards in summary tab', () => {
      cy.get('.card').should('have.length.at.least', 1);
      cy.get('.card').each($card => {
        cy.wrap($card).should('be.visible');
      });
    });

    it('should display stat boxes as panels', () => {
      cy.get('.stat-box').should('have.length', 4);
      cy.get('.stat-box').each($box => {
        cy.wrap($box).should('be.visible');
        cy.wrap($box).find('.stat-value').should('exist');
        cy.wrap($box).find('.stat-label').should('exist');
      });
    });
  });

  describe('Form Action and Method Tests', () => {
    it('should verify contact form attributes', () => {
      cy.get('.nav-tab').contains('Contact Us').click();
      cy.get('#contactForm')
        .should('have.attr', 'action', 'http://localhost:5001/portal/create-password')
        .should('have.attr', 'method', 'get');
    });

    it('should verify document upload form attributes', () => {
      cy.get('.nav-tab').contains('Upload Documents').click();
      cy.get('#docUploadForm')
        .should('have.attr', 'action', 'http://localhost:5001/portal/create-password')
        .should('have.attr', 'method', 'get');
    });

    it('should verify referral form attributes', () => {
      cy.get('.nav-tab').contains('Refer a Friend').click();
      cy.get('#referralForm')
        .should('have.attr', 'action', 'http://localhost:5001/portal/create-password')
        .should('have.attr', 'method', 'get');
    });
  });
});