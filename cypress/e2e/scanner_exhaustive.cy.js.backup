// Exhaustive test for /scanner
describe('/scanner - Document Scanner', () => {
  beforeEach(() => {
    // Public route - no auth required
    cy.visit('/scanner');
  });

  // Page Load Tests
  describe('Page Load Tests', () => {
    it('should load without errors', () => {
      cy.url().should('include', '/scanner');
      cy.get('body').should('be.visible');
    });

    it('should have correct page title', () => {
      cy.title().should('eq', 'Document Scanner - Brightpath Ascend');
    });

    it('should not have console errors', () => {
      cy.window().then((win) => {
        cy.stub(win.console, 'error').as('consoleError');
      });
      cy.get('@consoleError').should('not.have.been.called');
    });

    it('should not have server errors', () => {
      cy.intercept('GET', '/scanner').as('pageLoad');
      cy.visit('/scanner');
      cy.wait('@pageLoad').its('response.statusCode').should('eq', 200);
    });
  });

  // Navigation Tests
  describe('Navigation Tests', () => {
    it('should display navigation sidebar', () => {
      cy.get('.sidebar').should('be.visible');
    });

    it('should display logo and company name', () => {
      cy.get('.logo').should('be.visible');
      cy.get('.logo img').should('have.attr', 'src', '/static/images/logo.png');
      cy.get('.logo span').should('contain', 'BrightpathAscend');
    });

    it('should display main navigation section expanded', () => {
      cy.get('.nav-section[data-section="main"]').should('be.visible');
      cy.get('.nav-section[data-section="main"] .nav-section-items').should('have.class', 'expanded');
      cy.get('.nav-section[data-section="main"] .chevron').should('have.class', 'rotated');
    });

    it('should display all main navigation items', () => {
      cy.get('.nav-section[data-section="main"] .nav-item[href="/dashboard"]').should('contain', 'Dashboard');
      cy.get('.nav-section[data-section="main"] .nav-item[href="/dashboard/analytics"]').should('contain', 'Analytics');
      cy.get('.nav-section[data-section="main"] .nav-item[href="/dashboard/calendar"]').should('contain', 'Calendar');
      cy.get('.nav-section[data-section="main"] .nav-item[href="/dashboard/contacts"]').should('contain', 'Contact List');
      cy.get('.nav-section[data-section="main"] .nav-item[href="/dashboard/clients"]').should('contain', 'Cases');
      cy.get('.nav-section[data-section="main"] .nav-item[href="/dashboard/queue"]').should('contain', 'Processing Queue');
      cy.get('.nav-section[data-section="main"] .nav-item[href="/dashboard/documents"]').should('contain', 'Documents');
    });

    it('should display cases navigation section', () => {
      cy.get('.nav-section[data-section="cases"]').should('be.visible');
      cy.get('.nav-section[data-section="cases"] .nav-section-title span').should('contain', 'Cases');
    });

    it('should display cases navigation items', () => {
      cy.get('.nav-section[data-section="cases"] .nav-item[href="/dashboard/cases?status=stage1_complete"]').should('contain', 'Pending Review');
      cy.get('.nav-section[data-section="cases"] .nav-item[href="/dashboard/cases?status=stage2_complete"]').should('contain', 'Ready to Deliver');
      cy.get('.nav-section[data-section="cases"] .nav-item[href="/dashboard/settlements"]').should('contain', 'Settlements');
      cy.get('.nav-section[data-section="cases"] .nav-item[href="/dashboard/furnishers"]').should('contain', 'Furnisher Intelligence');
    });

    it('should display tools navigation section', () => {
      cy.get('.nav-section[data-section="tools"]').should('be.visible');
      cy.get('.nav-section[data-section="tools"] .nav-section-title span').should('contain', 'Tools');
      cy.get('.nav-section[data-section="tools"] .nav-item[href="/dashboard/settings"]').should('contain', 'Settings');
    });

    it('should display user info and logout', () => {
      cy.get('.sidebar-user').should('be.visible');
      cy.get('.sidebar-user').should('contain', 'User');
      cy.get('.sidebar-user').should('contain', 'staff');
      cy.get('a[href="/staff/logout"]').should('contain', 'Sign Out');
    });

    it('should toggle navigation sections', () => {
      cy.get('.nav-section[data-section="cases"] .nav-section-title').click();
      cy.get('.nav-section[data-section="cases"] .nav-section-items').should('have.class', 'expanded');
      cy.get('.nav-section[data-section="cases"] .chevron').should('have.class', 'rotated');
      
      cy.get('.nav-section[data-section="cases"] .nav-section-title').click();
      cy.get('.nav-section[data-section="cases"] .nav-section-items').should('not.have.class', 'expanded');
      cy.get('.nav-section[data-section="cases"] .chevron').should('not.have.class', 'rotated');
    });
  });

  // Main Content Tests
  describe('Main Content Tests', () => {
    it('should display page header', () => {
      cy.get('.page-header').should('be.visible');
      cy.get('.page-header h4').should('contain', 'Document Scanner');
      cy.get('.page-header small').should('contain', 'Brightpath Ascend Group');
    });

    it('should display scanner container', () => {
      cy.get('.scanner-container').should('be.visible');
    });

    it('should display step indicator with correct steps', () => {
      cy.get('.step-indicator').should('be.visible');
      cy.get('#step-1').should('have.class', 'active');
      cy.get('#step-2').should('not.have.class', 'active');
      cy.get('#step-3').should('not.have.class', 'active');
    });
  });

  // Button Tests
  describe('Button Tests', () => {
    it('should display camera tab button as active', () => {
      cy.get('button.nav-link.active').should('contain', 'Camera').and('be.visible');
    });

    it('should display upload tab button', () => {
      cy.get('button.nav-link').not('.active').should('contain', 'Upload').and('be.visible');
    });

    it('should switch between camera and upload tabs', () => {
      cy.get('button.nav-link').contains('Upload').click();
      cy.get('button.nav-link').contains('Upload').should('have.class', 'active');
      cy.get('button.nav-link').contains('Camera').should('not.have.class', 'active');
      
      cy.get('button.nav-link').contains('Camera').click();
      cy.get('button.nav-link').contains('Camera').should('have.class', 'active');
      cy.get('button.nav-link').contains('Upload').should('not.have.class', 'active');
    });

    it('should display capture button', () => {
      cy.get('#btn-capture').should('be.visible').and('have.attr', 'type', 'submit');
    });

    it('should display add more button', () => {
      cy.get('#add-more-btn').should('be.visible').and('have.attr', 'type', 'submit');
    });

    it('should display download PDF link', () => {
      cy.get('#download-pdf-link')
        .should('be.visible')
        .and('contain', 'Download PDF')
        .and('have.attr', 'href')
        .and('include', '/scanner');
    });

    it('should display download text link', () => {
      cy.get('#download-text-link')
        .should('be.visible')
        .and('contain', 'Download Text')
        .and('have.attr', 'href')
        .and('include', '/scanner');
    });

    it('should display scan another document button', () => {
      cy.get('button.btn.btn-gradient.w-100')
        .should('be.visible')
        .and('contain', 'Scan Another Document')
        .and('have.attr', 'type', 'submit');
    });

    it('should display back button', () => {
      cy.get('#btn-back')
        .should('be.visible')
        .and('contain', 'Back')
        .and('have.attr', 'type', 'submit');
    });

    it('should display next button', () => {
      cy.get('#btn-next')
        .should('be.visible')
        .and('contain', 'Next')
        .and('have.attr', 'type', 'submit');
    });

    it('should make all buttons clickable', () => {
      cy.get('button.nav-link.active').click();
      cy.get('button.nav-link').not('.active').click();
      cy.get('#btn-capture').should('not.be.disabled');
      cy.get('#add-more-btn').should('not.be.disabled');
      cy.get('#btn-back').should('not.be.disabled');
      cy.get('#btn-next').should('not.be.disabled');
      cy.get('button.btn.btn-gradient.w-100').should('not.be.disabled');
    });
  });

  // Document Type Selection Tests
  describe('Document Type Selection Tests', () => {
    it('should display document type selection step', () => {
      cy.get('#step-select-type').should('be.visible');
      cy.get('#step-select-type h5').should('contain', 'Select Document Type');
    });

    it('should display CRA Response Letter card', () => {
      cy.get('.doc-type-card[data-type="cra_response"]')
        .should('be.visible')
        .and('have.attr', 'data-has-rounds', 'true');
      cy.get('.doc-type-card[data-type="cra_response"]').should('contain', 'CRA Response Letter');
      cy.get('.doc-type-card[data-type="cra_response"]').should('contain', 'Response from credit bureau');
    });

    it('should display Collection Letter card', () => {
      cy.get('.doc-type-card[data-type="collection_letter"]')
        .should('be.visible');
      cy.get('.doc-type-card[data-type="collection_letter"]').should('contain', 'Collection Letter');
      cy.get('.doc-type-card[data-type="collection_letter"]').should('contain', 'Letter from debt collector');
    });

    it('should display Creditor/Furnisher Response card', () => {
      cy.get('.doc-type-card[data-type="creditor_response"]')
        .should('be.visible');
      cy.get('.doc-type-card[data-type="creditor_response"]').should('contain', 'Creditor/Furnisher Response');
      cy.get('.doc-type-card[data-type="creditor_response"]').should('contain', 'Response from creditor or data furnisher');
    });

    it('should display Court Document card', () => {
      cy.get('.doc-type-card[data-type="court_document"]')
        .should('be.visible');
      cy.get('.doc-type-card[data-type="court_document"]').should('contain', 'Court Document');
      cy.get('.doc-type-card[data-type="court_document"]').should('contain', 'Lawsuit, summons, or court filing');
    });

    it('should display ID Document card', () => {
      cy.get('.doc-type-card[data-type="id_document"]')
        .should('be.visible');
      cy.get('.doc-type-card[data-type="id_document"]').should('contain', 'ID Document');
      cy.get('.doc-type-card[data-type="id_document"]').should('contain', 'Driver license, passport, or other ID');
    });

    it('should make document type cards clickable', () => {
      cy.get('.doc-type-card[data-type="cra_response"]').click();
      cy.get('.doc-type-card[data-type="collection_letter"]').click();
      cy.get('.doc-type-card[data-type="creditor_response"]').click();
      cy.get('.doc-type-card[data-type="court_document"]').click();
      cy.get('.doc-type-card[data-type="id_document"]').click();
    });
  });

  // Interactive Element Tests
  describe('Interactive Element Tests', () => {
    it('should handle tab switching functionality', () => {
      cy.get('button.nav-link').contains('Upload').click();
      cy.get('button.nav-link').contains('Upload').should('have.class', 'active');
      
      cy.get('button.nav-link').contains('Camera').click();
      cy.get('button.nav-link').contains('Camera').should('have.class', 'active');
    });

    it('should handle step navigation', () => {
      cy.get('#btn-next').click();
      cy.get('#step-2').should('have.class', 'active');
      
      cy.get('#btn-back').click();
      cy.get('#step-1').should('have.class', 'active');
    });

    it('should handle document type selection', () => {
      cy.get('.doc-type-card[data-type="cra_response"]').click();
      cy.get('.doc-type-card[data-type="cra_response"]').should('have.class', 'selected');
    });

    it('should handle capture button click', () => {
      cy.get('#btn-capture').click();
      // Should trigger capture functionality
    });

    it('should handle add more button click', () => {
      cy.get('#add-more-btn').click();
      // Should allow adding more pages
    });
  });

  // Responsive Tests
  describe('Responsive Tests', () => {
    it('should display correctly on desktop (1280px)', () => {
      cy.viewport(1280, 800);
      cy.get('.sidebar').should('be.visible');
      cy.get('.main-content').should('be.visible');
      cy.get('.scanner-container').should('be.visible');
    });

    it('should display correctly on tablet (768px)', () => {
      cy.viewport(768, 1024);
      cy.get('.scanner-container').should('be.visible');
      cy.get('.doc-type-card').should('be.visible');
      cy.get('.step-indicator').should('be.visible');
    });

    it('should display correctly on mobile (375px)', () => {
      cy.viewport(375, 667);
      cy.get('.scanner-container').should('be.visible');
      cy.get('.doc-type-card').should('be.visible');
      cy.get('#btn-capture').should('be.visible');
      cy.get('#btn-next').should('be.visible');
      cy.get('#btn-back').should('be.visible');
    });
  });

  // File Upload Tests
  describe('File Upload Tests', () => {
    it('should handle file upload functionality', () => {
      cy.get('button.nav-link').contains('Upload').click();
      
      // Create a test file
      const fileName = 'test-document.pdf';
      cy.fixture('test-document.pdf', 'binary')
        .then(Cypress.Blob.binaryStringToBlob)
        .then(fileContent => {
          const file = new File([fileContent], fileName, { type: 'application/pdf' });
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          
          // Simulate file upload (assuming there's a file input)
          cy.get('input[type="file"]').then(input => {
            input[0].files = dataTransfer.files;
          });
        });
    });
  });

  // Error Handling Tests
  describe('Error Handling Tests', () => {
    it('should handle network errors gracefully', () => {
      cy.intercept('POST', '**/api/**', { statusCode: 500 }).as('serverError');
      cy.get('#btn-capture').click();
      // Should display error message or handle gracefully
    });

    it('should handle invalid file uploads', () => {
      cy.get('button.nav-link').contains('Upload').click();
      
      const fileName = 'invalid-file.txt';
      const fileContent = 'This is not a valid document';
      const file = new File([fileContent], fileName, { type: 'text/plain' });
      
      // Should show validation error for invalid file type
    });

    it('should handle empty document selection', () => {
      cy.get('#btn-next').click();
      // Should show validation error or prevent progression
    });
  });

  // Chart Tests (since charts are indicated as present)
  describe('Chart Tests', () => {
    it('should display charts if present', () => {
      // Look for common chart containers or canvas elements
      cy.get('canvas, svg, .chart-container').should('exist');
    });
  });

  // LocalStorage Tests
  describe('LocalStorage Tests', () => {
    it('should save sidebar state to localStorage', () => {
      cy.get('.nav-section[data-section="cases"] .nav-section-title').click();
      cy.window().then((win) => {
        const savedState = JSON.parse(win.localStorage.getItem('dashboard_sidebar_sections'));
        expect(savedState.cases).to.be.true;
      });
    });

    it('should restore sidebar state from localStorage', () => {
      cy.window().then((win) => {
        win.localStorage.setItem('dashboard_sidebar_sections', JSON.stringify({
          cases: true,
          tools: false
        }));
      });
      cy.reload();
      cy.get('.nav-section[data-section="cases"] .nav-section-items').should('have.class', 'expanded');
    });
  });

  // Accessibility Tests
  describe('Accessibility Tests', () => {
    it('should have proper heading structure', () => {
      cy.get('h4').should('contain', 'Document Scanner');
      cy.get('h5').should('contain', 'Select Document Type');
    });

    it('should have clickable elements with proper cursor', () => {
      cy.get('button').should('have.css', 'cursor', 'pointer');
      cy.get('.doc-type-card').should('have.css', 'cursor', 'pointer');
    });

    it('should have proper form labels and inputs', () => {
      cy.get('button[type="submit"]').should('exist');
    });
  });
});